<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="DesClick CRM - Solution de gestion commerciale">
  <title>DesClick CRM</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- PDF Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- =====================================================
       DESCLICK CRM - CLIENT API GOOGLE SHEETS
  ===================================================== -->
  <script>
  const API_CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbxu4ncqWOgSh1_opvFrCiQUnzjkFj_5sGx6kvFyMBPzSzcVwl8Ca-IgFllSbSKn72Vv/exec',
    TOKEN_KEY: 'desclick_crm_token',
    USER_KEY: 'desclick_crm_user',
    DEBUG: true // Activer le mode debug
  };

  class DesClickAPI {
    constructor() {
      this.baseUrl = API_CONFIG.API_URL;
      this.token = localStorage.getItem(API_CONFIG.TOKEN_KEY) || '';
    }
    
    async request(action, data = {}, method = 'POST') {
      try {
        // Google Apps Script : toujours utiliser GET pour √©viter CORS preflight
        const params = new URLSearchParams();
        params.append('action', action);
        params.append('token', this.token);
        
        // Pour les actions CRUD, envoyer les donn√©es dans un param√®tre 'data'
        const crudActions = ['createUser', 'updateUser', 'createEntreprise', 'updateEntreprise', 
                            'createContact', 'updateContact', 'createOpportunite', 'updateOpportunite',
                            'createProduit', 'updateProduit', 'createPack', 'updatePack',
                            'createCommande', 'updateCommande', 'createEmail', 'updateEmail', 
                            'createRdv', 'updateRdv', 'createAppel', 'updateAppel',
                            'createTache', 'updateTache', 'sendMessage'];
        
        if (crudActions.includes(action)) {
          // Extraire l'id s'il existe et l'envoyer s√©par√©ment
          const { id, ...restData } = data;
          if (id !== undefined) {
            params.append('id', id);
          }
          // Envoyer le reste des donn√©es comme JSON
          if (Object.keys(restData).length > 0) {
            params.append('data', JSON.stringify(restData));
          }
        } else {
          // Pour les autres actions, envoyer les param√®tres s√©par√©ment
          for (const [key, value] of Object.entries(data)) {
            if (value !== undefined && value !== null) {
              if (typeof value === 'object') {
                params.append(key, JSON.stringify(value));
              } else {
                params.append(key, value);
              }
            }
          }
        }
        
        const url = `${this.baseUrl}?${params.toString()}`;
        
        // Toujours afficher les logs pour le debug
        console.log('üîó API Request:', action);
        console.log('üì§ Data envoy√©e:', data);
        console.log('üåê URL:', url.substring(0, 300));
        
        // Utiliser GET simple sans headers personnalis√©s pour √©viter CORS preflight
        const response = await fetch(url, {
          method: 'GET',
          redirect: 'follow'
        });
        
        console.log('üì° Response status:', response.status, response.statusText);
        
        const text = await response.text();
        
        if (API_CONFIG.DEBUG) {
          console.log('üìÑ Response body:', text.substring(0, 500));
        }
        
        let result;
        try {
          result = JSON.parse(text);
        } catch (e) {
          console.error('‚ùå JSON Parse Error:', e, 'Text:', text);
          throw new Error('R√©ponse invalide du serveur. V√©rifiez que l\'API est correctement d√©ploy√©e.');
        }
        
        if (!result.success && result.message === 'Non authentifi√©') {
          this.logout();
          throw new Error('Session expir√©e, veuillez vous reconnecter');
        }
        
        return result;
      } catch (error) {
        console.error('‚ùå Erreur API:', error);
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          throw new Error('Impossible de contacter le serveur. V√©rifiez votre connexion et l\'URL de l\'API.');
        }
        throw error;
      }
    }
    
    saveToken(token, user) {
      this.token = token;
      localStorage.setItem(API_CONFIG.TOKEN_KEY, token);
      localStorage.setItem(API_CONFIG.USER_KEY, JSON.stringify(user));
    }
    
    getStoredUser() {
      try { return JSON.parse(localStorage.getItem(API_CONFIG.USER_KEY)); } 
      catch (e) { return null; }
    }
    
    isLoggedIn() { return !!this.token && !!this.getStoredUser(); }
    
    logout() {
      this.token = '';
      localStorage.removeItem(API_CONFIG.TOKEN_KEY);
      localStorage.removeItem(API_CONFIG.USER_KEY);
    }
    
    // Auth
    async login(username, password) {
      const result = await this.request('login', { username, password });
      if (result.success) this.saveToken(result.data.token, result.data.user);
      return result;
    }
    async getMe() { return this.request('me', {}, 'GET'); }
    
    // Users
    async getUsers() { return this.request('getUsers', {}, 'GET'); }
    async getCommerciaux() { return this.request('getCommerciaux', {}, 'GET'); }
    async createUser(data) { return this.request('createUser', data); }
    async updateUser(id, data) { return this.request('updateUser', { id, ...data }); }
    async deleteUser(id) { return this.request('deleteUser', { id }); }
    
    // Entreprises
    async getEntreprises(filters = {}) { return this.request('getEntreprises', filters, 'GET'); }
    async getAllEntreprises() { return this.request('getAllEntreprises', {}, 'GET'); }
    async getEntreprise(id) { return this.request('getEntreprise', { id }, 'GET'); }
    async createEntreprise(data) { return this.request('createEntreprise', data); }
    async updateEntreprise(id, data) { return this.request('updateEntreprise', { id, ...data }); }
    async deleteEntreprise(id) { return this.request('deleteEntreprise', { id }); }
    
    // Contacts
    async getContacts(filters = {}) { return this.request('getContacts', filters, 'GET'); }
    async createContact(data) { return this.request('createContact', data); }
    async updateContact(id, data) { return this.request('updateContact', { id, ...data }); }
    async deleteContact(id) { return this.request('deleteContact', { id }); }
    
    // Opportunit√©s
    async getOpportunites(filters = {}) { return this.request('getOpportunites', filters, 'GET'); }
    async getPipeline() { return this.request('getPipeline', {}, 'GET'); }
    async createOpportunite(data) { return this.request('createOpportunite', data); }
    async updateOpportunite(id, data) { return this.request('updateOpportunite', { id, ...data }); }
    async updateOpportuniteStage(id, stage) { return this.request('updateOpportuniteStage', { id, stage }); }
    async deleteOpportunite(id) { return this.request('deleteOpportunite', { id }); }
    
    // Produits
    async getProduits(filters = {}) { return this.request('getProduits', filters, 'GET'); }
    async createProduit(data) { return this.request('createProduit', data); }
    async updateProduit(id, data) { return this.request('updateProduit', { id, ...data }); }
    async deleteProduit(id) { return this.request('deleteProduit', { id }); }
    async importProduits(products) { return this.request('importProduits', { products }); }
    
    // Packs
    async getPacks() { return this.request('getPacks', {}, 'GET'); }
    async createPack(data) { return this.request('createPack', data); }
    async updatePack(id, data) { return this.request('updatePack', { id, ...data }); }
    async deletePack(id) { return this.request('deletePack', { id }); }
    
    // Commandes
    async getCommandes(filters = {}) { return this.request('getCommandes', filters, 'GET'); }
    async getCommandesStats() { return this.request('getCommandesStats', {}, 'GET'); }
    async createCommande(data) { return this.request('createCommande', data); }
    async updateCommande(id, data) { return this.request('updateCommande', { id, ...data }); }
    async deleteCommande(id) { return this.request('deleteCommande', { id }); }
    
    // Actions
    async getEmails(filters = {}) { return this.request('getEmails', filters, 'GET'); }
    async createEmail(data) { return this.request('createEmail', data); }
    async updateEmail(id, data) { return this.request('updateEmail', { id, ...data }); }
    async deleteEmail(id) { return this.request('deleteEmail', { id }); }
    
    async getRdv(filters = {}) { return this.request('getRdv', filters, 'GET'); }
    async createRdv(data) { return this.request('createRdv', data); }
    async updateRdv(id, data) { return this.request('updateRdv', { id, ...data }); }
    async deleteRdv(id) { return this.request('deleteRdv', { id }); }
    
    async getAppels(filters = {}) { return this.request('getAppels', filters, 'GET'); }
    async createAppel(data) { return this.request('createAppel', data); }
    async updateAppel(id, data) { return this.request('updateAppel', { id, ...data }); }
    async deleteAppel(id) { return this.request('deleteAppel', { id }); }
    
    async getTaches(filters = {}) { return this.request('getTaches', filters, 'GET'); }
    async getTachesStats() { return this.request('getTachesStats', {}, 'GET'); }
    async createTache(data) { return this.request('createTache', data); }
    async updateTache(id, data) { return this.request('updateTache', { id, ...data }); }
    async toggleTache(id) { return this.request('toggleTache', { id }); }
    async deleteTache(id) { return this.request('deleteTache', { id }); }
    
    async getCalendarEvents(month, year) { return this.request('getCalendarEvents', { month, year }, 'GET'); }
    
    // Messages & Alertes
    async getMessages() { return this.request('getMessages', {}, 'GET'); }
    async getUnreadMessages() { return this.request('getUnreadMessages', {}, 'GET'); }
    async sendMessage(toUserId, content) { return this.request('sendMessage', { toUserId, content }); }
    async getAlertes() { return this.request('getAlertes', {}, 'GET'); }
    async getUnreadAlertes() { return this.request('getUnreadAlertes', {}, 'GET'); }
    async markAlerteRead(id) { return this.request('markAlerteRead', { id }); }
    
    // Dashboard
    async getDashboard() { return this.request('getDashboard', {}, 'GET'); }
    async getConsolidation() { return this.request('getConsolidation', {}, 'GET'); }
    
    // Settings
    async getSettings() { return this.request('getSettings', {}, 'GET'); }
    async updateSetting(key, value) { return this.request('updateSetting', { key, value }); }
  }

  const api = new DesClickAPI();
  </script>
  
  <style>
    /* =====================================================
       CSS VARIABLES & THEME SYSTEM
    ===================================================== */
    :root {
      /* Brand Colors - DesClick */
      --brand-primary: #2B5EA7;
      --brand-secondary: #1E4A8A;
      --brand-accent: #F5A623;
      --brand-accent-dark: #D4890F;
      --brand-light: #5B8FD9;
      
      /* Semantic Colors */
      --success: #10B981;
      --success-light: #D1FAE5;
      --warning: #F5A623;
      --warning-light: #FEF3C7;
      --danger: #EF4444;
      --danger-light: #FEE2E2;
      --info: #2B5EA7;
      --info-light: #DBEAFE;
      
      /* Pipeline Stage Colors */
      --stage-prospect: #6B7280;
      --stage-qualification: #2B5EA7;
      --stage-proposition: #F5A623;
      --stage-negotiation: #F97316;
      --stage-closing: #10B981;
      --stage-won: #059669;
      --stage-lost: #EF4444;
      
      /* Dark Theme (Default) */
      --bg-primary: #0A1628;
      --bg-secondary: #112240;
      --bg-tertiary: #1A365D;
      --bg-card: rgba(17, 34, 64, 0.95);
      --bg-hover: rgba(43, 94, 167, 0.1);
      --bg-active: rgba(43, 94, 167, 0.15);
      
      --text-primary: #F8FAFC;
      --text-secondary: #CBD5E1;
      --text-muted: #64748B;
      --text-inverse: #0F172A;
      
      --border-default: rgba(255, 255, 255, 0.08);
      --border-light: rgba(255, 255, 255, 0.04);
      --border-focus: var(--brand-primary);
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 24px 60px rgba(0, 0, 0, 0.6);
      --shadow-glow: 0 0 40px rgba(43, 94, 167, 0.3);
      
      /* Gradients */
      --gradient-brand: linear-gradient(135deg, #2B5EA7 0%, #1E4A8A 50%, #153A6E 100%);
      --gradient-accent: linear-gradient(135deg, #F5A623 0%, #D4890F 100%);
      --gradient-success: linear-gradient(135deg, #10B981 0%, #059669 100%);
      --gradient-danger: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      --gradient-dark: linear-gradient(180deg, #112240 0%, #0A1628 100%);
      --gradient-mesh: radial-gradient(ellipse at 20% 0%, rgba(43, 94, 167, 0.15) 0%, transparent 50%),
                       radial-gradient(ellipse at 80% 100%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                       radial-gradient(ellipse at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
      
      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;
      --space-3xl: 64px;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      
      /* Typography */
      --font-sans: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
      
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 2rem;
      --text-4xl: 2.5rem;
      
      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
      
      /* Z-Index Scale */
      --z-dropdown: 100;
      --z-sticky: 200;
      --z-modal: 300;
      --z-toast: 400;
      --z-tooltip: 500;
      
      /* Layout */
      --sidebar-width: 280px;
      --sidebar-collapsed: 72px;
      --header-height: 64px;
    }

    /* Light Theme Override */
    [data-theme="light"] {
      --bg-primary: #F8FAFC;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F1F5F9;
      --bg-card: rgba(255, 255, 255, 0.95);
      --bg-hover: rgba(99, 102, 241, 0.08);
      --bg-active: rgba(99, 102, 241, 0.12);
      
      --text-primary: #0F172A;
      --text-secondary: #475569;
      --text-muted: #94A3B8;
      --text-inverse: #F8FAFC;
      
      --border-default: rgba(0, 0, 0, 0.08);
      --border-light: rgba(0, 0, 0, 0.04);
      
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 24px 60px rgba(0, 0, 0, 0.15);
      
      --gradient-mesh: radial-gradient(ellipse at 20% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                       radial-gradient(ellipse at 80% 100%, rgba(139, 92, 246, 0.06) 0%, transparent 50%);
    }

    /* =====================================================
       RESET & BASE STYLES
    ===================================================== */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: var(--font-sans);
      font-size: var(--text-base);
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-primary);
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: var(--gradient-mesh);
      pointer-events: none;
      z-index: 0;
    }

    /* =====================================================
       TYPOGRAPHY
    ===================================================== */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      line-height: 1.2;
      color: var(--text-primary);
    }

    h1 { font-size: var(--text-4xl); }
    h2 { font-size: var(--text-3xl); }
    h3 { font-size: var(--text-2xl); }
    h4 { font-size: var(--text-xl); }
    h5 { font-size: var(--text-lg); }
    h6 { font-size: var(--text-base); }

    p { margin-bottom: var(--space-md); }

    a {
      color: var(--brand-primary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }
    a:hover { color: var(--brand-secondary); }

    /* =====================================================
       SCROLLBAR
    ===================================================== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border-default);
      border-radius: var(--radius-full);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* =====================================================
       SELECTION
    ===================================================== */
    ::selection {
      background: var(--brand-primary);
      color: white;
    }

    /* =====================================================
       UTILITY CLASSES
    ===================================================== */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .text-muted { color: var(--text-muted); }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-danger { color: var(--danger); }
    .text-brand { color: var(--brand-primary); }

    .font-mono { font-family: var(--font-mono); }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }

    .truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* =====================================================
       ANIMATIONS
    ===================================================== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .animate-fade-in { animation: fadeIn var(--transition-base) ease-out; }
    .animate-slide-up { animation: slideUp var(--transition-base) ease-out; }
    .animate-slide-down { animation: slideDown var(--transition-base) ease-out; }
    .animate-scale-in { animation: scaleIn var(--transition-base) ease-out; }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    .animate-spin { animation: spin 1s linear infinite; }

    /* =====================================================
       FORM ELEMENTS
    ===================================================== */
    .form-group {
      margin-bottom: var(--space-lg);
    }

    .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--space-sm);
    }

    .form-label .required {
      color: var(--danger);
      margin-left: 2px;
    }

    .form-control {
      width: 100%;
      padding: 12px 16px;
      font-family: inherit;
      font-size: var(--text-sm);
      color: var(--text-primary);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      outline: none;
    }

    .form-control::placeholder {
      color: var(--text-muted);
    }

    .form-control:hover {
      border-color: var(--text-muted);
    }

    .form-control:focus {
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .form-control:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-control.error {
      border-color: var(--danger);
    }

    select.form-control {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748B' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 40px;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
    }

    .form-hint {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-top: var(--space-xs);
    }

    .form-error {
      font-size: var(--text-xs);
      color: var(--danger);
      margin-top: var(--space-xs);
    }

    /* Checkbox & Radio */
    .form-check {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      cursor: pointer;
    }

    .form-check input {
      width: 18px;
      height: 18px;
      accent-color: var(--brand-primary);
      cursor: pointer;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      cursor: pointer;
    }

    .toggle-switch input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      width: 44px;
      height: 24px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      position: relative;
      transition: var(--transition-fast);
      border: 1px solid var(--border-default);
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: var(--text-muted);
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: var(--transition-fast);
    }

    .toggle-switch input:checked + .toggle-slider {
      background: var(--brand-primary);
      border-color: var(--brand-primary);
    }

    .toggle-switch input:checked + .toggle-slider::before {
      background: white;
      transform: translateX(20px);
    }

    /* =====================================================
       BUTTONS
    ===================================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: 10px 20px;
      font-family: inherit;
      font-size: var(--text-sm);
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-primary);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
      white-space: nowrap;
      user-select: none;
    }

    .btn:hover {
      background: var(--bg-hover);
      border-color: var(--brand-primary);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: var(--gradient-brand);
      border: none;
      color: white;
      box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
      background: var(--gradient-brand);
    }

    .btn-success {
      background: var(--gradient-success);
      border: none;
      color: white;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }

    .btn-warning {
      background: var(--gradient-accent);
      border: none;
      color: white;
      box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4);
    }

    .btn-danger {
      background: var(--gradient-danger);
      border: none;
      color: white;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
    }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      border-color: transparent;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--brand-primary);
      color: var(--brand-primary);
    }

    .btn-outline:hover {
      background: var(--brand-primary);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: var(--text-xs);
    }

    .btn-lg {
      padding: 14px 28px;
      font-size: var(--text-base);
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: var(--radius-md);
    }

    .btn-icon.sm {
      width: 32px;
      height: 32px;
    }

    .btn-group {
      display: flex;
      gap: var(--space-sm);
    }

    /* =====================================================
       BADGES
    ===================================================== */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: var(--text-xs);
      font-weight: 600;
      border-radius: var(--radius-full);
      white-space: nowrap;
    }

    .badge-default {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .badge-primary {
      background: rgba(99, 102, 241, 0.15);
      color: var(--brand-primary);
    }

    .badge-success {
      background: var(--success-light);
      color: var(--success);
    }

    .badge-warning {
      background: var(--warning-light);
      color: #B45309;
    }

    .badge-danger {
      background: var(--danger-light);
      color: var(--danger);
    }

    .badge-info {
      background: var(--info-light);
      color: var(--info);
    }

    .badge-dot::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* =====================================================
       CARDS
    ===================================================== */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(20px);
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-light);
    }

    .card-title {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .card-body {
      padding: var(--space-lg);
    }

    .card-footer {
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--border-light);
      background: var(--bg-tertiary);
    }

    .card-hover:hover {
      border-color: var(--brand-primary);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
      transition: all var(--transition-base);
    }

    /* =====================================================
       TABLES
    ===================================================== */
    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: var(--space-md);
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }

    .table th {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--bg-tertiary);
    }

    .table tbody tr {
      transition: background var(--transition-fast);
    }

    .table tbody tr:hover {
      background: var(--bg-hover);
    }

    .table td {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .table .actions-cell {
      display: flex;
      gap: var(--space-xs);
      justify-content: flex-end;
    }

    /* =====================================================
       MODALS
    ===================================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-lg);
      z-index: var(--z-modal);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      transform: scale(0.95) translateY(20px);
      transition: transform var(--transition-base);
      overflow: hidden;
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-light);
    }

    .modal-title {
      font-size: var(--text-xl);
      font-weight: 700;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--text-muted);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-sm);
      padding: var(--space-lg);
      border-top: 1px solid var(--border-light);
      background: var(--bg-tertiary);
    }

    /* =====================================================
       TOAST NOTIFICATIONS
    ===================================================== */
    .toast-container {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      z-index: var(--z-toast);
      pointer-events: none;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      min-width: 300px;
      max-width: 450px;
      animation: slideInRight var(--transition-base) ease-out;
      pointer-events: auto;
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      font-size: 14px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: var(--text-sm);
      margin-bottom: 2px;
    }

    .toast-message {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .toast-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .toast.success .toast-icon {
      background: var(--success-light);
      color: var(--success);
    }

    .toast.error .toast-icon {
      background: var(--danger-light);
      color: var(--danger);
    }

    .toast.warning .toast-icon {
      background: var(--warning-light);
      color: var(--warning);
    }

    .toast.info .toast-icon {
      background: var(--info-light);
      color: var(--info);
    }

    /* =====================================================
       EMPTY STATES
    ===================================================== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-3xl);
      text-align: center;
    }

    .empty-state-icon {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      margin-bottom: var(--space-lg);
    }

    .empty-state-title {
      font-size: var(--text-xl);
      font-weight: 700;
      margin-bottom: var(--space-sm);
    }

    .empty-state-text {
      color: var(--text-muted);
      max-width: 320px;
      margin-bottom: var(--space-lg);
    }

    /* =====================================================
       LOADING STATES
    ===================================================== */
    .skeleton {
      background: linear-gradient(
        90deg,
        var(--bg-tertiary) 0%,
        var(--bg-secondary) 50%,
        var(--bg-tertiary) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: var(--radius-sm);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-default);
      border-top-color: var(--brand-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 15, 26, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* =====================================================
       LOGIN PAGE
    ===================================================== */
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-lg);
      position: relative;
      z-index: 1;
    }

    .login-container {
      width: 100%;
      max-width: 440px;
    }

    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-xl);
    }

    .login-logo {
      text-align: center;
      margin-bottom: var(--space-2xl);
    }

    .login-logo-icon {
      width: 72px;
      height: 72px;
      background: var(--gradient-brand);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin: 0 auto var(--space-md);
      box-shadow: var(--shadow-glow);
    }
    
    .login-logo-img {
      max-width: 280px;
      height: auto;
      margin: 0 auto var(--space-md);
      display: block;
    }

    .login-title {
      font-size: var(--text-3xl);
      font-weight: 800;
      background: var(--gradient-brand);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-subtitle {
      color: var(--text-muted);
      margin-top: var(--space-xs);
    }

    .login-demo-info {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-top: var(--space-lg);
      font-size: var(--text-sm);
    }

    .login-demo-info code {
      font-family: var(--font-mono);
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      color: var(--brand-primary);
    }

    /* =====================================================
       APP LAYOUT
    ===================================================== */
    .app {
      display: none;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    .app.active {
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--bg-card);
      border-right: 1px solid var(--border-default);
      display: flex;
      flex-direction: column;
      position: fixed;
      left: 0;
      top: 0;
      z-index: var(--z-sticky);
      transition: all var(--transition-base);
      backdrop-filter: blur(20px);
    }

    .sidebar-header {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-light);
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .sidebar-logo {
      width: 44px;
      height: 44px;
      background: var(--gradient-brand);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: var(--shadow-glow);
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: var(--text-xl);
      font-weight: 800;
      background: var(--gradient-brand);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar-user {
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-tertiary);
      margin: var(--space-md);
      border-radius: var(--radius-md);
    }

    .sidebar-user-info {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .sidebar-user-avatar {
      width: 40px;
      height: 40px;
      background: var(--gradient-brand);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: var(--text-sm);
    }

    .sidebar-user-name {
      font-weight: 600;
      font-size: var(--text-sm);
    }

    .sidebar-user-role {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-md) 0;
    }

    .nav-section {
      margin-bottom: var(--space-xs);
    }

    .nav-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-lg);
      cursor: pointer;
      user-select: none;
      transition: all var(--transition-fast);
      border-radius: var(--radius-md);
      margin: 2px var(--space-sm);
    }

    .nav-section-header:hover {
      background: var(--bg-hover);
    }

    .nav-section-title {
      font-size: var(--text-xs);
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .nav-section-title .section-icon {
      font-size: 14px;
    }

    .nav-section-arrow {
      font-size: 12px;
      color: var(--text-muted);
      transition: transform var(--transition-base);
    }

    .nav-section.collapsed .nav-section-arrow {
      transform: rotate(-90deg);
    }

    .nav-section.collapsed .nav-section-header {
      background: transparent;
    }

    .nav-section-content {
      max-height: 500px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
      opacity: 1;
    }

    .nav-section.collapsed .nav-section-content {
      max-height: 0;
      opacity: 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-sm) var(--space-lg);
      padding-left: calc(var(--space-lg) + 12px);
      margin: 2px var(--space-sm);
      color: var(--text-secondary);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      font-size: var(--text-sm);
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--bg-active);
      color: var(--brand-primary);
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 20px;
      background: var(--brand-primary);
      border-radius: 0 2px 2px 0;
    }

    .nav-item-icon {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .nav-item-text {
      flex: 1;
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .nav-item-badge {
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--danger);
      color: white;
      font-size: 10px;
      font-weight: 700;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-item.highlight {
      border-left: 3px solid var(--brand-accent);
    }

    /* Indicateur section active */
    .nav-section.has-active .nav-section-title {
      color: var(--brand-primary);
    }

    .nav-section.has-active .nav-section-header {
      background: rgba(99, 102, 241, 0.05);
    }

    .sidebar-footer {
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--border-light);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: calc(100vw - var(--sidebar-width));
    }

    .top-bar {
      height: var(--header-height);
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-default);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-lg);
      position: sticky;
      top: 0;
      z-index: var(--z-sticky);
      backdrop-filter: blur(20px);
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }

    .menu-toggle {
      display: none;
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      border-radius: var(--radius-md);
    }

    .menu-toggle:hover {
      background: var(--bg-hover);
    }

    .search-box {
      position: relative;
      width: 320px;
    }

    .search-box input {
      width: 100%;
      padding: 10px 16px 10px 44px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: var(--text-sm);
      transition: all var(--transition-fast);
    }

    .search-box input:focus {
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      outline: none;
    }

    .search-box-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .top-bar-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      position: relative;
      transition: all var(--transition-fast);
    }

    .top-bar-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--brand-primary);
    }

    .notification-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: var(--danger);
      border-radius: 50%;
      border: 2px solid var(--bg-secondary);
    }

    /* Page Container */
    .page-container {
      flex: 1;
      padding: var(--space-lg);
      overflow: visible;
    }

    .page {
      display: none;
      animation: fadeIn var(--transition-base) ease-out;
    }

    .page.active {
      display: block;
    }

    #page-boncommande {
      overflow: visible;
    }

    #page-pipeline, #page-admin-pipeline {
      overflow-x: auto;
      padding-bottom: var(--space-lg);
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-xl);
      flex-wrap: wrap;
      gap: var(--space-md);
    }

    .page-title {
      font-size: var(--text-2xl);
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .page-actions {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    /* =====================================================
       DASHBOARD
    ===================================================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      position: relative;
      overflow: hidden;
      transition: all var(--transition-base);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--gradient-brand);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card.success::before { background: var(--gradient-success); }
    .stat-card.warning::before { background: var(--gradient-accent); }
    .stat-card.danger::before { background: var(--gradient-danger); }
    .stat-card.info::before { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }

    .stat-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-md);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .stat-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: var(--text-xs);
      font-weight: 600;
      padding: 4px 8px;
      border-radius: var(--radius-full);
    }

    .stat-trend.up {
      background: var(--success-light);
      color: var(--success);
    }

    .stat-trend.down {
      background: var(--danger-light);
      color: var(--danger);
    }

    .stat-value {
      font-size: var(--text-3xl);
      font-weight: 800;
      font-family: var(--font-mono);
      margin-bottom: var(--space-xs);
    }

    .stat-label {
      font-size: var(--text-sm);
      color: var(--text-muted);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--space-lg);
    }

    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
      padding: var(--space-md);
    }

    /* Recent Activity */
    .activity-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      gap: var(--space-md);
      padding: var(--space-md) 0;
      border-bottom: 1px solid var(--border-light);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      font-size: 16px;
      flex-shrink: 0;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-text {
      font-size: var(--text-sm);
      margin-bottom: 2px;
    }

    .activity-time {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    /* =====================================================
       PIPELINE / KANBAN
    ===================================================== */
    .pipeline-container {
      display: flex;
      gap: var(--space-md);
      overflow-x: auto;
      overflow-y: visible;
      padding-bottom: var(--space-md);
      min-height: 500px;
      width: 100%;
      -webkit-overflow-scrolling: touch;
    }
    
    .pipeline-container::-webkit-scrollbar {
      height: 8px;
    }
    
    .pipeline-container::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }
    
    .pipeline-container::-webkit-scrollbar-thumb {
      background: var(--border-default);
      border-radius: 4px;
    }
    
    .pipeline-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .pipeline-column {
      min-width: 280px;
      width: 280px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .pipeline-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .pipeline-title {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-weight: 700;
      font-size: var(--text-sm);
    }

    .pipeline-color {
      width: 12px;
      height: 12px;
      border-radius: var(--radius-sm);
    }

    .pipeline-count {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
    }

    .pipeline-amount {
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .pipeline-cards {
      flex: 1;
      padding: var(--space-sm);
      overflow-y: auto;
      min-height: 200px;
    }

    .pipeline-card {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      cursor: grab;
      transition: all var(--transition-fast);
    }

    .pipeline-card:hover {
      border-color: var(--brand-primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .pipeline-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .pipeline-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-sm);
    }

    .pipeline-card-title {
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--text-primary);
    }

    .pipeline-card-company {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-bottom: var(--space-sm);
    }

    .pipeline-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pipeline-card-amount {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--success);
    }

    .pipeline-card-date {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .pipeline-card-probability {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .probability-bar {
      width: 40px;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .probability-fill {
      height: 100%;
      background: var(--brand-primary);
      border-radius: var(--radius-full);
    }

    /* =====================================================
       DATA LISTS
    ===================================================== */
    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-md);
    }

    .list-filters {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 8px 32px 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-sm);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748B' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--brand-primary);
    }

    .tabs {
      display: flex;
      gap: var(--space-xs);
      background: var(--bg-tertiary);
      padding: var(--space-xs);
      border-radius: var(--radius-md);
    }

    .tab {
      padding: var(--space-sm) var(--space-md);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--bg-secondary);
      color: var(--brand-primary);
      box-shadow: var(--shadow-sm);
    }

    /* Category Filters */
    .category-filter {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      padding: 4px 10px;
      font-size: 11px;
      border-radius: var(--radius-full);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .category-filter:hover {
      background: var(--bg-secondary);
      border-color: var(--brand-primary);
      color: var(--brand-primary);
    }
    
    .category-filter.active {
      background: var(--brand-primary);
      border-color: var(--brand-primary);
      color: white;
    }

    /* =====================================================
       SYST√àME D'ALERTES
    ===================================================== */
    
    /* Centre de notifications (header) */
    .notification-center {
      position: relative;
    }
    
    .notification-trigger {
      position: relative;
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: var(--radius-md);
      transition: background 0.2s;
    }
    
    .notification-trigger:hover {
      background: var(--bg-tertiary);
    }
    
    .notification-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--danger);
      color: white;
      font-size: 10px;
      font-weight: 700;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }
    
    .notification-panel {
      position: absolute;
      top: 100%;
      right: 0;
      width: 400px;
      max-height: 500px;
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: 1000;
      display: none;
      overflow: hidden;
    }
    
    .notification-panel.open {
      display: block;
      animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .notification-panel-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-panel-header h4 {
      margin: 0;
      font-size: var(--text-base);
    }
    
    .notification-tabs {
      display: flex;
      gap: 4px;
      padding: 0 var(--space-md);
      border-bottom: 1px solid var(--border-light);
    }
    
    .notification-tab {
      padding: 8px 12px;
      font-size: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
    }
    
    .notification-tab.active {
      color: var(--brand-primary);
      border-bottom-color: var(--brand-primary);
    }
    
    .notification-list {
      max-height: 350px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .notification-item:hover {
      background: var(--bg-tertiary);
    }
    
    .notification-item.unread {
      background: rgba(37, 99, 235, 0.05);
      border-left: 3px solid var(--brand-primary);
    }
    
    .notification-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
    }
    
    .notification-item-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
    }
    
    .notification-item-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .notification-item-content {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    .notification-item-meta {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    
    .notification-panel-footer {
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border-light);
      text-align: center;
    }
    
    .notification-panel-footer a {
      font-size: 12px;
      color: var(--brand-primary);
      text-decoration: none;
    }
    
    /* Page Alertes - Layout */
    .alerts-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: var(--space-lg);
      align-items: start;
    }
    
    @media (max-width: 1200px) {
      .alerts-layout {
        grid-template-columns: 1fr;
      }
    }
    
    /* Filtres alertes */
    .alerts-filters {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
      margin-bottom: var(--space-lg);
    }
    
    .alert-filter-group {
      display: flex;
      gap: 4px;
    }
    
    .alert-filter-btn {
      padding: 6px 12px;
      font-size: 12px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .alert-filter-btn:hover {
      border-color: var(--brand-primary);
    }
    
    .alert-filter-btn.active {
      background: var(--brand-primary);
      border-color: var(--brand-primary);
      color: white;
    }
    
    /* Carte Alerte */
    .alert-card {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid var(--border-default);
    }
    
    .alert-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .alert-card.selected {
      border-color: var(--brand-primary);
      box-shadow: var(--shadow-md);
    }
    
    .alert-card.unread {
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.05) 0%, var(--bg-card) 100%);
    }
    
    /* Priorit√©s */
    .alert-card.priority-critical { border-left-color: #dc2626; }
    .alert-card.priority-high { border-left-color: #f59e0b; }
    .alert-card.priority-medium { border-left-color: #3b82f6; }
    .alert-card.priority-low { border-left-color: #6b7280; }
    
    .alert-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .alert-card-badges {
      display: flex;
      gap: 6px;
    }
    
    .alert-type-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }
    
    .alert-type-badge.type-information { background: #dbeafe; color: #1e40af; }
    .alert-type-badge.type-action_required { background: #fef3c7; color: #92400e; }
    .alert-type-badge.type-urgent { background: #fee2e2; color: #991b1b; }
    .alert-type-badge.type-validation { background: #d1fae5; color: #065f46; }
    
    .alert-priority-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }
    
    .alert-priority-badge.priority-critical { background: #fee2e2; color: #991b1b; }
    .alert-priority-badge.priority-high { background: #fef3c7; color: #92400e; }
    .alert-priority-badge.priority-medium { background: #dbeafe; color: #1e40af; }
    .alert-priority-badge.priority-low { background: #f3f4f6; color: #4b5563; }
    
    .alert-card-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .alert-card-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--text-primary);
    }
    
    .alert-card-excerpt {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
      margin-bottom: 8px;
    }
    
    .alert-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .alert-card-sender {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .alert-card-sender img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    
    .alert-status-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Panneau de d√©tail alerte */
    .alert-detail-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      position: sticky;
      top: 80px;
    }
    
    .alert-detail-header {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-light);
    }
    
    .alert-detail-meta {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }
    
    .alert-reference {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
    }
    
    .alert-detail-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: var(--space-sm);
    }
    
    .alert-detail-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    .alert-context-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: var(--space-sm);
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      font-size: 12px;
      color: var(--brand-primary);
      text-decoration: none;
    }
    
    .alert-context-link:hover {
      background: var(--bg-secondary);
    }
    
    /* Channels status */
    .alert-channels {
      display: flex;
      gap: var(--space-md);
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--border-light);
      background: var(--bg-tertiary);
    }
    
    .alert-channel {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .alert-channel.sent { color: var(--success); }
    .alert-channel.failed { color: var(--danger); }
    
    /* Thread / Discussion */
    .alert-thread {
      padding: var(--space-md) var(--space-lg);
      max-height: 300px;
      overflow-y: auto;
    }
    
    .alert-thread-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: var(--space-md);
      text-transform: uppercase;
    }
    
    .thread-message {
      padding: var(--space-sm);
      margin-bottom: var(--space-sm);
      border-radius: var(--radius-md);
      background: var(--bg-tertiary);
    }
    
    .thread-message.own {
      background: rgba(37, 99, 235, 0.1);
      margin-left: 20px;
    }
    
    .thread-message-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 11px;
    }
    
    .thread-message-author {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .thread-message-source {
      color: var(--text-muted);
    }
    
    .thread-message-time {
      color: var(--text-muted);
      margin-left: auto;
    }
    
    .thread-message-content {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    /* Reply input */
    .alert-reply {
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: var(--space-sm);
    }
    
    .alert-reply textarea {
      flex: 1;
      min-height: 60px;
      resize: none;
    }
    
    /* Actions panel */
    .alert-actions-panel {
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    /* =====================================================
       BON DE COMMANDE
    ===================================================== */
    .bc-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: var(--space-lg);
      align-items: start;
    }

    @media (max-width: 1200px) {
      .bc-layout {
        grid-template-columns: 1fr;
      }
    }

    .bc-form-section {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-lg);
      overflow: hidden;
    }

    .bc-form-header {
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-weight: 700;
      font-size: var(--text-base);
    }

    .bc-form-body {
      padding: var(--space-lg);
    }

    .bc-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
    }

    .bc-form-grid .span-2 {
      grid-column: span 2;
    }

    @media (max-width: 600px) {
      .bc-form-grid .span-2 {
        grid-column: span 1;
      }
    }

    /* Products Table */
    .bc-products-table {
      width: 100%;
      margin-top: var(--space-md);
    }

    .bc-product-row {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      border: 1px solid var(--border-light);
      transition: all var(--transition-fast);
    }

    .bc-product-row:hover {
      border-color: var(--brand-accent);
    }

    .bc-product-main {
      display: grid;
      grid-template-columns: 2fr 80px 120px 120px 50px;
      gap: var(--space-md);
      align-items: center;
    }

    .bc-product-characteristics {
      display: flex;
      align-items: flex-start;
      gap: var(--space-sm);
      padding-top: var(--space-xs);
      border-top: 1px dashed var(--border-light);
    }

    .bc-product-characteristics label {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
      padding-top: 8px;
    }

    .bc-product-characteristics textarea {
      flex: 1;
      font-size: 12px;
      padding: 8px;
      min-height: 36px;
      resize: vertical;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-style: italic;
    }

    .bc-product-characteristics textarea:focus {
      border-color: var(--brand-primary);
      outline: none;
    }

    @media (max-width: 768px) {
      .bc-product-main {
        grid-template-columns: 1fr;
        gap: var(--space-sm);
      }
    }

    .bc-product-row .form-control {
      background: var(--bg-secondary);
    }

    .bc-price-display {
      font-family: var(--font-mono);
      font-weight: 600;
      text-align: right;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-default);
    }

    .bc-remove-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .bc-remove-btn:hover {
      background: var(--danger);
      color: white;
    }

    /* Summary Panel */
    .bc-summary {
      position: -webkit-sticky;
      position: sticky;
      top: 80px;
      align-self: start;
      z-index: 10;
    }

    .bc-summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .bc-summary-header {
      padding: var(--space-md) var(--space-lg);
      background: var(--gradient-brand);
      color: white;
      font-weight: 700;
    }

    .bc-summary-body {
      padding: var(--space-lg);
    }

    .bc-summary-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
    }

    .bc-summary-stat {
      text-align: center;
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .bc-summary-stat-value {
      font-size: var(--text-xl);
      font-weight: 800;
      font-family: var(--font-mono);
      color: var(--brand-primary);
    }

    .bc-summary-stat-label {
      font-size: var(--text-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .bc-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) 0;
      border-bottom: 1px solid var(--border-light);
    }

    .bc-summary-row:last-child {
      border-bottom: none;
    }

    .bc-summary-row .label {
      color: var(--text-muted);
      font-weight: 500;
    }

    .bc-summary-row .value {
      font-family: var(--font-mono);
      font-weight: 600;
    }

    .bc-summary-total {
      background: var(--gradient-accent);
      margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1);
      padding: var(--space-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .bc-summary-total .label {
      font-weight: 700;
      font-size: var(--text-lg);
    }

    .bc-summary-total .value {
      font-family: var(--font-mono);
      font-weight: 800;
      font-size: var(--text-2xl);
    }

    /* File Upload */
    .bc-file-zone {
      border: 2px dashed var(--border-default);
      border-radius: var(--radius-md);
      padding: var(--space-xl);
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      background: var(--bg-tertiary);
    }

    .bc-file-zone:hover,
    .bc-file-zone.dragover {
      border-color: var(--brand-primary);
      background: var(--bg-hover);
    }

    .bc-file-zone-icon {
      font-size: 40px;
      margin-bottom: var(--space-md);
    }

    .bc-file-zone-text {
      color: var(--text-muted);
      font-size: var(--text-sm);
    }

    .bc-file-list {
      margin-top: var(--space-md);
    }

    .bc-file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
    }

    /* Signature */
    .bc-signature-zone {
      border: 2px dashed var(--brand-accent);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      background: var(--bg-tertiary);
    }

    .bc-signature-info {
      text-align: center;
      padding: var(--space-md);
      background: rgba(245, 158, 11, 0.1);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
    }

    .bc-signature-info h4 {
      color: var(--brand-accent);
      margin-bottom: var(--space-xs);
    }

    .bc-signature-canvas {
      width: 100%;
      height: 200px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      cursor: crosshair;
      touch-action: none;
    }

    /* =====================================================
       MESSAGERIE
    ===================================================== */
    .messaging-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: var(--space-lg);
      height: calc(100vh - var(--header-height) - var(--space-lg) * 3);
    }

    @media (max-width: 900px) {
      .messaging-layout {
        grid-template-columns: 1fr;
      }
    }

    .conversation-list {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .conversation-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      transition: background var(--transition-fast);
    }

    .conversation-item:hover {
      background: var(--bg-hover);
    }

    .conversation-item.active {
      background: var(--bg-active);
    }

    .conversation-item.unread {
      background: rgba(99, 102, 241, 0.05);
    }

    .conversation-avatar {
      width: 44px;
      height: 44px;
      background: var(--gradient-brand);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .conversation-info {
      flex: 1;
      min-width: 0;
    }

    .conversation-name {
      font-weight: 600;
      font-size: var(--text-sm);
      margin-bottom: 2px;
    }

    .conversation-preview {
      font-size: var(--text-xs);
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-meta {
      text-align: right;
    }

    .conversation-time {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .conversation-unread {
      width: 8px;
      height: 8px;
      background: var(--brand-primary);
      border-radius: 50%;
      margin-top: var(--space-xs);
      margin-left: auto;
    }

    .chat-container {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .chat-message {
      max-width: 70%;
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
    }

    .chat-message.sent {
      align-self: flex-end;
      background: var(--brand-primary);
      color: white;
      border-bottom-right-radius: var(--radius-sm);
    }

    .chat-message.received {
      align-self: flex-start;
      background: var(--bg-tertiary);
      border-bottom-left-radius: var(--radius-sm);
    }

    .chat-message-time {
      font-size: var(--text-xs);
      opacity: 0.7;
      margin-top: var(--space-xs);
      text-align: right;
    }

    .chat-input {
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: var(--space-sm);
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: var(--text-sm);
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--brand-primary);
    }

    /* =====================================================
       SETTINGS
    ===================================================== */
    .settings-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: var(--space-lg);
    }

    @media (max-width: 900px) {
      .settings-layout {
        grid-template-columns: 1fr;
      }
    }

    .settings-nav {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: var(--space-sm);
      height: fit-content;
    }

    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--text-secondary);
      font-size: var(--text-sm);
      transition: all var(--transition-fast);
    }

    .settings-nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .settings-nav-item.active {
      background: var(--bg-active);
      color: var(--brand-primary);
    }

    .settings-content {
      background: var(--bg-card);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
    }

    .settings-section {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-light);
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-section-title {
      font-size: var(--text-lg);
      font-weight: 700;
      margin-bottom: var(--space-lg);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .settings-grid {
      display: grid;
      gap: var(--space-md);
    }

    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .settings-item-info {
      flex: 1;
    }

    .settings-item-label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .settings-item-desc {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    /* =====================================================
       RESPONSIVE
    ===================================================== */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
        box-shadow: var(--shadow-xl);
      }

      .main-content {
        margin-left: 0;
      }

      .menu-toggle {
        display: flex;
      }

      .search-box {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .modal {
        max-width: 100%;
        margin: var(--space-md);
        border-radius: var(--radius-lg);
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .page-actions {
        width: 100%;
      }

      .page-actions .btn {
        flex: 1;
      }
    }

    /* Admin Only Elements */
    .admin-only {
      display: none;
    }

    body.is-admin .admin-only {
      display: block;
    }

    /* Commercial Only Elements */
    .commercial-only {
      display: flex;
    }

    body.is-admin .commercial-only {
      display: none !important;
    }

    /* Pack Styles */
    .pack-card {
      background: var(--bg-card);
      border: 2px solid var(--brand-primary);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      position: relative;
      overflow: hidden;
    }

    .pack-card::before {
      content: 'PACK';
      position: absolute;
      top: 12px;
      right: -30px;
      background: var(--gradient-brand);
      color: white;
      padding: 4px 40px;
      font-size: 10px;
      font-weight: 700;
      transform: rotate(45deg);
    }

    .pack-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-md);
    }

    .pack-title {
      font-size: var(--text-xl);
      font-weight: 800;
    }

    .pack-price {
      text-align: right;
    }

    .pack-price-current {
      font-size: var(--text-2xl);
      font-weight: 800;
      color: var(--success);
      font-family: var(--font-mono);
    }

    .pack-price-regular {
      font-size: var(--text-sm);
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .pack-savings {
      display: inline-block;
      background: var(--success-light);
      color: var(--success);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
      margin-top: 4px;
    }

    .pack-description {
      color: var(--text-muted);
      margin-bottom: var(--space-md);
    }

    .pack-items {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: var(--space-md);
    }

    .pack-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-light);
      font-size: var(--text-sm);
    }

    .pack-item:last-child {
      border-bottom: none;
    }

    .pack-item-name {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .pack-item-qty {
      background: var(--brand-primary);
      color: white;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 600;
    }

    .packs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }

    /* =====================================================
       MODULE ACTIONS - CALENDRIER
    ===================================================== */
    
    .calendar-layout {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: var(--space-lg);
    }
    
    @media (max-width: 1024px) {
      .calendar-layout {
        grid-template-columns: 1fr;
      }
      .calendar-sidebar {
        order: -1;
      }
    }
    
    .calendar-main {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      border: 1px solid var(--border-default);
    }
    
    .calendar-header-month {
      text-align: center;
      margin-bottom: var(--space-lg);
    }
    
    .calendar-header-month h2 {
      font-size: var(--text-2xl);
      color: var(--brand-primary);
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: var(--space-sm);
    }
    
    .calendar-day-header {
      text-align: center;
      padding: var(--space-sm);
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--text-secondary);
      text-transform: uppercase;
    }
    
    .calendar-day-header.weekend {
      color: var(--danger);
    }
    
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    
    .calendar-day {
      min-height: 100px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      padding: var(--space-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid transparent;
    }
    
    .calendar-day:hover {
      background: var(--bg-hover);
      border-color: var(--brand-primary);
    }
    
    .calendar-day.other-month {
      opacity: 0.4;
    }
    
    .calendar-day.today {
      background: rgba(43, 94, 167, 0.2);
      border-color: var(--brand-primary);
    }
    
    .calendar-day-number {
      font-weight: 600;
      font-size: var(--text-sm);
      margin-bottom: var(--space-xs);
    }
    
    .calendar-day.today .calendar-day-number {
      background: var(--brand-primary);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .calendar-event {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    
    .calendar-event.rdv {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border-left: 2px solid var(--success);
    }
    
    .calendar-event.appel {
      background: rgba(43, 94, 167, 0.2);
      color: var(--brand-primary);
      border-left: 2px solid var(--brand-primary);
    }
    
    .calendar-event.tache {
      background: rgba(245, 166, 35, 0.2);
      color: var(--warning);
      border-left: 2px solid var(--warning);
    }
    
    .calendar-event.email {
      background: rgba(139, 92, 246, 0.2);
      color: #8B5CF6;
      border-left: 2px solid #8B5CF6;
    }
    
    .calendar-sidebar .card {
      background: var(--bg-card);
    }
    
    .event-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-sm);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-sm);
      background: var(--bg-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .event-item:hover {
      background: var(--bg-hover);
    }
    
    .event-item-icon {
      font-size: 20px;
    }
    
    .event-item-content {
      flex: 1;
      min-width: 0;
    }
    
    .event-item-title {
      font-weight: 500;
      font-size: var(--text-sm);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .event-item-meta {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }
    
    /* =====================================================
       MODULE ACTIONS - TACHES
    ===================================================== */
    
    .taches-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      padding: var(--space-md);
    }
    
    .tache-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--text-muted);
      transition: all var(--transition-fast);
    }
    
    .tache-item:hover {
      background: var(--bg-hover);
    }
    
    .tache-item.priorite-haute {
      border-left-color: var(--danger);
    }
    
    .tache-item.priorite-urgente {
      border-left-color: #DC2626;
      background: rgba(239, 68, 68, 0.05);
    }
    
    .tache-item.priorite-normale {
      border-left-color: var(--warning);
    }
    
    .tache-item.priorite-basse {
      border-left-color: var(--success);
    }
    
    .tache-item.terminee {
      opacity: 0.6;
      border-left-color: var(--text-muted);
    }
    
    .tache-item.terminee .tache-titre {
      text-decoration: line-through;
    }
    
    .tache-checkbox {
      width: 22px;
      height: 22px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border-default);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }
    
    .tache-checkbox:hover {
      border-color: var(--brand-primary);
    }
    
    .tache-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    
    .tache-content {
      flex: 1;
      min-width: 0;
    }
    
    .tache-titre {
      font-weight: 500;
      margin-bottom: var(--space-xs);
    }
    
    .tache-meta {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: var(--text-xs);
      color: var(--text-muted);
    }
    
    .tache-echeance {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .tache-echeance.en-retard {
      color: var(--danger);
    }
    
    .tache-actions {
      display: flex;
      gap: var(--space-xs);
    }

    /* Print Styles */
    @media print {
      .sidebar,
      .top-bar,
      .page-actions,
      .modal-overlay {
        display: none !important;
      }

      .main-content {
        margin-left: 0;
      }

      .page {
        padding: 0;
      }
    }
  
    /* Styles pour pipeline admin vide */
    .pipeline-column-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--text-muted);
      font-size: 12px;
    }

    </style>
</head>
<body>

<!-- =====================================================
     LOGIN PAGE
===================================================== -->
<div class="login-page" id="loginPage">
  <div class="login-container">
    <div class="login-card animate-slide-up">
      <div class="login-logo">
        <img src="data:image/webp;base64,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" alt="DesClick" class="login-logo-img" id="loginLogoImg" onerror="this.style.display='none'">
        <h1 class="login-title">DesClick <span style="color: var(--brand-accent);">CRM</span></h1>
      </div>
      
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label class="form-label">Identifiant</label>
          <input type="text" class="form-control" id="loginUsername" placeholder="Votre identifiant" required autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label">Mot de passe</label>
          <input type="password" class="form-control" id="loginPassword" placeholder="Votre mot de passe" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
          Se connecter
        </button>
      </form>
      
      <div class="login-demo-info">
        <p><strong>Comptes de d√©monstration :</strong></p>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button type="button" class="btn btn-sm" style="flex: 1;" onclick="quickLogin('admin', 'admin123')">
            üë§ Admin
          </button>
          <button type="button" class="btn btn-sm" style="flex: 1;" onclick="quickLogin('commercial', 'demo123')">
            üíº Commercial
          </button>
        </div>
        <p style="margin-top: 15px; font-size: 11px; color: var(--text-muted);">
          <a href="#" onclick="resetLocalStorage()" style="color: var(--danger);">üîÑ R√©initialiser les donn√©es</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- =====================================================
     MAIN APPLICATION
===================================================== -->
<div class="app" id="appContainer">
  
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="sidebar-logo" style="background: var(--brand-accent); color: white;">D</div>
        <span class="sidebar-title">DesClick <span style="color: var(--brand-accent);">CRM</span></span>
      </div>
    </div>
    
    <div class="sidebar-user">
      <div class="sidebar-user-info">
        <div class="sidebar-user-avatar" id="userAvatar">AD</div>
        <div>
          <div class="sidebar-user-name" id="userName">-</div>
          <div class="sidebar-user-role" id="userRole">-</div>
        </div>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <!-- Principal - toujours visible -->
      <div class="nav-section" data-section="principal">
        <div class="nav-section-header" onclick="toggleNavSection(this)">
          <div class="nav-section-title">
            <span class="section-icon">üìà</span>
            Principal
          </div>
          <span class="nav-section-arrow">‚ñº</span>
        </div>
        <div class="nav-section-content">
          <div class="nav-item active" onclick="showPage('dashboard')">
            <span class="nav-item-icon">üìä</span>
            <span class="nav-item-text">Tableau de bord</span>
          </div>
        </div>
      </div>
      
      <!-- CRM -->
      <div class="nav-section" data-section="crm">
        <div class="nav-section-header" onclick="toggleNavSection(this)">
          <div class="nav-section-title">
            <span class="section-icon">üè¢</span>
            CRM
          </div>
          <span class="nav-section-arrow">‚ñº</span>
        </div>
        <div class="nav-section-content">
          <div class="nav-item" onclick="showPage('entreprises')">
            <span class="nav-item-icon">üè™</span>
            <span class="nav-item-text">Entreprises</span>
          </div>
          <div class="nav-item" onclick="showPage('contacts')">
            <span class="nav-item-icon">üë•</span>
            <span class="nav-item-text">Contacts</span>
          </div>
          <div class="nav-item" onclick="showPage('pipeline')">
            <span class="nav-item-icon">üéØ</span>
            <span class="nav-item-text">Pipeline</span>
          </div>
          <div class="nav-item" onclick="showPage('opportunites')">
            <span class="nav-item-icon">üí∞</span>
            <span class="nav-item-text">Opportunit√©s</span>
          </div>
        </div>
      </div>
      
      <!-- Actions Commerciales -->
      <div class="nav-section" data-section="actions">
        <div class="nav-section-header" onclick="toggleNavSection(this)">
          <div class="nav-section-title">
            <span class="section-icon">üìÖ</span>
            Actions
          </div>
          <span class="nav-section-arrow">‚ñº</span>
        </div>
        <div class="nav-section-content">
          <div class="nav-item" onclick="showPage('calendrier')">
            <span class="nav-item-icon">üìÜ</span>
            <span class="nav-item-text">Calendrier</span>
          </div>
          <div class="nav-item" onclick="showPage('emails')">
            <span class="nav-item-icon">üìß</span>
            <span class="nav-item-text">Emails</span>
          </div>
          <div class="nav-item" onclick="showPage('rdv')">
            <span class="nav-item-icon">ü§ù</span>
            <span class="nav-item-text">Rendez-vous</span>
          </div>
          <div class="nav-item" onclick="showPage('appels')">
            <span class="nav-item-icon">üìû</span>
            <span class="nav-item-text">Appels</span>
          </div>
          <div class="nav-item" onclick="showPage('taches')">
            <span class="nav-item-icon">‚úÖ</span>
            <span class="nav-item-text">T√¢ches</span>
          </div>
        </div>
      </div>
      
      <!-- Commercial -->
      <div class="nav-section" data-section="commercial">
        <div class="nav-section-header" onclick="toggleNavSection(this)">
          <div class="nav-section-title">
            <span class="section-icon">üì¶</span>
            Commercial
          </div>
          <span class="nav-section-arrow">‚ñº</span>
        </div>
        <div class="nav-section-content">
          <div class="nav-item" onclick="showPage('produits')">
            <span class="nav-item-icon">üõí</span>
            <span class="nav-item-text">Produits & Services</span>
          </div>
          <div class="nav-item commercial-only highlight" onclick="showPage('boncommande')">
            <span class="nav-item-icon">üìù</span>
            <span class="nav-item-text">Bon de Commande</span>
          </div>
          <div class="nav-item" onclick="showPage('commandes')">
            <span class="nav-item-icon">üìã</span>
            <span class="nav-item-text">Historique BC</span>
          </div>
        </div>
      </div>
      
      <!-- Communication -->
      <div class="nav-section" data-section="communication">
        <div class="nav-section-header" onclick="toggleNavSection(this)">
          <div class="nav-section-title">
            <span class="section-icon">üí¨</span>
            Communication
          </div>
          <span class="nav-section-arrow">‚ñº</span>
        </div>
        <div class="nav-section-content">
          <div class="nav-item" onclick="showPage('messagerie')">
            <span class="nav-item-icon">‚úâÔ∏è</span>
            <span class="nav-item-text">Messagerie</span>
            <span class="nav-item-badge" id="unreadMessages" style="display: none;">0</span>
          </div>
          <div class="nav-item" onclick="showPage('alertes')">
            <span class="nav-item-icon">üîî</span>
            <span class="nav-item-text">Alertes</span>
            <span class="nav-item-badge" id="unreadAlerts" style="display: none;">0</span>
          </div>
        </div>
      </div>
      
      <!-- Administration (admin only) -->
      <div class="nav-section admin-only" data-section="admin">
        <div class="nav-section-header" onclick="toggleNavSection(this)">
          <div class="nav-section-title">
            <span class="section-icon">‚öôÔ∏è</span>
            Administration
          </div>
          <span class="nav-section-arrow">‚ñº</span>
        </div>
        <div class="nav-section-content">
          <div class="nav-item" onclick="showPage('equipe')">
            <span class="nav-item-icon">üëî</span>
            <span class="nav-item-text">√âquipe commerciale</span>
          </div>
          <div class="nav-item" onclick="showPage('consolidation')">
            <span class="nav-item-icon">üìä</span>
            <span class="nav-item-text">Consolidation globale</span>
          </div>
          <div class="nav-item" onclick="showPage('admin-pipeline')">
            <span class="nav-item-icon">üéØ</span>
            <span class="nav-item-text">Pipeline consolid√©</span>
          </div>
          <div class="nav-item" onclick="showPage('admin-entreprises')">
            <span class="nav-item-icon">üè¢</span>
            <span class="nav-item-text">Toutes les entreprises</span>
          </div>
          <div class="nav-item" onclick="showPage('admin-contacts')">
            <span class="nav-item-icon">üë•</span>
            <span class="nav-item-text">Tous les contacts</span>
          </div>
          <div class="nav-item" onclick="showPage('admin-opportunites')">
            <span class="nav-item-icon">üí∞</span>
            <span class="nav-item-text">Toutes les opportunit√©s</span>
          </div>
          <div class="nav-item" onclick="showPage('admin-commandes')">
            <span class="nav-item-icon">üìù</span>
            <span class="nav-item-text">Tous les BC</span>
          </div>
        </div>
      </div>
      
      <!-- Syst√®me -->
      <div class="nav-section" data-section="systeme">
        <div class="nav-section-header" onclick="toggleNavSection(this)">
          <div class="nav-section-title">
            <span class="section-icon">üîß</span>
            Syst√®me
          </div>
          <span class="nav-section-arrow">‚ñº</span>
        </div>
        <div class="nav-section-content">
          <div class="nav-item" onclick="showPage('parametres')">
            <span class="nav-item-icon">‚öôÔ∏è</span>
            <span class="nav-item-text">Param√®tres</span>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="sidebar-footer">
      <button class="btn btn-ghost" style="width: 100%; justify-content: flex-start;" onclick="handleLogout()">
        <span>üö™</span>
        <span>D√©connexion</span>
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <header class="top-bar">
      <div class="top-bar-left">
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
        <div class="search-box">
          <span class="search-box-icon">üîç</span>
          <input type="text" placeholder="Rechercher..." id="globalSearch" onkeyup="handleGlobalSearch(event)">
        </div>
      </div>
      <div class="top-bar-right">
        <div class="sync-menu-container" style="position: relative;">
          <button class="top-bar-btn" onclick="toggleSyncMenu()" title="Synchronisation Google Sheets" id="syncBtn">
            üîÑ
          </button>
          <div id="syncMenu" style="display: none; position: absolute; top: 100%; right: 0; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; min-width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000;">
            <button class="btn btn-primary btn-sm" onclick="syncFromGoogleSheets(); toggleSyncMenu();" style="width: 100%; margin-bottom: 8px;">
              üîÑ Synchroniser maintenant
            </button>
            <button class="btn btn-sm" onclick="testAPI(); toggleSyncMenu();" style="width: 100%; margin-bottom: 8px;">
              üß™ Tester la connexion API
            </button>
            <div style="font-size: 11px; color: var(--text-muted); padding: 8px 0; border-top: 1px solid var(--border-color);">
              <div>Mode: <strong id="apiModeIndicator">-</strong></div>
              <div>Entreprises: <span id="syncCountEntr">-</span></div>
              <div>Opportunit√©s: <span id="syncCountOpp">-</span></div>
            </div>
          </div>
        </div>
        <button class="top-bar-btn" onclick="toggleTheme()" title="Changer le th√®me">
          <span id="themeIcon">üåô</span>
        </button>
        
        <!-- Centre de Notifications -->
        <div class="notification-center">
          <button class="notification-trigger" onclick="toggleNotificationPanel()" title="Notifications">
            üîî
            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
          </button>
          <div class="notification-panel" id="notificationPanel">
            <div class="notification-panel-header">
              <h4>üîî Notifications</h4>
              <button class="btn btn-sm" onclick="markAllAlertsRead()">Tout marquer lu</button>
            </div>
            <div class="notification-tabs">
              <button class="notification-tab active" onclick="filterNotifications('all', this)">Toutes</button>
              <button class="notification-tab" onclick="filterNotifications('unread', this)">Non lues</button>
              <button class="notification-tab" onclick="filterNotifications('urgent', this)">Urgentes</button>
            </div>
            <div class="notification-list" id="notificationList">
              <!-- Notifications rendues par JS -->
            </div>
            <div class="notification-panel-footer">
              <a href="#" onclick="showPage('alertes'); toggleNotificationPanel();">Voir toutes les alertes ‚Üí</a>
            </div>
          </div>
        </div>
        
        <button class="top-bar-btn" onclick="openQuickActions()" title="Actions rapides">‚ö°</button>
      </div>
    </header>
    
    <div class="page-container">
      
      <!-- Dashboard Page -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <h1 class="page-title">üìà Tableau de bord</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportReport()">üì• Exporter</button>
            <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Actualiser</button>
          </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
          <!-- Stats will be rendered by JS -->
        </div>
        
        <div class="dashboard-grid">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üìä √âvolution du CA</h3>
              <select class="filter-select" id="chartPeriod" onchange="updateChart()">
                <option value="7">7 jours</option>
                <option value="30" selected>30 jours</option>
                <option value="90">90 jours</option>
              </select>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üïí Activit√© r√©cente</h3>
            </div>
            <div class="card-body">
              <div class="activity-list" id="activityList">
                <!-- Activities will be rendered by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Entreprises Page -->
      <div class="page" id="page-entreprises">
        <div class="page-header">
          <h1 class="page-title">üè¢ Entreprises</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportEntreprises()">üì• Exporter</button>
            <button class="btn btn-primary" onclick="openModal('entreprise')">+ Nouvelle entreprise</button>
          </div>
        </div>
        
        <div class="list-header">
          <div class="tabs" id="entreprisesTabs">
            <div class="tab active" onclick="filterEntreprises('all', this)">Toutes</div>
            <div class="tab" onclick="filterEntreprises('Prospect', this)">Prospects</div>
            <div class="tab" onclick="filterEntreprises('Client', this)">Clients</div>
            <div class="tab" onclick="filterEntreprises('Partenaire', this)">Partenaires</div>
          </div>
          <div class="list-filters">
            <input type="text" class="form-control" placeholder="Rechercher..." style="width: 200px;" id="searchEntreprises" oninput="renderEntreprises()">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Entreprise</th>
                  <th>Type</th>
                  <th>Contact</th>
                  <th>T√©l√©phone</th>
                  <th>Ville</th>
                  <th>Commercial</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="entreprisesTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Contacts Page -->
      <div class="page" id="page-contacts">
        <div class="page-header">
          <h1 class="page-title">üë• Contacts</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportContacts()">üì• Exporter</button>
            <button class="btn btn-primary" onclick="openModal('contact')">+ Nouveau contact</button>
          </div>
        </div>
        
        <div class="list-header">
          <div class="list-filters">
            <select class="filter-select" id="filterContactType" onchange="renderContacts()">
              <option value="">Tous les types</option>
              <option value="prospect">Prospects</option>
              <option value="client">Clients</option>
              <option value="autre">Autres</option>
            </select>
            <select class="filter-select" id="filterContactEntreprise" onchange="renderContacts()">
              <option value="">Toutes les entreprises</option>
            </select>
            <input type="text" class="form-control" placeholder="Rechercher..." style="width: 200px;" id="searchContacts" oninput="renderContacts()">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>ID Ent.</th>
                  <th>Entreprise</th>
                  <th>ID Contact</th>
                  <th>Nom</th>
                  <th>Pr√©nom</th>
                  <th>E-mail</th>
                  <th>N¬∞ Mobile</th>
                  <th>Fonction</th>
                  <th>Type</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="contactsTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Pipeline Page -->
      <div class="page" id="page-pipeline">
        <div class="page-header">
          <h1 class="page-title">üéØ Pipeline Commercial</h1>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openModal('opportunite')">+ Nouvelle opportunit√©</button>
          </div>
        </div>
        
        <div style="width: 100%; overflow-x: auto; padding-bottom: 20px;">
          <div class="pipeline-container" id="pipelineContainer" style="min-width: max-content;">
            <!-- Pipeline columns will be rendered by JS -->
          </div>
        </div>
      </div>
      
      <!-- Opportunit√©s Page -->
      <div class="page" id="page-opportunites">
        <div class="page-header">
          <h1 class="page-title">üí∞ Opportunit√©s</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportOpportunites()">üì• Exporter</button>
            <button class="btn btn-primary" onclick="openModal('opportunite')">+ Nouvelle opportunit√©</button>
          </div>
        </div>
        
        <div class="list-header">
          <div class="list-filters">
            <select class="filter-select" id="filterOppState" onchange="renderOpportunites()">
              <option value="">Tous les √©tats</option>
              <option value="ouvert">Ouvert</option>
              <option value="encours">En cours</option>
              <option value="remporte">Remport√©</option>
              <option value="perdu">Perdu</option>
              <option value="abandonne">Abandonn√©</option>
            </select>
            <select class="filter-select" id="filterOppStage" onchange="renderOpportunites()">
              <option value="">Toutes les √©tapes</option>
            </select>
            <input type="text" class="form-control" placeholder="Rechercher..." style="width: 200px;" id="searchOpportunites" oninput="renderOpportunites()">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container" style="overflow-x: auto;">
            <table class="table" style="min-width: 1400px;">
              <thead>
                <tr>
                  <th>ID Opp.</th>
                  <th>Nom opportunit√©</th>
                  <th>ID Ent.</th>
                  <th>Entreprise</th>
                  <th>Ville</th>
                  <th>Interlocuteur</th>
                  <th>√âtape</th>
                  <th>Montant</th>
                  <th>Date cr√©ation</th>
                  <th>Date cl√¥ture</th>
                  <th>% R√©ussite</th>
                  <th>√âtat</th>
                  <th>Priorit√©</th>
                  <th>Source</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="opportunitesTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Produits Page -->
      <div class="page" id="page-produits">
        <div class="page-header">
          <h1 class="page-title">üì¶ Produits, Services & Packs</h1>
          <div class="page-actions">
            <button class="btn admin-only" onclick="exportProduitsExcel()">üì• Exporter Excel</button>
            <button class="btn admin-only" onclick="document.getElementById('importExcelFile').click()">üì§ Importer Excel</button>
            <input type="file" id="importExcelFile" accept=".xlsx,.xls" style="display:none;" onchange="importProduitsExcel(event)">
            <button class="btn admin-only" onclick="openModal('pack')">üì¶ Nouveau Pack</button>
            <button class="btn btn-primary admin-only" onclick="openModal('produit')">+ Nouveau produit</button>
          </div>
        </div>
        
        <!-- Packs Section -->
        <div class="card" style="margin-bottom: var(--space-xl);">
          <div class="card-header">
            <h3 class="card-title">üì¶ Packs Commerciaux</h3>
          </div>
          <div class="card-body">
            <div class="packs-grid" id="packsGrid">
              <!-- Packs will be rendered by JS -->
            </div>
          </div>
        </div>
        
        <!-- Products/Services Section -->
        <div class="list-header" style="flex-wrap: wrap; gap: var(--space-sm);">
          <div class="tabs" id="produitsTabs">
            <div class="tab active" onclick="filterProduits('all', this)">Tous</div>
            <div class="tab" onclick="filterProduits('Produit', this)">Produits</div>
            <div class="tab" onclick="filterProduits('Service', this)">Services</div>
          </div>
          <div class="category-filters" id="categoryFilters" style="display: flex; gap: 6px; flex-wrap: wrap; margin-left: auto;">
            <button class="btn btn-sm category-filter active" data-category="all" onclick="filterByCategory('all', this)">üìã Toutes</button>
            <button class="btn btn-sm category-filter" data-category="Mat√©riel" onclick="filterByCategory('Mat√©riel', this)">üíª Mat√©riel</button>
            <button class="btn btn-sm category-filter" data-category="Logiciel" onclick="filterByCategory('Logiciel', this)">üìÄ Logiciel</button>
            <button class="btn btn-sm category-filter" data-category="IoT" onclick="filterByCategory('IoT', this)">üì° IoT</button>
            <button class="btn btn-sm category-filter" data-category="Service" onclick="filterByCategory('Service', this)">üîß Service</button>
            <button class="btn btn-sm category-filter" data-category="Formation" onclick="filterByCategory('Formation', this)">üéì Formation</button>
            <button class="btn btn-sm category-filter" data-category="Support" onclick="filterByCategory('Support', this)">üõ†Ô∏è Support</button>
            <button class="btn btn-sm category-filter" data-category="Consommables" onclick="filterByCategory('Consommables', this)">üì¶ Consommables</button>
            <button class="btn btn-sm category-filter" data-category="Connectique" onclick="filterByCategory('Connectique', this)">üîå Connectique</button>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>R√©f√©rence</th>
                  <th>Nom</th>
                  <th>Mod√®le</th>
                  <th>Cat√©gorie</th>
                  <th>Prix HT</th>
                  <th>TVA</th>
                  <th>Acc√®s</th>
                  <th>Statut</th>
                  <th class="admin-only">Actions</th>
                </tr>
              </thead>
              <tbody id="produitsTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Bon de Commande Page -->
      <div class="page" id="page-boncommande">
        <div class="page-header">
          <h1 class="page-title">üìù Bon de Commande</h1>
          <div class="page-actions">
            <button class="btn" onclick="openBCHistory()">üìö Historique</button>
            <button class="btn" onclick="resetBCForm()">üîÑ Nouveau</button>
          </div>
        </div>
        
        <form id="bcForm" onsubmit="previewBC(event)">
          <div class="bc-layout">
            <div class="bc-form-main">
              
              <!-- Informations g√©n√©rales -->
              <div class="bc-form-section">
                <div class="bc-form-header">üìã Informations g√©n√©rales</div>
                <div class="bc-form-body">
                  <div class="bc-form-grid">
                    <div class="form-group">
                      <label class="form-label">N¬∞ Commande</label>
                      <input type="text" class="form-control" id="bcNumber" readonly>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Date <span class="required">*</span></label>
                      <input type="date" class="form-control" id="bcDate" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Date installation</label>
                      <input type="date" class="form-control" id="bcInstallDate">
                    </div>
                    <div class="form-group span-2">
                      <label class="form-label">Client <span class="required">*</span></label>
                      <select class="form-control" id="bcClient" required onchange="fillBCClient()">
                        <option value="">-- S√©lectionner un client --</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Enseigne</label>
                      <input type="text" class="form-control" id="bcEnseigne" placeholder="Nom commercial">
                    </div>
                    <div class="form-group span-2">
                      <label class="form-label">Adresse</label>
                      <input type="text" class="form-control" id="bcAddress" placeholder="Adresse">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Code Postal</label>
                      <input type="text" class="form-control" id="bcCP" placeholder="00000">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Ville</label>
                      <input type="text" class="form-control" id="bcCity" placeholder="Ville">
                    </div>
                    <div class="form-group">
                      <label class="form-label">SIRET</label>
                      <input type="text" class="form-control" id="bcSiret" placeholder="XXX XXX XXX XXXXX">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Mode de r√®glement</label>
                      <select class="form-control" id="bcPayment" onchange="toggleEcheances()">
                        <option value="Ch√®que">Ch√®que</option>
                        <option value="Pr√©l√®vement">Pr√©l√®vement</option>
                        <option value="Resto Proxi">Resto Proxi</option>
                        <option value="Virement">Virement bancaire</option>
                        <option value="CB">CB</option>
                        <option value="Esp√®ces">Esp√®ces</option>
                      </select>
                    </div>
                    <div class="form-group" id="echeancesGroup" style="display: none;">
                      <label class="form-label">Nombre d'√©ch√©ances</label>
                      <select class="form-control" id="bcEcheances">
                        <option value="1">1 √©ch√©ance</option>
                        <option value="2">2 √©ch√©ances</option>
                        <option value="3">3 √©ch√©ances</option>
                        <option value="4">4 √©ch√©ances</option>
                        <option value="6">6 √©ch√©ances</option>
                        <option value="10">10 √©ch√©ances</option>
                        <option value="12">12 √©ch√©ances</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Signataire -->
              <div class="bc-form-section">
                <div class="bc-form-header">üë§ Signataire</div>
                <div class="bc-form-body">
                  <div class="bc-form-grid">
                    <div class="form-group">
                      <label class="form-label">Pr√©nom <span class="required">*</span></label>
                      <input type="text" class="form-control" id="bcSignerFirstName" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Nom <span class="required">*</span></label>
                      <input type="text" class="form-control" id="bcSignerLastName" required>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Fonction</label>
                      <select class="form-control" id="bcSignerTitle">
                        <option value="">-- S√©lectionner --</option>
                        <option value="G√©rant">G√©rant</option>
                        <option value="Directeur">Directeur</option>
                        <option value="Responsable">Responsable</option>
                        <option value="Propri√©taire">Propri√©taire</option>
                        <option value="Pr√©sident">Pr√©sident</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">T√©l√©phone</label>
                      <input type="tel" class="form-control" id="bcSignerPhone" placeholder="06 XX XX XX XX">
                    </div>
                    <div class="form-group span-2">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-control" id="bcSignerEmail" placeholder="email@exemple.com">
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Produits -->
              <div class="bc-form-section">
                <div class="bc-form-header">üõí Produits & Services</div>
                <div class="bc-form-body">
                  <div id="bcProductsContainer">
                    <!-- Product rows will be added by JS -->
                  </div>
                  <button type="button" class="btn btn-primary" onclick="addBCProductRow()" style="margin-top: var(--space-md);">
                    + Ajouter un produit
                  </button>
                </div>
              </div>
              
              <!-- Fichiers -->
              <div class="bc-form-section">
                <div class="bc-form-header">üìé Pi√®ces jointes</div>
                <div class="bc-form-body">
                  <div class="bc-file-zone" id="bcFileZone">
                    <input type="file" id="bcFileInput" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
                    <div class="bc-file-zone-icon">üìÅ</div>
                    <p class="bc-file-zone-text">Cliquez ou glissez-d√©posez vos fichiers ici</p>
                    <p class="bc-file-zone-text" style="font-size: 11px;">PDF, JPG, PNG (max 10 Mo)</p>
                  </div>
                  <div class="bc-file-list" id="bcFileList"></div>
                </div>
              </div>
              
              <!-- Observations g√©n√©rales (pied de bon de commande) -->
              <div class="bc-form-section">
                <div class="bc-form-header">üìã Observations g√©n√©rales</div>
                <div class="bc-form-body">
                  <textarea class="form-control" id="bcNotes" rows="3" placeholder="Conditions particuli√®res, d√©lais, remarques importantes..."></textarea>
                  <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px; display: block;">Ce texte appara√Ætra une seule fois en pied du document</small>
                </div>
              </div>
              
              <div style="display: flex; justify-content: flex-end; gap: var(--space-md);">
                <button type="button" class="btn" onclick="resetBCForm()">Annuler</button>
                <button type="submit" class="btn btn-success btn-lg">‚úì Valider et signer</button>
              </div>
            </div>
            
            <!-- Summary Panel -->
            <div class="bc-summary">
              <div class="bc-summary-card">
                <div class="bc-summary-header">üí∞ R√©capitulatif</div>
                <div class="bc-summary-body">
                  <div class="bc-summary-stats">
                    <div class="bc-summary-stat">
                      <div class="bc-summary-stat-value" id="bcStatProducts">0</div>
                      <div class="bc-summary-stat-label">Produits</div>
                    </div>
                    <div class="bc-summary-stat">
                      <div class="bc-summary-stat-value" id="bcStatQty">0</div>
                      <div class="bc-summary-stat-label">Quantit√©</div>
                    </div>
                    <div class="bc-summary-stat">
                      <div class="bc-summary-stat-value" id="bcStatFiles">0</div>
                      <div class="bc-summary-stat-label">Fichiers</div>
                    </div>
                  </div>
                  
                  <div class="bc-summary-row">
                    <span class="label">Total HT</span>
                    <span class="value" id="bcTotalHT">0,00 ‚Ç¨</span>
                  </div>
                  <div class="bc-summary-row">
                    <span class="label">TVA (20%)</span>
                    <span class="value" id="bcTotalTVA">0,00 ‚Ç¨</span>
                  </div>
                  
                  <div class="bc-summary-total">
                    <span class="label">TOTAL TTC</span>
                    <span class="value" id="bcTotalTTC">0,00 ‚Ç¨</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <!-- Messagerie Page -->
      <div class="page" id="page-messagerie">
        <div class="page-header">
          <h1 class="page-title">üí¨ Messagerie</h1>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openModal('message')">+ Nouveau message</button>
          </div>
        </div>
        
        <div class="messaging-layout">
          <div class="conversation-list">
            <div class="card-header">
              <h3 class="card-title" style="font-size: var(--text-base);">Conversations</h3>
            </div>
            <div id="conversationsList" style="flex: 1; overflow-y: auto;">
              <!-- Conversations will be rendered by JS -->
            </div>
          </div>
          
          <div class="chat-container" id="chatContainer">
            <div class="chat-header">
              <div id="chatHeaderInfo">
                <strong>S√©lectionnez une conversation</strong>
              </div>
            </div>
            <div class="chat-messages" id="chatMessages">
              <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <h3 class="empty-state-title">Aucune conversation</h3>
                <p class="empty-state-text">S√©lectionnez une conversation ou cr√©ez-en une nouvelle</p>
              </div>
            </div>
            <div class="chat-input">
              <input type="text" id="chatInput" placeholder="Tapez votre message..." onkeypress="handleChatKeypress(event)">
              <button class="btn btn-primary" onclick="sendChatMessage()">üì§</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Alertes Page -->
      <div class="page" id="page-alertes">
        <div class="page-header">
          <h1 class="page-title">üîî Centre d'Alertes</h1>
          <div class="page-actions">
            <button class="btn" onclick="markAllAlertsRead()">‚úì Tout marquer lu</button>
            <button class="btn btn-primary" onclick="openModal('alerte')">+ Nouvelle alerte</button>
          </div>
        </div>
        
        <!-- Statistiques alertes -->
        <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom: var(--space-lg);">
          <div class="stat-card">
            <div class="stat-value" id="statTotalAlerts">0</div>
            <div class="stat-label">Total alertes</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-value" id="statUnreadAlerts">0</div>
            <div class="stat-label">Non lues</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-value" id="statUrgentAlerts">0</div>
            <div class="stat-label">Urgentes</div>
          </div>
          <div class="stat-card info">
            <div class="stat-value" id="statPendingAlerts">0</div>
            <div class="stat-label">En attente</div>
          </div>
          <div class="stat-card success">
            <div class="stat-value" id="statResolvedAlerts">0</div>
            <div class="stat-label">R√©solues</div>
          </div>
        </div>
        
        <!-- Filtres -->
        <div class="alerts-filters">
          <div class="alert-filter-group">
            <span style="font-size: 12px; color: var(--text-muted); margin-right: 8px;">Type:</span>
            <button class="alert-filter-btn active" onclick="filterAlerts('type', 'all', this)">Tous</button>
            <button class="alert-filter-btn" onclick="filterAlerts('type', 'information', this)">‚ÑπÔ∏è Info</button>
            <button class="alert-filter-btn" onclick="filterAlerts('type', 'action_required', this)">‚ö° Action</button>
            <button class="alert-filter-btn" onclick="filterAlerts('type', 'urgent', this)">üö® Urgent</button>
            <button class="alert-filter-btn" onclick="filterAlerts('type', 'validation', this)">‚úÖ Validation</button>
          </div>
          <div class="alert-filter-group">
            <span style="font-size: 12px; color: var(--text-muted); margin-right: 8px;">Priorit√©:</span>
            <button class="alert-filter-btn active" onclick="filterAlerts('priority', 'all', this)">Toutes</button>
            <button class="alert-filter-btn" onclick="filterAlerts('priority', 'critical', this)">üî¥ Critique</button>
            <button class="alert-filter-btn" onclick="filterAlerts('priority', 'high', this)">üü† Haute</button>
            <button class="alert-filter-btn" onclick="filterAlerts('priority', 'medium', this)">üîµ Moyenne</button>
            <button class="alert-filter-btn" onclick="filterAlerts('priority', 'low', this)">‚ö™ Basse</button>
          </div>
          <div class="alert-filter-group">
            <span style="font-size: 12px; color: var(--text-muted); margin-right: 8px;">Statut:</span>
            <button class="alert-filter-btn active" onclick="filterAlerts('status', 'all', this)">Tous</button>
            <button class="alert-filter-btn" onclick="filterAlerts('status', 'sent', this)">üì§ Envoy√©e</button>
            <button class="alert-filter-btn" onclick="filterAlerts('status', 'read', this)">üëÅÔ∏è Lue</button>
            <button class="alert-filter-btn" onclick="filterAlerts('status', 'in_progress', this)">üîÑ En cours</button>
            <button class="alert-filter-btn" onclick="filterAlerts('status', 'resolved', this)">‚úÖ R√©solue</button>
          </div>
        </div>
        
        <!-- Layout principal -->
        <div class="alerts-layout">
          <!-- Liste des alertes -->
          <div class="alerts-list-container">
            <div id="alertsList">
              <!-- Alertes rendues par JS -->
            </div>
          </div>
          
          <!-- Panneau de d√©tail -->
          <div class="alert-detail-panel" id="alertDetailPanel" style="display: none;">
            <div class="alert-detail-header">
              <div class="alert-detail-meta">
                <span class="alert-reference" id="alertDetailRef">-</span>
                <span class="alert-type-badge" id="alertDetailType">-</span>
                <span class="alert-priority-badge" id="alertDetailPriority">-</span>
              </div>
              <h3 class="alert-detail-title" id="alertDetailTitle">-</h3>
              <p class="alert-detail-content" id="alertDetailContent">-</p>
              <a href="#" class="alert-context-link" id="alertDetailContext" style="display: none;">
                üìé <span id="alertDetailContextText">-</span>
              </a>
            </div>
            
            <!-- Statut des canaux -->
            <div class="alert-channels">
              <div class="alert-channel" id="channelCRM">üíª CRM: <span>-</span></div>
              <div class="alert-channel" id="channelEmail">üìß Email: <span>-</span></div>
              <div class="alert-channel" id="channelTeams">üí¨ Teams: <span>-</span></div>
            </div>
            
            <!-- Fil de discussion -->
            <div class="alert-thread">
              <div class="alert-thread-title">üí¨ Discussion</div>
              <div id="alertThreadMessages">
                <!-- Messages rendus par JS -->
              </div>
            </div>
            
            <!-- R√©pondre -->
            <div class="alert-reply">
              <textarea id="alertReplyInput" placeholder="Votre r√©ponse..."></textarea>
              <button class="btn btn-primary" onclick="sendAlertReply()">üì§</button>
            </div>
            
            <!-- Actions -->
            <div class="alert-actions-panel">
              <button class="btn btn-sm" id="btnAcknowledge" onclick="acknowledgeAlert()">‚úÖ Accuser r√©ception</button>
              <button class="btn btn-sm" id="btnInProgress" onclick="setAlertInProgress()">üîÑ En cours</button>
              <button class="btn btn-sm btn-success" id="btnResolve" onclick="resolveAlert()">‚úîÔ∏è R√©soudre</button>
              <button class="btn btn-sm btn-warning" id="btnEscalate" onclick="escalateAlert()">‚¨ÜÔ∏è Escalader</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- √âquipe Page (Admin) -->
      <div class="page" id="page-equipe">
        <div class="page-header">
          <h1 class="page-title">üëî Gestion de l'√©quipe</h1>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openModal('utilisateur')">+ Nouveau commercial</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon">üë•</div>
            </div>
            <div class="stat-value" id="statTotalUsers">0</div>
            <div class="stat-label">Commerciaux actifs</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header">
              <div class="stat-icon">üí∞</div>
            </div>
            <div class="stat-value" id="statTotalTeamCA">0 ‚Ç¨</div>
            <div class="stat-label">CA Total √©quipe</div>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Entreprises</th>
                  <th>Opportunit√©s</th>
                  <th>CA G√©n√©r√©</th>
                  <th>Acc√®s Produits</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="equipeTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Consolidation Page (Admin) -->
      <div class="page" id="page-consolidation">
        <div class="page-header">
          <h1 class="page-title">üìä Consolidation</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportConsolidation()">üì• Exporter le rapport</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üè¢</div></div>
            <div class="stat-value" id="consolEntreprises">0</div>
            <div class="stat-label">Total Entreprises</div>
          </div>
          <div class="stat-card info">
            <div class="stat-header"><div class="stat-icon">üë•</div></div>
            <div class="stat-value" id="consolContacts">0</div>
            <div class="stat-label">Total Contacts</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">üéØ</div></div>
            <div class="stat-value" id="consolOpportunites">0</div>
            <div class="stat-label">Total Opportunit√©s</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">üí∞</div></div>
            <div class="stat-value" id="consolCA">0 ‚Ç¨</div>
            <div class="stat-label">CA Pipeline</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Performance par commercial</h3>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Commercial</th>
                  <th>Entreprises</th>
                  <th>Contacts</th>
                  <th>Opportunit√©s</th>
                  <th>CA Pipeline</th>
                  <th>CA Gagn√©</th>
                  <th>Conversion</th>
                </tr>
              </thead>
              <tbody id="consolidationTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Param√®tres Page -->
      <div class="page" id="page-parametres">
        <div class="page-header">
          <h1 class="page-title">‚öôÔ∏è Param√®tres</h1>
        </div>
        
        <div class="settings-layout">
          <nav class="settings-nav">
            <div class="settings-nav-item active" onclick="showSettingsTab('general', this)">
              <span>üè¢</span> Entreprise
            </div>
            <div class="settings-nav-item" onclick="showSettingsTab('preferences', this)">
              <span>üé®</span> Pr√©f√©rences
            </div>
            <div class="settings-nav-item" onclick="showSettingsTab('donnees', this)">
              <span>üíæ</span> Donn√©es
            </div>
          </nav>
          
          <div class="settings-content">
            <div class="settings-tab active" id="settings-general">
              <div class="settings-section">
                <h3 class="settings-section-title">üè¢ Informations entreprise</h3>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Nom de l'entreprise</label>
                    <input type="text" class="form-control" id="settingCompanyName">
                  </div>
                  <div class="form-group">
                    <label class="form-label">SIRET</label>
                    <input type="text" class="form-control" id="settingCompanySiret">
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Adresse</label>
                  <input type="text" class="form-control" id="settingCompanyAddress">
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">T√©l√©phone</label>
                    <input type="tel" class="form-control" id="settingCompanyPhone">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="settingCompanyEmail">
                  </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Enregistrer</button>
              </div>
            </div>
            
            <div class="settings-tab" id="settings-preferences" style="display: none;">
              <div class="settings-section">
                <h3 class="settings-section-title">üé® Pr√©f√©rences d'affichage</h3>
                <div class="settings-grid">
                  <div class="settings-item">
                    <div class="settings-item-info">
                      <div class="settings-item-label">Mode sombre</div>
                      <div class="settings-item-desc">Activer le th√®me sombre</div>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="settingDarkMode" checked onchange="toggleTheme()">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                  <div class="settings-item">
                    <div class="settings-item-info">
                      <div class="settings-item-label">Devise</div>
                      <div class="settings-item-desc">Devise pour les montants</div>
                    </div>
                    <select class="filter-select" id="settingCurrency" onchange="saveSettings()">
                      <option value="EUR">EUR (‚Ç¨)</option>
                      <option value="USD">USD ($)</option>
                      <option value="GBP">GBP (¬£)</option>
                    </select>
                  </div>
                  <div class="settings-item">
                    <div class="settings-item-info">
                      <div class="settings-item-label">Taux TVA</div>
                      <div class="settings-item-desc">Taux de TVA par d√©faut</div>
                    </div>
                    <select class="filter-select" id="settingTVA" onchange="saveSettings()">
                      <option value="0">0%</option>
                      <option value="5.5">5.5%</option>
                      <option value="10">10%</option>
                      <option value="20" selected>20%</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="settings-tab" id="settings-donnees" style="display: none;">
              <div class="settings-section">
                <h3 class="settings-section-title">üíæ Gestion des donn√©es</h3>
                <div class="settings-grid">
                  <div class="settings-item">
                    <div class="settings-item-info">
                      <div class="settings-item-label">Exporter les donn√©es</div>
                      <div class="settings-item-desc">T√©l√©charger toutes vos donn√©es au format JSON</div>
                    </div>
                    <button class="btn" onclick="exportAllData()">üì• Exporter</button>
                  </div>
                  <div class="settings-item">
                    <div class="settings-item-info">
                      <div class="settings-item-label">Importer des donn√©es</div>
                      <div class="settings-item-desc">Restaurer des donn√©es depuis un fichier JSON</div>
                    </div>
                    <button class="btn" onclick="importData()">üì§ Importer</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                  </div>
                  <div class="settings-item admin-only">
                    <div class="settings-item-info">
                      <div class="settings-item-label">R√©initialiser les donn√©es</div>
                      <div class="settings-item-desc" style="color: var(--danger);">‚ö†Ô∏è Cette action est irr√©versible</div>
                    </div>
                    <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è R√©initialiser</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Historique Commandes Page -->
      <div class="page" id="page-commandes">
        <div class="page-header">
          <h1 class="page-title">üìã Historique des Bons de Commande</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportCommandesCSV()">üì• Exporter CSV</button>
          </div>
        </div>
        
        <div class="list-header">
          <div class="list-filters">
            <select class="filter-select" id="filterCommandeCommercial" onchange="renderCommandes()">
              <option value="">Tous les commerciaux</option>
            </select>
            <input type="date" class="form-control" id="filterCommandeDateFrom" onchange="renderCommandes()" style="width: 150px;">
            <input type="date" class="form-control" id="filterCommandeDateTo" onchange="renderCommandes()" style="width: 150px;">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>N¬∞ Commande</th>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Total HT</th>
                  <th>Total TTC</th>
                  <th>Commercial</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="commandesTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- ADMIN: Pipeline Consolid√© -->
      <div class="page" id="page-admin-pipeline">
        <div class="page-header">
          <h1 class="page-title">üéØ Pipeline Consolid√© - Tous les Commerciaux</h1>
          <div class="page-actions">
            <select class="filter-select" id="filterPipelineCommercial" onchange="renderAdminPipeline()">
              <option value="">Tous les commerciaux</option>
            </select>
            <button class="btn" onclick="exportAdminPipeline()">üì• Exporter</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üéØ</div></div>
            <div class="stat-value" id="adminPipelineTotal">0</div>
            <div class="stat-label">Opportunit√©s actives</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">üìä</div></div>
            <div class="stat-value" id="adminPipelineValue">0 ‚Ç¨</div>
            <div class="stat-label">Valeur pipeline</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">‚úÖ</div></div>
            <div class="stat-value" id="adminPipelineWon">0 ‚Ç¨</div>
            <div class="stat-label">Gagn√© ce mois</div>
          </div>
          <div class="stat-card info">
            <div class="stat-header"><div class="stat-icon">üìà</div></div>
            <div class="stat-value" id="adminPipelineAvgProba">0%</div>
            <div class="stat-label">Probabilit√© moyenne</div>
          </div>
        </div>
        
        <!-- Pipeline Kanban consolid√© -->
        <div class="card" style="margin-bottom: var(--space-lg);">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <h3 class="card-title">Vue Kanban - Pipeline Global</h3>
            <div id="commercialLegend" style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 12px;">
              <!-- L√©gende des commerciaux g√©n√©r√©e par JS -->
            </div>
          </div>
          <div class="card-body" style="padding: 0; overflow-x: auto;">
            <div class="pipeline-container" id="adminPipelineContainer" style="min-width: max-content; display: flex; gap: 12px; padding: 16px;">
              <!-- Contenu par d√©faut - sera remplac√© par JS -->
              <div style="padding: 40px; text-align: center; color: var(--text-muted); width: 100%;">
                <p>‚è≥ Chargement du pipeline...</p>
                <button class="btn btn-primary" onclick="renderAdminPipeline()">üîÑ Recharger</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tableau d√©taill√© par commercial -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">D√©tail par Commercial</h3>
          </div>
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Commercial</th>
                  <th>Lead</th>
                  <th>Prospection</th>
                  <th>Qualification</th>
                  <th>D√©couverte</th>
                  <th>Proposition</th>
                  <th>N√©gociation</th>
                  <th>Closing</th>
                  <th>Total Pipeline</th>
                  <th>Gagn√©</th>
                </tr>
              </thead>
              <tbody id="adminPipelineByUserTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- ADMIN: Toutes les Entreprises -->
      <div class="page" id="page-admin-entreprises">
        <div class="page-header">
          <h1 class="page-title">üè¢ Consolidation - Toutes les Entreprises</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportAdminEntreprises()">üì• Exporter</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üè¢</div></div>
            <div class="stat-value" id="adminEntTotal">0</div>
            <div class="stat-label">Total entreprises</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">‚úÖ</div></div>
            <div class="stat-value" id="adminEntClients">0</div>
            <div class="stat-label">Clients</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">üéØ</div></div>
            <div class="stat-value" id="adminEntProspects">0</div>
            <div class="stat-label">Prospects</div>
          </div>
        </div>
        
        <div class="list-header">
          <div class="list-filters">
            <select class="filter-select" id="filterAdminEntCommercial" onchange="renderAdminEntreprises()">
              <option value="">Tous les commerciaux</option>
            </select>
            <select class="filter-select" id="filterAdminEntType" onchange="renderAdminEntreprises()">
              <option value="">Tous les types</option>
              <option value="Prospect">Prospects</option>
              <option value="Client">Clients</option>
              <option value="Partenaire">Partenaires</option>
            </select>
            <input type="text" class="form-control" placeholder="Rechercher..." style="width: 200px;" id="searchAdminEnt" oninput="renderAdminEntreprises()">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Entreprise</th>
                  <th>Type</th>
                  <th>Secteur</th>
                  <th>Ville</th>
                  <th>Commercial</th>
                  <th>Contacts</th>
                  <th>Opportunit√©s</th>
                  <th>CA Potentiel</th>
                </tr>
              </thead>
              <tbody id="adminEntreprisesTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- ADMIN: Tous les Contacts -->
      <div class="page" id="page-admin-contacts">
        <div class="page-header">
          <h1 class="page-title">üë• Consolidation - Tous les Contacts</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportAdminContacts()">üì• Exporter</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üë•</div></div>
            <div class="stat-value" id="adminContactsTotal">0</div>
            <div class="stat-label">Total contacts</div>
          </div>
          <div class="stat-card info">
            <div class="stat-header"><div class="stat-icon">‚≠ê</div></div>
            <div class="stat-value" id="adminContactsPrimary">0</div>
            <div class="stat-label">Contacts principaux</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">ü§ù</div></div>
            <div class="stat-value" id="adminContactsClients">0</div>
            <div class="stat-label">Clients</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">üîç</div></div>
            <div class="stat-value" id="adminContactsProspects">0</div>
            <div class="stat-label">Prospects</div>
          </div>
        </div>
        
        <div class="list-header">
          <div class="list-filters">
            <select class="filter-select" id="filterAdminContactCommercial" onchange="renderAdminContacts()">
              <option value="">Tous les commerciaux</option>
            </select>
            <select class="filter-select" id="filterAdminContactType" onchange="renderAdminContacts()">
              <option value="">Tous les types</option>
              <option value="prospect">Prospects</option>
              <option value="client">Clients</option>
              <option value="autre">Autres</option>
            </select>
            <input type="text" class="form-control" placeholder="Rechercher..." style="width: 200px;" id="searchAdminContact" oninput="renderAdminContacts()">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container" style="overflow-x: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>ID Ent.</th>
                  <th>Entreprise</th>
                  <th>ID Contact</th>
                  <th>Nom</th>
                  <th>Pr√©nom</th>
                  <th>E-mail</th>
                  <th>N¬∞ Mobile</th>
                  <th>Fonction</th>
                  <th>Type</th>
                  <th>Commercial</th>
                </tr>
              </thead>
              <tbody id="adminContactsTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- ADMIN: Toutes les Opportunit√©s -->
      <div class="page" id="page-admin-opportunites">
        <div class="page-header">
          <h1 class="page-title">üí∞ Consolidation - Toutes les Opportunit√©s</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportAdminOpportunites()">üì• Exporter</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üéØ</div></div>
            <div class="stat-value" id="adminOppTotal">0</div>
            <div class="stat-label">Total opportunit√©s</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">üìä</div></div>
            <div class="stat-value" id="adminOppPipeline">0 ‚Ç¨</div>
            <div class="stat-label">Pipeline total</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">‚úÖ</div></div>
            <div class="stat-value" id="adminOppWon">0 ‚Ç¨</div>
            <div class="stat-label">CA Gagn√©</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-header"><div class="stat-icon">‚ùå</div></div>
            <div class="stat-value" id="adminOppLost">0 ‚Ç¨</div>
            <div class="stat-label">CA Perdu</div>
          </div>
        </div>
        
        <div class="list-header">
          <div class="list-filters">
            <select class="filter-select" id="filterAdminOppCommercial" onchange="renderAdminOpportunites()">
              <option value="">Tous les commerciaux</option>
            </select>
            <select class="filter-select" id="filterAdminOppStage" onchange="renderAdminOpportunites()">
              <option value="">Toutes les √©tapes</option>
            </select>
            <select class="filter-select" id="filterAdminOppState" onchange="renderAdminOpportunites()">
              <option value="">Tous les √©tats</option>
              <option value="ouvert">Ouvert</option>
              <option value="encours">En cours</option>
              <option value="remporte">Remport√©</option>
              <option value="perdu">Perdu</option>
              <option value="abandonne">Abandonn√©</option>
            </select>
            <input type="text" class="form-control" placeholder="Rechercher..." style="width: 200px;" id="searchAdminOpp" oninput="renderAdminOpportunites()">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container" style="overflow-x: auto;">
            <table class="table" style="min-width: 1800px;">
              <thead>
                <tr>
                  <th>ID Opp.</th>
                  <th>Nom opportunit√©</th>
                  <th>Description</th>
                  <th>ID Ent.</th>
                  <th>Entreprise</th>
                  <th>Ville</th>
                  <th>Interlocuteur</th>
                  <th>N¬∞ Mobile</th>
                  <th>√âtape</th>
                  <th>Montant</th>
                  <th>Date cr√©ation</th>
                  <th>Date cl√¥ture</th>
                  <th>% R√©ussite</th>
                  <th>√âtat</th>
                  <th>Motif √©chec</th>
                  <th>Priorit√©</th>
                  <th>Source</th>
                  <th>Avancement</th>
                  <th>Commercial</th>
                </tr>
              </thead>
              <tbody id="adminOpportunitesTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- ADMIN: Tous les BC -->
      <div class="page" id="page-admin-commandes">
        <div class="page-header">
          <h1 class="page-title">üìù Consolidation - Tous les Bons de Commande</h1>
          <div class="page-actions">
            <button class="btn" onclick="exportAdminCommandes()">üì• Exporter</button>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üìù</div></div>
            <div class="stat-value" id="adminBCTotal">0</div>
            <div class="stat-label">Total BC</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">üí∞</div></div>
            <div class="stat-value" id="adminBCCA">0 ‚Ç¨</div>
            <div class="stat-label">CA Total</div>
          </div>
          <div class="stat-card info">
            <div class="stat-header"><div class="stat-icon">üìä</div></div>
            <div class="stat-value" id="adminBCAvg">0 ‚Ç¨</div>
            <div class="stat-label">Panier moyen</div>
          </div>
        </div>
        
        <div class="list-header">
          <div class="list-filters">
            <select class="filter-select" id="filterAdminBCCommercial" onchange="renderAdminCommandes()">
              <option value="">Tous les commerciaux</option>
            </select>
            <input type="date" class="form-control" id="filterAdminBCDateFrom" onchange="renderAdminCommandes()" style="width: 150px;">
            <input type="date" class="form-control" id="filterAdminBCDateTo" onchange="renderAdminCommandes()" style="width: 150px;">
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>N¬∞ Commande</th>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Produits</th>
                  <th>Total HT</th>
                  <th>Total TTC</th>
                  <th>Commercial</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminCommandesTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- =====================================================
           PAGES ACTIONS COMMERCIALES
      ===================================================== -->
      
      <!-- Page Calendrier -->
      <div class="page" id="page-calendrier">
        <div class="page-header">
          <h1 class="page-title">üìÜ Calendrier des Actions</h1>
          <div class="page-actions">
            <button class="btn" onclick="previousMonth()">‚óÄ Mois pr√©c√©dent</button>
            <button class="btn btn-primary" onclick="goToToday()">Aujourd'hui</button>
            <button class="btn" onclick="nextMonth()">Mois suivant ‚ñ∂</button>
          </div>
        </div>
        
        <div class="calendar-layout">
          <div class="calendar-main">
            <div class="calendar-header-month">
              <h2 id="calendarMonthTitle">Janvier 2026</h2>
            </div>
            <div class="calendar-grid">
              <div class="calendar-day-header">Lun</div>
              <div class="calendar-day-header">Mar</div>
              <div class="calendar-day-header">Mer</div>
              <div class="calendar-day-header">Jeu</div>
              <div class="calendar-day-header">Ven</div>
              <div class="calendar-day-header weekend">Sam</div>
              <div class="calendar-day-header weekend">Dim</div>
            </div>
            <div class="calendar-days" id="calendarDays">
              <!-- Days will be rendered by JS -->
            </div>
          </div>
          
          <div class="calendar-sidebar">
            <div class="card" style="margin-bottom: var(--space-md);">
              <div class="card-header">
                <h3 class="card-title">üìå Actions du jour</h3>
              </div>
              <div class="card-body" id="todayActions">
                <!-- Today's actions will be rendered by JS -->
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üìÖ Prochains √©v√©nements</h3>
              </div>
              <div class="card-body" id="upcomingEvents">
                <!-- Upcoming events will be rendered by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Page Emails -->
      <div class="page" id="page-emails">
        <div class="page-header">
          <h1 class="page-title">üìß Gestion des Emails</h1>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openNewEmailModal()">
              <span>‚úâÔ∏è</span> Nouveau message
            </button>
          </div>
        </div>
        
        <div class="tabs">
          <button class="tab active" onclick="filterEmails('all', this)">Tous</button>
          <button class="tab" onclick="filterEmails('brouillon', this)">Brouillons</button>
          <button class="tab" onclick="filterEmails('a_envoyer', this)">√Ä envoyer</button>
          <button class="tab" onclick="filterEmails('envoye', this)">Envoy√©s</button>
          <button class="tab" onclick="filterEmails('recu', this)">Re√ßus</button>
          <button class="tab" onclick="filterEmails('traite', this)">Trait√©s</button>
        </div>
        
        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üì¨</div></div>
            <div class="stat-value" id="emailsTotal">0</div>
            <div class="stat-label">Total emails</div>
          </div>
          <div class="stat-card info">
            <div class="stat-header"><div class="stat-icon">üìù</div></div>
            <div class="stat-value" id="emailsBrouillons">0</div>
            <div class="stat-label">Brouillons</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">üì§</div></div>
            <div class="stat-value" id="emailsAEnvoyer">0</div>
            <div class="stat-label">√Ä envoyer</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">‚úÖ</div></div>
            <div class="stat-value" id="emailsEnvoyes">0</div>
            <div class="stat-label">Envoy√©s</div>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Destinataire</th>
                  <th>Sujet</th>
                  <th>Entreprise</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="emailsTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Page Rendez-vous -->
      <div class="page" id="page-rdv">
        <div class="page-header">
          <h1 class="page-title">ü§ù Gestion des Rendez-vous</h1>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openNewRdvModal()">
              <span>‚ûï</span> Nouveau RDV
            </button>
          </div>
        </div>
        
        <div class="tabs">
          <button class="tab active" onclick="filterRdv('all', this)">Tous</button>
          <button class="tab" onclick="filterRdv('a_confirmer', this)">√Ä confirmer</button>
          <button class="tab" onclick="filterRdv('confirme', this)">Confirm√©s</button>
          <button class="tab" onclick="filterRdv('effectue', this)">Effectu√©s</button>
          <button class="tab" onclick="filterRdv('annule', this)">Annul√©s</button>
        </div>
        
        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üìÖ</div></div>
            <div class="stat-value" id="rdvTotal">0</div>
            <div class="stat-label">Total RDV</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">‚è≥</div></div>
            <div class="stat-value" id="rdvAConfirmer">0</div>
            <div class="stat-label">√Ä confirmer</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">‚úÖ</div></div>
            <div class="stat-value" id="rdvConfirmes">0</div>
            <div class="stat-label">Confirm√©s</div>
          </div>
          <div class="stat-card info">
            <div class="stat-header"><div class="stat-icon">üìç</div></div>
            <div class="stat-value" id="rdvSemaine">0</div>
            <div class="stat-label">Cette semaine</div>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Date & Heure</th>
                  <th>Entreprise</th>
                  <th>Contact</th>
                  <th>Objet</th>
                  <th>Lieu</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="rdvTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Page Appels -->
      <div class="page" id="page-appels">
        <div class="page-header">
          <h1 class="page-title">üìû Gestion des Appels</h1>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openNewAppelModal()">
              <span>‚ûï</span> Nouvel appel
            </button>
          </div>
        </div>
        
        <div class="tabs">
          <button class="tab active" onclick="filterAppels('all', this)">Tous</button>
          <button class="tab" onclick="filterAppels('planifie', this)">Planifi√©s</button>
          <button class="tab" onclick="filterAppels('effectue', this)">Effectu√©s</button>
          <button class="tab" onclick="filterAppels('manque', this)">Manqu√©s</button>
          <button class="tab" onclick="filterAppels('a_rappeler', this)">√Ä rappeler</button>
        </div>
        
        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üìû</div></div>
            <div class="stat-value" id="appelsTotal">0</div>
            <div class="stat-label">Total appels</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">‚è∞</div></div>
            <div class="stat-value" id="appelsPlanifies">0</div>
            <div class="stat-label">Planifi√©s</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">‚úÖ</div></div>
            <div class="stat-value" id="appelsEffectues">0</div>
            <div class="stat-label">Effectu√©s</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-header"><div class="stat-icon">üìµ</div></div>
            <div class="stat-value" id="appelsManques">0</div>
            <div class="stat-label">Manqu√©s / √Ä rappeler</div>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Date & Heure</th>
                  <th>Contact</th>
                  <th>T√©l√©phone</th>
                  <th>Entreprise</th>
                  <th>Objet</th>
                  <th>Dur√©e</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="appelsTable">
                <!-- Data will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Page T√¢ches -->
      <div class="page" id="page-taches">
        <div class="page-header">
          <h1 class="page-title">‚úÖ Gestion des T√¢ches</h1>
          <div class="page-actions">
            <button class="btn btn-primary" onclick="openNewTacheModal()">
              <span>‚ûï</span> Nouvelle t√¢che
            </button>
          </div>
        </div>
        
        <div class="tabs">
          <button class="tab active" onclick="filterTaches('all', this)">Toutes</button>
          <button class="tab" onclick="filterTaches('a_faire', this)">√Ä faire</button>
          <button class="tab" onclick="filterTaches('en_cours', this)">En cours</button>
          <button class="tab" onclick="filterTaches('terminee', this)">Termin√©es</button>
          <button class="tab" onclick="filterTaches('urgente', this)">Urgentes</button>
        </div>
        
        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
          <div class="stat-card">
            <div class="stat-header"><div class="stat-icon">üìã</div></div>
            <div class="stat-value" id="tachesTotal">0</div>
            <div class="stat-label">Total t√¢ches</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-header"><div class="stat-icon">‚è≥</div></div>
            <div class="stat-value" id="tachesAFaire">0</div>
            <div class="stat-label">√Ä faire</div>
          </div>
          <div class="stat-card info">
            <div class="stat-header"><div class="stat-icon">üîÑ</div></div>
            <div class="stat-value" id="tachesEnCours">0</div>
            <div class="stat-label">En cours</div>
          </div>
          <div class="stat-card success">
            <div class="stat-header"><div class="stat-icon">‚úÖ</div></div>
            <div class="stat-value" id="tachesTerminees">0</div>
            <div class="stat-label">Termin√©es</div>
          </div>
        </div>
        
        <div class="card">
          <div class="taches-list" id="tachesList">
            <!-- Tasks will be rendered by JS -->
          </div>
        </div>
      </div>
      
    </div>
</div>

<!-- =====================================================
     MODALS
===================================================== -->

<!-- Main Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOverlay(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">-</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Modal content will be rendered by JS -->
    </div>
  </div>
</div>

<!-- BC Signature Modal -->
<div class="modal-overlay" id="bcSignatureModal">
  <div class="modal" style="max-width: 650px;">
    <div class="modal-header" style="background: var(--gradient-accent); color: white;">
      <h3 class="modal-title">‚úÖ Validation du bon de commande</h3>
      <button class="modal-close" onclick="closeBCSignatureModal()" style="color: white;">√ó</button>
    </div>
    <div class="modal-body">
      <div class="bc-signature-zone">
        <div class="bc-signature-info">
          <h4>VALIDATION COMMERCIALE</h4>
          <p style="color: var(--text-muted); font-size: var(--text-sm);">Apposez votre signature pour valider</p>
        </div>
        <canvas id="bcSignatureCanvas" class="bc-signature-canvas"></canvas>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="clearBCSignature()">‚úó Effacer</button>
      <button class="btn" onclick="closeBCSignatureModal()">Annuler</button>
      <button class="btn btn-success" onclick="generateBCPDF()">‚úì Valider et g√©n√©rer PDF</button>
    </div>
  </div>
</div>

<!-- BC Preview Modal -->
<div class="modal-overlay" id="bcPreviewModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header" style="background: var(--gradient-brand); color: white;">
      <h3 class="modal-title">üìÑ Pr√©visualisation</h3>
      <button class="modal-close" onclick="closeBCPreviewModal()" style="color: white;">√ó</button>
    </div>
    <div class="modal-body" id="bcPreviewContent">
      <!-- Preview content -->
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeBCPreviewModal()">Annuler</button>
      <button class="btn btn-success" onclick="generateBCPDF()">‚úì G√©n√©rer le bon de commande</button>
    </div>
  </div>
</div>

<!-- BC History Modal -->
<div class="modal-overlay" id="bcHistoryModal">
  <div class="modal" style="max-width: 900px;">
    <div class="modal-header">
      <h3 class="modal-title">üìö Historique des commandes</h3>
      <button class="modal-close" onclick="closeBCHistoryModal()">√ó</button>
    </div>
    <div class="modal-body" id="bcHistoryContent">
      <!-- History content -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="clearBCHistory()">üóëÔ∏è Vider</button>
      <button class="btn" onclick="exportBCHistory()">üì• Exporter CSV</button>
      <button class="btn btn-primary" onclick="closeBCHistoryModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// =====================================================
// DATA STRUCTURE & CONSTANTS
// =====================================================

const STORAGE_KEY = 'crm_pro_saas_data';

const PIPELINE_STAGES = [
  { id: 'lead', name: '1 - LEAD (Piste commerciale)', color: '#6B7280', probability: 10 },
  { id: 'prospection', name: '2 - PROSPECTION', color: '#8B5CF6', probability: 20 },
  { id: 'qualification', name: '3 - QUALIFICATION', color: '#3B82F6', probability: 30 },
  { id: 'decouverte', name: '4 - D√âCOUVERTE (Analyse des besoins)', color: '#06B6D4', probability: 40 },
  { id: 'proposition', name: '5 - PROPOSITION (Offre commerciale)', color: '#F59E0B', probability: 60 },
  { id: 'negociation', name: '6 - N√âGOCIATION', color: '#F97316', probability: 75 },
  { id: 'closing', name: '7 - CLOSING (signature)', color: '#10B981', probability: 90, isWon: true },
  { id: 'perdu', name: '8 - PERDU', color: '#EF4444', probability: 0, isLost: true },
  { id: 'topcoflow', name: '9 - TOP-COFLOW', color: '#8B5CF6', probability: 100, isWon: true }
];

const CONTACT_TYPES = [
  { id: 'prospect', name: 'Prospect' },
  { id: 'client', name: 'Client' },
  { id: 'autre', name: 'Autre' }
];

const OPP_STATES = [
  { id: 'ouvert', name: 'Ouvert', color: '#3B82F6' },
  { id: 'remporte', name: 'Remport√©', color: '#10B981' },
  { id: 'perdu', name: 'Perdu', color: '#EF4444' },
  { id: 'abandonne', name: 'Abandonn√©', color: '#6B7280' },
  { id: 'encours', name: 'En cours', color: '#F59E0B' },
  { id: 'top', name: 'TOP', color: '#8B5CF6' }
];

const OPP_SOURCES = [
  { id: 'publicite', name: 'Publicit√©' },
  { id: 'teleprospection', name: 'T√©l√©prospection' },
  { id: 'email', name: 'E-mail' },
  { id: 'sms', name: 'SMS' },
  { id: 'recommandation', name: 'Recommandation' },
  { id: 'topcom', name: 'TOPCOM' },
  { id: 'terrain', name: 'Prospection Terrain' },
  { id: 'autres', name: 'Autres' }
];

const OPP_MOTIFS_ECHEC = [
  { id: 'aucun', name: 'Aucun' },
  { id: 'concurrence', name: 'Concurrence' },
  { id: 'fonctionnalites', name: 'Fonctionnalit√©s' },
  { id: 'prix', name: 'Prix' },
  { id: 'projet_abandonne', name: 'Projet abandonn√©' },
  { id: 'budget', name: 'Manque de Budget' },
  { id: 'timing', name: 'Mauvais timing' },
  { id: 'solution', name: 'Solution non adapt√©e' },
  { id: 'idcc', name: 'IDCC non Conforme' }
];

const OPP_PRIORITIES = [
  { id: 'elevee', name: '√âlev√©e', color: '#EF4444' },
  { id: 'moyenne', name: 'Moyenne', color: '#F59E0B' },
  { id: 'faible', name: 'Faible', color: '#10B981' }
];

let PRODUCT_CATALOGUE = [
  // Mat√©riel
  { ref: 'TAB-8-STD', name: 'Tablette tactile standard 8"', model: 'Lenovo Tab M8', price: 157.00, tva: 20, type: 'Produit', category: 'Mat√©riel', isActive: true, access: 1, characteristics: '√âcran 8" HD IPS | Android 11 | 32 Go | WiFi | Batterie 5000mAh' },
  { ref: 'PRINT-THERM', name: 'Imprimante √©tiquettes thermique', model: 'Rongta RP 324', price: 199.00, tva: 20, type: 'Produit', category: 'Mat√©riel', isActive: true, access: 1, characteristics: 'Impression thermique directe | 203 dpi | USB + Ethernet | Largeur 80mm' },
  { ref: 'BOITIER', name: 'Boitier Aluminium Raspberry PI 4', model: 'Aluminium pour Raspberry PI 4', price: 11.88, tva: 20, type: 'Produit', category: 'Mat√©riel', isActive: true, access: 1, characteristics: 'Aluminium anodis√© | Dissipation thermique passive | Compatible Pi 4B' },
  { ref: 'RASP', name: 'Raspberry PI 4', model: 'Modele PI 4 GB', price: 117.60, tva: 20, type: 'Produit', category: 'Mat√©riel', isActive: true, access: 1, characteristics: 'Quad-core Cortex-A72 | 4 Go RAM | 2x USB 3.0 | Gigabit Ethernet | WiFi 5' },
  { ref: 'CARTE', name: 'Carte Micro SD', model: 'Officiel Raspberry PI 32 GB', price: 16.56, tva: 20, type: 'Produit', category: 'Mat√©riel', isActive: true, access: 1, characteristics: 'Classe 10 | UHS-I | Vitesse lecture 100 Mo/s | Adaptateur inclus' },
  
  // Logiciel
  { ref: 'APP-WEB-ANNUAL', name: 'Application Web - Licence annuelle', model: 'ClickLean Pro', price: 468.00, tva: 20, type: 'Produit', category: 'Logiciel', isActive: true, access: 1, characteristics: 'Licence 12 mois | Utilisateurs illimit√©s | Mises √† jour incluses | Support email' },
  { ref: 'APP-WEB-MONTHLY', name: 'Application Web - Licence mensuelle', model: 'ClickLean Pro', price: 39.00, tva: 20, type: 'Produit', category: 'Logiciel', isActive: true, access: 1, characteristics: 'Licence mensuelle | Sans engagement | Mises √† jour incluses' },
  
  // IoT
  { ref: 'TEMP-SENSOR', name: 'Capteur de temp√©rature sans fil', model: 'TempLog Pro', price: 25.00, tva: 20, type: 'Produit', category: 'IoT', isActive: true, access: 1, characteristics: 'Plage -40¬∞C √† +85¬∞C | Pr√©cision ¬±0.5¬∞C | Bluetooth LE | Pile CR2032 incluse' },
  { ref: 'GATEWAY-IOT', name: 'Passerelle IoT (Gateway)', model: 'IoT Hub Pro', price: 60.00, tva: 20, type: 'Produit', category: 'IoT', isActive: true, access: 1, characteristics: 'WiFi + Bluetooth | Jusqu\'√† 50 capteurs | Cloud ready | Alimentation USB-C' },
  
  // Services
  { ref: 'INSTALL-BASE', name: 'Installation et configuration de base', model: 'Service', price: 112.00, tva: 20, type: 'Service', category: 'Service', isActive: true, access: 1, characteristics: 'Installation mat√©riel | Configuration initiale | Test fonctionnel | 2h sur site' },
  { ref: 'INSTALL-COMP', name: 'Installation et configuration compl√®te', model: 'Service', price: 350.00, tva: 20, type: 'Service', category: 'Service', isActive: true, access: 1, characteristics: 'Installation compl√®te | Param√©trage personnalis√© | Formation utilisateur | Demi-journ√©e' },
  
  // Formation
  { ref: 'FORM-HACCP', name: 'Formation HACCP (4h)', model: 'Formation', price: 400.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1, characteristics: 'Formation 4h | 1 √† 6 participants | Attestation d√©livr√©e | Support p√©dagogique inclus' },
  
  // Consommables
  { ref: 'CONSO', name: "Rouleau d'√©tiquette", model: 'Etiquettes autocollantes - mandrin 80', price: 7.45, tva: 20, type: 'Produit', category: 'Consommables', isActive: true, access: 1, characteristics: 'Rouleau 500 √©tiquettes | 60x40mm | Adh√©sif permanent | Compatible RP324' },
  
  // Connectique
  { ref: 'CABLE', name: 'Cable HDMI', model: 'Micro HDMI 0,5 m', price: 6.96, tva: 20, type: 'Produit', category: 'Connectique', isActive: true, access: 1, characteristics: 'Micro HDMI vers HDMI | 50cm | 4K@60Hz | Connecteurs plaqu√©s or' },
  
  // Site Web
  { ref: '22-PROD-10-01', name: 'Site Web Restauration', model: 'Site Web', price: 1990.00, tva: 20, type: 'Produit', category: 'Site Web', isActive: true, access: 1 },
  { ref: '22-PROD-10-02', name: 'Site web Boulangerie', model: 'Site Web', price: 0.00, tva: 20, type: 'Produit', category: 'Site Web', isActive: true, access: 1 },
  { ref: '22-PROD-10-03', name: 'Site Web Autres metiers', model: 'Site Web', price: 0.00, tva: 20, type: 'Produit', category: 'Site Web', isActive: true, access: 1 },
  { ref: '22-PROD-10-04', name: 'Site Web Vitrine', model: 'Site Web', price: 0.00, tva: 20, type: 'Produit', category: 'Site Web', isActive: true, access: 1 },
  { ref: '22-PROD-10-05', name: 'Site Web (ajout de point de ventes ou de boutique)', model: 'Site Web', price: 1290.00, tva: 20, type: 'Produit', category: 'Site Web', isActive: true, access: 1 },
  { ref: '22-PROD-10-06', name: 'Site web - Version langue √©trang√®re', model: 'Site Web', price: 0.00, tva: 20, type: 'Produit', category: 'Site Web', isActive: true, access: 1 },
  { ref: '22-PROD-10-07', name: 'Design Charte graphique STW', model: 'Site Web', price: 290.00, tva: 20, type: 'Produit', category: 'Site Web', isActive: true, access: 2 },
  
  // Application Mobile
  { ref: '22-PROD-11-01', name: 'Application Android & Ios - Restauration', model: 'Application Mobile', price: 1000.00, tva: 20, type: 'Produit', category: 'Application Mobile', isActive: true, access: 1 },
  { ref: '22-PROD-11-02', name: 'Application Android & Ios - Boulangerie', model: 'Application Mobile', price: 0.00, tva: 20, type: 'Produit', category: 'Application Mobile', isActive: true, access: 1 },
  { ref: '22-PROD-11-03', name: 'Application Android & Ios - Autres Metiers', model: 'Application Mobile', price: 0.00, tva: 20, type: 'Produit', category: 'Application Mobile', isActive: true, access: 1 },
  { ref: '22-PROD-11-04', name: 'Application android & IOS - vitrine', model: 'Application Mobile', price: 0.00, tva: 20, type: 'Produit', category: 'Application Mobile', isActive: true, access: 1 },
  { ref: '22-PROD-11-05', name: 'Application android & IOS - (ajout de point de ventes ou boutiques)', model: 'Application Mobile', price: 0.00, tva: 20, type: 'Produit', category: 'Application Mobile', isActive: true, access: 1 },
  { ref: '22-PROD-11-06', name: 'Application android & IOS - Version langue √©trang√®re', model: 'Application Mobile', price: 0.00, tva: 20, type: 'Produit', category: 'Application Mobile', isActive: true, access: 1 },
  { ref: '22-PROD-11-07', name: 'Design Charte graphique APS', model: 'Application Mobile', price: 99.00, tva: 20, type: 'Produit', category: 'Application Mobile', isActive: true, access: 2 },
  
  // Site WEB APS
  { ref: '22-PROD-12-01', name: 'Site Web et Application - Restauration', model: 'Site WEB APS', price: 2990.00, tva: 20, type: 'Produit', category: 'Site WEB APS', isActive: true, access: 1 },
  { ref: '22-PROD-12-02', name: 'Site Web et Application - Boulangerie', model: 'Site WEB APS', price: 0.00, tva: 20, type: 'Produit', category: 'Site WEB APS', isActive: true, access: 1 },
  { ref: '22-PROD-12-03', name: 'Site Web et Application - Autres Metiers', model: 'Site WEB APS', price: 0.00, tva: 20, type: 'Produit', category: 'Site WEB APS', isActive: true, access: 1 },
  { ref: '22-PROD-12-04', name: 'Site Web et Application - vitrine', model: 'Site WEB APS', price: 0.00, tva: 20, type: 'Produit', category: 'Site WEB APS', isActive: true, access: 1 },
  { ref: '22-PROD-12-05', name: 'Site Web et Application - (ajout de point de ventes ou boutiques)', model: 'Site WEB APS', price: 0.00, tva: 20, type: 'Produit', category: 'Site WEB APS', isActive: true, access: 1 },
  { ref: '22-PROD-12-06', name: 'Design Charte graphique STW-APS', model: 'Site WEB APS', price: 390.00, tva: 20, type: 'Produit', category: 'Site WEB APS', isActive: true, access: 2 },
  
  // Mise √† jour
  { ref: '22-PROD-13-01', name: 'Mise √† jour carte', model: 'Mise √† jour', price: 99.00, tva: 20, type: 'Service', category: 'Mise √† jour', isActive: true, access: 1 },
  { ref: '22-PROD-13-02', name: 'Mise √† jour site version platinium 1', model: 'Mise √† jour', price: 0.00, tva: 20, type: 'Service', category: 'Mise √† jour', isActive: true, access: 1 },
  { ref: '22-PROD-13-05', name: 'Mise √† jour site version platinium 2', model: 'Mise √† jour', price: 990.00, tva: 20, type: 'Service', category: 'Mise √† jour', isActive: true, access: 1 },
  { ref: '22-PROD-13-04', name: 'Design Charte Graphique MAJ', model: 'Mise √† jour', price: 99.00, tva: 20, type: 'Service', category: 'Mise √† jour', isActive: true, access: 2 },
  
  // Menu Board
  { ref: '22-PROD-13-03', name: 'Module Coupe du monde', model: 'Menu Board', price: 0.00, tva: 20, type: 'Produit', category: 'Menu Board', isActive: true, access: 1 },
  { ref: '22-PROD-14-01', name: 'Menu Board Classique - 5 Ecrans', model: 'Menu Board', price: 408.33, tva: 20, type: 'Produit', category: 'Menu Board', isActive: true, access: 1 },
  { ref: '22-PROD-14-02', name: 'Menu Board Video dynamique - 5 Ecrans', model: 'Menu Board', price: 825.00, tva: 20, type: 'Produit', category: 'Menu Board', isActive: true, access: 1 },
  { ref: '22-PROD-14-03', name: 'Design Charte Graphique MBC', model: 'Menu Board', price: 99.00, tva: 20, type: 'Produit', category: 'Menu Board', isActive: true, access: 2 },
  { ref: '22-PROD-14-04', name: 'Design Charte Graphique MBVD', model: 'Menu Board', price: 166.00, tva: 20, type: 'Produit', category: 'Menu Board', isActive: true, access: 2 },
  { ref: '22-PROD-14-05', name: 'BOX MENU BOARD Connect√©', model: 'Menu Board', price: 89.81, tva: 20, type: 'Produit', category: 'Menu Board', isActive: true, access: 1 },
  
  // N√©gociation
  { ref: '22-NEGO-20-01', name: 'H√©bergement Site', model: 'N√©gociation', price: 249.17, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-20-02', name: 'Changement de nom de domaine + h√©bergement', model: 'N√©gociation', price: 0.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-21-01', name: 'Nom de Domaine', model: 'N√©gociation', price: 15.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-22-01', name: '500 Sms', model: 'N√©gociation', price: 47.50, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-22-02', name: '1000 Sms', model: 'N√©gociation', price: 90.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-22-03', name: '5000 Sms', model: 'N√©gociation', price: 400.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-22-04', name: '10000 Sms', model: 'N√©gociation', price: 720.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-22-05', name: 'PROSPECTION SMS', model: 'N√©gociation', price: 0.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-22-06', name: 'Envoi SMS', model: 'N√©gociation', price: 0.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  { ref: '22-NEGO-22-07', name: 'SMS OLD', model: 'N√©gociation', price: 0.00, tva: 20, type: 'Service', category: 'N√©gociation', isActive: true, access: 2 },
  
  // Formation
  { ref: '22-FORM-30-01', name: 'N√©gociation Commerciale', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 2 },
  { ref: '22-FORM-30-02', name: 'Digitalisation des processus de production', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-30-03', name: 'Digitalisation des processus de Ventes', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-30-04', name: 'Digitalisation de la communication', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-30-05', name: "Digitalisation de l'activit√©", model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-30-06', name: 'Mutations digitales et Pilotage de la performance', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-01', name: 'HACCP - Hygi√®ne et s√©curit√© alimentaire', model: 'Formation', price: 1750.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-02', name: 'Maitrise du Plan sanitaire', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-03', name: 'Allerg√®nes', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-04', name: 'Piloter Mon Activit√© Et Evaluer Sa Performance', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-05', name: "Formalisation de votre plan d'action Qualiopi personnalis√©", model: 'Formation', price: 958.33, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-06', name: "L'accompagnement vers la certification Qualiopi", model: 'Formation', price: 2483.33, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-07', name: 'Diagnostic de Votre activit√© de Formation', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-08', name: 'Ma√Ætriser les fonctionnalit√©s de CLICKLEAN', model: 'Formation', price: 1241.67, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-09', name: 'HYGIENE ET BONNES PRATIQUES PROFESSIONNELLES', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-31-10', name: 'Digitalisation des processus de fabrication KOOCLICK', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-01', name: 'P√¢tisserie Classique Traditionnelle', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-02', name: 'Initiation Au Travail Du Chocolat', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-03', name: "G√¢teaux Des F√™tes De Fin D'ann√©e", model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-04', name: 'Snacking En Boulangerie', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-05', name: 'Galette Des Rois', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-06', name: 'Viennoiseries', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-07', name: 'LA P√ÇTISSERIE CLASSIQUE TRADITIONNELLE', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-32-08', name: '√âtiquetage et tra√ßabilit√© Boulangerie P√¢tisserie', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-33-01', name: 'R√©seaux Sociaux', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-33-02', name: 'Google Ads', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-33-03', name: 'Piloter Mon Site Internet', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-33-04', name: 'Facebook', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-33-05', name: 'Instagram', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-33-06', name: 'MUTATIONS DIGITALES : PILOTER ET REFERENCER MON SITE', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  { ref: '22-FORM-33-07', name: 'PILOTER VOTRE APPLICATION MOBILE DCWEBAPS', model: 'Formation', price: 0.00, tva: 20, type: 'Service', category: 'Formation', isActive: true, access: 1 },
  
  // Marketing
  { ref: '22-MKTG-51-01', name: 'Pack Comm neuve', model: 'Marketing', price: 200.00, tva: 20, type: 'Service', category: 'Marketing', isActive: true, access: 1 },
  { ref: '22-MKTG-51-02', name: 'Pack Essentiel 1', model: 'Marketing', price: 250.00, tva: 20, type: 'Service', category: 'Marketing', isActive: true, access: 2 },
  { ref: '22-MKTG-51-03', name: 'Pack Plus 2', model: 'Marketing', price: 350.00, tva: 20, type: 'Service', category: 'Marketing', isActive: true, access: 2 },
  { ref: '22-MKTG-51-04', name: 'Pack Premium 3', model: 'Marketing', price: 550.00, tva: 20, type: 'Service', category: 'Marketing', isActive: true, access: 2 },
  { ref: '22-MKTG-51-05', name: 'Accompagnement et conseil marketing', model: 'Marketing', price: 0.00, tva: 20, type: 'Service', category: 'Marketing', isActive: true, access: 2 },
  { ref: '22-MKTG-52-01', name: 'Prospection et emailing', model: 'Marketing', price: 0.00, tva: 20, type: 'Service', category: 'Marketing', isActive: true, access: 2 },
  
  // Commission
  { ref: '22-COMM-62-01', name: "Commissions apporteur d'affaire", model: 'Commission', price: 0.00, tva: 20, type: 'Service', category: 'Commission', isActive: true, access: 3 },
  { ref: '22-COMM-62-02', name: 'Commissions sur abonnement client apport√©s', model: 'Commission', price: 4.17, tva: 20, type: 'Service', category: 'Commission', isActive: true, access: 3 },
  
  // Prestation
  { ref: '22-PRES-71-01', name: 'Installation agent', model: 'Prestation', price: 50.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 3 },
  { ref: '22-PRES-71-02', name: 'Changement de soci√©t√©s', model: 'Prestation', price: 499.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 2 },
  { ref: '22-PRES-71-03', name: 'Data cleaning', model: 'Prestation', price: 0.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 2 },
  { ref: '22-PRES-71-04', name: 'Commissioning', model: 'Prestation', price: 0.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 3 },
  { ref: '22-PRES-71-05', name: 'Support contract', model: 'Prestation', price: 0.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 2 },
  { ref: '22-PRES-72-01', name: 'Conseil en publicit√©', model: 'Prestation', price: 0.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 2 },
  { ref: '22-PRES-72-02', name: 'Conseil en image', model: 'Prestation', price: 0.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 3 },
  { ref: '22-PRES-72-03', name: 'Conseil en Marketing', model: 'Prestation', price: 0.00, tva: 20, type: 'Service', category: 'Prestation', isActive: true, access: 3 },
  
  // Microbiologie
  { ref: '22-AMB-74-001', name: 'Analyses Alimentaires microbiologie', model: 'Microbiologie', price: 111.50, tva: 20, type: 'Service', category: 'Microbiologie', isActive: true, access: 1 },
  { ref: '22-AMB-74-002', name: 'Analyse de surface List√©ria Monocytog√©n√®se', model: 'Microbiologie', price: 56.19, tva: 20, type: 'Service', category: 'Microbiologie', isActive: true, access: 1 },
  { ref: '22-AMB-74-003', name: 'Frais de Passage', model: 'Microbiologie', price: 48.75, tva: 20, type: 'Service', category: 'Microbiologie', isActive: true, access: 1 },
  { ref: '22-AMB-74-004', name: 'Consommables', model: 'Microbiologie', price: 5.57, tva: 20, type: 'Service', category: 'Microbiologie', isActive: true, access: 1 },
  { ref: '22-AMB-74-005', name: 'Analyses produits finis / Analyses de surfaces', model: 'Microbiologie', price: 291.67, tva: 20, type: 'Service', category: 'Microbiologie', isActive: true, access: 1 },
  { ref: '22-AMB-74-006', name: 'Assistance d√©marche administrative - Plan action Inspection hygi√®ne', model: 'Assistance', price: 250.00, tva: 20, type: 'Service', category: 'Assistance', isActive: true, access: 1 }
];

// Packs pr√©d√©finis
let PACKS_CATALOGUE = [
  { 
    ref: 'PACK-STARTER', 
    name: 'Pack Starter ClickLean', 
    type: 'Pack',
    category: 'Pack',
    description: 'Solution de base pour d√©marrer avec ClickLean',
    characteristics: 'Tablette 8" + Application mensuelle + Installation de base | Id√©al pour d√©marrage rapide',
    notes: 'Formation utilisateur incluse (1h)',
    items: [
      { ref: 'TAB-8-STD', qty: 1 },
      { ref: 'APP-WEB-MONTHLY', qty: 1 },
      { ref: 'INSTALL-BASE', qty: 1 }
    ],
    price: 280,
    regularPrice: 308,
    access: 1
  },
  { 
    ref: 'PACK-PRO', 
    name: 'Pack Professionnel ClickLean', 
    type: 'Pack',
    category: 'Pack',
    description: 'Solution compl√®te pour professionnels de la restauration',
    characteristics: 'Tablette + Imprimante √©tiquettes + Licence annuelle + Installation compl√®te + Formation HACCP',
    notes: 'Attestation de formation HACCP d√©livr√©e | Support prioritaire 12 mois inclus',
    items: [
      { ref: 'TAB-8-STD', qty: 1 },
      { ref: 'PRINT-THERM', qty: 1 },
      { ref: 'APP-WEB-ANNUAL', qty: 1 },
      { ref: 'INSTALL-COMP', qty: 1 },
      { ref: 'FORM-HACCP', qty: 1 }
    ],
    price: 1400,
    regularPrice: 1575,
    access: 1
  },
  { 
    ref: 'PACK-IOT', 
    name: 'Pack IoT Temp√©rature', 
    type: 'Pack',
    category: 'Pack',
    description: 'Surveillance temp√©rature connect√©e HACCP',
    characteristics: '3 capteurs temp√©rature + Passerelle IoT + Installation | Alertes temps r√©el par SMS/Email',
    notes: 'Compatible avec toutes les chambres froides | Autonomie capteurs 2 ans',
    items: [
      { ref: 'TEMP-SENSOR', qty: 3 },
      { ref: 'GATEWAY-IOT', qty: 1 },
      { ref: 'INSTALL-BASE', qty: 1 }
    ],
    price: 220,
    regularPrice: 247,
    access: 1
  },
  { 
    ref: 'PACK-MENU-BOARD', 
    name: 'Pack Menu Board', 
    type: 'Pack',
    category: 'Pack',
    description: 'Affichage dynamique pour menu digital',
    characteristics: 'Raspberry Pi 4 + Bo√Ætier alu + Carte SD + C√¢ble HDMI + Logiciel + Installation',
    notes: '√âcran non inclus | Compatible tout √©cran HDMI',
    items: [
      { ref: 'RASP', qty: 1 },
      { ref: 'CARTE', qty: 1 },
      { ref: 'BOITIER', qty: 1 },
      { ref: 'CABLE', qty: 1 },
      { ref: '22-PROD-14-05', qty: 1 },
      { ref: 'INSTALL-BASE', qty: 1 }
    ],
    price: 350,
    regularPrice: 383,
    access: 1
  }
];

const DEFAULT_DATA = {
  users: [
    { 
      id: 1, 
      username: 'admin', 
      password: 'admin123', 
      firstName: 'Admin', 
      lastName: 'Syst√®me',
      email: 'admin@crmpro.com', 
      phone: '', 
      role: 'admin', 
      isActive: true, 
      createdAt: new Date().toISOString(),
      accessTypes: [1, 2, 3]
    },
    { 
      id: 2, 
      username: 'commercial', 
      password: 'demo123', 
      firstName: 'Jean', 
      lastName: 'Dupont',
      email: 'jean.dupont@crmpro.com', 
      phone: '06 12 34 56 78', 
      role: 'commercial', 
      isActive: true, 
      createdAt: new Date().toISOString(),
      accessTypes: [1]
    }
  ],
  entreprises: [
    { id: 1, name: 'Tech Solutions SARL', tradeName: 'TechSol', siret: '123 456 789 00012', type: 'Client', industry: 'Informatique', contact: 'Marie Martin', email: 'contact@techsol.fr', phone: '01 23 45 67 89', address: '15 Rue de la Tech', city: 'Paris', postalCode: '75001', country: 'France', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 2, name: 'Boulangerie Artisanale', tradeName: '', siret: '987 654 321 00034', type: 'Prospect', industry: 'Alimentaire', contact: 'Pierre Durand', email: 'boulangerie@example.com', phone: '04 56 78 90 12', address: '8 Place du March√©', city: 'Lyon', postalCode: '69001', country: 'France', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 3, name: 'Restaurant Le Gourmet', tradeName: 'Le Gourmet', siret: '456 789 123 00056', type: 'Prospect', industry: 'Restauration', contact: 'Sophie Leroy', email: 'legourmet@resto.fr', phone: '03 21 54 87 09', address: '25 Avenue Centrale', city: 'Marseille', postalCode: '13001', country: 'France', ownerId: 2, createdAt: new Date().toISOString() }
  ],
  contacts: [
    { id: 1, firstName: 'Marie', lastName: 'Martin', entrepriseId: 1, email: 'marie.martin@techsol.fr', phone: '06 11 22 33 44', function: 'Directrice', isPrimary: true, ownerId: 2, createdAt: new Date().toISOString() },
    { id: 2, firstName: 'Pierre', lastName: 'Durand', entrepriseId: 2, email: 'pierre@boulangerie.fr', phone: '06 55 66 77 88', function: 'G√©rant', isPrimary: true, ownerId: 2, createdAt: new Date().toISOString() },
    { id: 3, firstName: 'Sophie', lastName: 'Leroy', entrepriseId: 3, email: 'sophie@legourmet.fr', phone: '06 99 88 77 66', function: 'Propri√©taire', isPrimary: true, ownerId: 2, createdAt: new Date().toISOString() }
  ],
  opportunites: [
    { id: 1, name: 'D√©ploiement CRM', entrepriseId: 1, contactId: 1, amount: 5900, stage: 'proposition', probability: 60, expectedClose: '2025-02-15', source: 'Site web', priority: 'high', description: 'D√©ploiement solution CRM compl√®te', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 2, name: '√âquipement IoT', entrepriseId: 2, contactId: 2, amount: 1200, stage: 'qualification', probability: 30, expectedClose: '2025-03-01', source: 'Prospection', priority: 'medium', description: 'Capteurs temp√©rature pour laboratoire', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 3, name: 'Formation √©quipe', entrepriseId: 3, contactId: 3, amount: 800, stage: 'prospection', probability: 15, expectedClose: '2025-03-15', source: 'Recommandation', priority: 'low', description: 'Formation HACCP', ownerId: 2, createdAt: new Date().toISOString() }
  ],
  produits: [
    { id: 1, reference: 'CRM-LIC-PRO', name: 'Licence CRM Pro - Annuelle', type: 'Service', category: 'Licence', price: 590, unit: 'licence', isActive: true, createdAt: new Date().toISOString() },
    { id: 2, reference: 'TAB-10-PRO', name: 'Tablette 10" Professionnelle', type: 'Produit', category: 'Mat√©riel', price: 299, unit: 'pi√®ce', isActive: true, createdAt: new Date().toISOString() },
    { id: 3, reference: 'INSTALL-BASE', name: 'Installation de base', type: 'Service', category: 'Installation', price: 150, unit: 'forfait', isActive: true, createdAt: new Date().toISOString() }
  ],
  orders: [],
  packs: [],
  messages: [],
  alertes: [
    { id: 1, fromId: 1, toId: 0, title: 'Bienvenue sur DesClick CRM !', content: 'D√©couvrez toutes les fonctionnalit√©s de votre nouvelle solution CRM.', type: 'info', read: false, createdAt: new Date().toISOString() }
  ],
  activities: [],
  // === MODULE ACTIONS ===
  emails: [
    { id: 1, type: 'sortant', to: 'contact@techsol.fr', from: 'jean.dupont@crmpro.com', subject: 'Proposition commerciale Pack Pro', body: 'Bonjour, suite √† notre entretien...', entrepriseId: 1, contactId: 1, opportuniteId: 1, statut: 'envoye', dateEnvoi: new Date().toISOString(), ownerId: 2, createdAt: new Date().toISOString() },
    { id: 2, type: 'sortant', to: 'boulangerie@example.com', from: 'jean.dupont@crmpro.com', subject: 'Suivi de notre conversation', body: 'Bonjour Pierre...', entrepriseId: 2, contactId: 2, opportuniteId: null, statut: 'brouillon', dateEnvoi: null, ownerId: 2, createdAt: new Date().toISOString() }
  ],
  rdv: [
    { id: 1, entrepriseId: 1, contactId: 1, date: new Date(Date.now() + 86400000 * 2).toISOString().split('T')[0], heure: '10:00', objet: 'Pr√©sentation solution CRM', lieu: 'Paris - Si√®ge client', opportuniteId: 1, notes: 'Pr√©voir d√©mo tablette', statut: 'confirme', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 2, entrepriseId: 3, contactId: 3, date: new Date(Date.now() + 86400000 * 5).toISOString().split('T')[0], heure: '14:30', objet: 'D√©couverte besoins HACCP', lieu: 'Restaurant Le Gourmet', opportuniteId: 3, notes: '', statut: 'a_confirmer', ownerId: 2, createdAt: new Date().toISOString() }
  ],
  appels: [
    { id: 1, entrepriseId: 2, contactId: 2, contact: 'Pierre Durand', telephone: '06 55 66 77 88', date: new Date().toISOString().split('T')[0], heure: '11:00', objet: 'Relance proposition IoT', duree: 15, notes: 'Int√©ress√©, rappeler la semaine prochaine', statut: 'effectue', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 2, entrepriseId: 1, contactId: 1, contact: 'Marie Martin', telephone: '06 11 22 33 44', date: new Date(Date.now() + 86400000).toISOString().split('T')[0], heure: '09:30', objet: 'Confirmation commande', duree: null, notes: '', statut: 'planifie', ownerId: 2, createdAt: new Date().toISOString() }
  ],
  taches: [
    { id: 1, titre: 'Pr√©parer pr√©sentation Pack Pro', description: 'Cr√©er slides et d√©mo pour Tech Solutions', entrepriseId: 1, opportuniteId: 1, echeance: new Date(Date.now() + 86400000).toISOString().split('T')[0], priorite: 'haute', statut: 'en_cours', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 2, titre: 'Envoyer documentation HACCP', description: 'Documentation formation HACCP pour Restaurant Le Gourmet', entrepriseId: 3, opportuniteId: 3, echeance: new Date(Date.now() + 86400000 * 3).toISOString().split('T')[0], priorite: 'normale', statut: 'a_faire', ownerId: 2, createdAt: new Date().toISOString() },
    { id: 3, titre: 'Relancer Boulangerie Artisanale', description: 'Rappeler pour capteurs temp√©rature', entrepriseId: 2, opportuniteId: 2, echeance: new Date(Date.now() + 86400000 * 7).toISOString().split('T')[0], priorite: 'basse', statut: 'a_faire', ownerId: 2, createdAt: new Date().toISOString() }
  ],
  settings: {
    companyName: 'Mon Entreprise',
    companyAddress: '123 Rue Exemple, 75001 Paris',
    companyPhone: '+33 1 23 45 67 89',
    companyEmail: 'contact@monentreprise.com',
    companySiret: '123 456 789 00012',
    currency: 'EUR',
    tvaRate: 20,
    darkMode: true,
    typesContact: ['Prospect', 'Client', 'Partenaire', 'Fournisseur'],
    categories: ['Licence', 'Mat√©riel', 'IoT', 'Installation', 'Formation', 'Support']
  },
  lastId: {
    user: 2,
    entreprise: 3,
    contact: 3,
    opportunite: 3,
    produit: 3,
    order: 0,
    message: 0,
    alerte: 1,
    email: 2,
    rdv: 2,
    appel: 2,
    tache: 3
  }
};

// =====================================================
// STATE MANAGEMENT
// =====================================================

let data = {};
let currentUser = null;
let currentChat = null;
let bcState = { files: [], formData: null };
let bcSignatureCanvas, bcSignatureCtx;
let bcIsDrawing = false, bcHasDrawn = false;
let revenueChart = null;

// =====================================================
// INITIALIZATION
// =====================================================

async function init() {
  // Tester la connexion API d'abord
  await testAPIConnection();
  
  // Setup les √©v√©nements
  setupEventListeners();
  
  // Puis charger les donn√©es et v√©rifier l'auth
  if (USE_GOOGLE_SHEETS_API) {
    console.log('üåê Initialisation en mode API');
    await checkAuth();
  } else {
    console.log('üíæ Initialisation en mode localStorage');
    await loadData();
    checkAuth();
  }
}

// Mode API Google Sheets activ√©
// Passe automatiquement en mode localStorage si l'API n'est pas accessible
let USE_GOOGLE_SHEETS_API = true;
let API_CONNECTION_TESTED = false;

async function testAPIConnection() {
  if (API_CONNECTION_TESTED) return USE_GOOGLE_SHEETS_API;
  
  try {
    console.log('üîç Test de connexion √† l\'API...');
    
    // Timeout court (3 secondes)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      console.log('‚è±Ô∏è Timeout API');
      controller.abort();
    }, 3000);
    
    const response = await fetch(API_CONFIG.API_URL + '?action=getSettings', {
      method: 'GET',
      redirect: 'follow',
      signal: controller.signal
    });
    clearTimeout(timeoutId);
    
    if (!response.ok) throw new Error('Response: ' + response.status);
    
    const text = await response.text();
    JSON.parse(text);
    
    console.log('‚úÖ API accessible - Mode en ligne');
    API_CONNECTION_TESTED = true;
    return true;
  } catch (error) {
    console.warn('‚ö†Ô∏è API non accessible:', error.message);
    console.log('üì¶ Mode hors-ligne activ√© (localStorage)');
    USE_GOOGLE_SHEETS_API = false;
    API_CONNECTION_TESTED = true;
    return false;
  }
}

async function loadData() {
  // Tester la connexion API au premier chargement
  if (!API_CONNECTION_TESTED) {
    await testAPIConnection();
  }
  
  if (!USE_GOOGLE_SHEETS_API) {
    // Mode localStorage (hors-ligne)
    console.log('üì¶ Chargement depuis localStorage...');
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      try {
        data = JSON.parse(stored);
        data = { ...DEFAULT_DATA, ...data };
        data.settings = { ...DEFAULT_DATA.settings, ...data.settings };
        data.lastId = { ...DEFAULT_DATA.lastId, ...data.lastId };
      } catch (e) {
        data = JSON.parse(JSON.stringify(DEFAULT_DATA));
      }
    } else {
      data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    }
    loadCustomCatalogues();
    saveData();
    return;
  }
  
  // Mode Google Sheets API
  try {
    showLoadingOverlay('Chargement des donn√©es...');
    
    // Initialiser avec les donn√©es par d√©faut
    data = JSON.parse(JSON.stringify(DEFAULT_DATA));
    
    // Charger toutes les donn√©es en parall√®le
    const [entreprisesRes, contactsRes, opportunitesRes, produitsRes, packsRes, 
           emailsRes, rdvRes, appelsRes, tachesRes, usersRes] = await Promise.all([
      api.getEntreprises(),
      api.getContacts(),
      api.getOpportunites(),
      api.getProduits(),
      api.getPacks(),
      api.getEmails(),
      api.getRdv(),
      api.getAppels(),
      api.getTaches(),
      currentUser?.role === 'admin' ? api.getUsers() : Promise.resolve({ success: true, data: [] })
    ]);
    
    // Mettre √† jour les donn√©es locales
    data.entreprises = entreprisesRes.success ? entreprisesRes.data : [];
    data.contacts = contactsRes.success ? contactsRes.data : [];
    data.opportunites = opportunitesRes.success ? opportunitesRes.data : [];
    data.orders = []; // Les commandes sont charg√©es s√©par√©ment
    data.emails = emailsRes.success ? emailsRes.data : [];
    data.rdv = rdvRes.success ? rdvRes.data : [];
    data.appels = appelsRes.success ? appelsRes.data : [];
    data.taches = tachesRes.success ? tachesRes.data : [];
    data.users = usersRes.success ? usersRes.data : [];
    
    // Mettre √† jour les catalogues produits et packs
    if (produitsRes.success && produitsRes.data.length > 0) {
      PRODUCT_CATALOGUE.length = 0;
      produitsRes.data.forEach(p => {
        PRODUCT_CATALOGUE.push({
          ref: p.reference,
          name: p.name,
          model: p.model || '',
          description: p.description || '',
          characteristics: p.characteristics || '',
          notes: p.notes || '',
          type: p.type || 'Produit',
          category: p.category || 'Divers',
          price: parseFloat(p.price) || 0,
          tva: parseFloat(p.tva) || 20,
          access: p.accessLevel || 1
        });
      });
    }
    
    if (packsRes.success && packsRes.data.length > 0) {
      PACKS_CATALOGUE.length = 0;
      packsRes.data.forEach(p => {
        PACKS_CATALOGUE.push({
          ref: p.reference,
          name: p.name,
          type: 'Pack',
          category: 'Pack',
          description: p.description || '',
          characteristics: p.characteristics || '',
          notes: p.notes || '',
          items: (p.items || []).map(i => ({ ref: i.produitReference, qty: i.quantity })),
          price: parseFloat(p.price) || 0,
          regularPrice: parseFloat(p.regularPrice) || 0,
          access: p.accessLevel || 1
        });
      });
    }
    
    // Charger les commandes
    const commandesRes = await api.getCommandes();
    if (commandesRes.success) {
      data.orders = commandesRes.data.map(c => ({
        ...c,
        products: c.productsJson ? JSON.parse(c.productsJson) : []
      }));
    }
    
    hideLoadingOverlay();
    console.log('‚úÖ Donn√©es charg√©es depuis Google Sheets');
    
  } catch (error) {
    console.error('Erreur chargement API:', error);
    hideLoadingOverlay();
    showToast('Erreur', 'Impossible de charger les donn√©es: ' + error.message, 'error');
    // Fallback sur les donn√©es par d√©faut
    data = JSON.parse(JSON.stringify(DEFAULT_DATA));
  }
}

function showLoadingOverlay(message) {
  let overlay = document.getElementById('loadingOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;gap:16px;">
        <div class="spinner" style="width:48px;height:48px;border:4px solid rgba(255,255,255,0.2);border-top-color:#2B5EA7;border-radius:50%;animation:spin 1s linear infinite;"></div>
        <div id="loadingMessage" style="color:var(--text-primary);font-size:14px;">${message || 'Chargement...'}</div>
      </div>
    `;
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
    document.body.appendChild(overlay);
  } else {
    document.getElementById('loadingMessage').textContent = message || 'Chargement...';
    overlay.style.display = 'flex';
  }
}

function hideLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = 'none';
}

function loadCustomCatalogues() {
  // Load custom product catalogue
  const storedProducts = localStorage.getItem('crm_product_catalogue');
  if (storedProducts) {
    try {
      const customProducts = JSON.parse(storedProducts);
      // Replace PRODUCT_CATALOGUE with stored version
      PRODUCT_CATALOGUE.length = 0;
      customProducts.forEach(p => PRODUCT_CATALOGUE.push(p));
    } catch (e) {
      console.error('Error loading product catalogue:', e);
    }
  }
  
  // Load custom packs catalogue
  const storedPacks = localStorage.getItem('crm_packs_catalogue');
  if (storedPacks) {
    try {
      const customPacks = JSON.parse(storedPacks);
      // Replace PACKS_CATALOGUE with stored version
      PACKS_CATALOGUE.length = 0;
      customPacks.forEach(p => PACKS_CATALOGUE.push(p));
    } catch (e) {
      console.error('Error loading packs catalogue:', e);
    }
  }
}

function saveData() {
  // En mode Google Sheets API, les donn√©es sont sauvegard√©es via les appels API individuels
  if (USE_GOOGLE_SHEETS_API) {
    return; // Pas de sauvegarde localStorage
  }
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function setupEventListeners() {
  // Global search
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && !e.target.matches('input, textarea')) {
      e.preventDefault();
      document.getElementById('globalSearch')?.focus();
    }
    if (e.key === 'Escape') {
      closeModal();
      closeBCSignatureModal();
      closeBCPreviewModal();
      closeBCHistoryModal();
    }
  });

  // BC File upload
  const bcFileZone = document.getElementById('bcFileZone');
  const bcFileInput = document.getElementById('bcFileInput');
  
  if (bcFileZone && bcFileInput) {
    bcFileZone.addEventListener('click', () => bcFileInput.click());
    bcFileZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      bcFileZone.classList.add('dragover');
    });
    bcFileZone.addEventListener('dragleave', () => {
      bcFileZone.classList.remove('dragover');
    });
    bcFileZone.addEventListener('drop', (e) => {
      e.preventDefault();
      bcFileZone.classList.remove('dragover');
      handleBCFiles(e.dataTransfer.files);
    });
    bcFileInput.addEventListener('change', (e) => handleBCFiles(e.target.files));
  }
}

// =====================================================
// AUTHENTICATION
// =====================================================

async function checkAuth() {
  if (USE_GOOGLE_SHEETS_API) {
    // Mode API: V√©rifier si le token est valide
    if (api.isLoggedIn()) {
      currentUser = api.getStoredUser();
      try {
        await loadData();
        showApp();
      } catch (error) {
        console.warn('Erreur chargement donn√©es API, basculement localStorage');
        USE_GOOGLE_SHEETS_API = false;
        await loadData();
        showLogin();
      }
    } else {
      showLogin();
    }
  } else {
    // Mode localStorage
    const storedUser = sessionStorage.getItem('crm_current_user');
    if (storedUser) {
      currentUser = JSON.parse(storedUser);
      showApp();
    } else {
      showLogin();
    }
  }
}

async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  console.log('üîê ========================================');
  console.log('üîê CONNEXION - D√âBUT');
  console.log('üîê ========================================');
  console.log('üë§ Username:', username);
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:8px;"><svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.3"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Connexion...</span>';
  submitBtn.disabled = true;

  // Tester la connexion API si pas encore fait
  if (!API_CONNECTION_TESTED) {
    console.log('üîç Test de connexion API...');
    await testAPIConnection();
  }
  
  console.log('üåê Mode API:', USE_GOOGLE_SHEETS_API ? 'ACTIV√â' : 'D√âSACTIV√â (localStorage)');

  if (USE_GOOGLE_SHEETS_API) {
    try {
      console.log('üì° Envoi de la requ√™te login...');
      const result = await api.login(username, password);
      console.log('üìã R√©sultat login:', result);
      
      if (result.success && result.data) {
        currentUser = result.data.user;
        api.token = result.data.token || '';
        
        console.log('‚úÖ Connexion r√©ussie!');
        console.log('üë§ User:', currentUser);
        console.log('üé´ Token:', api.token ? 'Pr√©sent' : 'ABSENT!');
        
        localStorage.setItem(API_CONFIG.TOKEN_KEY, api.token);
        localStorage.setItem(API_CONFIG.USER_KEY, JSON.stringify(currentUser));
        
        showLoadingOverlay('Chargement des donn√©es...');
        
        // Utiliser Promise.allSettled pour ne pas bloquer
        console.log('üì• Chargement des donn√©es...');
        const results = await Promise.allSettled([
          api.getEntreprises(),
          api.getContacts(),
          api.getOpportunites(),
          api.getProduits(),
          api.getPacks(),
          api.getEmails(),
          api.getRdv(),
          api.getAppels(),
          api.getTaches(),
          currentUser?.role === 'admin' ? api.getUsers() : Promise.resolve({ success: true, data: [] })
        ]);
        
        const getValue = (r, name) => {
          if (r.status === 'fulfilled' && r.value.success) {
            console.log('‚úÖ', name + ':', r.value.data?.length || 0);
            return r.value.data || [];
          } else {
            console.warn('‚ö†Ô∏è', name + ': √âCHEC', r.status === 'rejected' ? r.reason : r.value?.message);
            return [];
          }
        };
        
        data.entreprises = getValue(results[0], 'Entreprises');
        data.contacts = getValue(results[1], 'Contacts');
        data.opportunites = getValue(results[2], 'Opportunit√©s');
        data.produits = getValue(results[3], 'Produits');
        data.packs = getValue(results[4], 'Packs');
        data.emails = getValue(results[5], 'Emails');
        data.rdv = getValue(results[6], 'RDV');
        data.appels = getValue(results[7], 'Appels');
        data.taches = getValue(results[8], 'T√¢ches');
        if (results[9].status === 'fulfilled' && results[9].value.success) {
          data.users = results[9].value.data || [];
        }
        
        // S'assurer que les tableaux optionnels existent
        if (!data.activities) data.activities = [];
        if (!data.orders) data.orders = [];
        if (!data.messages) data.messages = [];
        if (!data.alertes) data.alertes = [];
        
        console.log('üìä Donn√©es finales:', {
          entreprises: data.entreprises?.length,
          contacts: data.contacts?.length,
          opportunites: data.opportunites?.length,
          activities: data.activities?.length
        });
        
        hideLoadingOverlay();
        showApp();
        
        const total = (data.entreprises?.length || 0) + (data.contacts?.length || 0) + 
                      (data.opportunites?.length || 0);
        showToast('Bienvenue', currentUser.firstName + ' - ' + total + ' √©l√©ments charg√©s', 'success');
        
      } else {
        console.warn('‚ö†Ô∏è √âchec connexion:', result.message);
        showToast('Erreur', result.message || 'Identifiants incorrects', 'error');
      }
    } catch (error) {
      console.error('‚ùå Erreur connexion:', error);
      USE_GOOGLE_SHEETS_API = false;
      showToast('Mode hors-ligne', 'API non accessible', 'warning');
      await loadData();
      await handleLoginLocalStorage(username, password, submitBtn, originalText);
      return;
    }
  } else {
    await handleLoginLocalStorage(username, password, submitBtn, originalText);
    return;
  }
  
  submitBtn.innerHTML = originalText;
  submitBtn.disabled = false;
  
  console.log('üîê ========================================');
  console.log('üîê CONNEXION - FIN');
  console.log('üîê ========================================');
}


async function handleLoginLocalStorage(username, password, submitBtn, originalText) {
  console.log('üîê Connexion en mode localStorage avec:', username);
  const user = data.users.find(u => u.username === username && u.password === password);
  
  if (user) {
    if (!user.isActive) {
      showToast('Compte d√©sactiv√©', 'Contactez votre administrateur', 'error');
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      return;
    }
    currentUser = user;
    sessionStorage.setItem('crm_current_user', JSON.stringify(user));
    user.lastLoginAt = new Date().toISOString();
    saveData();
    showApp();
    showToast('Connexion r√©ussie', `Bienvenue ${user.firstName} ! (Mode hors-ligne)`, 'success');
  } else {
    showToast('Erreur', 'Identifiants incorrects', 'error');
  }
  
  submitBtn.innerHTML = originalText;
  submitBtn.disabled = false;
}

function handleLogout() {
  if (USE_GOOGLE_SHEETS_API) {
    api.logout();
  }
  currentUser = null;
  sessionStorage.removeItem('crm_current_user');
  showLogin();
  showToast('D√©connexion', '√Ä bient√¥t !', 'info');
}

function quickLogin(username, password) {
  document.getElementById('loginUsername').value = username;
  document.getElementById('loginPassword').value = password;
  document.getElementById('loginForm').dispatchEvent(new Event('submit'));
}

function resetLocalStorage() {
  if (confirm('‚ö†Ô∏è Cela supprimera toutes les donn√©es locales et r√©initialisera l\'application. Continuer ?')) {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem('crm_product_catalogue');
    localStorage.removeItem('crm_packs_catalogue');
    sessionStorage.removeItem('crm_current_user');
    location.reload();
  }
}

function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appContainer').classList.remove('active');
  document.body.classList.remove('is-admin');
}

function showApp() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appContainer').classList.add('active');
  
  // Reload catalogues to get latest admin changes (seulement en mode localStorage)
  if (!USE_GOOGLE_SHEETS_API) {
    loadCustomCatalogues();
  }
  
  // Update user info in sidebar
  document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName;
  document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrateur' : 'Commercial';
  document.getElementById('userAvatar').textContent = (currentUser.firstName[0] + currentUser.lastName[0]).toUpperCase();
  
  // Show admin sections
  if (currentUser.role === 'admin') {
    document.body.classList.add('is-admin');
  } else {
    document.body.classList.remove('is-admin');
  }
  
  // Apply theme
  applyTheme();
  
  // Initialize navigation sections (accordion)
  initNavSections();
  
  // Initialize dashboard
  try {
    showPage('dashboard');
  } catch (e) {
    console.warn('‚ö†Ô∏è Erreur lors du rendu du dashboard:', e);
  }
  
  try {
    updateNotificationBadges();
  } catch (e) {
    console.warn('‚ö†Ô∏è Erreur updateNotificationBadges:', e);
  }
}

// =====================================================
// NAVIGATION
// =====================================================

function showPage(pageName) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  
  // Show selected page
  const page = document.getElementById('page-' + pageName);
  if (page) page.classList.add('active');
  
  // Update nav items
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  event?.target?.closest('.nav-item')?.classList.add('active');
  
  // Update section active state
  updateNavSectionActive();
  
  // Close sidebar on mobile
  if (window.innerWidth <= 1024) {
    document.getElementById('sidebar').classList.remove('open');
  }
  
  // Render page content
  switch(pageName) {
    case 'dashboard': renderDashboard(); break;
    case 'entreprises': renderEntreprises(); break;
    case 'contacts': renderContacts(); break;
    case 'pipeline': renderPipeline(); break;
    case 'opportunites': renderOpportunites(); break;
    case 'produits': renderProduits(); break;
    case 'boncommande': initBonCommande(); break;
    case 'commandes': renderCommandes(); break;
    case 'messagerie': renderMessaging(); break;
    case 'alertes': renderAlertes(); break;
    case 'equipe': renderEquipe(); break;
    case 'consolidation': renderConsolidation(); break;
    case 'admin-pipeline': 
      (async () => {
        try {
          console.log('üìç ========================================');
          console.log('üìç Navigation vers admin-pipeline');
          console.log('üìç ========================================');
          console.log('üìä data.opportunites:', data.opportunites?.length || 0, '√©l√©ments');
          console.log('üìä data.users:', data.users?.length || 0, '√©l√©ments');
          console.log('üìä PIPELINE_STAGES:', PIPELINE_STAGES?.length || 0, '√©tapes');
          
          // Forcer le rechargement des donn√©es si n√©cessaire
          if (!data.opportunites || data.opportunites.length === 0) {
            console.log('‚ö†Ô∏è Pas d\'opportunit√©s - tentative de rechargement...');
            if (USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
              try {
                const oppRes = await api.getOpportunites();
                if (oppRes.success) {
                  data.opportunites = oppRes.data;
                  console.log('‚úÖ Opportunit√©s recharg√©es:', data.opportunites.length);
                }
              } catch(e) {
                console.warn('Erreur rechargement opportunit√©s:', e);
              }
            }
          }
          
          // Toujours appeler renderAdminPipeline
          renderAdminPipeline();
        } catch(e) {
          console.error('‚ùå Erreur renderAdminPipeline:', e);
          console.error('Stack:', e.stack);
          try {
            renderAdminPipelineEmpty();
          } catch(e2) {
            console.error('‚ùå Erreur renderAdminPipelineEmpty:', e2);
          }
        }
      })();
      break;
    case 'admin-entreprises': renderAdminEntreprises(); break;
    case 'admin-contacts': renderAdminContacts(); break;
    case 'admin-opportunites': renderAdminOpportunites(); break;
    case 'admin-commandes': renderAdminCommandes(); break;
    case 'parametres': loadSettings(); break;
    // MODULE ACTIONS
    case 'calendrier': renderCalendrier(); break;
    case 'emails': renderEmails(); break;
    case 'rdv': renderRdv(); break;
    case 'appels': renderAppels(); break;
    case 'taches': renderTaches(); break;
  }
}

// Toggle navigation section (accordion)
function toggleNavSection(header) {
  const section = header.closest('.nav-section');
  const isCollapsed = section.classList.contains('collapsed');
  
  // Mode accord√©on : fermer les autres sections
  document.querySelectorAll('.nav-section').forEach(s => {
    if (s !== section && !s.querySelector('.nav-item.active')) {
      s.classList.add('collapsed');
    }
  });
  
  // Toggle la section cliqu√©e
  if (isCollapsed) {
    section.classList.remove('collapsed');
  } else {
    // Ne pas fermer si contient un item actif
    if (!section.querySelector('.nav-item.active')) {
      section.classList.add('collapsed');
    }
  }
}

// Update which section has active item
function updateNavSectionActive() {
  document.querySelectorAll('.nav-section').forEach(section => {
    const hasActive = section.querySelector('.nav-item.active');
    if (hasActive) {
      section.classList.add('has-active');
      section.classList.remove('collapsed');
    } else {
      section.classList.remove('has-active');
    }
  });
}

// Initialize nav sections (collapse all except active)
function initNavSections() {
  document.querySelectorAll('.nav-section').forEach(section => {
    if (!section.querySelector('.nav-item.active')) {
      section.classList.add('collapsed');
    }
  });
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function handleGlobalSearch(e) {
  if (e.key === 'Enter') {
    const query = e.target.value.trim().toLowerCase();
    if (query) {
      // Search across all entities
      showToast('Recherche', 'Recherche de "' + query + '"...', 'info');
      // Implement global search logic here
    }
  }
}

// =====================================================
// THEME
// =====================================================

function toggleTheme() {
  if (!data) data = {};
  if (!data.settings) data.settings = { darkMode: false };
  data.settings.darkMode = !data.settings.darkMode;
  applyTheme();
  saveData();
}

function applyTheme() {
  // V√©rifier que data.settings existe
  if (!data || !data.settings) {
    data = data || {};
    data.settings = data.settings || { darkMode: false };
  }
  
  if (data.settings.darkMode) {
    document.documentElement.removeAttribute('data-theme');
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) themeIcon.textContent = 'üåô';
  } else {
    document.documentElement.setAttribute('data-theme', 'light');
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
  }
  
  const darkModeCheckbox = document.getElementById('settingDarkMode');
  if (darkModeCheckbox) darkModeCheckbox.checked = data.settings.darkMode;
}

// =====================================================
// DASHBOARD
// =====================================================

function renderDashboard() {
  const userFilter = currentUser.role === 'admin' ? null : currentUser.id;
  
  const entreprises = filterByOwner(data.entreprises, userFilter);
  const contacts = filterByOwner(data.contacts, userFilter);
  const opportunites = filterByOwner(data.opportunites, userFilter);
  const orders = filterByOwner(data.orders || [], userFilter);
  
  const activeOpps = opportunites.filter(o => !PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon && !PIPELINE_STAGES.find(s => s.id === o.stage)?.isLost);
  const wonOpps = opportunites.filter(o => PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon);
  
  const pipelineTotal = activeOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  const wonTotal = wonOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  const ordersTotal = orders.reduce((sum, o) => sum + (o.totalTTC || 0), 0);
  
  // Calculate trends (mock for now)
  const conversionRate = opportunites.length > 0 ? Math.round((wonOpps.length / opportunites.length) * 100) : 0;
  
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card animate-slide-up" style="animation-delay: 0ms;">
      <div class="stat-header">
        <div class="stat-icon">üè¢</div>
        <div class="stat-trend up">+12%</div>
      </div>
      <div class="stat-value">${entreprises.length}</div>
      <div class="stat-label">Entreprises</div>
    </div>
    <div class="stat-card info animate-slide-up" style="animation-delay: 50ms;">
      <div class="stat-header">
        <div class="stat-icon">üéØ</div>
        <div class="stat-trend up">+8%</div>
      </div>
      <div class="stat-value">${activeOpps.length}</div>
      <div class="stat-label">Opportunit√©s en cours</div>
    </div>
    <div class="stat-card warning animate-slide-up" style="animation-delay: 100ms;">
      <div class="stat-header">
        <div class="stat-icon">üìä</div>
      </div>
      <div class="stat-value">${formatCurrency(pipelineTotal)}</div>
      <div class="stat-label">Pipeline</div>
    </div>
    <div class="stat-card success animate-slide-up" style="animation-delay: 150ms;">
      <div class="stat-header">
        <div class="stat-icon">üí∞</div>
        <div class="stat-trend up">+${conversionRate}%</div>
      </div>
      <div class="stat-value">${formatCurrency(wonTotal)}</div>
      <div class="stat-label">CA Gagn√©</div>
    </div>
  `;
  
  renderRevenueChart();
  renderActivityList();
}

function refreshDashboard() {
  renderDashboard();
  showToast('Actualis√©', 'Donn√©es mises √† jour', 'success');
}

function renderRevenueChart() {
  const ctx = document.getElementById('revenueChart');
  if (!ctx) return;
  
  const period = parseInt(document.getElementById('chartPeriod')?.value || 30);
  const labels = [];
  const values = [];
  
  // Generate mock data
  for (let i = period - 1; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    labels.push(date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }));
    values.push(Math.floor(Math.random() * 5000) + 1000);
  }
  
  if (revenueChart) {
    revenueChart.destroy();
  }
  
  revenueChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'CA',
        data: values,
        borderColor: '#6366F1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        fill: true,
        tension: 0.4,
        pointRadius: 0,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#64748B', maxTicksLimit: 7 }
        },
        y: {
          grid: { color: 'rgba(255,255,255,0.05)' },
          ticks: { 
            color: '#64748B',
            callback: (value) => formatCurrency(value)
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
}

function updateChart() {
  renderRevenueChart();
}

function renderActivityList() {
  const container = document.getElementById('activityList');
  if (!container) return;
  
  // S'assurer que data.activities est un tableau
  const allActivities = Array.isArray(data.activities) ? data.activities : [];
  const activities = allActivities.slice(-10).reverse();
  
  if (activities.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 2rem;">
        <div class="empty-state-icon" style="width: 50px; height: 50px; font-size: 24px;">üìù</div>
        <p style="color: var(--text-muted);">Aucune activit√© r√©cente</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = activities.map(a => `
    <div class="activity-item">
      <div class="activity-icon">${getActivityIcon(a.type)}</div>
      <div class="activity-content">
        <div class="activity-text">${a.message || ''}</div>
        <div class="activity-time">${formatDateTime(a.date)}</div>
      </div>
    </div>
  `).join('');
}

function getActivityIcon(type) {
  const icons = {
    create: '‚ûï',
    update: '‚úèÔ∏è',
    delete: 'üóëÔ∏è',
    order: 'üìù',
    message: 'üí¨',
    login: 'üîê'
  };
  return icons[type] || 'üìå';
}

// =====================================================
// ENTREPRISES
// =====================================================

let entreprisesFilter = 'all';

function renderEntreprises() {
  const search = document.getElementById('searchEntreprises')?.value.toLowerCase() || '';
  let entreprises = getAccessibleEntreprises();
  
  if (entreprisesFilter !== 'all') {
    entreprises = entreprises.filter(e => e.type === entreprisesFilter);
  }
  
  if (search) {
    entreprises = entreprises.filter(e => 
      e.name.toLowerCase().includes(search) ||
      e.contact?.toLowerCase().includes(search) ||
      e.city?.toLowerCase().includes(search)
    );
  }
  
  const container = document.getElementById('entreprisesTable');
  
  if (entreprises.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="7">
          <div class="empty-state">
            <div class="empty-state-icon">üè¢</div>
            <h3 class="empty-state-title">Aucune entreprise</h3>
            <p class="empty-state-text">Commencez par ajouter votre premi√®re entreprise</p>
            <button class="btn btn-primary" onclick="openModal('entreprise')">+ Nouvelle entreprise</button>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  container.innerHTML = entreprises.map(e => {
    const owner = data.users.find(u => String(u.id) === String(e.ownerId));
    return `
      <tr>
        <td>
          <strong>${e.name}</strong>
          ${e.tradeName ? `<br><small class="text-muted">${e.tradeName}</small>` : ''}
        </td>
        <td><select class="status-select" onchange="changeEntrepriseType('${e.id}', this.value)" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);font-size:12px;"><option value="Prospect" ${e.type === 'Prospect' ? 'selected' : ''}>üîµ Prospect</option><option value="Client" ${e.type === 'Client' ? 'selected' : ''}>üü¢ Client</option><option value="Partenaire" ${e.type === 'Partenaire' ? 'selected' : ''}>üü£ Partenaire</option><option value="Inactif" ${e.type === 'Inactif' ? 'selected' : ''}>‚ö´ Inactif</option></select></td>
        <td>${e.contact || '-'}</td>
        <td>${e.phone || '-'}</td>
        <td>${e.city || '-'}</td>
        <td>${owner?.firstName || '-'}</td>
        <td class="actions-cell">
          <button class="btn btn-icon sm" onclick="viewEntreprise('${e.id}')" title="Voir">üëÅÔ∏è</button>
          <button class="btn btn-icon sm" onclick="openModal('entreprise', '${e.id}')" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-icon sm btn-danger" onclick="deleteEntreprise('${e.id}')" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
}

function filterEntreprises(filter, tab) {
  entreprisesFilter = filter;
  document.querySelectorAll('#entreprisesTabs .tab').forEach(t => t.classList.remove('active'));
  tab?.classList.add('active');
  renderEntreprises();
}

async function saveEntreprise(e) {
  e.preventDefault();
  const form = e.target;
  const id = form.dataset.id;
  
  const entrepriseData = {
    name: form.name.value.trim(),
    tradeName: form.tradeName?.value.trim() || '',
    siret: form.siret?.value.trim() || '',
    type: form.type.value,
    industry: form.industry?.value.trim() || '',
    contact: form.contact?.value.trim() || '',
    email: form.email?.value.trim() || '',
    phone: form.phone?.value.trim() || '',
    address: form.address?.value.trim() || '',
    city: form.city?.value.trim() || '',
    postalCode: form.postalCode?.value.trim() || '',
    country: form.country?.value || 'France'
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      console.log('üì§ Envoi entreprise:', entrepriseData);
      let result;
      
      if (id) {
        result = await api.updateEntreprise(id, entrepriseData);
      } else {
        result = await api.createEntreprise(entrepriseData);
      }
      
      console.log('üì• R√©sultat API:', result);
      hideLoadingOverlay();
      
      if (result.success) {
        // Recharger les entreprises
        const entreprisesRes = await api.getEntreprises();
        if (entreprisesRes.success) data.entreprises = entreprisesRes.data;
        
        closeModal();
        renderEntreprises();
        showToast('Succ√®s', id ? 'Entreprise modifi√©e' : 'Entreprise cr√©√©e', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur lors de l\'enregistrement', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      console.error('‚ùå Erreur saveEntreprise:', error);
      showToast('Erreur', 'Erreur: ' + error.message, 'error');
    }
  } else {
    // Mode localStorage
    const entreprise = {
      id: parseInt(id) || ++data.lastId.entreprise,
      ...entrepriseData,
      ownerId: currentUser.id,
      createdAt: id ? data.entreprises.find(ent => ent.id === parseInt(id))?.createdAt : new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    if (id) {
      const index = data.entreprises.findIndex(ent => ent.id === parseInt(id));
      if (index >= 0) data.entreprises[index] = entreprise;
      logActivity('update', 'Entreprise modifi√©e: ' + entreprise.name);
    } else {
      data.entreprises.push(entreprise);
      logActivity('create', 'Nouvelle entreprise: ' + entreprise.name);
    }
    
    saveData();
    closeModal();
    renderEntreprises();
    showToast('Succ√®s', id ? 'Entreprise modifi√©e' : 'Entreprise cr√©√©e', 'success');
  }
}

// Nouvelle fonction pour sauvegarder entreprise + contact principal
async function saveEntrepriseWithContact(e) {
  e.preventDefault();
  console.log('üè¢ saveEntrepriseWithContact appel√©e');
  console.log('üìã USE_GOOGLE_SHEETS_API:', USE_GOOGLE_SHEETS_API);
  
  const form = e.target;
  const entrepriseId = form.dataset.id || null;
  const contactId = form.contactId?.value || null;
  
  console.log('üìã entrepriseId:', entrepriseId, 'contactId:', contactId);
  
  // Pr√©parer les donn√©es de l'entreprise
  const entrepriseData = {
    name: form.name.value.trim(),
    tradeName: form.tradeName?.value.trim() || '',
    siret: form.siret?.value.trim() || '',
    type: form.type.value,
    industry: form.industry?.value.trim() || '',
    email: form.email?.value.trim() || '',
    phone: form.phone?.value.trim() || '',
    website: form.website?.value.trim() || '',
    address: form.address?.value.trim() || '',
    city: form.city?.value.trim() || '',
    postalCode: form.postalCode?.value.trim() || '',
    country: 'France'
  };
  
  console.log('üì§ entrepriseData:', entrepriseData);
  
  // Cr√©er le nom du contact pour le champ entreprise.contact
  const contactFullName = [form.contactFirstName?.value.trim(), form.contactLastName?.value.trim()].filter(Boolean).join(' ');
  entrepriseData.contact = contactFullName;
  
  // Pr√©parer les donn√©es du contact si fournies
  const hasContactInfo = form.contactFirstName?.value.trim() || form.contactLastName?.value.trim();
  let contactData = null;
  
  if (hasContactInfo) {
    contactData = {
      firstName: form.contactFirstName?.value.trim() || '',
      lastName: form.contactLastName?.value.trim() || '',
      civility: form.contactCivility?.value || '',
      email: form.contactEmail?.value.trim() || '',
      phone: form.contactPhone?.value.trim() || '',
      mobile: form.contactMobile?.value.trim() || '',
      functionTitle: form.contactFunction?.value.trim() || '',
      contactType: form.contactType?.value || 'prospect',
      notes: form.contactNotes?.value.trim() || '',
      isPrimary: true
    };
  }
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      console.log('üì§ Envoi entreprise:', entrepriseData);
      
      let entrepriseResult;
      if (entrepriseId) {
        entrepriseResult = await api.updateEntreprise(entrepriseId, entrepriseData);
      } else {
        entrepriseResult = await api.createEntreprise(entrepriseData);
      }
      
      console.log('üì• R√©sultat entreprise:', entrepriseResult);
      
      if (!entrepriseResult.success) {
        hideLoadingOverlay();
        showToast('Erreur', entrepriseResult.message || 'Erreur lors de l\'enregistrement', 'error');
        return;
      }
      
      const newEntrepriseId = entrepriseResult.data?.id || entrepriseId;
      
      // Sauvegarder le contact si fourni
      if (contactData && newEntrepriseId) {
        contactData.entrepriseId = newEntrepriseId;
        console.log('üì§ Envoi contact:', contactData);
        
        let contactResult;
        if (contactId) {
          contactResult = await api.updateContact(contactId, contactData);
        } else {
          contactResult = await api.createContact(contactData);
        }
        console.log('üì• R√©sultat contact:', contactResult);
      }
      
      // Recharger les donn√©es
      const [entreprisesRes, contactsRes] = await Promise.all([
        api.getEntreprises(),
        api.getContacts()
      ]);
      
      if (entreprisesRes.success) data.entreprises = entreprisesRes.data;
      if (contactsRes.success) data.contacts = contactsRes.data;
      
      hideLoadingOverlay();
      closeModal();
      renderEntreprises();
      renderContacts();
      showToast('Succ√®s', entrepriseId ? 'Entreprise et contact modifi√©s' : 'Entreprise et contact cr√©√©s', 'success');
      
    } catch (error) {
      hideLoadingOverlay();
      console.error('‚ùå Erreur:', error);
      showToast('Erreur', 'Erreur: ' + error.message, 'error');
    }
  } else {
    // Mode localStorage
    const entreprise = {
      id: parseInt(entrepriseId) || ++data.lastId.entreprise,
      ...entrepriseData,
      ownerId: currentUser.id,
      createdAt: entrepriseId ? data.entreprises.find(ent => ent.id === parseInt(entrepriseId))?.createdAt : new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    if (entrepriseId) {
      const index = data.entreprises.findIndex(ent => ent.id === parseInt(entrepriseId));
      if (index >= 0) data.entreprises[index] = entreprise;
      logActivity('update', 'Entreprise modifi√©e: ' + entreprise.name);
    } else {
      data.entreprises.push(entreprise);
      logActivity('create', 'Nouvelle entreprise: ' + entreprise.name);
    }
    
    // Sauvegarder le contact principal si des informations sont fournies
    if (hasContactInfo) {
      const contact = {
        id: parseInt(contactId) || ++data.lastId.contact,
        ...contactData,
        entrepriseId: entreprise.id,
        function: contactData.functionTitle,
        ownerId: currentUser.id,
        createdAt: contactId ? data.contacts.find(c => String(c.id) === String(parseInt(contactId)))?.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      if (contactId) {
        const index = data.contacts.findIndex(c => c.id === parseInt(contactId));
        if (index >= 0) data.contacts[index] = contact;
      } else {
        // Marquer les autres contacts de cette entreprise comme non-principaux
        data.contacts.forEach(c => {
          if (c.entrepriseId === entreprise.id) c.isPrimary = false;
        });
        data.contacts.push(contact);
      }
    }
    
    saveData();
    closeModal();
    renderEntreprises();
    renderContacts();
    showToast('Succ√®s', entrepriseId ? 'Entreprise et contact modifi√©s' : 'Entreprise et contact cr√©√©s', 'success');
  }
}

function deleteEntreprise(id) {
  if (!confirm('Supprimer cette entreprise ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    (async () => {
      try {
        showLoadingOverlay('Suppression...');
        const result = await api.deleteEntreprise(id);
        hideLoadingOverlay();
        
        if (result.success) {
          // Recharger les donn√©es
          const [entreprisesRes, contactsRes, opportunitesRes] = await Promise.all([
            api.getEntreprises(),
            api.getContacts(),
            api.getOpportunites()
          ]);
          if (entreprisesRes.success) data.entreprises = entreprisesRes.data;
          if (contactsRes.success) data.contacts = contactsRes.data;
          if (opportunitesRes.success) data.opportunites = opportunitesRes.data;
          
          renderEntreprises();
          showToast('Supprim√©', 'Entreprise supprim√©e', 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur lors de la suppression', 'error');
        }
      } catch (error) {
        hideLoadingOverlay();
        showToast('Erreur', 'Erreur: ' + error.message, 'error');
      }
    })();
  } else {
    const entreprise = data.entreprises.find(e => String(e.id) === String(id));
    data.entreprises = (data.entreprises || []).filter(e => e.id !== id);
    // Also delete related contacts and opportunities
    data.contacts = (data.contacts || []).filter(c => c.entrepriseId !== id);
    data.opportunites = (data.opportunites || []).filter(o => o.entrepriseId !== id);
    
    logActivity('delete', 'Entreprise supprim√©e: ' + (entreprise?.name || ''));
    saveData();
    renderEntreprises();
    showToast('Supprim√©', 'Entreprise supprim√©e', 'success');
  }
}

function viewEntreprise(id) {
  // Open detailed view modal or navigate to detail page
  openModal('entreprise', id);
}
// =====================================================
// FONCTIONS VIEW POUR TOUS LES MODULES
// =====================================================

function viewContact(id) {
  openModal('contact', id);
}

function viewRdv(id) {
  openModal('rdv', id);
}

function viewAppel(id) {
  openModal('appel', id);
}

function viewTache(id) {
  openModal('tache', id);
}

function viewOpportunite(id) {
  openModal('opportunite', id);
}

function viewProduit(id) {
  const produit = data.produits?.find(p => String(p.id) === String(id)) || 
                  PRODUCT_CATALOGUE?.find(p => String(p.id) === String(id));
  if (produit) {
    showToast('Produit', `${produit.name || produit.ref} - ${formatCurrency(produit.price)}`, 'info');
  }
}

function viewPack(id) {
  const pack = data.packs?.find(p => String(p.id) === String(id)) ||
               PACKS_CATALOGUE?.find(p => String(p.id) === String(id));
  if (pack) {
    showToast('Pack', `${pack.name || pack.ref} - ${formatCurrency(pack.price)}`, 'info');
  }
}

function viewCommande(id) {
  const commande = data.orders?.find(c => String(c.id) === String(id));
  if (commande) {
    showToast('Commande', `${commande.orderNumber || 'BC'} - ${formatCurrency(commande.totalTTC)}`, 'info');
  }
}


// =====================================================
// CONTACTS
// =====================================================

function renderContacts() {
  const search = document.getElementById('searchContacts')?.value.toLowerCase() || '';
  const entrepriseFilter = document.getElementById('filterContactEntreprise')?.value;
  const typeFilter = document.getElementById('filterContactType')?.value;
  
  // Update entreprise dropdown
  const entreprises = getAccessibleEntreprises();
  const dropdown = document.getElementById('filterContactEntreprise');
  if (dropdown && dropdown.options.length <= 1) {
    dropdown.innerHTML = '<option value="">Toutes les entreprises</option>' +
      entreprises.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
  }
  
  let contacts = filterByOwner(data.contacts, currentUser.role === 'admin' ? null : currentUser.id);
  
  if (entrepriseFilter) {
    contacts = contacts.filter(c => c.entrepriseId === parseInt(entrepriseFilter));
  }
  
  if (typeFilter) {
    contacts = contacts.filter(c => c.contactType === typeFilter);
  }
  
  if (search) {
    contacts = contacts.filter(c =>
      `${c.firstName} ${c.lastName}`.toLowerCase().includes(search) ||
      c.email?.toLowerCase().includes(search)
    );
  }
  
  const container = document.getElementById('contactsTable');
  
  if (contacts.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="10">
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <h3 class="empty-state-title">Aucun contact</h3>
            <p class="empty-state-text">Ajoutez des contacts √† vos entreprises</p>
            <button class="btn btn-primary" onclick="openModal('contact')">+ Nouveau contact</button>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  container.innerHTML = contacts.map(c => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(c.entrepriseId));
    const contactType = CONTACT_TYPES.find(t => String(t.id) === String(c.contactType));
    return `
      <tr>
        <td><code class="font-mono">${entreprise?.id || '-'}</code></td>
        <td><strong>${entreprise?.name || '-'}</strong></td>
        <td><code class="font-mono">${c.id}</code></td>
        <td><strong>${c.lastName || ''}</strong></td>
        <td>${c.firstName || ''}</td>
        <td>${c.email || '-'}</td>
        <td>${c.mobile || c.phone || '-'}</td>
        <td>${c.function || '-'}</td>
        <td><span class="badge badge-${c.contactType === 'client' ? 'success' : c.contactType === 'prospect' ? 'warning' : 'default'}">${contactType?.name || '-'}</span></td>
        <td class="actions-cell">
          <button class="btn btn-icon sm" onclick="viewContact('${c.id}')" title="Voir">üëÅÔ∏è</button>
          <button class="btn btn-icon sm" onclick="openModal('contact', '${c.id}')" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-icon sm btn-danger" onclick="deleteContact('${c.id}')" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
}

function saveContact(e) {
  e.preventDefault();
  const form = e.target;
  const id = form.dataset.id;
  
  const contactData = {
    firstName: form.firstName.value.trim(),
    lastName: form.lastName.value.trim(),
    entrepriseId: form.entrepriseId.value,
    email: form.email?.value.trim() || '',
    phone: form.phone?.value.trim() || '',
    mobile: form.mobile?.value.trim() || '',
    functionTitle: form.function?.value.trim() || '',
    contactType: form.contactType?.value || 'prospect',
    isPrimary: form.isPrimary?.checked || false,
    notes: form.notes?.value.trim() || ''
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    (async () => {
      try {
        showLoadingOverlay('Enregistrement...');
        let result;
        
        if (id) {
          result = await api.updateContact(id, contactData);
        } else {
          result = await api.createContact(contactData);
        }
        
        hideLoadingOverlay();
        
        if (result.success) {
          const contactsRes = await api.getContacts();
          if (contactsRes.success) data.contacts = contactsRes.data;
          
          closeModal();
          renderContacts();
          showToast('Succ√®s', id ? 'Contact modifi√©' : 'Contact cr√©√©', 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur lors de l\'enregistrement', 'error');
        }
      } catch (error) {
        hideLoadingOverlay();
        showToast('Erreur', 'Erreur: ' + error.message, 'error');
      }
    })();
  } else {
    const contact = {
      id: parseInt(id) || ++data.lastId.contact,
      ...contactData,
      function: contactData.functionTitle,
      ownerId: currentUser.id,
      createdAt: id ? data.contacts.find(c => String(c.id) === String(parseInt(id)))?.createdAt : new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    if (id) {
      const index = data.contacts.findIndex(c => c.id === parseInt(id));
      if (index >= 0) data.contacts[index] = contact;
      logActivity('update', `Contact modifi√©: ${contact.firstName} ${contact.lastName}`);
    } else {
      data.contacts.push(contact);
      logActivity('create', `Nouveau contact: ${contact.firstName} ${contact.lastName}`);
    }
    
    saveData();
    closeModal();
    renderContacts();
    showToast('Succ√®s', id ? 'Contact modifi√©' : 'Contact cr√©√©', 'success');
  }
}

function deleteContact(id) {
  if (!confirm('Supprimer ce contact ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    (async () => {
      try {
        showLoadingOverlay('Suppression...');
        const result = await api.deleteContact(id);
        hideLoadingOverlay();
        
        if (result.success) {
          const contactsRes = await api.getContacts();
          if (contactsRes.success) data.contacts = contactsRes.data;
          
          renderContacts();
          showToast('Supprim√©', 'Contact supprim√©', 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur lors de la suppression', 'error');
        }
      } catch (error) {
        hideLoadingOverlay();
        showToast('Erreur', 'Erreur: ' + error.message, 'error');
      }
    })();
  } else {
    const contact = data.contacts.find(c => String(c.id) === String(id));
    data.contacts = (data.contacts || []).filter(c => c.id !== id);
    logActivity('delete', `Contact supprim√©: ${contact?.firstName} ${contact?.lastName}`);
    saveData();
    renderContacts();
    showToast('Supprim√©', 'Contact supprim√©', 'success');
  }
}

// =====================================================
// OPPORTUNIT√âS
// =====================================================

let opportunitesFilter = 'all';

function renderOpportunites() {
  const search = document.getElementById('searchOpportunites')?.value.toLowerCase() || '';
  const stateFilter = document.getElementById('filterOppState')?.value;
  const stageFilter = document.getElementById('filterOppStage')?.value;
  
  // Update stage dropdown
  const stageDropdown = document.getElementById('filterOppStage');
  if (stageDropdown && stageDropdown.options.length <= 1) {
    stageDropdown.innerHTML = '<option value="">Toutes les √©tapes</option>' +
      PIPELINE_STAGES.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  }
  
  let opportunites = filterByOwner(data.opportunites, currentUser.role === 'admin' ? null : currentUser.id);
  
  if (stateFilter) {
    opportunites = opportunites.filter(o => o.state === stateFilter);
  }
  
  if (stageFilter) {
    opportunites = opportunites.filter(o => o.stage === stageFilter);
  }
  
  if (search) {
    opportunites = opportunites.filter(o =>
      o.name?.toLowerCase().includes(search) ||
      o.description?.toLowerCase().includes(search)
    );
  }
  
  const container = document.getElementById('opportunitesTable');
  
  if (opportunites.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="15">
          <div class="empty-state">
            <div class="empty-state-icon">üéØ</div>
            <h3 class="empty-state-title">Aucune opportunit√©</h3>
            <p class="empty-state-text">Cr√©ez votre premi√®re opportunit√© commerciale</p>
            <button class="btn btn-primary" onclick="openModal('opportunite')">+ Nouvelle opportunit√©</button>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  container.innerHTML = opportunites.map(o => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(o.entrepriseId));
    const contact = data.contacts.find(c => String(c.id) === String(o.contactId));
    const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
    const state = OPP_STATES.find(s => s.id === o.state);
    const priority = OPP_PRIORITIES.find(p => String(p.id) === String(o.priority));
    const source = OPP_SOURCES.find(s => s.id === o.source);
    
    return `
      <tr>
        <td><code class="font-mono">${o.id}</code></td>
        <td><strong>${o.name || '-'}</strong></td>
        <td><code class="font-mono">${entreprise?.id || '-'}</code></td>
        <td>${entreprise?.name || '-'}</td>
        <td>${entreprise?.city || '-'}</td>
        <td>${contact ? `${contact.firstName} ${contact.lastName}` : '-'}</td>
        <td><span class="badge" style="background: ${stage?.color}20; color: ${stage?.color}; font-size: 10px;">${stage?.name || o.stage}</span></td>
        <td class="font-mono" style="color: var(--success); font-weight: 600;">${formatCurrency(o.amount)}</td>
        <td>${o.createdAt ? formatDate(o.createdAt) : '-'}</td>
        <td>${o.expectedClose ? formatDate(o.expectedClose) : '-'}</td>
        <td>
          <div style="display: flex; align-items: center; gap: 4px;">
            <div class="probability-bar" style="width: 50px;">
              <div class="probability-fill" style="width: ${o.probability}%;"></div>
            </div>
            <span class="text-muted" style="font-size: 11px;">${o.probability}%</span>
          </div>
        </td>
        <td><span class="badge" style="background: ${state?.color}20; color: ${state?.color};">${state?.name || '-'}</span></td>
        <td><span class="badge" style="background: ${priority?.color}20; color: ${priority?.color};">${priority?.name || '-'}</span></td>
        <td>${source?.name || '-'}</td>
        <td class="actions-cell">
          <button class="btn btn-icon sm" onclick="openModal('opportunite', ${o.id})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-icon sm btn-danger" onclick="deleteOpportunite(${o.id})" title="Supprimer">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');
}

function filterOpportunites(filter, tab) {
  opportunitesFilter = filter;
  document.querySelectorAll('#opportunitesTabs .tab').forEach(t => t.classList.remove('active'));
  tab?.classList.add('active');
  renderOpportunites();
}

async function saveOpportunite(e) {
  e.preventDefault();
  const form = e.target;
  const id = form.dataset.id;
  
  const oppData = {
    name: form.name.value.trim(),
    description: form.description?.value.trim() || '',
    entrepriseId: form.entrepriseId.value,
    contactId: form.contactId?.value || null,
    amount: parseFloat(form.amount.value) || 0,
    stage: form.stage.value,
    probability: parseInt(form.probability.value) || 50,
    expectedClose: form.expectedClose.value || null,
    status: form.state?.value === 'ferme_gagne' ? 'won' : form.state?.value === 'ferme_perdu' ? 'lost' : 'open',
    source: form.source?.value || '',
    priority: form.priority?.value || 'medium',
    lossReason: form.motifEchec?.value || ''
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      let result;
      
      if (id) {
        result = await api.updateOpportunite(id, oppData);
      } else {
        result = await api.createOpportunite(oppData);
      }
      
      hideLoadingOverlay();
      
      if (result.success) {
        const opportunitesRes = await api.getOpportunites();
        if (opportunitesRes.success) data.opportunites = opportunitesRes.data;
        
        closeModal();
        renderOpportunites();
        renderPipeline();
        showToast('Succ√®s', id ? 'Opportunit√© modifi√©e' : 'Opportunit√© cr√©√©e', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur lors de l\'enregistrement', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', 'Erreur: ' + error.message, 'error');
    }
  } else {
    const opportunite = {
      id: parseInt(id) || ++data.lastId.opportunite,
      ...oppData,
      state: form.state?.value || 'ouvert',
      motifEchec: form.motifEchec?.value || 'aucun',
      avancement: form.avancement?.value.trim() || '',
      ownerId: currentUser.id,
      createdAt: id ? data.opportunites.find(o => String(o.id) === String(parseInt(id)))?.createdAt : new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    if (id) {
      const index = data.opportunites.findIndex(o => o.id === parseInt(id));
      if (index >= 0) data.opportunites[index] = opportunite;
      logActivity('update', `Opportunit√© modifi√©e: ${opportunite.name}`);
    } else {
      data.opportunites.push(opportunite);
      logActivity('create', `Nouvelle opportunit√©: ${opportunite.name} (${formatCurrency(opportunite.amount)})`);
    }
    
    saveData();
    closeModal();
    renderOpportunites();
    renderPipeline();
    showToast('Succ√®s', id ? 'Opportunit√© modifi√©e' : 'Opportunit√© cr√©√©e', 'success');
  }
}

function deleteOpportunite(id) {
  if (!confirm('Supprimer cette opportunit√© ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    (async () => {
      try {
        showLoadingOverlay('Suppression...');
        const result = await api.deleteOpportunite(id);
        hideLoadingOverlay();
        
        if (result.success) {
          const opportunitesRes = await api.getOpportunites();
          if (opportunitesRes.success) data.opportunites = opportunitesRes.data;
          
          renderOpportunites();
          renderPipeline();
          showToast('Supprim√©', 'Opportunit√© supprim√©e', 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur lors de la suppression', 'error');
        }
      } catch (error) {
        hideLoadingOverlay();
        showToast('Erreur', 'Erreur: ' + error.message, 'error');
      }
    })();
  } else {
    const opp = data.opportunites.find(o => String(o.id) === String(id));
    data.opportunites = (data.opportunites || []).filter(o => o.id !== id);
    logActivity('delete', `Opportunit√© supprim√©e: ${opp?.name}`);
    saveData();
    renderOpportunites();
    renderPipeline();
    showToast('Supprim√©', 'Opportunit√© supprim√©e', 'success');
  }
}

// =====================================================
// PIPELINE (KANBAN)
// =====================================================

function renderPipeline() {
  const container = document.getElementById('pipelineContainer');
  const opportunites = filterByOwner(data.opportunites, currentUser.role === 'admin' ? null : currentUser.id);
  
  container.innerHTML = PIPELINE_STAGES.filter(s => !s.isLost).map(stage => {
    const stageOpps = opportunites.filter(o => o.stage === stage.id);
    const total = stageOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    
    return `
      <div class="pipeline-column" data-stage="${stage.id}"
           ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${stage.id}')">
        <div class="pipeline-header">
          <div class="pipeline-title">
            <div class="pipeline-color" style="background: ${stage.color};"></div>
            ${stage.name}
            <span class="pipeline-count">${stageOpps.length}</span>
          </div>
          <div class="pipeline-amount">${formatCurrency(total)}</div>
        </div>
        <div class="pipeline-cards">
          ${stageOpps.map(o => renderPipelineCard(o, stage)).join('')}
        </div>
      </div>
    `;
  }).join('');
}

function renderPipelineCard(opp, stage) {
  const entreprise = data.entreprises.find(e => String(e.id) === String(opp.entrepriseId));
  return `
    <div class="pipeline-card" draggable="true" 
         ondragstart="handleDragStart(event, '${opp.id}')"
         ondragend="handleDragEnd(event)"
         onclick="openModal('opportunite', '${opp.id}')">
      <div class="pipeline-card-header">
        <div class="pipeline-card-title">${opp.name}</div>
      </div>
      <div class="pipeline-card-company">${entreprise?.name || '-'}</div>
      <div class="pipeline-card-footer">
        <div class="pipeline-card-amount">${formatCurrency(opp.amount)}</div>
        <div class="pipeline-card-probability">
          <div class="probability-bar">
            <div class="probability-fill" style="width: ${opp.probability}%; background: ${stage.color};"></div>
          </div>
          ${opp.probability}%
        </div>
      </div>
      ${opp.expectedClose ? `<div class="pipeline-card-date">üìÖ ${formatDate(opp.expectedClose)}</div>` : ''}
    </div>
  `;
}

let draggedOppId = null;

function handleDragStart(e, oppId) {
  draggedOppId = oppId;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.pipeline-column').forEach(col => col.classList.remove('drag-over'));
}

function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}

function handleDrop(e, stageId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  
  if (draggedOppId) {
    const opp = data.opportunites.find(o => String(o.id) === String(draggedOppId));
    if (opp) {
      const stage = PIPELINE_STAGES.find(s => s.id === stageId);
      
      if (USE_GOOGLE_SHEETS_API) {
        (async () => {
          try {
            const result = await api.updateOpportuniteStage(opp.id, stageId);
            
            if (result.success) {
              // Mettre √† jour localement
              opp.stage = stageId;
              opp.probability = stage?.probability || opp.probability;
              opp.updatedAt = new Date().toISOString();
              
              renderPipeline();
              showToast('D√©plac√©', `Opportunit√© d√©plac√©e vers ${stage?.name}`, 'success');
            } else {
              showToast('Erreur', result.message || 'Erreur lors du d√©placement', 'error');
              renderPipeline(); // Recharger pour revenir √† l'√©tat pr√©c√©dent
            }
          } catch (error) {
            showToast('Erreur', 'Erreur: ' + error.message, 'error');
            renderPipeline();
          }
        })();
      } else {
        opp.stage = stageId;
        opp.probability = stage?.probability || opp.probability;
        opp.updatedAt = new Date().toISOString();
        
        logActivity('update', `${opp.name} d√©plac√©e vers ${stage?.name}`);
        saveData();
        renderPipeline();
        showToast('D√©plac√©', `Opportunit√© d√©plac√©e vers ${stage?.name}`, 'success');
      }
    }
  }
  draggedOppId = null;
}

// =====================================================
// PRODUITS
// =====================================================

let produitsFilter = 'all';
let categoryFilter = 'all';

// =====================================================
// IMPORT / EXPORT EXCEL PRODUITS
// =====================================================

function exportProduitsExcel() {
  // Pr√©parer les donn√©es pour l'export
  const exportData = PRODUCT_CATALOGUE.map(p => ({
    'R√©f√©rence': p.ref,
    'D√©signation': p.name,
    'Mod√®le': p.model || '',
    'Prix Unitaire HT': p.price,
    'Taux TVA': p.tva + '%',
    'Cat√©gorie': p.category,
    'Type': p.type,
    'Actif': p.isActive ? 'Oui' : 'Non',
    'Acc√®s': p.access || 1,
    'Caract√©ristiques': p.characteristics || '',
    'Notes': p.notes || ''
  }));
  
  // Cr√©er le workbook
  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Produits');
  
  // Ajuster les largeurs de colonnes
  const colWidths = [
    { wch: 18 },  // R√©f√©rence
    { wch: 50 },  // D√©signation
    { wch: 25 },  // Mod√®le
    { wch: 15 },  // Prix
    { wch: 10 },  // TVA
    { wch: 20 },  // Cat√©gorie
    { wch: 12 },  // Type
    { wch: 8 },   // Actif
    { wch: 8 },   // Acc√®s
    { wch: 60 },  // Caract√©ristiques
    { wch: 40 }   // Notes
  ];
  ws['!cols'] = colWidths;
  
  // T√©l√©charger le fichier
  const date = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, 'Catalogue_Produits_' + date + '.xlsx');
  
  showToast('Export r√©ussi', PRODUCT_CATALOGUE.length + ' produits export√©s', 'success');
}

function importProduitsExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      if (jsonData.length === 0) {
        showToast('Erreur', 'Le fichier est vide', 'error');
        return;
      }
      
      // Afficher le modal de confirmation avec aper√ßu
      showImportPreview(jsonData);
      
    } catch (err) {
      console.error('Erreur import Excel:', err);
      showToast('Erreur', 'Impossible de lire le fichier Excel', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
  
  // Reset input pour permettre de r√©importer le m√™me fichier
  event.target.value = '';
}

function showImportPreview(jsonData) {
  const existingModal = document.getElementById('importPreviewModal');
  if (existingModal) existingModal.remove();
  
  // Mapper les colonnes
  const mappedData = jsonData.map(row => ({
    ref: row['R√©f√©rence'] || row['Reference'] || row['REF'] || '',
    name: row['D√©signation'] || row['Designation'] || row['Nom'] || row['NAME'] || '',
    model: row['Mod√®le'] || row['Modele'] || row['Model'] || '',
    price: parseFloat(String(row['Prix Unitaire HT'] || row['Prix'] || row['PRIX'] || 0).replace(',', '.').replace(/[^0-9.-]/g, '')) || 0,
    tva: parseInt(String(row['Taux TVA'] || row['TVA'] || '20').replace('%', '')) || 20,
    category: row['Cat√©gorie'] || row['Categorie'] || row['Category'] || 'Divers',
    type: row['Type'] || 'Produit',
    isActive: String(row['Actif'] || 'Oui').toLowerCase() !== 'non',
    access: parseInt(row['Acc√®s'] || row['Acces'] || row['Access'] || 1) || 1,
    characteristics: row['Caract√©ristiques'] || row['Caracteristiques'] || row['Characteristics'] || '',
    notes: row['Notes'] || row['Note'] || ''
  })).filter(p => p.ref && p.name);
  
  // Compter nouveaux vs existants
  let newCount = 0;
  let updateCount = 0;
  mappedData.forEach(p => {
    if (PRODUCT_CATALOGUE.find(existing => existing.ref === p.ref)) {
      updateCount++;
    } else {
      newCount++;
    }
  });
  
  const previewHtml = `
    <div style="padding: 20px;">
      <h3 style="margin-bottom: 15px;">üìä Aper√ßu de l'import</h3>
      
      <div style="display: flex; gap: 15px; margin-bottom: 20px;">
        <div style="flex: 1; padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: var(--success);">${newCount}</div>
          <div style="font-size: 12px; color: var(--text-muted);">Nouveaux produits</div>
        </div>
        <div style="flex: 1; padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: var(--warning);">${updateCount}</div>
          <div style="font-size: 12px; color: var(--text-muted);">Mises √† jour</div>
        </div>
        <div style="flex: 1; padding: 15px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: var(--brand-primary);">${mappedData.length}</div>
          <div style="font-size: 12px; color: var(--text-muted);">Total</div>
        </div>
      </div>
      
      <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-default); border-radius: 8px;">
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
          <thead style="position: sticky; top: 0; background: var(--bg-tertiary);">
            <tr>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-default);">R√©f</th>
              <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-default);">D√©signation</th>
              <th style="padding: 8px; text-align: right; border-bottom: 1px solid var(--border-default);">Prix</th>
              <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-default);">Statut</th>
            </tr>
          </thead>
          <tbody>
            ${mappedData.slice(0, 20).map(p => {
              const exists = PRODUCT_CATALOGUE.find(existing => existing.ref === p.ref);
              return '<tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-light);">' + p.ref + '</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-light);">' + p.name.substring(0, 40) + (p.name.length > 40 ? '...' : '') + '</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-light); text-align: right;">' + p.price.toFixed(2) + ' ‚Ç¨</td><td style="padding: 6px 8px; border-bottom: 1px solid var(--border-light); text-align: center;"><span class="badge badge-' + (exists ? 'warning' : 'success') + '">' + (exists ? 'MAJ' : 'Nouveau') + '</span></td></tr>';
            }).join('')}
            ${mappedData.length > 20 ? '<tr><td colspan="4" style="padding: 10px; text-align: center; color: var(--text-muted);">... et ' + (mappedData.length - 20) + ' autres produits</td></tr>' : ''}
          </tbody>
        </table>
      </div>
      
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn" onclick="closeImportPreview()">Annuler</button>
        <button class="btn btn-primary" onclick="executeImport()">Importer ${mappedData.length} produits</button>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.id = 'importPreviewModal';
  modal.className = 'modal';
  modal.style.display = 'flex';
  modal.innerHTML = '<div class="modal-content" style="max-width: 700px;"><div class="modal-header"><h2 class="modal-title">üì§ Import Excel</h2><button class="modal-close" onclick="closeImportPreview()">&times;</button></div><div class="modal-body">' + previewHtml + '</div></div>';
  
  // Stocker les donn√©es pour l'import
  modal.dataset.importData = JSON.stringify(mappedData);
  
  document.body.appendChild(modal);
}

function closeImportPreview() {
  const modal = document.getElementById('importPreviewModal');
  if (modal) modal.remove();
}

function executeImport() {
  const modal = document.getElementById('importPreviewModal');
  if (!modal) return;
  
  const mappedData = JSON.parse(modal.dataset.importData);
  let newCount = 0;
  let updateCount = 0;
  
  mappedData.forEach(p => {
    const existingIndex = PRODUCT_CATALOGUE.findIndex(existing => existing.ref === p.ref);
    
    if (existingIndex >= 0) {
      // Mettre √† jour le produit existant
      PRODUCT_CATALOGUE[existingIndex] = {
        ...PRODUCT_CATALOGUE[existingIndex],
        name: p.name,
        model: p.model,
        price: p.price,
        tva: p.tva,
        category: p.category,
        type: p.type,
        isActive: p.isActive,
        access: p.access,
        characteristics: p.characteristics || PRODUCT_CATALOGUE[existingIndex].characteristics || '',
        notes: p.notes || PRODUCT_CATALOGUE[existingIndex].notes || ''
      };
      updateCount++;
    } else {
      // Ajouter nouveau produit
      PRODUCT_CATALOGUE.push({
        ref: p.ref,
        name: p.name,
        model: p.model,
        price: p.price,
        tva: p.tva,
        type: p.type,
        category: p.category,
        isActive: p.isActive,
        access: p.access,
        characteristics: p.characteristics || '',
        notes: p.notes || ''
      });
      newCount++;
    }
  });
  
  // Sauvegarder dans localStorage
  localStorage.setItem('crm_product_catalogue', JSON.stringify(PRODUCT_CATALOGUE));
  
  closeImportPreview();
  renderProduits();
  
  showToast('Import r√©ussi', newCount + ' nouveaux, ' + updateCount + ' mis √† jour', 'success');
}

function renderProduits() {
  // Recharger les packs depuis localStorage (synchronisation admin -> commercial)
  const storedPacks = localStorage.getItem('crm_packs_catalogue');
  if (storedPacks) {
    try {
      const parsedPacks = JSON.parse(storedPacks);
      PACKS_CATALOGUE.length = 0;
      parsedPacks.forEach(p => PACKS_CATALOGUE.push(p));
    } catch(e) { console.error('Error parsing packs:', e); }
  }
  
  // Recharger les produits depuis localStorage (synchronisation admin -> commercial)
  const storedProducts = localStorage.getItem('crm_product_catalogue');
  if (storedProducts) {
    try {
      const parsedProducts = JSON.parse(storedProducts);
      PRODUCT_CATALOGUE.length = 0;
      parsedProducts.forEach(p => PRODUCT_CATALOGUE.push(p));
    } catch(e) { console.error('Error parsing products:', e); }
  }
  
  // Render Packs
  renderPacks();
  
  // Combine catalogue products with custom products
  // Assign IDs to catalogue products for display
  let allProducts = [
    ...PRODUCT_CATALOGUE.map((p, idx) => ({ 
      id: 'cat_' + idx, 
      reference: p.ref, 
      name: p.name,
      model: p.model || '',
      price: p.price,
      tva: p.tva || 20,
      type: p.type,
      category: p.category,
      isActive: p.isActive !== false,
      isCatalogue: true,
      catIndex: idx,
      access: p.access || 1
    })),
    ...(data.produits || []).map(p => ({ ...p, isCatalogue: false, access: p.access || 1 }))
  ];
  
  // Filter by type (Produit/Service)
  if (produitsFilter !== 'all') {
    if (produitsFilter === 'Produit') {
      allProducts = allProducts.filter(p => p.type === 'Produit');
    } else if (produitsFilter === 'Service') {
      allProducts = allProducts.filter(p => p.type === 'Service');
    }
  }
  
  // Filter by category
  if (categoryFilter !== 'all') {
    allProducts = allProducts.filter(p => p.category === categoryFilter);
  }
  
  const container = document.getElementById('produitsTable');
  const isAdmin = currentUser?.role === 'admin';
  
  if (allProducts.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="${isAdmin ? 9 : 7}">
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3 class="empty-state-title">Aucun produit</h3>
            <p class="empty-state-text">Ajoutez vos produits et services</p>
            ${isAdmin ? '<button class="btn btn-primary" onclick="openModal(\'produit\')">+ Nouveau produit</button>' : ''}
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  const accessColors = { 1: 'success', 2: 'warning', 3: 'danger' };
  const accessLabels = { 1: 'Niveau 1', 2: 'Niveau 2', 3: 'Niveau 3' };
  
  container.innerHTML = allProducts.map(p => `
    <tr>
      <td><code class="font-mono">${p.reference}</code></td>
      <td><strong>${p.name}</strong></td>
      <td>${p.model || '-'}</td>
      <td><span class="badge badge-${getCategoryBadge(p.category)}">${p.category || '-'}</span></td>
      <td class="font-mono" style="font-weight: 600;">${formatCurrency(p.price)}</td>
      <td>${p.tva || 20}%</td>
      <td><span class="badge badge-${accessColors[p.access] || 'success'}">${accessLabels[p.access] || 'Niveau 1'}</span></td>
      <td><span class="badge badge-${p.isActive ? 'success' : 'danger'}">${p.isActive ? 'Actif' : 'Inactif'}</span></td>
      ${isAdmin ? `
        <td class="actions-cell">
          <button class="btn btn-icon sm" onclick="editProduct('${p.id}', ${p.isCatalogue})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-icon sm btn-danger" onclick="deleteProduct('${p.id}', ${p.isCatalogue})" title="Supprimer">üóëÔ∏è</button>
        </td>
      ` : ''}
    </tr>
  `).join('');
}

// Edit product (catalogue or custom)
function editProduct(id, isCatalogue) {
  if (isCatalogue) {
    openModal('produit', id); // Pass 'cat_X' id directly
  } else {
    openModal('produit', id);
  }
}

// Delete product (catalogue or custom)
async function deleteProduct(id, isCatalogue) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      // Extraire l'ID r√©el si c'est un index de catalogue
      const realId = isCatalogue ? PRODUCT_CATALOGUE[parseInt(id.replace('cat_', ''))]?.id : id;
      
      if (realId) {
        const result = await api.deleteProduit(realId);
        if (result.success) {
          const produitsRes = await api.getProduits();
          if (produitsRes.success) {
            PRODUCT_CATALOGUE.length = 0;
            produitsRes.data.forEach(p => {
              PRODUCT_CATALOGUE.push({
                ref: p.reference,
                name: p.name,
                model: p.model || '',
                type: p.type || 'produit',
                category: p.category || 'Mat√©riel',
                price: parseFloat(p.price) || 0,
                tva: parseFloat(p.tva) || 20,
                isActive: p.isActive !== false,
                id: p.id
              });
            });
          }
          renderProduits();
          showToast('Supprim√©', 'Produit supprim√©', 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur', 'error');
        }
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
    }
  } else {
    if (isCatalogue) {
      const catIndex = parseInt(id.replace('cat_', ''));
      PRODUCT_CATALOGUE.splice(catIndex, 1);
      localStorage.setItem('crm_product_catalogue', JSON.stringify(PRODUCT_CATALOGUE));
    } else {
      const index = data.produits.findIndex(p => p.id === parseInt(id));
      if (index >= 0) data.produits.splice(index, 1);
      saveData();
    }
    
    renderProduits();
    showToast('Supprim√©', 'Produit supprim√©', 'success');
  }
}

function getCategoryBadge(category) {
  const badges = {
    'Mat√©riel': 'default',
    'Logiciel': 'primary',
    'IoT': 'info',
    'Service': 'warning',
    'Formation': 'success',
    'Support': 'warning',
    'Consommables': 'default',
    'Connectique': 'info'
  };
  return badges[category] || 'default';
}

function renderPacks() {
  const container = document.getElementById('packsGrid');
  if (!container) return;
  
  // Combine catalogue packs + custom packs with source tracking
  const allPacks = [
    ...PACKS_CATALOGUE.map((p, idx) => ({ ...p, isCatalogue: true, catIndex: idx })),
    ...(data.packs || []).map(p => ({ ...p, isCatalogue: false }))
  ];
  
  const isAdmin = currentUser?.role === 'admin';
  
  if (allPacks.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1/-1;">
        <p class="text-muted">Aucun pack disponible</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = allPacks.map((pack, index) => {
    const savings = pack.regularPrice - pack.price;
    const savingsPercent = Math.round((savings / pack.regularPrice) * 100);
    const packId = pack.isCatalogue ? `cat_${pack.catIndex}` : pack.id;
    
    return `
      <div class="pack-card">
        ${isAdmin ? `
          <div class="pack-actions" style="position: absolute; top: 10px; right: 50px; display: flex; gap: 4px; z-index: 10;">
            <button class="btn btn-icon sm" onclick="editPack('${packId}', ${pack.isCatalogue})" title="Modifier">‚úèÔ∏è</button>
            <button class="btn btn-icon sm btn-danger" onclick="deletePack('${packId}', ${pack.isCatalogue})" title="Supprimer">üóëÔ∏è</button>
          </div>
        ` : ''}
        <div class="pack-header">
          <div>
            <div class="pack-title">${pack.name}</div>
            <code class="font-mono text-muted" style="font-size: 11px;">${pack.ref}</code>
          </div>
          <div class="pack-price">
            <div class="pack-price-current">${formatCurrency(pack.price)}</div>
            <div class="pack-price-regular">${formatCurrency(pack.regularPrice)}</div>
            <div class="pack-savings">-${savingsPercent}% (${formatCurrency(savings)})</div>
          </div>
        </div>
        <p class="pack-description">${pack.description || ''}</p>
        <div class="pack-items">
          ${pack.items.map(item => {
            const product = PRODUCT_CATALOGUE.find(p => p.ref === item.ref) || 
                           data.produits?.find(p => p.reference === item.ref);
            const itemType = product?.type === 'Service' ? 'üîß' : 'üì¶';
            return `
              <div class="pack-item">
                <div class="pack-item-name">
                  <span>${itemType}</span>
                  <span>${product?.name || item.ref}</span>
                </div>
                <span class="pack-item-qty">x${item.qty}</span>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');
}

// Edit pack (catalogue or custom)
function editPack(id, isCatalogue) {
  if (isCatalogue) {
    const catIndex = parseInt(id.replace('cat_', ''));
    openModal('pack-catalogue', catIndex);
  } else {
    openModal('pack-edit', parseInt(id));
  }
}

// Delete pack (catalogue or custom)
async function deletePack(id, isCatalogue) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce pack ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const realId = isCatalogue ? PACKS_CATALOGUE[parseInt(id.replace('cat_', ''))]?.id : id;
      
      if (realId) {
        const result = await api.deletePack(realId);
        if (result.success) {
          const packsRes = await api.getPacks();
          if (packsRes.success) {
            PACKS_CATALOGUE.length = 0;
            packsRes.data.forEach(p => {
              PACKS_CATALOGUE.push({
                ref: p.reference,
                name: p.name,
                products: p.products || [],
                price: parseFloat(p.price) || 0,
                discount: parseFloat(p.discount) || 0,
                isActive: p.isActive !== false,
                id: p.id
              });
            });
          }
          renderProduits();
          showToast('Supprim√©', 'Pack supprim√©', 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur', 'error');
        }
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
    }
  } else {
    if (isCatalogue) {
      const catIndex = parseInt(id.replace('cat_', ''));
      PACKS_CATALOGUE.splice(catIndex, 1);
      localStorage.setItem('crm_packs_catalogue', JSON.stringify(PACKS_CATALOGUE));
    } else {
      const index = data.packs.findIndex(p => p.id === parseInt(id));
      if (index >= 0) data.packs.splice(index, 1);
      saveData();
    }
    
    renderProduits();
    showToast('Supprim√©', 'Pack supprim√©', 'success');
  }
}

function filterProduits(filter, tab) {
  produitsFilter = filter;
  document.querySelectorAll('#produitsTabs .tab').forEach(t => t.classList.remove('active'));
  tab?.classList.add('active');
  renderProduits();
}

function filterByCategory(category, btn) {
  categoryFilter = category;
  document.querySelectorAll('.category-filter').forEach(b => b.classList.remove('active'));
  btn?.classList.add('active');
  renderProduits();
}

async function saveProduit(e) {
  e.preventDefault();
  const form = e.target;
  const id = form.dataset.id;
  
  const produitData = {
    reference: form.reference.value.trim().toUpperCase(),
    name: form.name.value.trim(),
    model: form.model?.value.trim() || '',
    type: form.type.value,
    category: form.category?.value || 'Mat√©riel',
    price: parseFloat(form.price.value) || 0,
    tva: parseFloat(form.tva?.value) || 20,
    isActive: form.isActive?.checked !== false,
    characteristics: form.characteristics?.value.trim() || '',
    notes: form.notes?.value.trim() || ''
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      let result;
      
      if (id && !id.startsWith('cat_')) {
        result = await api.updateProduit(id, produitData);
      } else {
        result = await api.createProduit(produitData);
      }
      
      hideLoadingOverlay();
      
      if (result.success) {
        // Recharger les produits
        const produitsRes = await api.getProduits();
        if (produitsRes.success) {
          // Mettre √† jour le catalogue
          PRODUCT_CATALOGUE.length = 0;
          produitsRes.data.forEach(p => {
            PRODUCT_CATALOGUE.push({
              ref: p.reference,
              name: p.name,
              model: p.model || '',
              type: p.type || 'produit',
              category: p.category || 'Mat√©riel',
              price: parseFloat(p.price) || 0,
              tva: parseFloat(p.tva) || 20,
              isActive: p.isActive !== false,
              characteristics: p.characteristics || '',
              notes: p.notes || '',
              id: p.id
            });
          });
        }
        closeModal();
        renderProduits();
        showToast('Succ√®s', id ? 'Produit modifi√©' : 'Produit cr√©√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    // Mode localStorage
    const produit = {
      ref: produitData.reference,
      ...produitData
    };
    
    if (currentUser?.role === 'admin') {
      if (id && id.startsWith('cat_')) {
        const catIndex = parseInt(id.replace('cat_', ''));
        PRODUCT_CATALOGUE[catIndex] = produit;
      } else if (id) {
        const index = data.produits.findIndex(p => p.id === parseInt(id));
        if (index >= 0) {
          data.produits[index] = { ...data.produits[index], ...produit, reference: produit.ref };
        }
        saveData();
      } else {
        PRODUCT_CATALOGUE.push(produit);
      }
      localStorage.setItem('crm_product_catalogue', JSON.stringify(PRODUCT_CATALOGUE));
    } else {
      const customProduit = {
        id: id ? parseInt(id) : ++data.lastId.produit,
        reference: produit.ref,
        ...produit,
        createdAt: id ? data.produits.find(p => String(p.id) === String(parseInt(id)))?.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      if (id) {
        const index = data.produits.findIndex(p => p.id === parseInt(id));
        if (index >= 0) data.produits[index] = customProduit;
      } else {
        data.produits.push(customProduit);
      }
      saveData();
    }
    
    closeModal();
    renderProduits();
    showToast('Succ√®s', id ? 'Produit modifi√©' : 'Produit cr√©√©', 'success');
  }
}

async function deleteProduit(id) {
  if (!confirm('Supprimer ce produit ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.deleteProduit(id);
      if (result.success) {
        // Recharger les produits
        const produitsRes = await api.getProduits();
        if (produitsRes.success) {
          PRODUCT_CATALOGUE.length = 0;
          produitsRes.data.forEach(p => {
            PRODUCT_CATALOGUE.push({
              ref: p.reference,
              name: p.name,
              model: p.model || '',
              type: p.type || 'produit',
              category: p.category || 'Mat√©riel',
              price: parseFloat(p.price) || 0,
              tva: parseFloat(p.tva) || 20,
              isActive: p.isActive !== false,
              id: p.id
            });
          });
        }
        renderProduits();
        showToast('Supprim√©', 'Produit supprim√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
    }
  } else {
    data.produits = data.produits.filter(p => p.id !== id);
    saveData();
    renderProduits();
    showToast('Supprim√©', 'Produit supprim√©', 'success');
  }
}

// =====================================================
// BON DE COMMANDE
// =====================================================

function toggleEcheances() {
  const payment = document.getElementById('bcPayment').value;
  const echeancesGroup = document.getElementById('echeancesGroup');
  if (payment === 'Pr√©l√®vement' || payment === 'Resto Proxi') {
    echeancesGroup.style.display = 'block';
  } else {
    echeancesGroup.style.display = 'none';
  }
}

function initBonCommande() {
  // Generate order number
  const orderNum = generateBCNumber();
  document.getElementById('bcNumber').value = orderNum;
  
  // Set today's date
  document.getElementById('bcDate').value = new Date().toISOString().split('T')[0];
  
  // Populate client dropdown
  const clientSelect = document.getElementById('bcClient');
  const entreprises = getAccessibleEntreprises();
  clientSelect.innerHTML = '<option value="">-- S√©lectionner un client --</option>' +
    entreprises.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
  
  // Add initial product row
  const container = document.getElementById('bcProductsContainer');
  if (container.children.length === 0) {
    addBCProductRow();
  }
  
  // Reset state
  bcState = { files: [], formData: null };
  renderBCFileList();
  updateBCTotals();
}

function generateBCNumber() {
  const year = new Date().getFullYear();
  const num = (data.lastId.order || 0) + 1;
  return `BC-${year}-${String(num).padStart(4, '0')}`;
}

function fillBCClient() {
  const clientId = parseInt(document.getElementById('bcClient').value);
  if (!clientId) return;
  
  const entreprise = data.entreprises.find(e => String(e.id) === String(clientId));
  if (entreprise) {
    document.getElementById('bcAddress').value = entreprise.address || '';
    document.getElementById('bcCity').value = entreprise.city || '';
    document.getElementById('bcCP').value = entreprise.postalCode || '';
    document.getElementById('bcSiret').value = entreprise.siret || '';
    document.getElementById('bcEnseigne').value = entreprise.enseigne || '';
    
    // Find primary contact
    const contact = data.contacts.find(c => c.entrepriseId === clientId && c.isPrimary) ||
                    data.contacts.find(c => c.entrepriseId === clientId);
    if (contact) {
      document.getElementById('bcSignerFirstName').value = contact.firstName || '';
      document.getElementById('bcSignerLastName').value = contact.lastName || '';
      document.getElementById('bcSignerPhone').value = contact.mobile || contact.phone || '';
      document.getElementById('bcSignerEmail').value = contact.email || '';
      document.getElementById('bcSignerTitle').value = contact.function || '';
    }
  }
}

function addBCProductRow() {
  const container = document.getElementById('bcProductsContainer');
  const index = container.children.length;
  
  // Get all products (catalogue + custom) + packs - filtered by user access
  const allProducts = [
    ...getAccessibleProducts().map(p => ({ ...p, isPack: false })),
    ...(data.produits || []).filter(p => {
      let userAccess = currentUser.accessTypes || [1];
      if (typeof userAccess === 'string') try { userAccess = JSON.parse(userAccess); } catch(e) { userAccess = [1]; }
      if (!Array.isArray(userAccess)) userAccess = [1];
      return currentUser.role === 'admin' || userAccess.includes(p.access || 1);
    }).map(p => ({ ref: p.reference, name: p.name, model: p.model || '', price: p.price, category: p.category, characteristics: p.characteristics || '', notes: p.notes || '', isPack: false }))
  ];
  
  const allPacks = [
    ...getAccessiblePacks().map(p => ({ ref: p.ref, name: p.name, price: p.price, characteristics: p.characteristics || '', notes: p.notes || '', isPack: true })),
    ...(data.packs || []).filter(p => {
      let userAccess = currentUser.accessTypes || [1];
      if (typeof userAccess === 'string') try { userAccess = JSON.parse(userAccess); } catch(e) { userAccess = [1]; }
      if (!Array.isArray(userAccess)) userAccess = [1];
      return currentUser.role === 'admin' || userAccess.includes(p.access || 1);
    }).map(p => ({ ref: p.ref, name: p.name, price: p.price, characteristics: p.characteristics || '', notes: p.notes || '', isPack: true }))
  ];
  
  // Group products by category
  const categories = [...new Set(allProducts.map(p => p.category))];
  
  const row = document.createElement('div');
  row.className = 'bc-product-row';
  row.innerHTML = `
    <div class="bc-product-main">
      <select class="form-control" name="product_${index}" onchange="updateBCProductPrice(this, ${index})" required>
        <option value="">-- S√©lectionner --</option>
        <optgroup label="üì¶ Packs">
          ${allPacks.map(p => '<option value="' + p.ref + '" data-price="' + p.price + '" data-ispack="true" data-characteristics="' + escapeHtml(p.characteristics || '') + '" data-notes="' + escapeHtml(p.notes || '') + '">üì¶ ' + p.ref + ' - ' + p.name + ' (' + formatCurrency(p.price) + ')</option>').join('')}
        </optgroup>
        ${categories.map(cat => 
          '<optgroup label="' + getCategoryIcon(cat) + ' ' + cat + '">' +
            allProducts.filter(p => p.category === cat).map(p => 
              '<option value="' + p.ref + '" data-price="' + p.price + '" data-characteristics="' + escapeHtml(p.characteristics || '') + '" data-notes="' + escapeHtml(p.notes || '') + '">' + p.ref + ' - ' + p.name + (p.model ? ' - ' + p.model : '') + ' (' + formatCurrency(p.price) + ')</option>'
            ).join('') +
          '</optgroup>'
        ).join('')}
      </select>
      <input type="number" class="form-control" name="qty_${index}" value="1" min="1" onchange="updateBCRowTotal(${index})" placeholder="Qt√©">
      <input type="number" class="form-control" name="price_${index}" step="0.01" min="0" onchange="updateBCRowTotal(${index})" placeholder="Prix HT">
      <div class="bc-price-display" id="bcRowTotal_${index}">0,00 ‚Ç¨</div>
      <button type="button" class="bc-remove-btn" onclick="removeBCProductRow(this)">‚úï</button>
    </div>
    <div class="bc-product-characteristics">
      <label>üìã Caract√©ristiques :</label>
      <textarea name="characteristics_${index}" placeholder="Sp√©cifications techniques, options..." rows="1"></textarea>
    </div>
    <div class="bc-product-characteristics">
      <label>üìù Notes :</label>
      <textarea name="notes_${index}" placeholder="Informations compl√©mentaires..." rows="1"></textarea>
    </div>
  `;
  
  container.appendChild(row);
  updateBCTotals();
}

// Escape HTML pour les attributs data-*
function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function getCategoryIcon(category) {
  const icons = {
    'Mat√©riel': 'üíª',
    'Logiciel': 'üìÄ',
    'IoT': 'üì°',
    'Service': 'üîß',
    'Formation': 'üéì',
    'Support': 'üõ†Ô∏è',
    'Consommables': 'üìã',
    'Connectique': 'üîå'
  };
  return icons[category] || 'üì¶';
}

function updateBCProductPrice(select, index) {
  const selectedOption = select.options[select.selectedIndex];
  const price = selectedOption?.dataset.price || 0;
  const characteristics = selectedOption?.dataset.characteristics || '';
  const notes = selectedOption?.dataset.notes || '';
  
  // Mettre √† jour le prix
  const priceInput = document.querySelector('[name="price_' + index + '"]');
  if (priceInput) {
    priceInput.value = price;
    updateBCRowTotal(index);
  }
  
  // Fonction pour d√©coder les entit√©s HTML
  function decodeHtml(text) {
    return text
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'")
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>');
  }
  
  // Pr√©-remplir les caract√©ristiques
  const characteristicsInput = document.querySelector('[name="characteristics_' + index + '"]');
  if (characteristicsInput) {
    characteristicsInput.value = decodeHtml(characteristics);
  }
  
  // Pr√©-remplir les notes
  const notesInput = document.querySelector('[name="notes_' + index + '"]');
  if (notesInput) {
    notesInput.value = decodeHtml(notes);
  }
}

function updateBCRowTotal(index) {
  const qty = parseFloat(document.querySelector(`[name="qty_${index}"]`)?.value) || 0;
  const price = parseFloat(document.querySelector(`[name="price_${index}"]`)?.value) || 0;
  const tva = parseFloat(data.settings.tvaRate) || 20;
  
  const totalHT = qty * price;
  const totalTTC = totalHT * (1 + tva / 100);
  
  const display = document.getElementById(`bcRowTotal_${index}`);
  if (display) {
    display.textContent = formatCurrency(totalTTC);
  }
  
  updateBCTotals();
}

function removeBCProductRow(btn) {
  const row = btn.closest('.bc-product-row');
  if (document.querySelectorAll('.bc-product-row').length > 1) {
    row.remove();
    updateBCTotals();
  } else {
    showToast('Information', 'Au moins un produit requis', 'info');
  }
}

function updateBCTotals() {
  const rows = document.querySelectorAll('.bc-product-row');
  let totalHT = 0;
  let totalQty = 0;
  let productCount = 0;
  
  rows.forEach((row, index) => {
    const select = row.querySelector('select');
    const qty = parseFloat(row.querySelector('[name^="qty_"]')?.value) || 0;
    const price = parseFloat(row.querySelector('[name^="price_"]')?.value) || 0;
    
    if (select?.value) {
      productCount++;
      totalQty += qty;
      totalHT += qty * price;
    }
  });
  
  const tvaRate = parseFloat(data.settings.tvaRate) || 20;
  const totalTVA = totalHT * (tvaRate / 100);
  const totalTTC = totalHT + totalTVA;
  
  document.getElementById('bcStatProducts').textContent = productCount;
  document.getElementById('bcStatQty').textContent = totalQty;
  document.getElementById('bcStatFiles').textContent = bcState.files.length;
  
  document.getElementById('bcTotalHT').textContent = formatCurrency(totalHT);
  document.getElementById('bcTotalTVA').textContent = formatCurrency(totalTVA);
  document.getElementById('bcTotalTTC').textContent = formatCurrency(totalTTC);
}

function handleBCFiles(files) {
  const maxSize = 10 * 1024 * 1024; // 10 Mo
  
  Array.from(files).forEach(file => {
    if (file.size > maxSize) {
      showToast('Erreur', `${file.name} d√©passe 10 Mo`, 'error');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      bcState.files.push({
        name: file.name,
        type: file.type,
        size: file.size,
        data: e.target.result
      });
      renderBCFileList();
      updateBCTotals();
    };
    reader.readAsDataURL(file);
  });
}

function renderBCFileList() {
  const container = document.getElementById('bcFileList');
  if (!container) return;
  
  container.innerHTML = bcState.files.map((f, i) => `
    <div class="bc-file-item">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span>üìÑ</span>
        <div>
          <div style="font-weight: 500;">${f.name}</div>
          <div class="text-muted" style="font-size: 11px;">${formatFileSize(f.size)}</div>
        </div>
      </div>
      <button type="button" class="btn btn-icon sm btn-danger" onclick="removeBCFile(${i})">‚úï</button>
    </div>
  `).join('');
}

function removeBCFile(index) {
  bcState.files.splice(index, 1);
  renderBCFileList();
  updateBCTotals();
}

function previewBC(e) {
  e.preventDefault();
  
  // Collect form data
  const formData = collectBCFormData();
  if (!formData) return;
  
  bcState.formData = formData;
  
  // Render preview
  const content = document.getElementById('bcPreviewContent');
  content.innerHTML = `
    <div style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
      <h4 style="margin-bottom: var(--space-md);">üìã ${formData.orderNumber}</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
        <div>
          <p class="text-muted">Client</p>
          <p><strong>${formData.clientName}</strong></p>
          <p>${formData.address}</p>
        </div>
        <div>
          <p class="text-muted">Signataire</p>
          <p><strong>${formData.signer.firstName} ${formData.signer.lastName}</strong></p>
          <p>${formData.signer.title || '-'}</p>
        </div>
      </div>
    </div>
    
    <table class="table" style="margin-bottom: var(--space-lg);">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Qt√©</th>
          <th>P.U. HT</th>
          <th>Total TTC</th>
        </tr>
      </thead>
      <tbody>
        ${formData.products.map(p => `
          <tr>
            <td>${p.ref} - ${p.name}</td>
            <td>${p.qty}</td>
            <td class="font-mono">${formatCurrency(p.price)}</td>
            <td class="font-mono">${formatCurrency(p.totalTTC)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    
    <div style="display: flex; justify-content: flex-end;">
      <div style="width: 250px;">
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-light);">
          <span class="text-muted">Total HT</span>
          <span class="font-mono">${formatCurrency(formData.totalHT)}</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-light);">
          <span class="text-muted">TVA (${data.settings.tvaRate}%)</span>
          <span class="font-mono">${formatCurrency(formData.totalTVA)}</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: var(--text-lg); font-weight: 700;">
          <span>Total TTC</span>
          <span class="font-mono" style="color: var(--success);">${formatCurrency(formData.totalTTC)}</span>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('bcPreviewModal').classList.add('active');
}

function collectBCFormData() {
  const clientId = parseInt(document.getElementById('bcClient').value);
  if (!clientId) {
    showToast('Erreur', 'Veuillez s√©lectionner un client', 'error');
    return null;
  }
  
  const entreprise = data.entreprises.find(e => String(e.id) === String(clientId));
  const products = [];
  const rows = document.querySelectorAll('.bc-product-row');
  
  const tvaRate = parseFloat(data.settings.tvaRate) || 20;
  let totalHT = 0;
  
  // Combine all catalogs - use accessible products
  const allProducts = [
    ...getAccessibleProducts().map(p => ({ ...p, isPack: false })),
    ...(data.produits || []).map(p => ({ ref: p.reference, name: p.name, price: p.price, isPack: false }))
  ];
  const allPacks = [
    ...getAccessiblePacks().map(p => ({ ...p, isPack: true })),
    ...(data.packs || []).map(p => ({ ...p, isPack: true }))
  ];
  
  rows.forEach((row, index) => {
    const select = row.querySelector('select');
    const qty = parseFloat(row.querySelector('[name^="qty_"]')?.value) || 0;
    const price = parseFloat(row.querySelector('[name^="price_"]')?.value) || 0;
    const characteristics = row.querySelector('[name^="characteristics_"]')?.value || '';
    const itemNotes = row.querySelector('[name^="notes_"]')?.value || '';
    
    if (select?.value && qty > 0) {
      const lineHT = qty * price;
      const lineTTC = lineHT * (1 + tvaRate / 100);
      totalHT += lineHT;
      
      // Check if it's a pack or product
      const pack = allPacks.find(p => p.ref === select.value);
      const product = allProducts.find(p => p.ref === select.value);
      
      if (pack) {
        products.push({
          ref: pack.ref,
          name: 'üì¶ ' + pack.name,
          qty: qty,
          price: price,
          totalHT: lineHT,
          totalTTC: lineTTC,
          isPack: true,
          items: pack.items,
          characteristics: characteristics,
          itemNotes: itemNotes
        });
      } else {
        products.push({
          ref: select.value,
          name: product?.name || select.value,
          qty: qty,
          price: price,
          totalHT: lineHT,
          totalTTC: lineTTC,
          isPack: false,
          characteristics: characteristics,
          itemNotes: itemNotes
        });
      }
    }
  });
  
  if (products.length === 0) {
    showToast('Erreur', 'Ajoutez au moins un produit', 'error');
    return null;
  }
  
  const totalTVA = totalHT * (tvaRate / 100);
  const totalTTC = totalHT + totalTVA;
  
  return {
    orderNumber: document.getElementById('bcNumber').value,
    orderDate: document.getElementById('bcDate').value,
    installDate: document.getElementById('bcInstallDate').value,
    clientId: clientId,
    clientName: entreprise?.name || '',
    enseigne: document.getElementById('bcEnseigne')?.value || '',
    address: document.getElementById('bcAddress').value,
    city: document.getElementById('bcCity')?.value || '',
    cp: document.getElementById('bcCP')?.value || '',
    siret: document.getElementById('bcSiret').value,
    payment: document.getElementById('bcPayment').value,
    echeances: parseInt(document.getElementById('bcEcheances')?.value) || 1,
    signer: {
      firstName: document.getElementById('bcSignerFirstName').value,
      lastName: document.getElementById('bcSignerLastName').value,
      title: document.getElementById('bcSignerTitle').value,
      phone: document.getElementById('bcSignerPhone').value,
      email: document.getElementById('bcSignerEmail').value
    },
    products: products,
    notes: document.getElementById('bcNotes').value,
    files: bcState.files,
    totalHT: totalHT,
    totalTVA: totalTVA,
    totalTTC: totalTTC,
    tvaRate: tvaRate
  };
}

function closeBCPreviewModal() {
  document.getElementById('bcPreviewModal').classList.remove('active');
}

function openBCSignatureModal() {
  closeBCPreviewModal();
  document.getElementById('bcSignatureModal').classList.add('active');
  initBCSignatureCanvas();
}

function closeBCSignatureModal() {
  document.getElementById('bcSignatureModal').classList.remove('active');
}

function initBCSignatureCanvas() {
  bcSignatureCanvas = document.getElementById('bcSignatureCanvas');
  bcSignatureCtx = bcSignatureCanvas.getContext('2d');
  
  // Set canvas size
  const rect = bcSignatureCanvas.getBoundingClientRect();
  bcSignatureCanvas.width = rect.width;
  bcSignatureCanvas.height = rect.height;
  
  // Clear canvas
  bcSignatureCtx.fillStyle = '#1A1A2E';
  bcSignatureCtx.fillRect(0, 0, bcSignatureCanvas.width, bcSignatureCanvas.height);
  
  // Drawing settings
  bcSignatureCtx.strokeStyle = '#F59E0B';
  bcSignatureCtx.lineWidth = 3;
  bcSignatureCtx.lineCap = 'round';
  bcSignatureCtx.lineJoin = 'round';
  
  bcIsDrawing = false;
  bcHasDrawn = false;
  
  // Mouse events
  bcSignatureCanvas.addEventListener('mousedown', bcStartDraw);
  bcSignatureCanvas.addEventListener('mousemove', bcDraw);
  bcSignatureCanvas.addEventListener('mouseup', bcStopDraw);
  bcSignatureCanvas.addEventListener('mouseout', bcStopDraw);
  
  // Touch events
  bcSignatureCanvas.addEventListener('touchstart', bcStartDrawTouch);
  bcSignatureCanvas.addEventListener('touchmove', bcDrawTouch);
  bcSignatureCanvas.addEventListener('touchend', bcStopDraw);
}

function bcStartDraw(e) {
  bcIsDrawing = true;
  bcSignatureCtx.beginPath();
  bcSignatureCtx.moveTo(e.offsetX, e.offsetY);
}

function bcDraw(e) {
  if (!bcIsDrawing) return;
  bcHasDrawn = true;
  bcSignatureCtx.lineTo(e.offsetX, e.offsetY);
  bcSignatureCtx.stroke();
}

function bcStopDraw() {
  bcIsDrawing = false;
}

function bcStartDrawTouch(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = bcSignatureCanvas.getBoundingClientRect();
  bcIsDrawing = true;
  bcSignatureCtx.beginPath();
  bcSignatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}

function bcDrawTouch(e) {
  if (!bcIsDrawing) return;
  e.preventDefault();
  const touch = e.touches[0];
  const rect = bcSignatureCanvas.getBoundingClientRect();
  bcHasDrawn = true;
  bcSignatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
  bcSignatureCtx.stroke();
}

function clearBCSignature() {
  if (bcSignatureCtx) {
    bcSignatureCtx.fillStyle = '#1A1A2E';
    bcSignatureCtx.fillRect(0, 0, bcSignatureCanvas.width, bcSignatureCanvas.height);
    bcHasDrawn = false;
  }
}

function generateBCPDF() {
  const formData = bcState.formData;
  if (!formData) {
    showToast('Erreur', 'Donn√©es du formulaire manquantes', 'error');
    return;
  }
  
  // Generate modern PDF
  generateModernBCPdf(formData, `${currentUser.firstName} ${currentUser.lastName}`);
  
  // Save order
  saveBCOrder(formData);
  
  resetBCForm();
  showToast('Succ√®s', 'Bon de commande g√©n√©r√© et enregistr√©', 'success');
}

// =====================================================
// MODERN PREMIUM PDF GENERATOR
// =====================================================

function generateModernBCPdf(order, commercialName) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  
  const W = 210, H = 297;
  const M = 12;
  const contentWidth = W - 2*M;
  
  // DesClick Brand Colors
  const BLUE = [43, 94, 167];
  const BLUE_DARK = [30, 74, 138];
  const BLUE_LIGHT = [91, 143, 217];
  const ORANGE = [245, 166, 35];
  const GRAY_DARK = [51, 51, 51];
  const GRAY = [102, 102, 102];
  const GRAY_LIGHT = [248, 249, 252];
  const WHITE = [255, 255, 255];
  
  // Format currency for PDF (avoid non-breaking space issues)
  function formatPdfPrice(amount) {
    const num = parseFloat(amount) || 0;
    // Format with space as thousands separator and comma for decimals
    const parts = num.toFixed(2).split('.');
    const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    return intPart + ',' + parts[1] + ' EUR';
  }
  
  // Helper functions
  const setColor = (rgb) => doc.setTextColor(...rgb);
  const setFill = (rgb) => doc.setFillColor(...rgb);
  const setDraw = (rgb) => doc.setDrawColor(...rgb);
  
  // Footer function - called on every page
  function drawFooter() {
    setFill(BLUE);
    doc.rect(0, H - 18, W, 0.8, 'F');
    setFill(ORANGE);
    doc.rect(0, H - 17, W, 0.4, 'F');
    
    doc.setFontSize(7);
    doc.setFont('helvetica', 'bold');
    setColor(BLUE);
    doc.text('S.A.S DC WEB APS', W/2, H - 12, { align: 'center' });
    
    doc.setFont('helvetica', 'normal');
    setColor(GRAY);
    doc.setFontSize(6.5);
    doc.text('Capital: 1 000,00 EUR - RCS Creteil 812 748 440 - SIRET: 812 748 440 00019 - TVA: FR12 812748440', W/2, H - 8, { align: 'center' });
    doc.text('3, rue Lech Walesa, 94270 Le Kremlin-Bicetre - Tel: 01 80 91 60 00 - support@des-click.com - www.des-click.com', W/2, H - 4, { align: 'center' });
  }
  
  // =====================================================
  // PAGE 1 - HEADER
  // =====================================================
  
  // Top decorative band
  setFill(BLUE);
  doc.rect(0, 0, W, 4, 'F');
  setFill(ORANGE);
  doc.rect(0, 4, W, 1.5, 'F');
  
  // =====================================================
  // LOGO DESCLICK (en haut a gauche, juste sous le bandeau)
  // =====================================================
  
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  setColor(BLUE);
  doc.text('Des', M, 14);
  setColor(BLUE_LIGHT);
  doc.text('Click', M + 16, 14);
  
  doc.setFontSize(10);
  setColor(ORANGE);
  doc.text('Formation', M + 19, 19);
  
  // =====================================================
  // TITRE "BON DE COMMANDE" (a droite du logo)
  // =====================================================
  
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  setColor(BLUE);
  doc.text('BON DE COMMANDE', W - M, 15, { align: 'right' });
  
  // Ligne decorative sous le titre (alignee avec le texte)
  setFill(ORANGE);
  doc.rect(W - M - 78, 18, 78, 1.2, 'F');
  
  // =====================================================
  // N¬∞ ET DATE SUR LA MEME LIGNE (bien en dessous)
  // =====================================================
  
  const infoY = 28;
  
  // Bloc N¬∞ (gauche)
  setFill(BLUE);
  doc.roundedRect(M, infoY, 55, 12, 2, 2, 'F');
  
  doc.setFontSize(8);
  setColor(WHITE);
  doc.setFont('helvetica', 'normal');
  doc.text('N. Document', M + 27.5, infoY + 4, { align: 'center' });
  
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.text(order.orderNumber || 'BC-0000', M + 27.5, infoY + 10, { align: 'center' });
  
  // Bloc Date (droite)
  setFill(ORANGE);
  doc.roundedRect(W - M - 55, infoY, 55, 12, 2, 2, 'F');
  
  doc.setFontSize(8);
  setColor(WHITE);
  doc.setFont('helvetica', 'normal');
  doc.text('Date', W - M - 27.5, infoY + 4, { align: 'center' });
  
  doc.setFontSize(11);
  doc.setFont('helvetica', 'bold');
  doc.text(formatDate(order.orderDate || new Date()), W - M - 27.5, infoY + 10, { align: 'center' });
  
  // Conseiller commercial (centre)
  doc.setFontSize(8);
  setColor(GRAY);
  doc.setFont('helvetica', 'normal');
  doc.text('Votre conseiller', W/2, infoY + 3, { align: 'center' });
  doc.setFont('helvetica', 'bold');
  setColor(BLUE);
  doc.setFontSize(10);
  doc.text(commercialName || '-', W/2, infoY + 9, { align: 'center' });
  
  // =====================================================
  // DEUX COLONNES : EMETTEUR & CLIENT
  // =====================================================
  
  const colY = 46;
  const colH = 44;
  const colW = (contentWidth - 8) / 2;
  
  // EMETTEUR (gauche)
  setFill(GRAY_LIGHT);
  doc.roundedRect(M, colY, colW, colH, 3, 3, 'F');
  
  // Header emetteur
  setFill(BLUE);
  doc.roundedRect(M, colY, colW, 9, 3, 3, 'F');
  doc.rect(M, colY + 4, colW, 5, 'F');
  
  doc.setFontSize(9);
  doc.setFont('helvetica', 'bold');
  setColor(WHITE);
  doc.text('EMETTEUR', M + colW/2, colY + 6, { align: 'center' });
  
  // Contenu emetteur
  let ey = colY + 15;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  setColor(BLUE);
  doc.text('DesClick Formation', M + 5, ey);
  
  ey += 5;
  doc.setFontSize(8);
  doc.setFont('helvetica', 'normal');
  setColor(GRAY_DARK);
  doc.text('3, rue Lech Walesa', M + 5, ey);
  ey += 4;
  doc.text('94270 Le Kremlin-Bicetre', M + 5, ey);
  
  ey += 5;
  setColor(GRAY);
  doc.text('Tel: 01 80 91 60 00', M + 5, ey);
  ey += 4;
  doc.text('Email: support@des-click.com', M + 5, ey);
  ey += 4;
  doc.text('Web: www.des-click.com', M + 5, ey);
  
  // CLIENT (droite)
  const clientX = M + colW + 8;
  setFill(GRAY_LIGHT);
  doc.roundedRect(clientX, colY, colW, colH, 3, 3, 'F');
  
  // Header client
  setFill(ORANGE);
  doc.roundedRect(clientX, colY, colW, 9, 3, 3, 'F');
  doc.rect(clientX, colY + 4, colW, 5, 'F');
  
  doc.setFontSize(9);
  doc.setFont('helvetica', 'bold');
  setColor(WHITE);
  doc.text('CLIENT', clientX + colW/2, colY + 6, { align: 'center' });
  
  // Contenu client
  let cy = colY + 15;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  setColor(GRAY_DARK);
  doc.text((order.clientName || '-').substring(0, 35), clientX + 5, cy);
  
  if (order.enseigne) {
    cy += 4;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    setColor(GRAY);
    doc.text(order.enseigne, clientX + 5, cy);
  }
  
  cy += 5;
  doc.setFontSize(8);
  doc.setFont('helvetica', 'normal');
  setColor(GRAY_DARK);
  if (order.address) doc.text(order.address.substring(0, 40), clientX + 5, cy);
  
  cy += 4;
  const cityLine = [order.cp, order.city].filter(Boolean).join(' ');
  if (cityLine) doc.text(cityLine.substring(0, 40), clientX + 5, cy);
  
  cy += 5;
  if (order.siret) {
    doc.setFont('helvetica', 'bold');
    setColor(GRAY);
    doc.text('SIRET: ', clientX + 5, cy);
    doc.setFont('helvetica', 'normal');
    doc.text(order.siret, clientX + 18, cy);
  }
  
  cy += 5;
  if (order.signer) {
    setColor(BLUE);
    doc.setFont('helvetica', 'bold');
    const signerName = [order.signer.firstName, order.signer.lastName].filter(Boolean).join(' ');
    doc.text(signerName, clientX + 5, cy);
    
    if (order.signer.phone || order.signer.email) {
      cy += 4;
      doc.setFont('helvetica', 'normal');
      setColor(GRAY);
      const contactInfo = [order.signer.phone, order.signer.email].filter(Boolean).join(' - ');
      doc.text(contactInfo.substring(0, 45), clientX + 5, cy);
    }
  }
  
  // =====================================================
  // TABLEAU DES PRODUITS AVEC DETAIL DES PACKS
  // =====================================================
  
  let tableY = 93;
  const products = order.products || [];
  
  // En-tete tableau
  setFill(BLUE);
  doc.roundedRect(M, tableY, contentWidth, 9, 2, 2, 'F');
  doc.rect(M, tableY + 4, contentWidth, 5, 'F');
  
  doc.setFontSize(8);
  doc.setFont('helvetica', 'bold');
  setColor(WHITE);
  doc.text('DESIGNATION', M + 4, tableY + 6);
  doc.text('QTE', M + 115, tableY + 6);
  doc.text('P.U. HT', M + 132, tableY + 6);
  doc.text('TOTAL HT', M + 160, tableY + 6);
  
  // Lignes du tableau
  let rowY = tableY + 12;
  const rowH = 7;
  
  // Bordure tableau
  setDraw([220, 220, 220]);
  doc.setLineWidth(0.2);
  
  products.forEach((p, i) => {
    // Verifier si on a besoin d'une nouvelle page
    if (rowY > H - 70) {
      drawFooter();
      doc.addPage();
      rowY = 20;
      
      // Re-afficher l'en-tete du tableau
      setFill(BLUE);
      doc.roundedRect(M, rowY, contentWidth, 9, 2, 2, 'F');
      doc.rect(M, rowY + 4, contentWidth, 5, 'F');
      
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      setColor(WHITE);
      doc.text('DESIGNATION', M + 4, rowY + 6);
      doc.text('QTE', M + 115, rowY + 6);
      doc.text('P.U. HT', M + 132, rowY + 6);
      doc.text('TOTAL HT', M + 160, rowY + 6);
      
      rowY += 12;
    }
    
    // Fond alterne
    if (i % 2 === 0) {
      setFill(GRAY_LIGHT);
      doc.rect(M, rowY - 1, contentWidth, rowH + 1, 'F');
    }
    
    doc.setFontSize(8);
    
    // Nom du produit
    let pName = (p.name || '').replace('üì¶ ', '');
    const isPack = p.isPack || pName.toLowerCase().includes('pack');
    
    if (isPack) {
      // Style pack - en gras avec icone
      doc.setFont('helvetica', 'bold');
      setColor(ORANGE);
      doc.text('[PACK]', M + 3, rowY + 4);
      setColor(BLUE_DARK);
      doc.text(pName.substring(0, 50), M + 18, rowY + 4);
    } else {
      doc.setFont('helvetica', 'normal');
      setColor(GRAY_DARK);
      doc.text(pName.substring(0, 60), M + 4, rowY + 4);
    }
    
    // Quantite
    doc.setFont('helvetica', 'normal');
    setColor(GRAY_DARK);
    doc.text(String(p.qty || 1), M + 118, rowY + 4);
    
    // Prix unitaire
    doc.text(formatPdfPrice(p.price || 0), M + 130, rowY + 4);
    
    // Total ligne
    doc.setFont('helvetica', 'bold');
    setColor(BLUE);
    doc.text(formatPdfPrice(p.totalHT || 0), contentWidth + M - 2, rowY + 4, { align: 'right' });
    
    rowY += rowH;
    
    // Si c'est un pack, afficher le detail des elements (SANS les prix) EN PREMIER
    if (isPack && p.items && p.items.length > 0) {
      p.items.forEach(item => {
        // Verifier pagination
        if (rowY > H - 70) {
          drawFooter();
          doc.addPage();
          rowY = 25;
        }
        
        // Fond legerement different pour les items du pack
        setFill([252, 252, 255]);
        doc.rect(M, rowY - 1, contentWidth, rowH - 1, 'F');
        
        // Trouver le nom du produit
        const itemProduct = PRODUCT_CATALOGUE.find(pr => pr.ref === item.ref) || 
                           (data.produits || []).find(pr => pr.reference === item.ref);
        const itemName = itemProduct ? itemProduct.name : item.ref;
        
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        setColor(GRAY);
        doc.text('    - ' + itemName.substring(0, 55), M + 8, rowY + 3);
        doc.text('x' + (item.qty || 1), M + 118, rowY + 3);
        // PAS de prix pour les elements du pack
        
        rowY += rowH - 1;
      });
    }
    
    // =====================================================
    // CARACTERISTIQUES DU PRODUIT (APRES les elements du pack)
    // =====================================================
    if (p.characteristics && p.characteristics.trim()) {
      // Verifier pagination
      if (rowY > H - 70) {
        drawFooter();
        doc.addPage();
        rowY = 25;
      }
      
      // Fond subtil pour les caracteristiques
      setFill([248, 250, 255]);
      
      doc.setFontSize(7);
      doc.setFont('helvetica', 'italic');
      setColor([80, 90, 120]);
      
      // Decouper le texte en lignes - AFFICHAGE COMPLET
      const charMaxWidth = contentWidth - 10;
      const charLines = doc.splitTextToSize(p.characteristics, charMaxWidth);
      const charHeight = charLines.length * 4 + 2;
      
      doc.rect(M, rowY - 1, contentWidth, charHeight, 'F');
      
      // Afficher TOUTES les lignes
      charLines.forEach((line, idx) => {
        doc.text('    ' + line, M + 4, rowY + 3 + (idx * 4));
      });
      
      rowY += charHeight;
    }
    
    // Les NOTES seront collectees et affichees en pied de document
  });
  
  // Bordure du tableau
  const tableEndY = rowY;
  setDraw([200, 200, 200]);
  doc.setLineWidth(0.3);
  doc.rect(M, tableY, contentWidth, tableEndY - tableY);
  
  // Lignes verticales
  doc.line(M + 112, tableY, M + 112, tableEndY);
  doc.line(M + 128, tableY, M + 128, tableEndY);
  doc.line(M + 155, tableY, M + 155, tableEndY);
  
  // =====================================================
  // TOTAUX + NOTES DES PRODUITS
  // =====================================================
  
  let totY = rowY + 6;
  
  // Verifier pagination pour les totaux
  if (totY > H - 90) {
    drawFooter();
    doc.addPage();
    totY = 20;
  }
  
  // Collecter toutes les notes des produits
  const allProductNotes = [];
  products.forEach(p => {
    if (p.itemNotes && p.itemNotes.trim()) {
      const productName = (p.name || '').replace('üì¶ ', '');
      allProductNotes.push({ name: productName, note: p.itemNotes.trim() });
    }
  });
  
  // Definir les dimensions - COMPACTES
  const notesBlockWidth = 95;
  let totX = M + notesBlockWidth + 3;
  let totW = contentWidth - notesBlockWidth - 3;
  let rightBlockHeight = 50; // TTC (28) + Mode reglement (15) + espaces
  
  // =====================================================
  // BLOC NOTES (a gauche) - Compact
  // =====================================================
  
  if (allProductNotes.length > 0) {
    const noteMaxWidth = notesBlockWidth - 6;
    
    doc.setFontSize(7);
    doc.setFont('helvetica', 'bold');
    setColor(BLUE);
    doc.text('NOTES', M, totY + 2);
    
    setFill([255, 252, 245]);
    doc.roundedRect(M, totY + 5, notesBlockWidth, rightBlockHeight - 1, 2, 2, 'F');
    setDraw([200, 180, 120]);
    doc.setLineWidth(0.2);
    doc.roundedRect(M, totY + 5, notesBlockWidth, rightBlockHeight - 1, 2, 2, 'S');
    
    doc.setFontSize(6);
    setColor([80, 70, 40]);
    
    let noteY = totY + 10;
    const maxNoteY = totY + rightBlockHeight - 2;
    
    allProductNotes.forEach((item) => {
      if (noteY < maxNoteY - 6) {
        doc.setFont('helvetica', 'bold');
        const displayName = item.name.length > 22 ? item.name.substring(0, 20) + '..' : item.name;
        doc.text('‚Ä¢ ' + displayName + ':', M + 2, noteY);
        noteY += 3;
        
        doc.setFont('helvetica', 'normal');
        const noteLines = doc.splitTextToSize(item.note, noteMaxWidth - 2);
        noteLines.forEach((line) => {
          if (noteY < maxNoteY) {
            doc.text('  ' + line, M + 2, noteY);
            noteY += 3;
          }
        });
        noteY += 1;
      }
    });
  } else {
    totX = M + 100;
    totW = contentWidth - 100;
  }
  
  // =====================================================
  // BLOC TOTAUX (a droite) - Compact
  // =====================================================
  
  setFill(GRAY_LIGHT);
  doc.roundedRect(totX, totY + 5, totW, 22, 2, 2, 'F');
  
  doc.setFontSize(8);
  doc.setFont('helvetica', 'normal');
  setColor(GRAY);
  doc.text('Sous-total HT', totX + 4, totY + 11);
  setColor(GRAY_DARK);
  doc.text(formatPdfPrice(order.totalHT || 0), totX + totW - 4, totY + 11, { align: 'right' });
  
  setColor(GRAY);
  doc.text('TVA (' + (order.tvaRate || 20) + '%)', totX + 4, totY + 17);
  setColor(GRAY_DARK);
  doc.text(formatPdfPrice(order.totalTVA || 0), totX + totW - 4, totY + 17, { align: 'right' });
  
  setFill(BLUE);
  doc.roundedRect(totX, totY + 20, totW, 8, 2, 2, 'F');
  
  doc.setFontSize(9);
  doc.setFont('helvetica', 'bold');
  setColor(WHITE);
  doc.text('TOTAL TTC', totX + 4, totY + 26);
  doc.text(formatPdfPrice(order.totalTTC || 0), totX + totW - 4, totY + 26, { align: 'right' });
  
  // =====================================================
  // MODE DE REGLEMENT (a droite, sous TTC) - Compact
  // =====================================================
  
  const payY = totY + 34;
  
  doc.setFontSize(7);
  doc.setFont('helvetica', 'bold');
  setColor(BLUE);
  doc.text('MODE DE REGLEMENT', totX, payY);
  
  setFill(GRAY_LIGHT);
  doc.roundedRect(totX, payY + 3, totW, 12, 2, 2, 'F');
  setDraw(BLUE);
  doc.setLineWidth(0.2);
  doc.roundedRect(totX, payY + 3, totW, 12, 2, 2, 'S');
  
  doc.setFontSize(7);
  doc.setFont('helvetica', 'normal');
  setColor(GRAY);
  doc.text('Mode:', totX + 3, payY + 10);
  
  doc.setFont('helvetica', 'bold');
  setColor(GRAY_DARK);
  let paymentMode = order.payment || 'Non specifie';
  doc.text(paymentMode, totX + 15, payY + 10);
  
  doc.setFont('helvetica', 'normal');
  setColor(GRAY);
  doc.text('| Ech:', totX + 42, payY + 10);
  
  doc.setFont('helvetica', 'bold');
  setColor(GRAY_DARK);
  const echeanceText = order.echeances && order.echeances > 1 
    ? order.echeances + 'x' + formatPdfPrice((order.totalTTC || 0) / order.echeances)
    : 'Comptant';
  doc.text(echeanceText, totX + 53, payY + 10);
  
  // =====================================================
  // OBSERVATIONS - Compact (sur une ligne)
  // =====================================================
  
  const obsY = totY + rightBlockHeight + 8;
  
  doc.setFontSize(7);
  doc.setFont('helvetica', 'bold');
  setColor(BLUE);
  doc.text('OBSERVATIONS', M, obsY);
  
  // Hauteur adaptee mais limitee
  let obsHeight = 10;
  let obsLines = [];
  if (order.notes && order.notes.trim()) {
    obsLines = doc.splitTextToSize(order.notes, contentWidth - 8);
    obsHeight = Math.min(Math.max(10, obsLines.length * 3 + 4), 18);
  }
  
  setFill([255, 255, 250]);
  doc.roundedRect(M, obsY + 3, contentWidth, obsHeight, 2, 2, 'F');
  setDraw(BLUE);
  doc.setLineWidth(0.2);
  doc.roundedRect(M, obsY + 3, contentWidth, obsHeight, 2, 2, 'S');
  
  if (order.notes && order.notes.trim()) {
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    setColor(GRAY_DARK);
    obsLines.slice(0, 4).forEach((line, i) => {
      doc.text(line, M + 3, obsY + 8 + (i * 3));
    });
  } else {
    doc.setFontSize(7);
    doc.setFont('helvetica', 'italic');
    setColor(GRAY);
    doc.text('Aucune observation', M + 3, obsY + 9);
  }
  
  // =====================================================
  // MENTIONS LEGALES
  // =====================================================
  
  const legalY = obsY + obsHeight + 8;
  
  doc.setFontSize(6);
  doc.setFont('helvetica', 'normal');
  setColor(GRAY);
  doc.text("En validant ce document, le client reconnait avoir pris connaissance des conditions generales de vente disponibles sur www.des-click.com et les accepte sans reserve.", W/2, legalY, { align: 'center' });
  doc.text("Conformement a l'article L.221-28 du Code de la Consommation, le client renonce expressement a son droit de retractation pour les prestations de services pleinement executees.", W/2, legalY + 3, { align: 'center' });
  
  // =====================================================
  // FOOTER
  // =====================================================
  
  drawFooter();
  
  // Save the PDF
  doc.save('DesClick-BC-' + (order.orderNumber || 'draft') + '.pdf');
}

async function saveBCOrder(formData) {
  const orderData = {
    ...formData,
    ownerName: currentUser.firstName + ' ' + currentUser.lastName
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.createCommande(orderData);
      if (result.success) {
        // Recharger les commandes
        const commandesRes = await api.getCommandes();
        if (commandesRes.success) {
          data.orders = commandesRes.data;
        }
        logActivity('order', 'Bon de commande cr√©√©: ' + formData.orderNumber + ' - ' + formatCurrency(formData.totalTTC));
        return true;
      } else {
        showToast('Erreur', result.message || 'Erreur lors de l\'enregistrement', 'error');
        return false;
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
      return false;
    }
  } else {
    data.lastId.order = (data.lastId.order || 0) + 1;
    
    const order = {
      id: data.lastId.order,
      ...orderData,
      ownerId: currentUser.id,
      createdAt: new Date().toISOString()
    };
    
    if (!data.orders) data.orders = [];
    data.orders.push(order);
    
    logActivity('order', 'Bon de commande cr√©√©: ' + formData.orderNumber + ' - ' + formatCurrency(formData.totalTTC));
    saveData();
    return true;
  }
}

function resetBCForm() {
  document.getElementById('bcForm').reset();
  document.getElementById('bcProductsContainer').innerHTML = '';
  bcState = { files: [], formData: null };
  initBonCommande();
}

function openBCHistory() {
  let orders = data.orders || [];
  if (currentUser.role !== 'admin') {
    orders = orders.filter(o => String(o.ownerId) === String(currentUser.id));
  }
  
  const content = document.getElementById('bcHistoryContent');
  
  if (orders.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìö</div>
        <h3 class="empty-state-title">Aucune commande</h3>
        <p class="empty-state-text">L'historique est vide</p>
      </div>
    `;
  } else {
    content.innerHTML = `
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>N¬∞ Commande</th>
              <th>Date</th>
              <th>Client</th>
              <th>Montant TTC</th>
              <th>Commercial</th>
            </tr>
          </thead>
          <tbody>
            ${orders.reverse().map(o => `
              <tr>
                <td><code>${o.orderNumber}</code></td>
                <td>${formatDate(o.orderDate)}</td>
                <td>${o.clientName}</td>
                <td class="font-mono" style="color: var(--success); font-weight: 600;">${formatCurrency(o.totalTTC)}</td>
                <td>${o.ownerName || '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  
  document.getElementById('bcHistoryModal').classList.add('active');
}

function closeBCHistoryModal() {
  document.getElementById('bcHistoryModal').classList.remove('active');
}

function clearBCHistory() {
  if (!confirm('Supprimer tout l\'historique des commandes ?')) return;
  data.orders = [];
  saveData();
  closeBCHistoryModal();
  showToast('Supprim√©', 'Historique vid√©', 'success');
}

function exportBCHistory() {
  const orders = data.orders || [];
  if (orders.length === 0) {
    showToast('Info', 'Aucune commande √† exporter', 'info');
    return;
  }
  
  const headers = ['N¬∞ Commande', 'Date', 'Client', 'Adresse', 'Total HT', 'TVA', 'Total TTC', 'Commercial'];
  const rows = orders.map(o => [
    o.orderNumber,
    o.orderDate,
    o.clientName,
    o.address,
    o.totalHT,
    o.totalTVA,
    o.totalTTC,
    o.ownerName || ''
  ]);
  
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'historique_commandes.csv', 'text/csv');
  showToast('Export√©', 'Fichier CSV t√©l√©charg√©', 'success');
}

// =====================================================
// MESSAGERIE
// =====================================================

function renderMessaging() {
  renderConversations();
}

function renderConversations() {
  const users = (data.users || []).filter(u => u.id !== currentUser.id && u.isActive);
  const container = document.getElementById('conversationsList');
  
  if (users.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 2rem;">
        <p class="text-muted">Aucun utilisateur disponible</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = users.map(u => {
    const messages = getConversationMessages(currentUser.id, u.id);
    const lastMsg = messages[messages.length - 1];
    const unread = messages.filter(m => m.toId === currentUser.id && !m.read).length;
    
    return `
      <div class="conversation-item ${currentChat === u.id ? 'active' : ''} ${unread > 0 ? 'unread' : ''}" 
           onclick="openChat(${u.id})">
        <div class="conversation-avatar">${(u.firstName[0] + u.lastName[0]).toUpperCase()}</div>
        <div class="conversation-info">
          <div class="conversation-name">${u.firstName} ${u.lastName}</div>
          <div class="conversation-preview">${lastMsg?.content || 'Aucun message'}</div>
        </div>
        <div class="conversation-meta">
          <div class="conversation-time">${lastMsg ? formatTime(lastMsg.date) : ''}</div>
          ${unread > 0 ? '<div class="conversation-unread"></div>' : ''}
        </div>
      </div>
    `;
  }).join('');
}

function getConversationMessages(userId1, userId2) {
  return (data.messages || []).filter(m =>
    (m.fromId === userId1 && m.toId === userId2) ||
    (m.fromId === userId2 && m.toId === userId1)
  ).sort((a, b) => new Date(a.date) - new Date(b.date));
}

function openChat(userId) {
  currentChat = userId;
  const user = data.users.find(u => String(u.id) === String(userId));
  
  // Update header
  document.getElementById('chatHeaderInfo').innerHTML = `
    <strong>${user.firstName} ${user.lastName}</strong>
    <span class="text-muted" style="margin-left: 8px;">${user.role === 'admin' ? 'Admin' : 'Commercial'}</span>
  `;
  
  // Mark messages as read
  (data.messages || []).forEach(m => {
    if (m.fromId === userId && m.toId === currentUser.id) {
      m.read = true;
    }
  });
  saveData();
  
  renderChatMessages();
  renderConversations();
  updateNotificationBadges();
}

function renderChatMessages() {
  if (!currentChat) return;
  
  const messages = getConversationMessages(currentUser.id, currentChat);
  const container = document.getElementById('chatMessages');
  
  if (messages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üí¨</div>
        <h3 class="empty-state-title">Nouvelle conversation</h3>
        <p class="empty-state-text">Envoyez votre premier message</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = messages.map(m => `
    <div class="chat-message ${m.fromId === currentUser.id ? 'sent' : 'received'}">
      <div>${m.content}</div>
      <div class="chat-message-time">${formatTime(m.date)}</div>
    </div>
  `).join('');
  
  // Scroll to bottom
  container.scrollTop = container.scrollHeight;
}

function handleChatKeypress(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    sendChatMessage();
  }
}

function sendChatMessage() {
  if (!currentChat) {
    showToast('Info', 'S√©lectionnez un destinataire', 'info');
    return;
  }
  
  const input = document.getElementById('chatInput');
  const content = input.value.trim();
  if (!content) return;
  
  if (!data.messages) data.messages = [];
  data.lastId.message = (data.lastId.message || 0) + 1;
  
  data.messages.push({
    id: data.lastId.message,
    fromId: currentUser.id,
    toId: currentChat,
    content: content,
    read: false,
    date: new Date().toISOString()
  });
  
  saveData();
  input.value = '';
  renderChatMessages();
  renderConversations();
}

// =====================================================
// ALERTES
// =====================================================

// =====================================================
// SYST√àME D'ALERTES MULTICANAL
// =====================================================

// Filtres actifs
let alertFilters = { type: 'all', priority: 'all', status: 'all' };
let selectedAlertId = null;
let notificationPanelFilter = 'all';

// G√©n√©ration r√©f√©rence unique
function generateAlertReference() {
  const year = new Date().getFullYear();
  const count = ((data.alertes || []).length + 1).toString().padStart(6, '0');
  return 'ALT-' + year + '-' + count;
}

// Rendu des alertes
function renderAlertes() {
  let alertes = data.alertes || [];
  
  // Filtrer par utilisateur si pas admin
  if (currentUser.role !== 'admin') {
    alertes = alertes.filter(a => {
      if (!a.recipients) return a.toId === 0 || a.toId === currentUser.id;
      return a.recipients.includes('all') || a.recipients.includes(currentUser.id.toString());
    });
  }
  
  // Appliquer les filtres
  if (alertFilters.type !== 'all') {
    alertes = alertes.filter(a => a.type === alertFilters.type);
  }
  if (alertFilters.priority !== 'all') {
    alertes = alertes.filter(a => a.priority === alertFilters.priority);
  }
  if (alertFilters.status !== 'all') {
    alertes = alertes.filter(a => a.status === alertFilters.status);
  }
  
  // Mettre √† jour les stats
  updateAlertStats();
  
  const container = document.getElementById('alertsList');
  if (!container) return;
  
  if (alertes.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîî</div><h3 class="empty-state-title">Aucune alerte</h3><p class="empty-state-text">Vous √™tes √† jour !</p></div>';
    return;
  }
  
  container.innerHTML = alertes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(a => {
    const isRead = isAlertRead(a);
    const sender = data.users.find(u => String(u.id) === String(a.senderId)) || { firstName: 'Syst√®me', lastName: '' };
    
    return '<div class="alert-card priority-' + a.priority + ' ' + (isRead ? '' : 'unread') + ' ' + (selectedAlertId === a.id ? 'selected' : '') + '" onclick="selectAlert(' + a.id + ')">' +
      '<div class="alert-card-header">' +
        '<div class="alert-card-badges">' +
          '<span class="alert-type-badge type-' + a.type + '">' + getAlertTypeIcon(a.type) + ' ' + getAlertTypeLabel(a.type) + '</span>' +
          '<span class="alert-priority-badge priority-' + a.priority + '">' + getPriorityLabel(a.priority) + '</span>' +
        '</div>' +
        '<span class="alert-card-time">' + formatRelativeTime(a.createdAt) + '</span>' +
      '</div>' +
      '<h4 class="alert-card-title">' + a.title + '</h4>' +
      '<p class="alert-card-excerpt">' + truncateText(a.content, 120) + '</p>' +
      '<div class="alert-card-footer">' +
        '<div class="alert-card-sender">' +
          '<span>' + sender.firstName + ' ' + sender.lastName + '</span>' +
        '</div>' +
        '<div class="alert-status-indicator">' +
          getStatusIcon(a.status) + ' ' + getStatusLabel(a.status) +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

function updateAlertStats() {
  let alertes = data.alertes || [];
  
  if (currentUser.role !== 'admin') {
    alertes = alertes.filter(a => {
      if (!a.recipients) return a.toId === 0 || a.toId === currentUser.id;
      return a.recipients.includes('all') || a.recipients.includes(currentUser.id.toString());
    });
  }
  
  const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
  
  el('statTotalAlerts', alertes.length);
  el('statUnreadAlerts', alertes.filter(a => !isAlertRead(a)).length);
  el('statUrgentAlerts', alertes.filter(a => a.type === 'urgent' || a.priority === 'critical').length);
  el('statPendingAlerts', alertes.filter(a => a.status === 'sent' || a.status === 'read').length);
  el('statResolvedAlerts', alertes.filter(a => a.status === 'resolved').length);
}

function selectAlert(id) {
  selectedAlertId = id;
  renderAlertes();
  showAlertDetail(id);
}

function showAlertDetail(id) {
  const alert = (data.alertes || []).find(a => String(a.id) === String(id));
  if (!alert) return;
  
  // Marquer comme lue
  if (!isAlertRead(alert)) {
    markAlertRead(id);
  }
  
  const panel = document.getElementById('alertDetailPanel');
  if (!panel) return;
  panel.style.display = 'block';
  
  // Remplir les d√©tails
  document.getElementById('alertDetailRef').textContent = alert.reference || 'ALT-' + alert.id;
  
  const typeEl = document.getElementById('alertDetailType');
  typeEl.className = 'alert-type-badge type-' + alert.type;
  typeEl.textContent = getAlertTypeIcon(alert.type) + ' ' + getAlertTypeLabel(alert.type);
  
  const prioEl = document.getElementById('alertDetailPriority');
  prioEl.className = 'alert-priority-badge priority-' + alert.priority;
  prioEl.textContent = getPriorityLabel(alert.priority);
  
  document.getElementById('alertDetailTitle').textContent = alert.title;
  document.getElementById('alertDetailContent').textContent = alert.content;
  
  // Contexte
  const ctxEl = document.getElementById('alertDetailContext');
  if (alert.contextType && alert.contextId) {
    ctxEl.style.display = 'inline-flex';
    document.getElementById('alertDetailContextText').textContent = alert.contextType + ' #' + alert.contextId;
    ctxEl.href = '#';
    ctxEl.onclick = () => navigateToContext(alert.contextType, alert.contextId);
  } else {
    ctxEl.style.display = 'none';
  }
  
  // Canaux
  const channels = alert.channels || { crm: 'sent', email: 'pending', teams: 'pending' };
  updateChannelStatus('channelCRM', channels.crm);
  updateChannelStatus('channelEmail', channels.email);
  updateChannelStatus('channelTeams', channels.teams);
  
  // Messages / Thread
  renderAlertThread(alert);
  
  // Boutons d'action
  updateAlertActionButtons(alert);
}

function updateChannelStatus(elementId, status) {
  const el = document.getElementById(elementId);
  if (!el) return;
  const span = el.querySelector('span');
  if (span) span.textContent = getChannelStatusLabel(status);
  el.className = 'alert-channel ' + status;
}

function getChannelStatusLabel(status) {
  const labels = { pending: 'En attente', sent: 'Envoy√©', delivered: 'Livr√©', failed: '√âchec' };
  return labels[status] || status;
}

function renderAlertThread(alert) {
  const container = document.getElementById('alertThreadMessages');
  if (!container) return;
  
  const messages = alert.messages || [];
  
  if (messages.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;">Aucun message dans cette discussion</div>';
    return;
  }
  
  container.innerHTML = messages.map(m => {
    const author = data.users.find(u => String(u.id) === String(m.authorId)) || { firstName: 'Inconnu', lastName: '' };
    const isOwn = m.authorId === currentUser.id;
    
    return '<div class="thread-message ' + (isOwn ? 'own' : '') + '">' +
      '<div class="thread-message-header">' +
        '<span class="thread-message-author">' + author.firstName + ' ' + author.lastName + '</span>' +
        '<span class="thread-message-source">via ' + getChannelIcon(m.source || 'crm') + '</span>' +
        '<span class="thread-message-time">' + formatDateTime(m.createdAt) + '</span>' +
      '</div>' +
      '<div class="thread-message-content">' + m.content + '</div>' +
    '</div>';
  }).join('');
  
  container.scrollTop = container.scrollHeight;
}

function getChannelIcon(channel) {
  const icons = { crm: 'üíª', email: 'üìß', teams: 'üí¨' };
  return icons[channel] || 'üí¨';
}

function updateAlertActionButtons(alert) {
  const btnAck = document.getElementById('btnAcknowledge');
  const btnProg = document.getElementById('btnInProgress');
  const btnResolve = document.getElementById('btnResolve');
  
  if (btnAck) btnAck.disabled = alert.status !== 'sent' && alert.status !== 'read';
  if (btnProg) btnProg.disabled = alert.status === 'resolved' || alert.status === 'in_progress';
  if (btnResolve) btnResolve.disabled = alert.status === 'resolved';
}

function sendAlertReply() {
  if (!selectedAlertId) return;
  
  const input = document.getElementById('alertReplyInput');
  const content = input.value.trim();
  if (!content) return;
  
  const alert = (data.alertes || []).find(a => String(a.id) === String(selectedAlertId));
  if (!alert) return;
  
  if (!alert.messages) alert.messages = [];
  
  alert.messages.push({
    id: Date.now(),
    authorId: currentUser.id,
    content: content,
    source: 'crm',
    createdAt: new Date().toISOString()
  });
  
  // Simuler envoi aux autres canaux
  simulateChannelSync(alert, content);
  
  saveData();
  input.value = '';
  renderAlertThread(alert);
  showToast('Envoy√©', 'Votre r√©ponse a √©t√© envoy√©e', 'success');
}

function acknowledgeAlert() {
  if (!selectedAlertId) return;
  const alert = (data.alertes || []).find(a => String(a.id) === String(selectedAlertId));
  if (!alert) return;
  
  alert.status = 'acknowledged';
  alert.acknowledgedAt = new Date().toISOString();
  alert.acknowledgedBy = currentUser.id;
  
  addSystemMessage(alert, currentUser.firstName + ' ' + currentUser.lastName + ' a accus√© r√©ception');
  
  saveData();
  renderAlertes();
  showAlertDetail(selectedAlertId);
  showToast('Confirm√©', 'R√©ception accus√©e', 'success');
}

function setAlertInProgress() {
  if (!selectedAlertId) return;
  const alert = (data.alertes || []).find(a => String(a.id) === String(selectedAlertId));
  if (!alert) return;
  
  alert.status = 'in_progress';
  addSystemMessage(alert, currentUser.firstName + ' ' + currentUser.lastName + ' a marqu√© l\'alerte en cours de traitement');
  
  saveData();
  renderAlertes();
  showAlertDetail(selectedAlertId);
  showToast('Mis √† jour', 'Alerte en cours de traitement', 'info');
}

function resolveAlert() {
  if (!selectedAlertId) return;
  const alert = (data.alertes || []).find(a => String(a.id) === String(selectedAlertId));
  if (!alert) return;
  
  alert.status = 'resolved';
  alert.resolvedAt = new Date().toISOString();
  alert.resolvedBy = currentUser.id;
  
  addSystemMessage(alert, currentUser.firstName + ' ' + currentUser.lastName + ' a r√©solu l\'alerte');
  
  saveData();
  renderAlertes();
  showAlertDetail(selectedAlertId);
  showToast('R√©solu', 'Alerte marqu√©e comme r√©solue', 'success');
}

function escalateAlert() {
  if (!selectedAlertId) return;
  const alert = (data.alertes || []).find(a => String(a.id) === String(selectedAlertId));
  if (!alert) return;
  
  alert.priority = 'critical';
  alert.escalatedAt = new Date().toISOString();
  alert.escalatedBy = currentUser.id;
  
  addSystemMessage(alert, currentUser.firstName + ' ' + currentUser.lastName + ' a escalad√© l\'alerte en CRITIQUE');
  
  // Ajouter l'admin aux destinataires
  if (!alert.recipients) alert.recipients = [];
  if (!alert.recipients.includes('admin')) alert.recipients.push('admin');
  
  saveData();
  renderAlertes();
  showAlertDetail(selectedAlertId);
  showToast('Escalad√©', 'Alerte escalad√©e en priorit√© critique', 'warning');
}

function addSystemMessage(alert, content) {
  if (!alert.messages) alert.messages = [];
  alert.messages.push({
    id: Date.now(),
    authorId: 0,
    content: 'üìå ' + content,
    source: 'system',
    isSystem: true,
    createdAt: new Date().toISOString()
  });
}

function simulateChannelSync(alert, content) {
  // Simuler envoi email et Teams
  setTimeout(() => {
    alert.channels = alert.channels || {};
    alert.channels.email = 'sent';
    alert.channels.teams = 'sent';
    saveData();
  }, 1000);
}

function filterAlerts(filterType, value, btn) {
  alertFilters[filterType] = value;
  
  // Mettre √† jour les boutons actifs
  if (btn) {
    btn.parentElement.querySelectorAll('.alert-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  
  renderAlertes();
}

// Helpers
function getAlertTypeIcon(type) {
  const icons = { information: '‚ÑπÔ∏è', action_required: '‚ö°', urgent: 'üö®', validation: '‚úÖ', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è', success: '‚úÖ', danger: '‚ùå' };
  return icons[type] || '‚ÑπÔ∏è';
}

function getAlertTypeLabel(type) {
  const labels = { information: 'Information', action_required: 'Action requise', urgent: 'Urgent', validation: 'Validation', info: 'Info', warning: 'Attention', success: 'Succ√®s', danger: 'Urgent' };
  return labels[type] || type;
}

function getAlertTypeColor(type) {
  const colors = { information: '#3B82F6', action_required: '#F59E0B', urgent: '#EF4444', validation: '#10B981', info: '#3B82F6', warning: '#F59E0B', success: '#10B981', danger: '#EF4444' };
  return colors[type] || '#3B82F6';
}

function getPriorityLabel(priority) {
  const labels = { critical: 'üî¥ Critique', high: 'üü† Haute', medium: 'üîµ Moyenne', low: '‚ö™ Basse' };
  return labels[priority] || priority;
}

function getStatusIcon(status) {
  const icons = { sent: 'üì§', read: 'üëÅÔ∏è', acknowledged: '‚úÖ', in_progress: 'üîÑ', resolved: '‚úîÔ∏è', closed: 'üìÅ' };
  return icons[status] || 'üì§';
}

function getStatusLabel(status) {
  const labels = { sent: 'Envoy√©e', read: 'Lue', acknowledged: 'Accus√©e', in_progress: 'En cours', resolved: 'R√©solue', closed: 'Ferm√©e' };
  return labels[status] || status;
}

function formatRelativeTime(dateStr) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = Math.floor((now - date) / 1000);
  
  if (diff < 60) return '√Ä l\'instant';
  if (diff < 3600) return Math.floor(diff / 60) + ' min';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h';
  if (diff < 604800) return Math.floor(diff / 86400) + 'j';
  return formatDate(dateStr);
}

function truncateText(text, maxLength) {
  if (!text) return '';
  return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function navigateToContext(type, id) {
  if (type === 'client') {
    const ent = data.entreprises.find(e => String(e.id) === String(id));
    if (ent) openModal('entreprise', id);
  } else if (type === 'opportunite') {
    showPage('pipeline');
  }
}

function isAlertRead(alert) {
  if (!alert.readBy) return alert.read || alert.status !== 'sent';
  return alert.readBy.includes(currentUser.id);
}

function markAlertRead(id) {
  const alert = (data.alertes || []).find(a => String(a.id) === String(id));
  if (alert) {
    if (!alert.readBy) alert.readBy = [];
    if (!alert.readBy.includes(currentUser.id)) {
      alert.readBy.push(currentUser.id);
    }
    if (alert.status === 'sent') alert.status = 'read';
    saveData();
    updateNotificationBadges();
  }
}

function markAllAlertsRead() {
  (data.alertes || []).forEach(a => {
    if (!a.readBy) a.readBy = [];
    if (!a.readBy.includes(currentUser.id)) {
      a.readBy.push(currentUser.id);
    }
  });
  saveData();
  renderAlertes();
  updateNotificationBadges();
  renderNotificationPanel();
  showToast('Succ√®s', 'Toutes les alertes marqu√©es comme lues', 'success');
}

// Centre de notifications (header)
function toggleNotificationPanel() {
  const panel = document.getElementById('notificationPanel');
  if (panel) {
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
      renderNotificationPanel();
    }
  }
}

function filterNotifications(filter, btn) {
  notificationPanelFilter = filter;
  if (btn) {
    document.querySelectorAll('.notification-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
  }
  renderNotificationPanel();
}

function renderNotificationPanel() {
  const container = document.getElementById('notificationList');
  if (!container) return;
  
  let alertes = data.alertes || [];
  
  if (currentUser.role !== 'admin') {
    alertes = alertes.filter(a => {
      if (!a.recipients) return a.toId === 0 || a.toId === currentUser.id;
      return a.recipients.includes('all') || a.recipients.includes(currentUser.id.toString());
    });
  }
  
  if (notificationPanelFilter === 'unread') {
    alertes = alertes.filter(a => !isAlertRead(a));
  } else if (notificationPanelFilter === 'urgent') {
    alertes = alertes.filter(a => a.type === 'urgent' || a.priority === 'critical');
  }
  
  alertes = alertes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 10);
  
  if (alertes.length === 0) {
    container.innerHTML = '<div style="padding: 30px; text-align: center; color: var(--text-muted);">Aucune notification</div>';
    return;
  }
  
  container.innerHTML = alertes.map(a => {
    const isRead = isAlertRead(a);
    return '<div class="notification-item ' + (isRead ? '' : 'unread') + '" onclick="goToAlert(' + a.id + ')">' +
      '<div class="notification-item-header">' +
        '<span class="notification-item-title">' + getAlertTypeIcon(a.type) + ' ' + truncateText(a.title, 40) + '</span>' +
        '<span class="notification-item-time">' + formatRelativeTime(a.createdAt) + '</span>' +
      '</div>' +
      '<div class="notification-item-content">' + truncateText(a.content, 80) + '</div>' +
    '</div>';
  }).join('');
}

function goToAlert(id) {
  toggleNotificationPanel();
  showPage('alertes');
  setTimeout(() => selectAlert(id), 100);
}

function updateNotificationBadges() {
  // Unread messages
  const unreadMsgs = (data.messages || []).filter(m => m.toId === currentUser.id && !m.read).length;
  const msgBadge = document.getElementById('unreadMessages');
  if (msgBadge) {
    msgBadge.textContent = unreadMsgs;
    msgBadge.style.display = unreadMsgs > 0 ? 'flex' : 'none';
  }
  
  // Unread alerts
  let alerts = data.alertes || [];
  if (currentUser.role !== 'admin') {
    alerts = alerts.filter(a => {
      if (!a.recipients) return a.toId === 0 || a.toId === currentUser.id;
      return a.recipients.includes('all') || a.recipients.includes(currentUser.id.toString());
    });
  }
  const unreadAlerts = alerts.filter(a => !isAlertRead(a)).length;
  
  const alertBadge = document.getElementById('unreadAlerts');
  if (alertBadge) {
    alertBadge.textContent = unreadAlerts;
    alertBadge.style.display = unreadAlerts > 0 ? 'flex' : 'none';
  }
  
  const notifBadge = document.getElementById('notificationBadge');
  if (notifBadge) {
    const total = unreadMsgs + unreadAlerts;
    notifBadge.textContent = total;
    notifBadge.style.display = total > 0 ? 'flex' : 'none';
  }
}

function saveAlerte(e) {
  e.preventDefault();
  const form = e.target;
  
  data.lastId.alerte = (data.lastId.alerte || 0) + 1;
  
  // R√©cup√©rer les destinataires s√©lectionn√©s
  const recipientSelect = form.recipients;
  const selectedRecipients = Array.from(recipientSelect.selectedOptions).map(o => o.value);
  
  const alerte = {
    id: data.lastId.alerte,
    reference: generateAlertReference(),
    senderId: currentUser.id,
    senderType: 'user',
    recipients: selectedRecipients,
    type: form.type.value,
    priority: form.priority.value,
    category: form.category?.value || '',
    title: form.title.value.trim(),
    content: form.content.value.trim(),
    status: 'sent',
    channels: {
      crm: 'sent',
      email: form.channel_email?.checked ? 'pending' : 'disabled',
      teams: form.channel_teams?.checked ? 'pending' : 'disabled'
    },
    contextType: form.contextClientId?.value ? 'client' : (form.contextOppId?.value ? 'opportunite' : null),
    contextId: form.contextClientId?.value || form.contextOppId?.value || null,
    tags: form.tags?.value ? form.tags.value.split(',').map(t => t.trim()).filter(t => t) : [],
    messages: [],
    readBy: [],
    createdAt: new Date().toISOString()
  };
  
  if (!data.alertes) data.alertes = [];
  data.alertes.push(alerte);
  
  // Simuler l'envoi aux autres canaux
  simulateMultiChannelDispatch(alerte);
  
  saveData();
  closeModal();
  renderAlertes();
  updateNotificationBadges();
  showToast('Succ√®s', 'Alerte envoy√©e sur tous les canaux', 'success');
}

function simulateMultiChannelDispatch(alert) {
  // Simulation d'envoi email
  if (alert.channels.email === 'pending') {
    setTimeout(() => {
      alert.channels.email = 'sent';
      saveData();
      console.log('üìß Email envoy√© pour alerte ' + alert.reference);
    }, 1500);
  }
  
  // Simulation d'envoi Teams
  if (alert.channels.teams === 'pending') {
    setTimeout(() => {
      alert.channels.teams = 'sent';
      saveData();
      console.log('üí¨ Teams envoy√© pour alerte ' + alert.reference);
    }, 2000);
  }
}

// Fermer le panel au clic ext√©rieur
document.addEventListener('click', function(e) {
  const panel = document.getElementById('notificationPanel');
  const trigger = document.querySelector('.notification-trigger');
  if (panel && !panel.contains(e.target) && trigger && !trigger.contains(e.target)) {
    panel.classList.remove('open');
  }
});


// =====================================================
// √âQUIPE (ADMIN)
// =====================================================

function renderEquipe() {
  const users = (data.users || []).filter(u => u.role === 'commercial');
  
  // Stats
  document.getElementById('statTotalUsers').textContent = users.filter(u => u.isActive).length;
  
  const totalCA = users.reduce((sum, u) => {
    const userId = String(u.id);
    const opps = (data.opportunites || []).filter(o => String(o.ownerId) === userId && PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon);
    return sum + opps.reduce((s, o) => s + (parseFloat(o.amount) || 0), 0);
  }, 0);
  document.getElementById('statTotalTeamCA').textContent = formatCurrency(totalCA);
  
  const container = document.getElementById('equipeTable');
  
  if (users.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="10">
          <div class="empty-state">
            <div class="empty-state-icon">üëî</div>
            <h3 class="empty-state-title">Aucun commercial</h3>
            <p class="empty-state-text">Ajoutez des membres √† votre √©quipe</p>
            <button class="btn btn-primary" onclick="openModal('utilisateur')">+ Nouveau commercial</button>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  container.innerHTML = users.map(u => {
    const userId = String(u.id);
    const entreprises = (data.entreprises || []).filter(e => String(e.ownerId) === userId).length;
    const opportunites = (data.opportunites || []).filter(o => String(o.ownerId) === userId).length;
    const caGenere = data.opportunites
      .filter(o => String(o.ownerId) === userId && PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon)
      .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    
    // Afficher les types d'acc√®s
    let accessTypes = u.accessTypes || [1];
    // Parser si c'est une cha√Æne JSON
    if (typeof accessTypes === 'string') {
      try {
        accessTypes = JSON.parse(accessTypes);
      } catch (e) {
        accessTypes = [1];
      }
    }
    if (!Array.isArray(accessTypes)) accessTypes = [1];
    
    const accessBadges = accessTypes.map(t => {
      const colors = { 1: 'success', 2: 'warning', 3: 'danger' };
      const labels = { 1: 'Niveau 1', 2: 'Niveau 2', 3: 'Niveau 3' };
      return '<span class="badge badge-' + colors[t] + '" style="margin-right:2px;font-size:10px;">' + labels[t] + '</span>';
    }).join('');
    
    return `
      <tr>
        <td><strong>${u.firstName} ${u.lastName}</strong></td>
        <td>${u.email}</td>
        <td>${entreprises}</td>
        <td>${opportunites}</td>
        <td class="font-mono" style="color: var(--success);">${formatCurrency(caGenere)}</td>
        <td>${accessBadges}</td>
        <td><span class="badge badge-${u.isActive ? 'success' : 'danger'}">${u.isActive ? 'Actif' : 'Inactif'}</span></td>
        <td class="actions-cell">
          <button class="btn btn-icon sm" onclick="openModal('utilisateur', ${u.id})" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-icon sm" onclick="openAccessModal(${u.id})" title="G√©rer acc√®s">üîë</button>
          <button class="btn btn-icon sm" onclick="toggleUserStatus(${u.id})" title="${u.isActive ? 'D√©sactiver' : 'Activer'}">
            ${u.isActive ? 'üîí' : 'üîì'}
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

function openAccessModal(userId) {
  const user = data.users.find(u => String(u.id) === String(userId));
  if (!user) return;
  
  let accessTypes = user.accessTypes || [1];
  if (typeof accessTypes === 'string') {
    try { accessTypes = JSON.parse(accessTypes); } catch(e) { accessTypes = [1]; }
  }
  if (!Array.isArray(accessTypes)) accessTypes = [1];
  
  const content = `
    <div style="padding: 20px;">
      <h3 style="margin-bottom: 20px;">G√©rer les acc√®s produits</h3>
      <p style="margin-bottom: 15px;"><strong>${user.firstName} ${user.lastName}</strong></p>
      
      <div style="margin-bottom: 20px;">
        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
          <input type="checkbox" id="access1" ${accessTypes.includes(1) ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
          <span class="badge badge-success" style="margin-right: 10px;">Niveau 1</span>
          Produits standards (Mat√©riel, Logiciel, IoT, Formation, etc.)
        </label>
        
        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
          <input type="checkbox" id="access2" ${accessTypes.includes(2) ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
          <span class="badge badge-warning" style="margin-right: 10px;">Niveau 2</span>
          N√©gociation, Marketing, Design, Prestations
        </label>
        
        <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
          <input type="checkbox" id="access3" ${accessTypes.includes(3) ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
          <span class="badge badge-danger" style="margin-right: 10px;">Niveau 3</span>
          Commissions, Prestations internes
        </label>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn" onclick="closeModal()">Annuler</button>
        <button class="btn btn-primary" onclick="saveUserAccess(${userId})">Enregistrer</button>
      </div>
    </div>
  `;
  
  // Cr√©er un modal temporaire
  const existingModal = document.getElementById('accessModal');
  if (existingModal) existingModal.remove();
  
  const modal = document.createElement('div');
  modal.id = 'accessModal';
  modal.className = 'modal';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">üîë Acc√®s Produits</h2>
        <button class="modal-close" onclick="closeAccessModal()">&times;</button>
      </div>
      <div class="modal-body">
        ${content}
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function closeAccessModal() {
  const modal = document.getElementById('accessModal');
  if (modal) modal.remove();
}

async function saveUserAccess(userId) {
  const user = data.users.find(u => String(u.id) === String(userId));
  if (!user) return;
  
  const accessTypes = [];
  if (document.getElementById('access1').checked) accessTypes.push(1);
  if (document.getElementById('access2').checked) accessTypes.push(2);
  if (document.getElementById('access3').checked) accessTypes.push(3);
  
  // Au moins un acc√®s requis
  if (accessTypes.length === 0) {
    showToast('Erreur', 'S√©lectionnez au moins un niveau d\'acc√®s', 'error');
    return;
  }
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.updateUser(userId, { accessTypes: JSON.stringify(accessTypes) });
      if (result.success) {
        user.accessTypes = accessTypes;
        closeAccessModal();
        renderEquipe();
        showToast('Succ√®s', 'Acc√®s mis √† jour', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      showToast('Erreur', 'Erreur de connexion', 'error');
    }
  } else {
    user.accessTypes = accessTypes;
    saveData();
    closeAccessModal();
    renderEquipe();
    showToast('Succ√®s', 'Acc√®s mis √† jour', 'success');
  }
}

// Fonction pour filtrer les produits selon les acc√®s de l'utilisateur
function getAccessibleProducts() {
  const userAccess = currentUser.accessTypes || [1];
  
  // Admin a acc√®s √† tout
  if (currentUser.role === 'admin') {
    return PRODUCT_CATALOGUE.filter(p => p.isActive);
  }
  
  // Commercial: filtrer selon ses acc√®s
  return PRODUCT_CATALOGUE.filter(p => p.isActive && userAccess.includes(p.access));
}

function getAccessiblePacks() {
  const userAccess = currentUser.accessTypes || [1];
  
  // Admin a acc√®s √† tout
  if (currentUser.role === 'admin') {
    return PACKS_CATALOGUE;
  }
  
  // Commercial: filtrer selon ses acc√®s
  return PACKS_CATALOGUE.filter(p => userAccess.includes(p.access || 1));
}

async function saveUtilisateur(e) {
  e.preventDefault();
  const form = e.target;
  const id = form.dataset.id;
  
  const existingUser = data.users.find(u => u.username === form.username.value && u.id !== id);
  if (existingUser) {
    showToast('Erreur', 'Ce nom d\'utilisateur existe d√©j√†', 'error');
    return;
  }
  
  // R√©cup√©rer les niveaux d'acc√®s
  const accessTypes = [];
  if (form.access1?.checked) accessTypes.push(1);
  if (form.access2?.checked) accessTypes.push(2);
  if (form.access3?.checked) accessTypes.push(3);
  
  if (accessTypes.length === 0) {
    showToast('Erreur', 'S√©lectionnez au moins un niveau d\'acc√®s', 'error');
    return;
  }
  
  const userData = {
    username: form.username.value.trim(),
    firstName: form.firstName.value.trim(),
    lastName: form.lastName.value.trim(),
    email: form.email.value.trim(),
    phone: form.phone?.value.trim() || '',
    role: 'commercial',
    isActive: true,
    accessTypes: JSON.stringify(accessTypes)
  };
  
  // Pour une cr√©ation, le mot de passe est obligatoire
  if (!id && !form.password.value) {
    showToast('Erreur', 'Le mot de passe est obligatoire', 'error');
    return;
  }
  
  if (form.password.value) {
    userData.password = form.password.value;
  }
  
  console.log('üì§ Envoi userData:', userData);
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      let result;
      if (id) {
        result = await api.updateUser(id, userData);
      } else {
        result = await api.createUser(userData);
      }
      
      if (result.success) {
        // Recharger les utilisateurs depuis l'API
        const usersRes = await api.getUsers();
        if (usersRes.success) {
          data.users = usersRes.data;
        }
        closeModal();
        renderEquipe();
        showToast('Succ√®s', id ? 'Utilisateur modifi√©' : 'Utilisateur cr√©√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur lors de la sauvegarde', 'error');
      }
    } catch (error) {
      console.error('Erreur API:', error);
      showToast('Erreur', 'Erreur de connexion √† l\'API', 'error');
    }
  } else {
    // Mode localStorage
    if (id) {
      const user = data.users.find(u => String(u.id) === String(id));
      if (user) {
        Object.assign(user, userData);
        user.accessTypes = accessTypes;
        user.updatedAt = new Date().toISOString();
      }
    } else {
      data.lastId.user = (data.lastId.user || 0) + 1;
      data.users.push({
        id: data.lastId.user,
        ...userData,
        accessTypes: accessTypes,
        createdAt: new Date().toISOString()
      });
    }
    
    saveData();
    closeModal();
    renderEquipe();
    showToast('Succ√®s', id ? 'Utilisateur modifi√©' : 'Utilisateur cr√©√©', 'success');
  }
}

async function toggleUserStatus(id) {
  const user = data.users.find(u => String(u.id) === String(id));
  if (user && user.role !== 'admin') {
    const newStatus = !user.isActive;
    
    if (USE_GOOGLE_SHEETS_API) {
      try {
        const result = await api.updateUser(id, { isActive: newStatus });
        if (result.success) {
          user.isActive = newStatus;
          renderEquipe();
          showToast('Succ√®s', 'Utilisateur ' + (newStatus ? 'activ√©' : 'd√©sactiv√©'), 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur', 'error');
        }
      } catch (error) {
        showToast('Erreur', 'Erreur de connexion', 'error');
      }
    } else {
      user.isActive = newStatus;
      saveData();
      renderEquipe();
      showToast('Succ√®s', 'Utilisateur ' + (newStatus ? 'activ√©' : 'd√©sactiv√©'), 'success');
    }
  }
}

// =====================================================
// CONSOLIDATION (ADMIN)
// =====================================================

function renderConsolidation() {
  console.log('üìä renderConsolidation - data.users:', data.users);
  console.log('üìä renderConsolidation - data.entreprises:', data.entreprises);
  console.log('üìä renderConsolidation - data.opportunites:', data.opportunites);
  
  // Global stats
  document.getElementById('consolEntreprises').textContent = (data.entreprises || []).length;
  document.getElementById('consolContacts').textContent = (data.contacts || []).length;
  document.getElementById('consolOpportunites').textContent = (data.opportunites || []).length;
  
  const totalCA = data.opportunites.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  document.getElementById('consolCA').textContent = formatCurrency(totalCA);
  
  // Per user stats
  const users = (data.users || []).filter(u => u.role === 'commercial');
  console.log('üìä Commerciaux trouv√©s:', users);
  
  // Log des ownerIds pour debug
  console.log('üìä OwnerIds des entreprises:', (data.entreprises || []).map(e => ({ id: e.id, name: e.name, ownerId: e.ownerId })));
  
  const container = document.getElementById('consolidationTable');
  
  if (users.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-muted">Aucun commercial trouv√©</td>
      </tr>
    `;
    return;
  }
  
  container.innerHTML = users.map(u => {
    const userId = String(u.id);
    const entreprises = (data.entreprises || []).filter(e => String(e.ownerId) === userId).length;
    const contacts = (data.contacts || []).filter(c => String(c.ownerId) === userId).length;
    const opps = (data.opportunites || []).filter(o => String(o.ownerId) === userId);
    const caPipeline = opps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    const wonOpps = opps.filter(o => PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon);
    const caGagne = wonOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    const conversion = opps.length > 0 ? Math.round((wonOpps.length / opps.length) * 100) : 0;
    
    return `
      <tr>
        <td><strong>${u.firstName} ${u.lastName}</strong></td>
        <td>${entreprises}</td>
        <td>${contacts}</td>
        <td>${opps.length}</td>
        <td class="font-mono">${formatCurrency(caPipeline)}</td>
        <td class="font-mono" style="color: var(--success);">${formatCurrency(caGagne)}</td>
        <td>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="probability-bar" style="width: 60px;">
              <div class="probability-fill" style="width: ${conversion}%; background: var(--success);"></div>
            </div>
            <span>${conversion}%</span>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function exportConsolidation() {
  const users = (data.users || []).filter(u => u.role === 'commercial');
  
  const headers = ['Commercial', 'Entreprises', 'Contacts', 'Opportunit√©s', 'CA Pipeline', 'CA Gagn√©'];
  const rows = users.map(u => {
    const userId = String(u.id);
    const entreprises = (data.entreprises || []).filter(e => String(e.ownerId) === userId).length;
    const contacts = (data.contacts || []).filter(c => String(c.ownerId) === userId).length;
    const opps = (data.opportunites || []).filter(o => String(o.ownerId) === userId);
    const caPipeline = opps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    const caGagne = opps.filter(o => PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon)
      .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    return [`${u.firstName} ${u.lastName}`, entreprises, contacts, opps.length, caPipeline, caGagne];
  });
  
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'consolidation.csv', 'text/csv');
  showToast('Export√©', 'Rapport t√©l√©charg√©', 'success');
}

// =====================================================
// ADMIN: PIPELINE CONSOLID√â
// =====================================================


// Fonction pour afficher le pipeline vide avec les colonnes
function renderAdminPipelineEmpty() {
  console.log('üîÑ renderAdminPipelineEmpty - Affichage des colonnes vides');
  
  const container = document.getElementById('adminPipelineContainer');
  if (!container) return;
  
  const stages = PIPELINE_STAGES.filter(s => !s.isLost);
  
  container.innerHTML = stages.map(stage => `
    <div class="pipeline-column" data-stage="${stage.id}" style="min-width: 250px; min-height: 400px;">
      <div class="pipeline-header">
        <div class="pipeline-title">
          <div class="pipeline-color" style="background: ${stage.color};"></div>
          ${stage.name}
          <span class="pipeline-count">0</span>
        </div>
        <div class="pipeline-amount">0 ‚Ç¨</div>
      </div>
      <div class="pipeline-cards" style="min-height: 300px; display: flex; align-items: center; justify-content: center;">
        <div style="text-align: center; color: var(--text-muted);">
          <p>Aucune opportunit√©</p>
          <button class="btn btn-sm btn-primary" onclick="syncFromGoogleSheets()">üîÑ Synchroniser</button>
        </div>
      </div>
    </div>
  `).join('');
  
  // Mettre √† jour les stats √† 0
  const els = ['adminPipelineTotal', 'adminPipelineValue', 'adminPipelineWon', 'adminPipelineAvgProba'];
  els.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = id.includes('Proba') ? '0%' : '0';
  });
}


function renderAdminPipeline() {
  console.log('üîÑ renderAdminPipeline - D√âBUT');
  
  // V√©rifier les donn√©es
  const opps = Array.isArray(data.opportunites) ? data.opportunites : [];
  const users = Array.isArray(data.users) ? data.users : [];
  
  console.log('üìä Donn√©es:', {
    opportunites: opps.length,
    users: users.length,
    entreprises: (data.entreprises || []).length
  });
  
  // Populate filter
  try {
    populateCommercialFilter('filterPipelineCommercial');
  } catch(e) {
    console.warn('Erreur populateCommercialFilter:', e);
  }
  
  // Reset color cache
  commercialColorMap = {};
  
  const commercialFilter = document.getElementById('filterPipelineCommercial')?.value;
  
  let opportunites = [...opps];
  
  // Filter by commercial if selected
  if (commercialFilter) {
    opportunites = opportunites.filter(o => String(o.ownerId) === String(commercialFilter));
    console.log('üìã Filtr√© par commercial:', commercialFilter, '‚Üí', opportunites.length, 'opportunit√©s');
  }
  
  // Filter active opportunities
  const activeOpps = opportunites.filter(o => {
    const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
    return stage && !stage.isWon && !stage.isLost;
  });
  
  // Calculate stats
  const pipelineValue = activeOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  
  // Won this month
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const wonThisMonth = opportunites
    .filter(o => {
      const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
      const updatedAt = new Date(o.updatedAt || o.createdAt || now);
      return stage?.isWon && updatedAt >= startOfMonth;
    })
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  
  // Average probability
  const avgProba = activeOpps.length > 0 
    ? Math.round(activeOpps.reduce((sum, o) => sum + (parseInt(o.probability) || 0), 0) / activeOpps.length)
    : 0;
  
  // Update stats
  const els = {
    total: document.getElementById('adminPipelineTotal'),
    value: document.getElementById('adminPipelineValue'),
    won: document.getElementById('adminPipelineWon'),
    avg: document.getElementById('adminPipelineAvgProba')
  };
  
  if (els.total) els.total.textContent = activeOpps.length;
  if (els.value) els.value.textContent = formatCurrency(pipelineValue);
  if (els.won) els.won.textContent = formatCurrency(wonThisMonth);
  if (els.avg) els.avg.textContent = avgProba + '%';
  
  // Generate legend
  try {
    renderCommercialLegend();
  } catch(e) {
    console.warn('Erreur renderCommercialLegend:', e);
  }
  
  // IMPORTANT: Toujours render le Kanban, m√™me avec 0 opportunit√©s
  try {
    renderAdminPipelineKanban(opportunites);
  } catch(e) {
    console.error('Erreur renderAdminPipelineKanban:', e);
    // Fallback: afficher les colonnes vides
    renderAdminPipelineEmpty();
  }
  
  // Render table
  try {
    renderAdminPipelineByUser(opportunites);
  } catch(e) {
    console.error('Erreur renderAdminPipelineByUser:', e);
  }
  
  console.log('‚úÖ renderAdminPipeline - FIN');
}


function renderCommercialLegend() {
  const legend = document.getElementById('commercialLegend');
  if (!legend) return;
  
  const commercials = (data.users || []).filter(u => u.role === 'commercial' || u.role === 'admin');
  
  legend.innerHTML = commercials.map(c => {
    const colors = getCommercialColor(c.id);
    return '<div style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; background: ' + colors.bg + '; border-radius: 4px; border: 1px solid ' + colors.border + ';">' +
      '<span style="width: 10px; height: 10px; border-radius: 50%; background: ' + colors.border + ';"></span>' +
      '<span style="color: ' + colors.text + '; font-weight: 500;">' + c.firstName + ' ' + c.lastName.charAt(0) + '.</span>' +
    '</div>';
  }).join('');
}

function renderAdminPipelineKanban(opportunites) {
  console.log('üéØ renderAdminPipelineKanban - D√âBUT');
  
  const container = document.getElementById('adminPipelineContainer');
  if (!container) {
    console.error('‚ùå Container adminPipelineContainer non trouv√©!');
    alert('Erreur: Container adminPipelineContainer non trouv√©');
    return;
  }
  
  console.log('‚úÖ Container trouv√©:', container);
  
  // S'assurer que PIPELINE_STAGES est d√©fini
  if (typeof PIPELINE_STAGES === 'undefined' || !PIPELINE_STAGES || !Array.isArray(PIPELINE_STAGES)) {
    console.error('‚ùå PIPELINE_STAGES non d√©fini!');
    container.innerHTML = '<div style="padding: 40px; text-align: center; color: red;">Erreur: √âtapes du pipeline non d√©finies</div>';
    return;
  }
  
  // Filtrer les stages (exclure les perdus)
  const stages = PIPELINE_STAGES.filter(s => !s.isLost);
  console.log('üìä Stages √† afficher:', stages.length, stages.map(s => s.id));
  
  if (stages.length === 0) {
    container.innerHTML = '<div style="padding: 40px; text-align: center;">Aucune √©tape d√©finie</div>';
    return;
  }
  
  // S'assurer que opportunites est un tableau
  const opps = Array.isArray(opportunites) ? opportunites : [];
  console.log('üìä Opportunit√©s √† afficher:', opps.length);
  
  // G√©n√©rer le HTML des colonnes
  let columnsHTML = '';
  
  for (const stage of stages) {
    const stageOpps = opps.filter(o => o && o.stage === stage.id);
    const total = stageOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    
    console.log(`  - ${stage.id}: ${stageOpps.length} opportunit√©s, total: ${total}`);
    
    // G√©n√©rer les cartes
    let cardsHTML = '';
    if (stageOpps.length > 0) {
      for (const o of stageOpps.slice(0, 15)) {
        try {
          cardsHTML += renderAdminPipelineCard(o, stage);
        } catch(e) {
          console.error('Erreur rendu carte:', e, o);
        }
      }
      if (stageOpps.length > 15) {
        cardsHTML += '<div class="text-muted text-center" style="padding: 8px;">+ ' + (stageOpps.length - 15) + ' autres...</div>';
      }
    } else {
      cardsHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">Aucune opportunit√©</div>';
    }
    
    columnsHTML += '<div class="pipeline-column" data-stage="' + stage.id + '" ' +
      'ondragover="handleDragOver(event)" ' +
      'ondragleave="handleDragLeave(event)" ' +
      'ondrop="handleDrop(event, \'' + stage.id + '\')" ' +
      'style="min-width: 250px; min-height: 400px; flex-shrink: 0; background: var(--bg-secondary); border-radius: 8px; margin-right: 12px;">' +
      '<div class="pipeline-header" style="padding: 12px; border-bottom: 1px solid var(--border-default);">' +
        '<div class="pipeline-title" style="display: flex; align-items: center; gap: 8px;">' +
          '<div class="pipeline-color" style="width: 12px; height: 12px; border-radius: 50%; background: ' + stage.color + ';"></div>' +
          '<span style="font-weight: 600;">' + stage.name + '</span>' +
          '<span class="pipeline-count" style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 10px; font-size: 12px;">' + stageOpps.length + '</span>' +
        '</div>' +
        '<div class="pipeline-amount" style="font-size: 14px; color: var(--text-muted); margin-top: 4px;">' + formatCurrency(total) + '</div>' +
      '</div>' +
      '<div class="pipeline-cards" style="padding: 12px; min-height: 300px;">' +
        cardsHTML +
      '</div>' +
    '</div>';
  }
  
  console.log('üìù HTML g√©n√©r√©, longueur:', columnsHTML.length);
  container.innerHTML = columnsHTML;
  console.log('‚úÖ Kanban rendu avec', stages.length, 'colonnes');
}


// Couleurs pastel pour les commerciaux
const COMMERCIAL_COLORS = [
  { bg: '#E8F5E9', border: '#4CAF50', text: '#2E7D32' },  // Vert pastel
  { bg: '#E3F2FD', border: '#2196F3', text: '#1565C0' },  // Bleu pastel
  { bg: '#FFF3E0', border: '#FF9800', text: '#E65100' },  // Orange pastel
  { bg: '#F3E5F5', border: '#9C27B0', text: '#6A1B9A' },  // Violet pastel
  { bg: '#E0F7FA', border: '#00BCD4', text: '#00838F' },  // Cyan pastel
  { bg: '#FCE4EC', border: '#E91E63', text: '#AD1457' },  // Rose pastel
  { bg: '#FFF8E1', border: '#FFC107', text: '#FF8F00' },  // Jaune pastel
  { bg: '#EFEBE9', border: '#795548', text: '#4E342E' },  // Marron pastel
  { bg: '#E8EAF6', border: '#3F51B5', text: '#283593' },  // Indigo pastel
  { bg: '#F1F8E9', border: '#8BC34A', text: '#558B2F' }   // Lime pastel
];

// Cache pour les couleurs assign√©es aux commerciaux
let commercialColorMap = {};

function getCommercialColor(userId) {
  if (!userId) return COMMERCIAL_COLORS[0];
  
  if (!commercialColorMap[userId]) {
    const users = Array.isArray(data.users) ? data.users : [];
    const commercials = users.filter(u => u.role === 'commercial' || u.role === 'admin');
    const index = commercials.findIndex(u => String(u.id) === String(userId));
    commercialColorMap[userId] = COMMERCIAL_COLORS[Math.max(0, index) % COMMERCIAL_COLORS.length];
  }
  return commercialColorMap[userId];
}

function renderAdminPipelineCard(opp, stage) {
  if (!opp) return '';
  
  const entreprises = Array.isArray(data.entreprises) ? data.entreprises : [];
  const users = Array.isArray(data.users) ? data.users : [];
  
  const entreprise = entreprises.find(e => String(e.id) === String(opp.entrepriseId));
  const owner = users.find(u => String(u.id) === String(opp.ownerId));
  const colors = getCommercialColor(opp.ownerId) || { bg: '#f5f5f5', border: '#999', text: '#333' };
  
  return `
    <div class="pipeline-card" draggable="true"
         ondragstart="handleDragStart(event, '${opp.id}')"
         ondragend="handleDragEnd(event)"
         onclick="openModal('opportunite', '${opp.id}')" 
         style="background: ${colors.bg}; border-left: 4px solid ${colors.border}; cursor: grab;">
      <div class="pipeline-card-header">
        <div class="pipeline-card-title" style="color: ${colors.text};">${opp.name || 'Sans nom'}</div>
      </div>
      <div class="pipeline-card-company">${entreprise?.name || '-'}</div>
      <div class="pipeline-card-footer">
        <div class="pipeline-card-amount">${formatCurrency(opp.amount || 0)}</div>
        <div class="pipeline-card-probability">
          <div class="probability-bar">
            <div class="probability-fill" style="width: ${opp.probability || 0}%; background: ${colors.border};"></div>
          </div>
          ${opp.probability || 0}%
        </div>
      </div>
      <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid ${colors.border}40; font-size: 11px; color: ${colors.text}; display: flex; align-items: center; gap: 5px;">
        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${colors.border}; display: inline-block;"></span>
        ${owner?.firstName || ''} ${owner?.lastName || ''}
      </div>
    </div>
  `;
}

function renderAdminPipelineByUser(allOpportunites) {
  const container = document.getElementById('adminPipelineByUserTable');
  if (!container) return;
  
  const users = Array.isArray(data.users) ? data.users.filter(u => u.role === 'commercial' || u.role === 'admin') : [];
  const opps = Array.isArray(allOpportunites) ? allOpportunites : [];
  
  if (users.length === 0) {
    container.innerHTML = '<tr><td colspan="10" class="text-muted" style="text-align: center; padding: 2rem;">Aucun commercial</td></tr>';
    return;
  }
  
  // Define stages for columns
  const stageColumns = ['lead', 'prospection', 'qualification', 'decouverte', 'proposition', 'negociation', 'closing'];
  
  container.innerHTML = users.map(u => {
    const userId = String(u.id);
    const userOpps = opps.filter(o => String(o.ownerId) === userId);
    
    // Count and sum by stage
    const byStage = {};
    stageColumns.forEach(s => {
      const stageOpps = userOpps.filter(o => o.stage === s);
      byStage[s] = {
        count: stageOpps.length,
        amount: stageOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0)
      };
    });
    
    // Total pipeline (excluding won/lost)
    const activeOpps = userOpps.filter(o => {
      const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
      return !stage?.isWon && !stage?.isLost;
    });
    const totalPipeline = activeOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    
    // Won
    const wonOpps = userOpps.filter(o => PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon);
    const totalWon = wonOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    
    return `
      <tr>
        <td><strong>${u.firstName} ${u.lastName}</strong></td>
        ${stageColumns.map(s => `
          <td style="text-align: center;">
            ${byStage[s].count > 0 ? `
              <div style="font-weight: 600;">${byStage[s].count}</div>
              <div class="text-muted" style="font-size: 11px;">${formatCurrency(byStage[s].amount)}</div>
            ` : '<span class="text-muted">-</span>'}
          </td>
        `).join('')}
        <td class="font-mono" style="color: var(--warning); font-weight: 600;">${formatCurrency(totalPipeline)}</td>
        <td class="font-mono" style="color: var(--success); font-weight: 600;">${formatCurrency(totalWon)}</td>
      </tr>
    `;
  }).join('');
  
  // Add totals row
  const totals = {};
  stageColumns.forEach(s => {
    const stageOpps = allOpportunites.filter(o => o.stage === s);
    totals[s] = {
      count: stageOpps.length,
      amount: stageOpps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0)
    };
  });
  
  const totalPipelineAll = allOpportunites
    .filter(o => {
      const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
      return !stage?.isWon && !stage?.isLost;
    })
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  
  const totalWonAll = allOpportunites
    .filter(o => PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon)
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  
  container.innerHTML += `
    <tr style="background: var(--bg-tertiary); font-weight: 700;">
      <td>TOTAL</td>
      ${stageColumns.map(s => `
        <td style="text-align: center;">
          <div>${totals[s].count}</div>
          <div style="font-size: 11px;">${formatCurrency(totals[s].amount)}</div>
        </td>
      `).join('')}
      <td class="font-mono" style="color: var(--warning);">${formatCurrency(totalPipelineAll)}</td>
      <td class="font-mono" style="color: var(--success);">${formatCurrency(totalWonAll)}</td>
    </tr>
  `;
}

function viewOpportuniteDetail(oppId) {
  const opp = data.opportunites.find(o => String(o.id) === String(oppId));
  if (!opp) return;
  
  const entreprise = data.entreprises.find(e => String(e.id) === String(opp.entrepriseId));
  const owner = data.users.find(u => String(u.id) === String(opp.ownerId));
  const stage = PIPELINE_STAGES.find(s => s.id === opp.stage);
  
  const content = `
    <div style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-md);">
        <div>
          <h3 style="margin: 0;">${opp.name}</h3>
          <p class="text-muted">${entreprise?.name || '-'}</p>
        </div>
        <span class="badge" style="background: ${stage?.color}20; color: ${stage?.color}; font-size: 14px; padding: 8px 16px;">
          ${stage?.name || opp.stage}
        </span>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
        <div>
          <p class="text-muted" style="margin-bottom: 4px;">Montant</p>
          <p style="font-size: var(--text-2xl); font-weight: 700; color: var(--success); margin: 0;">${formatCurrency(opp.amount)}</p>
        </div>
        <div>
          <p class="text-muted" style="margin-bottom: 4px;">Probabilit√©</p>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="probability-bar" style="width: 100px;">
              <div class="probability-fill" style="width: ${opp.probability}%;"></div>
            </div>
            <span style="font-weight: 600;">${opp.probability}%</span>
          </div>
        </div>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-lg);">
      <div>
        <p class="text-muted" style="margin-bottom: 4px;">Commercial</p>
        <p style="margin: 0; font-weight: 500;">üë§ ${owner?.firstName || ''} ${owner?.lastName || ''}</p>
      </div>
      <div>
        <p class="text-muted" style="margin-bottom: 4px;">Date cl√¥ture pr√©vue</p>
        <p style="margin: 0; font-weight: 500;">üìÖ ${opp.expectedClose ? formatDate(opp.expectedClose) : '-'}</p>
      </div>
      <div>
        <p class="text-muted" style="margin-bottom: 4px;">Source</p>
        <p style="margin: 0;">${opp.source || '-'}</p>
      </div>
      <div>
        <p class="text-muted" style="margin-bottom: 4px;">Priorit√©</p>
        <p style="margin: 0;">${opp.priority === 'high' ? 'üî¥ Haute' : opp.priority === 'medium' ? 'üü° Moyenne' : 'üü¢ Basse'}</p>
      </div>
    </div>
    
    ${opp.description ? `
      <div style="margin-bottom: var(--space-lg);">
        <p class="text-muted" style="margin-bottom: 4px;">Description</p>
        <p style="margin: 0; padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md);">${opp.description}</p>
      </div>
    ` : ''}
  `;
  
  document.getElementById('modalTitle').textContent = 'D√©tail Opportunit√©';
  document.getElementById('modalBody').innerHTML = content + `
    <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
      <button class="btn btn-primary" onclick="closeModal()">Fermer</button>
    </div>
  `;
  document.getElementById('modalOverlay').classList.add('active');
}

function exportAdminPipeline() {
  const headers = ['Opportunit√©', 'Entreprise', '√âtape', 'Montant', 'Probabilit√©', 'Date cl√¥ture', 'Commercial'];
  const rows = (data.opportunites || []).map(o => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(o.entrepriseId));
    const owner = data.users.find(u => String(u.id) === String(o.ownerId));
    const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
    return [o.name, entreprise?.name, stage?.name, o.amount, o.probability + '%', o.expectedClose || '', `${owner?.firstName || ''} ${owner?.lastName || ''}`];
  });
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'pipeline_consolide.csv', 'text/csv');
  showToast('Export√©', 'Pipeline export√©', 'success');
}

// =====================================================
// HISTORIQUE COMMANDES (COMMERCIAL + ADMIN)
// =====================================================

function renderCommandes() {
  // Populate commercial filter
  populateCommercialFilter('filterCommandeCommercial');
  
  let orders = data.orders || [];
  
  // Filter by role
  if (currentUser.role !== 'admin') {
    orders = orders.filter(o => String(o.ownerId) === String(currentUser.id));
  }
  
  // Apply filters
  const commercialFilter = document.getElementById('filterCommandeCommercial')?.value;
  const dateFrom = document.getElementById('filterCommandeDateFrom')?.value;
  const dateTo = document.getElementById('filterCommandeDateTo')?.value;
  
  if (commercialFilter) {
    orders = orders.filter(o => String(o.ownerId) === String(commercialFilter));
  }
  if (dateFrom) {
    orders = orders.filter(o => o.orderDate >= dateFrom);
  }
  if (dateTo) {
    orders = orders.filter(o => o.orderDate <= dateTo);
  }
  
  const container = document.getElementById('commandesTable');
  
  if (orders.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="7">
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <h3 class="empty-state-title">Aucune commande</h3>
            <p class="empty-state-text">L'historique est vide</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  container.innerHTML = orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)).map(o => `
    <tr>
      <td><code class="font-mono">${o.orderNumber}</code></td>
      <td>${formatDate(o.orderDate)}</td>
      <td><strong>${o.clientName}</strong></td>
      <td class="font-mono">${formatCurrency(o.totalHT)}</td>
      <td class="font-mono" style="color: var(--success); font-weight: 600;">${formatCurrency(o.totalTTC)}</td>
      <td>${o.ownerName || '-'}</td>
      <td class="actions-cell">
        <button class="btn btn-icon sm" onclick="viewOrderDetails('${o.id}')" title="Voir d√©tails">üëÅÔ∏è</button>
        <button class="btn btn-icon sm" onclick="editCommande('${o.id}')" title="Modifier">‚úèÔ∏è</button>
        <button class="btn btn-icon sm btn-danger" onclick="deleteCommande('${o.id}')" title="Supprimer">üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

function exportCommandesCSV() {
  let orders = data.orders || [];
  if (currentUser.role !== 'admin') {
    orders = orders.filter(o => String(o.ownerId) === String(currentUser.id));
  }
  
  const headers = ['N¬∞ Commande', 'Date', 'Client', 'Total HT', 'TVA', 'Total TTC', 'Commercial'];
  const rows = orders.map(o => [o.orderNumber, o.orderDate, o.clientName, o.totalHT, o.totalTVA, o.totalTTC, o.ownerName || '']);
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'commandes.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

// Fonctions pour les commandes
function editCommande(id) {
  showToast('Commande', 'La modification des commandes sera disponible prochainement', 'info');
}

async function deleteCommande(id) {
  if (!confirm('Supprimer cette commande ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.deleteCommande(id);
      if (result.success) {
        data.orders = (data.orders || []).filter(o => String(o.id) !== String(id));
        renderCommandes();
        showToast('Supprim√©', 'Commande supprim√©e', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur lors de la suppression', 'error');
      }
    } catch (e) {
      showToast('Erreur', e.message, 'error');
    }
  } else {
    data.orders = (data.orders || []).filter(o => String(o.id) !== String(id));
    saveData();
    renderCommandes();
    showToast('Supprim√©', 'Commande supprim√©e', 'success');
  }
}


function viewOrderDetails(orderId) {
  const order = data.orders.find(o => String(o.id) === String(orderId));
  if (!order) return;
  
  const content = `
    <div style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
      <h4 style="margin-bottom: var(--space-md);">üìã ${order.orderNumber}</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
        <div>
          <p class="text-muted">Client</p>
          <p><strong>${order.clientName}</strong></p>
          <p>${order.address || '-'}</p>
        </div>
        <div>
          <p class="text-muted">Commercial</p>
          <p><strong>${order.ownerName || '-'}</strong></p>
          <p>Date: ${formatDate(order.orderDate)}</p>
        </div>
      </div>
    </div>
    
    <table class="table">
      <thead>
        <tr><th>Produit</th><th>Qt√©</th><th>P.U. HT</th><th>Total TTC</th></tr>
      </thead>
      <tbody>
        ${order.products.map(p => `
          <tr>
            <td>${p.name}</td>
            <td>${p.qty}</td>
            <td class="font-mono">${formatCurrency(p.price)}</td>
            <td class="font-mono">${formatCurrency(p.totalTTC)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    
    <div style="text-align: right; margin-top: var(--space-lg);">
      <p><strong>Total HT:</strong> ${formatCurrency(order.totalHT)}</p>
      <p><strong>TVA:</strong> ${formatCurrency(order.totalTVA)}</p>
      <p style="font-size: var(--text-xl); color: var(--success);"><strong>Total TTC:</strong> ${formatCurrency(order.totalTTC)}</p>
    </div>
  `;
  
  document.getElementById('modalTitle').textContent = 'D√©tails de la commande';
  document.getElementById('modalBody').innerHTML = content + `
    <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
      <button class="btn btn-primary" onclick="downloadOrderPDF(${orderId})">üì• T√©l√©charger PDF</button>
      <button class="btn" onclick="closeModal()">Fermer</button>
    </div>
  `;
  document.getElementById('modalOverlay').classList.add('active');
}

// Download PDF for existing order
function downloadOrderPDF(orderId) {
  const order = data.orders.find(o => String(o.id) === String(orderId));
  if (!order) {
    showToast('Erreur', 'Commande non trouv√©e', 'error');
    return;
  }
  
  // Use the modern PDF generator
  generateModernBCPdf(order, order.ownerName || '-');
  showToast('Succ√®s', 'PDF t√©l√©charg√©', 'success');
}


// =====================================================
// ADMIN: TOUTES LES ENTREPRISES
// =====================================================

function renderAdminEntreprises() {
  populateCommercialFilter('filterAdminEntCommercial');
  
  const search = document.getElementById('searchAdminEnt')?.value.toLowerCase() || '';
  const commercialFilter = document.getElementById('filterAdminEntCommercial')?.value;
  const typeFilter = document.getElementById('filterAdminEntType')?.value;
  
  let entreprises = [...data.entreprises];
  
  // Stats
  document.getElementById('adminEntTotal').textContent = entreprises.length;
  document.getElementById('adminEntClients').textContent = entreprises.filter(e => e.type === 'Client').length;
  document.getElementById('adminEntProspects').textContent = entreprises.filter(e => e.type === 'Prospect').length;
  
  // Filters
  if (commercialFilter) {
    entreprises = entreprises.filter(e => e.ownerId === parseInt(commercialFilter));
  }
  if (typeFilter) {
    entreprises = entreprises.filter(e => e.type === typeFilter);
  }
  if (search) {
    entreprises = entreprises.filter(e => 
      e.name.toLowerCase().includes(search) || 
      e.city?.toLowerCase().includes(search)
    );
  }
  
  const container = document.getElementById('adminEntreprisesTable');
  
  if (entreprises.length === 0) {
    container.innerHTML = '<tr><td colspan="10" class="text-muted" style="text-align: center; padding: 2rem;">Aucune entreprise</td></tr>';
    return;
  }
  
  container.innerHTML = entreprises.map(e => {
    const owner = data.users.find(u => String(u.id) === String(e.ownerId));
    const contacts = (data.contacts || []).filter(c => c.entrepriseId === e.id).length;
    const opps = (data.opportunites || []).filter(o => o.entrepriseId === e.id);
    const ca = opps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    
    return `
      <tr>
        <td><strong>${e.name}</strong></td>
        <td><select class="status-select" onchange="changeEntrepriseType('${e.id}', this.value)" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);font-size:12px;"><option value="Prospect" ${e.type === 'Prospect' ? 'selected' : ''}>üîµ Prospect</option><option value="Client" ${e.type === 'Client' ? 'selected' : ''}>üü¢ Client</option><option value="Partenaire" ${e.type === 'Partenaire' ? 'selected' : ''}>üü£ Partenaire</option><option value="Inactif" ${e.type === 'Inactif' ? 'selected' : ''}>‚ö´ Inactif</option></select></td>
        <td>${e.industry || '-'}</td>
        <td>${e.city || '-'}</td>
        <td>${owner?.firstName} ${owner?.lastName || ''}</td>
        <td>${contacts}</td>
        <td>${opps.length}</td>
        <td class="font-mono" style="color: var(--success);">${formatCurrency(ca)}</td>
      </tr>
    `;
  }).join('');
}

function exportAdminEntreprises() {
  const headers = ['Entreprise', 'Type', 'Secteur', 'Ville', 'Commercial', 'Contacts', 'Opportunit√©s', 'CA'];
  const rows = (data.entreprises || []).map(e => {
    const owner = data.users.find(u => String(u.id) === String(e.ownerId));
    const contacts = (data.contacts || []).filter(c => c.entrepriseId === e.id).length;
    const opps = (data.opportunites || []).filter(o => o.entrepriseId === e.id);
    const ca = opps.reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
    return [e.name, e.type, e.industry, e.city, `${owner?.firstName || ''} ${owner?.lastName || ''}`, contacts, opps.length, ca];
  });
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'admin_entreprises.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

// =====================================================
// ADMIN: TOUS LES CONTACTS
// =====================================================

function renderAdminContacts() {
  populateCommercialFilter('filterAdminContactCommercial');
  
  const search = document.getElementById('searchAdminContact')?.value.toLowerCase() || '';
  const commercialFilter = document.getElementById('filterAdminContactCommercial')?.value;
  const typeFilter = document.getElementById('filterAdminContactType')?.value;
  
  let contacts = [...data.contacts];
  
  // Stats
  document.getElementById('adminContactsTotal').textContent = contacts.length;
  document.getElementById('adminContactsPrimary').textContent = contacts.filter(c => c.isPrimary).length;
  document.getElementById('adminContactsClients').textContent = contacts.filter(c => c.contactType === 'client').length;
  document.getElementById('adminContactsProspects').textContent = contacts.filter(c => c.contactType === 'prospect').length;
  
  // Filters
  if (commercialFilter) {
    contacts = contacts.filter(c => c.ownerId === parseInt(commercialFilter));
  }
  if (typeFilter) {
    contacts = contacts.filter(c => c.contactType === typeFilter);
  }
  if (search) {
    contacts = contacts.filter(c => 
      `${c.firstName} ${c.lastName}`.toLowerCase().includes(search) ||
      c.email?.toLowerCase().includes(search)
    );
  }
  
  const container = document.getElementById('adminContactsTable');
  
  if (contacts.length === 0) {
    container.innerHTML = '<tr><td colspan="10" class="text-muted" style="text-align: center; padding: 2rem;">Aucun contact</td></tr>';
    return;
  }
  
  container.innerHTML = contacts.map(c => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(c.entrepriseId));
    const owner = data.users.find(u => String(u.id) === String(c.ownerId));
    const contactType = CONTACT_TYPES.find(t => String(t.id) === String(c.contactType));
    
    return `
      <tr>
        <td><code class="font-mono">${entreprise?.id || '-'}</code></td>
        <td><strong>${entreprise?.name || '-'}</strong></td>
        <td><code class="font-mono">${c.id}</code></td>
        <td><strong>${c.lastName || ''}</strong></td>
        <td>${c.firstName || ''}</td>
        <td>${c.email || '-'}</td>
        <td>${c.mobile || c.phone || '-'}</td>
        <td>${c.function || '-'}</td>
        <td><span class="badge badge-${c.contactType === 'client' ? 'success' : c.contactType === 'prospect' ? 'warning' : 'default'}">${contactType?.name || '-'}</span></td>
        <td>${owner?.firstName || ''} ${owner?.lastName || ''}</td>
      </tr>
    `;
  }).join('');
}

function exportAdminContacts() {
  const headers = ['ID Entreprise', 'Entreprise', 'ID Contact', 'Nom', 'Pr√©nom', 'E-mail', 'N¬∞ Mobile', 'Fonction', 'Type', 'Commercial'];
  const rows = (data.contacts || []).map(c => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(c.entrepriseId));
    const owner = data.users.find(u => String(u.id) === String(c.ownerId));
    const contactType = CONTACT_TYPES.find(t => String(t.id) === String(c.contactType));
    return [entreprise?.id, entreprise?.name, c.id, c.lastName, c.firstName, c.email, c.mobile || c.phone, c.function, contactType?.name, `${owner?.firstName || ''} ${owner?.lastName || ''}`];
  });
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'admin_contacts.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

// =====================================================
// ADMIN: TOUTES LES OPPORTUNIT√âS
// =====================================================

function renderAdminOpportunites() {
  populateCommercialFilter('filterAdminOppCommercial');
  populateStageFilter('filterAdminOppStage');
  
  const commercialFilter = document.getElementById('filterAdminOppCommercial')?.value;
  const stageFilter = document.getElementById('filterAdminOppStage')?.value;
  const stateFilter = document.getElementById('filterAdminOppState')?.value;
  const search = document.getElementById('searchAdminOpp')?.value.toLowerCase() || '';
  
  let opportunites = [...data.opportunites];
  
  // Stats
  document.getElementById('adminOppTotal').textContent = opportunites.length;
  
  const pipeline = opportunites.filter(o => {
    const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
    return !stage?.isWon && !stage?.isLost;
  }).reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  document.getElementById('adminOppPipeline').textContent = formatCurrency(pipeline);
  
  const won = opportunites.filter(o => PIPELINE_STAGES.find(s => s.id === o.stage)?.isWon)
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  document.getElementById('adminOppWon').textContent = formatCurrency(won);
  
  const lost = opportunites.filter(o => PIPELINE_STAGES.find(s => s.id === o.stage)?.isLost)
    .reduce((sum, o) => sum + (parseFloat(o.amount) || 0), 0);
  document.getElementById('adminOppLost').textContent = formatCurrency(lost);
  
  // Filters
  if (commercialFilter) {
    opportunites = opportunites.filter(o => o.ownerId === parseInt(commercialFilter));
  }
  if (stageFilter) {
    opportunites = opportunites.filter(o => o.stage === stageFilter);
  }
  if (stateFilter) {
    opportunites = opportunites.filter(o => o.state === stateFilter);
  }
  if (search) {
    opportunites = opportunites.filter(o => 
      o.name?.toLowerCase().includes(search) ||
      o.description?.toLowerCase().includes(search)
    );
  }
  
  const container = document.getElementById('adminOpportunitesTable');
  
  if (opportunites.length === 0) {
    container.innerHTML = '<tr><td colspan="19" class="text-muted" style="text-align: center; padding: 2rem;">Aucune opportunit√©</td></tr>';
    return;
  }
  
  container.innerHTML = opportunites.map(o => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(o.entrepriseId));
    const contact = data.contacts.find(c => String(c.id) === String(o.contactId));
    const owner = data.users.find(u => String(u.id) === String(o.ownerId));
    const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
    const state = OPP_STATES.find(s => s.id === o.state);
    const priority = OPP_PRIORITIES.find(p => String(p.id) === String(o.priority));
    const source = OPP_SOURCES.find(s => s.id === o.source);
    const motif = OPP_MOTIFS_ECHEC.find(m => m.id === o.motifEchec);
    
    return `
      <tr>
        <td><code class="font-mono">${o.id}</code></td>
        <td><strong>${o.name || '-'}</strong></td>
        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${o.description || ''}">${o.description || '-'}</td>
        <td><code class="font-mono">${entreprise?.id || '-'}</code></td>
        <td>${entreprise?.name || '-'}</td>
        <td>${entreprise?.city || '-'}</td>
        <td>${contact ? `${contact.firstName} ${contact.lastName}` : '-'}</td>
        <td>${contact?.mobile || contact?.phone || '-'}</td>
        <td><span class="badge" style="background: ${stage?.color}20; color: ${stage?.color}; font-size: 9px;">${stage?.name || o.stage}</span></td>
        <td class="font-mono" style="color: var(--success); font-weight: 600;">${formatCurrency(o.amount)}</td>
        <td>${o.createdAt ? formatDate(o.createdAt) : '-'}</td>
        <td>${o.expectedClose ? formatDate(o.expectedClose) : '-'}</td>
        <td>
          <div style="display: flex; align-items: center; gap: 4px;">
            <div class="probability-bar" style="width: 40px;">
              <div class="probability-fill" style="width: ${o.probability}%;"></div>
            </div>
            <span style="font-size: 10px;">${o.probability}%</span>
          </div>
        </td>
        <td><span class="badge" style="background: ${state?.color}20; color: ${state?.color}; font-size: 10px;">${state?.name || '-'}</span></td>
        <td style="font-size: 11px;">${motif?.name || '-'}</td>
        <td><span class="badge" style="background: ${priority?.color}20; color: ${priority?.color}; font-size: 10px;">${priority?.name || '-'}</span></td>
        <td style="font-size: 11px;">${source?.name || '-'}</td>
        <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${o.avancement || ''}">${o.avancement || '-'}</td>
        <td>${owner?.firstName || ''} ${owner?.lastName || ''}</td>
      </tr>
    `;
  }).join('');
}

function exportAdminOpportunites() {
  const headers = ['ID Opportunit√©', 'Nom opportunit√©', 'Description', 'ID Entreprise', 'Entreprise', 'Ville', 'Interlocuteur', 'N¬∞ Mobile', '√âtape', 'Montant', 'Date cr√©ation', 'Date cl√¥ture', '% R√©ussite', '√âtat', 'Motif √©chec', 'Priorit√©', 'Source', 'Avancement', 'Commercial'];
  const rows = (data.opportunites || []).map(o => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(o.entrepriseId));
    const contact = data.contacts.find(c => String(c.id) === String(o.contactId));
    const owner = data.users.find(u => String(u.id) === String(o.ownerId));
    const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
    const state = OPP_STATES.find(s => s.id === o.state);
    const priority = OPP_PRIORITIES.find(p => String(p.id) === String(o.priority));
    const source = OPP_SOURCES.find(s => s.id === o.source);
    const motif = OPP_MOTIFS_ECHEC.find(m => m.id === o.motifEchec);
    return [
      o.id, 
      o.name, 
      o.description, 
      entreprise?.id, 
      entreprise?.name, 
      entreprise?.city,
      contact ? `${contact.firstName} ${contact.lastName}` : '',
      contact?.mobile || contact?.phone,
      stage?.name, 
      o.amount, 
      o.createdAt ? formatDate(o.createdAt) : '',
      o.expectedClose, 
      o.probability + '%', 
      state?.name,
      motif?.name,
      priority?.name,
      source?.name,
      o.avancement,
      `${owner?.firstName || ''} ${owner?.lastName || ''}`
    ];
  });
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'admin_opportunites.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

// =====================================================
// ADMIN: TOUS LES BONS DE COMMANDE
// =====================================================

function renderAdminCommandes() {
  populateCommercialFilter('filterAdminBCCommercial');
  
  const commercialFilter = document.getElementById('filterAdminBCCommercial')?.value;
  const dateFrom = document.getElementById('filterAdminBCDateFrom')?.value;
  const dateTo = document.getElementById('filterAdminBCDateTo')?.value;
  
  let orders = data.orders || [];
  
  // Stats
  document.getElementById('adminBCTotal').textContent = orders.length;
  const totalCA = orders.reduce((sum, o) => sum + (o.totalTTC || 0), 0);
  document.getElementById('adminBCCA').textContent = formatCurrency(totalCA);
  document.getElementById('adminBCAvg').textContent = orders.length > 0 ? formatCurrency(totalCA / orders.length) : '0 ‚Ç¨';
  
  // Filters
  if (commercialFilter) {
    orders = orders.filter(o => String(o.ownerId) === String(commercialFilter));
  }
  if (dateFrom) {
    orders = orders.filter(o => o.orderDate >= dateFrom);
  }
  if (dateTo) {
    orders = orders.filter(o => o.orderDate <= dateTo);
  }
  
  const container = document.getElementById('adminCommandesTable');
  
  if (orders.length === 0) {
    container.innerHTML = '<tr><td colspan="10" class="text-muted" style="text-align: center; padding: 2rem;">Aucun bon de commande</td></tr>';
    return;
  }
  
  container.innerHTML = orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)).map(o => `
    <tr>
      <td><code class="font-mono">${o.orderNumber}</code></td>
      <td>${formatDate(o.orderDate)}</td>
      <td><strong>${o.clientName}</strong></td>
      <td>${o.products?.length || 0} article(s)</td>
      <td class="font-mono">${formatCurrency(o.totalHT)}</td>
      <td class="font-mono" style="color: var(--success); font-weight: 600;">${formatCurrency(o.totalTTC)}</td>
      <td>${o.ownerName || '-'}</td>
      <td class="actions-cell">
        <button class="btn btn-icon sm" onclick="downloadOrderPDF(${o.id})" title="T√©l√©charger PDF">üì•</button>
        <button class="btn btn-icon sm" onclick="viewOrderDetails(${o.id})" title="Voir d√©tails">üëÅÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

function exportAdminCommandes() {
  const orders = data.orders || [];
  const headers = ['N¬∞ Commande', 'Date', 'Client', 'Produits', 'Total HT', 'TVA', 'Total TTC', 'Commercial'];
  const rows = orders.map(o => [o.orderNumber, o.orderDate, o.clientName, o.products?.length || 0, o.totalHT, o.totalTVA, o.totalTTC, o.ownerName || '']);
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'admin_commandes.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

// =====================================================
// HELPER: Populate Filters
// =====================================================

function populateCommercialFilter(selectId) {
  const select = document.getElementById(selectId);
  if (!select || select.options.length > 1) return;
  
  const commerciaux = (data.users || []).filter(u => u.role === 'commercial');
  commerciaux.forEach(u => {
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = `${u.firstName} ${u.lastName}`;
    select.appendChild(option);
  });
}

function populateStageFilter(selectId) {
  const select = document.getElementById(selectId);
  if (!select || select.options.length > 1) return;
  
  PIPELINE_STAGES.forEach(s => {
    const option = document.createElement('option');
    option.value = s.id;
    option.textContent = s.name;
    select.appendChild(option);
  });
}

// =====================================================
// PARAM√àTRES
// =====================================================

function loadSettings() {
  document.getElementById('settingCompanyName').value = data.settings.companyName || '';
  document.getElementById('settingCompanyAddress').value = data.settings.companyAddress || '';
  document.getElementById('settingCompanyPhone').value = data.settings.companyPhone || '';
  document.getElementById('settingCompanyEmail').value = data.settings.companyEmail || '';
  document.getElementById('settingCompanySiret').value = data.settings.companySiret || '';
  document.getElementById('settingDarkMode').checked = data.settings.darkMode;
  document.getElementById('settingCurrency').value = data.settings.currency || 'EUR';
  document.getElementById('settingTVA').value = data.settings.tvaRate || 20;
}

function saveSettings() {
  data.settings.companyName = document.getElementById('settingCompanyName').value.trim();
  data.settings.companyAddress = document.getElementById('settingCompanyAddress').value.trim();
  data.settings.companyPhone = document.getElementById('settingCompanyPhone').value.trim();
  data.settings.companyEmail = document.getElementById('settingCompanyEmail').value.trim();
  data.settings.companySiret = document.getElementById('settingCompanySiret').value.trim();
  data.settings.currency = document.getElementById('settingCurrency').value;
  data.settings.tvaRate = parseFloat(document.getElementById('settingTVA').value) || 20;
  
  saveData();
  showToast('Enregistr√©', 'Param√®tres sauvegard√©s', 'success');
}

function showSettingsTab(tabId, btn) {
  document.querySelectorAll('.settings-tab').forEach(t => t.style.display = 'none');
  document.querySelectorAll('.settings-nav-item').forEach(n => n.classList.remove('active'));
  
  document.getElementById('settings-' + tabId).style.display = 'block';
  btn?.classList.add('active');
}

function exportAllData() {
  const exportData = {
    data: data,
    productCatalogue: PRODUCT_CATALOGUE,
    packsCatalogue: PACKS_CATALOGUE,
    exportedAt: new Date().toISOString()
  };
  downloadFile(JSON.stringify(exportData, null, 2), `crm_export_${formatDateFile(new Date())}.json`, 'application/json');
  showToast('Export√©', 'Donn√©es export√©es', 'success');
}

function importData() {
  document.getElementById('importFile').click();
}

function handleImport(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const imported = JSON.parse(event.target.result);
      
      // Check if it's the new format with catalogues
      if (imported.data && imported.productCatalogue) {
        // New format
        data = imported.data;
        
        // Update catalogues
        PRODUCT_CATALOGUE.length = 0;
        imported.productCatalogue.forEach(p => PRODUCT_CATALOGUE.push(p));
        localStorage.setItem('crm_product_catalogue', JSON.stringify(PRODUCT_CATALOGUE));
        
        if (imported.packsCatalogue) {
          PACKS_CATALOGUE.length = 0;
          imported.packsCatalogue.forEach(p => PACKS_CATALOGUE.push(p));
          localStorage.setItem('crm_packs_catalogue', JSON.stringify(PACKS_CATALOGUE));
        }
      } else {
        // Old format (just data)
        data = imported;
      }
      
      saveData();
      showToast('Succ√®s', 'Donn√©es import√©es avec succ√®s', 'success');
      showPage('dashboard');
    } catch (err) {
      console.error('Import error:', err);
      showToast('Erreur', 'Fichier invalide', 'error');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function resetAllData() {
  if (!confirm('‚ö†Ô∏è ATTENTION: Toutes les donn√©es seront supprim√©es. Continuer ?')) return;
  if (!confirm('Cette action est IRR√âVERSIBLE. √ätes-vous vraiment s√ªr ?')) return;
  
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem('crm_product_catalogue');
  localStorage.removeItem('crm_packs_catalogue');
  data = JSON.parse(JSON.stringify(DEFAULT_DATA));
  saveData();
  handleLogout();
  showToast('R√©initialis√©', 'Donn√©es r√©initialis√©es', 'success');
}

// =====================================================
// MODALS
// =====================================================

function openModal(type, id = null) {
  const modal = document.getElementById('modalOverlay');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');
  
  switch(type) {
    case 'entreprise':
      title.textContent = id ? 'Modifier l\'entreprise' : 'Nouvelle entreprise';
      body.innerHTML = getEntrepriseForm(id);
      break;
    case 'contact':
      title.textContent = id ? 'Modifier le contact' : 'Nouveau contact';
      body.innerHTML = getContactForm(id);
      break;
    case 'opportunite':
      title.textContent = id ? 'Modifier l\'opportunit√©' : 'Nouvelle opportunit√©';
      body.innerHTML = getOpportuniteForm(id);
      break;
    case 'produit':
      title.textContent = id ? 'Modifier le produit' : 'Nouveau produit';
      body.innerHTML = getProduitForm(id);
      break;
    case 'produit-catalogue':
      title.textContent = 'Modifier le produit catalogue';
      body.innerHTML = getProduitCatalogueForm(id);
      break;
    case 'pack':
      title.textContent = 'Nouveau Pack';
      body.innerHTML = getPackForm();
      setTimeout(() => initPackForm(), 100);
      break;
    case 'pack-edit':
      title.textContent = 'Modifier le Pack';
      body.innerHTML = getPackEditForm(id, false);
      setTimeout(() => initPackEditForm(id, false), 100);
      break;
    case 'pack-catalogue':
      title.textContent = 'Modifier le Pack catalogue';
      body.innerHTML = getPackEditForm(id, true);
      setTimeout(() => initPackEditForm(id, true), 100);
      break;
    case 'message':
      title.textContent = 'Nouveau message';
      body.innerHTML = getMessageForm();
      break;
    case 'alerte':
      title.textContent = 'Nouvelle alerte';
      body.innerHTML = getAlerteForm();
      break;
    case 'utilisateur':
      title.textContent = id ? 'Modifier le commercial' : 'Nouveau commercial';
      body.innerHTML = getUtilisateurForm(id);
      break;
    case 'rdv':
      title.textContent = id ? 'Modifier le RDV' : 'Nouveau RDV';
      body.innerHTML = getRdvForm(id);
      break;
    case 'appel':
      title.textContent = id ? 'Modifier l\'appel' : 'Nouvel appel';
      body.innerHTML = getAppelForm(id);
      break;
    case 'tache':
      title.textContent = id ? 'Modifier la t√¢che' : 'Nouvelle t√¢che';
      body.innerHTML = getTacheForm(id);
      break;
    case 'email':
      title.textContent = id ? 'Modifier l\'email' : 'Nouvel email';
      body.innerHTML = getEmailForm(id);
      break;
    default:
      return;
  }
  
  modal.classList.add('active');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
}

function closeModalOverlay(e) {
  if (e.target.id === 'modalOverlay') {
    closeModal();
  }
}

// Fonctions pour le modal principal (Actions: Email, RDV, Appels, T√¢ches)
function openMainModal() {
  console.log('üîì openMainModal appel√©e');
  const modal = document.getElementById('modalOverlay');
  if (modal) {
    modal.classList.add('active');
    console.log('‚úÖ Modal ouvert');
  } else {
    console.error('‚ùå modalOverlay non trouv√©');
  }
}

function closeMainModal() {
  console.log('üîí closeMainModal appel√©e');
  const modal = document.getElementById('modalOverlay');
  if (modal) {
    modal.classList.remove('active');
    console.log('‚úÖ Modal ferm√©');
  } else {
    console.error('‚ùå modalOverlay non trouv√©');
  }
}

function getEntrepriseForm(id) {
  const e = id ? data.entreprises.find(ent => String(ent.id) === String(id)) : {};
  // Trouver le contact principal associ√©
  const primaryContact = id ? data.contacts.find(c => c.entrepriseId === id && c.isPrimary) : null;
  
  return `
    <form onsubmit="saveEntrepriseWithContact(event)" data-id="${id || ''}">
      <!-- Section Entreprise -->
      <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0; color: var(--brand-primary); font-size: 14px;">üè¢ Informations Entreprise</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nom entreprise <span class="required">*</span></label>
            <input type="text" class="form-control" name="name" value="${e.name || ''}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Nom commercial</label>
            <input type="text" class="form-control" name="tradeName" value="${e.tradeName || ''}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Type <span class="required">*</span></label>
            <select class="form-control" name="type" required>
              <option value="Prospect" ${e.type === 'Prospect' ? 'selected' : ''}>Prospect</option>
              <option value="Client" ${e.type === 'Client' ? 'selected' : ''}>Client</option>
              <option value="Partenaire" ${e.type === 'Partenaire' ? 'selected' : ''}>Partenaire</option>
              <option value="Fournisseur" ${e.type === 'Fournisseur' ? 'selected' : ''}>Fournisseur</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Secteur d'activit√©</label>
            <input type="text" class="form-control" name="industry" value="${e.industry || ''}" placeholder="Ex: Restauration">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">SIRET</label>
            <input type="text" class="form-control" name="siret" value="${e.siret || ''}" placeholder="XXX XXX XXX XXXXX">
          </div>
          <div class="form-group">
            <label class="form-label">Email entreprise</label>
            <input type="email" class="form-control" name="email" value="${e.email || ''}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">T√©l√©phone entreprise</label>
            <input type="tel" class="form-control" name="phone" value="${e.phone || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Site web</label>
            <input type="url" class="form-control" name="website" value="${e.website || ''}" placeholder="https://">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Adresse</label>
          <input type="text" class="form-control" name="address" value="${e.address || ''}">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Code postal</label>
            <input type="text" class="form-control" name="postalCode" value="${e.postalCode || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Ville</label>
            <input type="text" class="form-control" name="city" value="${e.city || ''}">
          </div>
        </div>
      </div>
      
      <!-- Section Contact Principal -->
      <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 15px 0; color: var(--brand-accent); font-size: 14px;">üë§ Contact Principal</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Civilit√©</label>
            <select class="form-control" name="contactCivility">
              <option value="">--</option>
              <option value="M." ${primaryContact?.civility === 'M.' ? 'selected' : ''}>M.</option>
              <option value="Mme" ${primaryContact?.civility === 'Mme' ? 'selected' : ''}>Mme</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Pr√©nom</label>
            <input type="text" class="form-control" name="contactFirstName" value="${primaryContact?.firstName || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Nom</label>
            <input type="text" class="form-control" name="contactLastName" value="${primaryContact?.lastName || ''}">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Fonction</label>
            <input type="text" class="form-control" name="contactFunction" value="${primaryContact?.function || ''}" placeholder="Ex: G√©rant, Directeur...">
          </div>
          <div class="form-group">
            <label class="form-label">Type de contact</label>
            <select class="form-control" name="contactType">
              ${CONTACT_TYPES.map(t => '<option value="' + t.id + '" ' + (primaryContact?.contactType === t.id ? 'selected' : '') + '>' + t.name + '</option>').join('')}
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email contact</label>
            <input type="email" class="form-control" name="contactEmail" value="${primaryContact?.email || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">T√©l√©phone fixe</label>
            <input type="tel" class="form-control" name="contactPhone" value="${primaryContact?.phone || ''}" placeholder="01 23 45 67 89">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Mobile</label>
            <input type="tel" class="form-control" name="contactMobile" value="${primaryContact?.mobile || ''}" placeholder="06 12 34 56 78">
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <input type="text" class="form-control" name="contactNotes" value="${primaryContact?.notes || ''}" placeholder="Remarques...">
          </div>
        </div>
      </div>
      
      <input type="hidden" name="contactId" value="${primaryContact?.id || ''}">
      
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">${id ? 'Modifier' : 'Cr√©er'}</button>
      </div>
    </form>
  `;
}

function getContactForm(id) {
  const c = id ? data.contacts.find(ct => ct.id === id) : {};
  const entreprises = getAccessibleEntreprises();
  
  return `
    <form onsubmit="saveContact(event)" data-id="${id || ''}">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nom <span class="required">*</span></label>
          <input type="text" class="form-control" name="lastName" value="${c.lastName || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Pr√©nom <span class="required">*</span></label>
          <input type="text" class="form-control" name="firstName" value="${c.firstName || ''}" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Entreprise <span class="required">*</span></label>
          <select class="form-control" name="entrepriseId" required>
            <option value="">-- S√©lectionner --</option>
            ${entreprises.map(e => `<option value="${e.id}" ${c.entrepriseId === e.id ? 'selected' : ''}>${e.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Type de contact <span class="required">*</span></label>
          <select class="form-control" name="contactType" required>
            ${CONTACT_TYPES.map(t => `<option value="${t.id}" ${c.contactType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fonction</label>
          <input type="text" class="form-control" name="function" value="${c.function || ''}" placeholder="Ex: Directeur">
        </div>
        <div class="form-group">
          <label class="form-label">E-mail</label>
          <input type="email" class="form-control" name="email" value="${c.email || ''}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">T√©l√©phone fixe</label>
          <input type="tel" class="form-control" name="phone" value="${c.phone || ''}" placeholder="01 23 45 67 89">
        </div>
        <div class="form-group">
          <label class="form-label">N¬∞ Mobile</label>
          <input type="tel" class="form-control" name="mobile" value="${c.mobile || ''}" placeholder="06 12 34 56 78">
        </div>
      </div>
      <div class="form-group">
        <label class="form-check">
          <input type="checkbox" name="isPrimary" ${c.isPrimary ? 'checked' : ''}>
          <span>Contact principal</span>
        </label>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" name="notes" rows="2">${c.notes || ''}</textarea>
      </div>
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">${id ? 'Modifier' : 'Cr√©er'}</button>
      </div>
    </form>
  `;
}

function getOpportuniteForm(id) {
  const o = id ? data.opportunites.find(op => op.id === id) : {};
  const entreprises = getAccessibleEntreprises();
  const contacts = (data.contacts || []).filter(c => !o.entrepriseId || c.entrepriseId === o.entrepriseId);
  
  // Get all products, services and packs for the dropdown
  const allItems = [
    ...PACKS_CATALOGUE.map(p => ({ ref: p.ref, name: `üì¶ ${p.name}`, price: p.price, type: 'Pack' })),
    ...(data.packs || []).map(p => ({ ref: p.ref, name: `üì¶ ${p.name}`, price: p.price, type: 'Pack' })),
    ...PRODUCT_CATALOGUE.map(p => ({ ref: p.ref, name: p.name, price: p.price, type: p.type })),
    ...(data.produits || []).map(p => ({ ref: p.reference, name: p.name, price: p.price, type: p.type }))
  ];
  
  return `
    <form onsubmit="saveOpportunite(event)" data-id="${id || ''}" style="max-height: 70vh; overflow-y: auto;">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Produit/Service/Pack <span class="required">*</span></label>
          <select class="form-control" name="name" required onchange="updateOppAmount(this)">
            <option value="">-- S√©lectionner --</option>
            <optgroup label="üì¶ Packs">
              ${allItems.filter(i => i.type === 'Pack').map(i => `<option value="${i.name}" data-price="${i.price}" ${o.name === i.name ? 'selected' : ''}>${i.ref} - ${i.name}</option>`).join('')}
            </optgroup>
            <optgroup label="üõí Produits">
              ${allItems.filter(i => i.type === 'Produit').map(i => `<option value="${i.name}" data-price="${i.price}" ${o.name === i.name ? 'selected' : ''}>${i.ref} - ${i.name}</option>`).join('')}
            </optgroup>
            <optgroup label="üîß Services">
              ${allItems.filter(i => i.type === 'Service').map(i => `<option value="${i.name}" data-price="${i.price}" ${o.name === i.name ? 'selected' : ''}>${i.ref} - ${i.name}</option>`).join('')}
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Montant (‚Ç¨) <span class="required">*</span></label>
          <input type="number" class="form-control" name="amount" value="${o.amount || ''}" min="0" step="0.01" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" name="description" rows="2" placeholder="Description de l'opportunit√©...">${o.description || ''}</textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Entreprise <span class="required">*</span></label>
          <select class="form-control" name="entrepriseId" required onchange="updateContactDropdown(this.value, 'oppContactId')">
            <option value="">-- S√©lectionner --</option>
            ${entreprises.map(e => `<option value="${e.id}" ${o.entrepriseId === e.id ? 'selected' : ''}>${e.name} - ${e.city || ''}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Interlocuteur</label>
          <select class="form-control" name="contactId" id="oppContactId">
            <option value="">-- S√©lectionner --</option>
            ${contacts.map(c => `<option value="${c.id}" ${o.contactId === c.id ? 'selected' : ''}>${c.firstName} ${c.lastName}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">√âtape <span class="required">*</span></label>
          <select class="form-control" name="stage" required onchange="updateProbability(this)">
            ${PIPELINE_STAGES.map(s => `<option value="${s.id}" data-prob="${s.probability}" ${o.stage === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">% R√©ussite</label>
          <input type="number" class="form-control" name="probability" value="${o.probability || 50}" min="0" max="100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">√âtat <span class="required">*</span></label>
          <select class="form-control" name="state" required>
            ${OPP_STATES.map(s => `<option value="${s.id}" ${o.state === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priorit√©</label>
          <select class="form-control" name="priority">
            ${OPP_PRIORITIES.map(p => `<option value="${p.id}" ${o.priority === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Source</label>
          <select class="form-control" name="source">
            <option value="">-- S√©lectionner --</option>
            ${OPP_SOURCES.map(s => `<option value="${s.id}" ${o.source === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Motif de l'√©chec</label>
          <select class="form-control" name="motifEchec">
            ${OPP_MOTIFS_ECHEC.map(m => `<option value="${m.id}" ${o.motifEchec === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date de cr√©ation</label>
          <input type="date" class="form-control" value="${o.createdAt ? o.createdAt.split('T')[0] : new Date().toISOString().split('T')[0]}" disabled>
        </div>
        <div class="form-group">
          <label class="form-label">Date de cl√¥ture pr√©vue</label>
          <input type="date" class="form-control" name="expectedClose" value="${o.expectedClose || ''}">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Avancement du dossier</label>
        <textarea class="form-control" name="avancement" rows="2" placeholder="Notes sur l'avancement...">${o.avancement || ''}</textarea>
      </div>
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">${id ? 'Modifier' : 'Cr√©er'}</button>
      </div>
    </form>
  `;
}

// Helper functions for opportunity form
function updateOppAmount(select) {
  const price = parseFloat(select.options[select.selectedIndex]?.dataset.price) || 0;
  const amountField = select.form.querySelector('[name="amount"]');
  if (amountField && price > 0) {
    amountField.value = price;
  }
}

function updateProbability(select) {
  const prob = parseInt(select.options[select.selectedIndex]?.dataset.prob) || 50;
  const probField = select.form.querySelector('[name="probability"]');
  if (probField) {
    probField.value = prob;
  }
}

function updateContactDropdown(entrepriseId, selectId) {
  const contacts = (data.contacts || []).filter(c => c.entrepriseId === parseInt(entrepriseId));
  const select = document.getElementById(selectId);
  if (select) {
    select.innerHTML = '<option value="">-- S√©lectionner --</option>' +
      contacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
  }
}

function getProduitForm(id) {
  let p = {};
  
  // Check if it's a catalogue product
  if (id && String(id).startsWith('cat_')) {
    const catIndex = parseInt(String(id).replace('cat_', ''));
    const catProduct = PRODUCT_CATALOGUE[catIndex];
    if (catProduct) {
      p = { ...catProduct, reference: catProduct.ref };
    }
  } else if (id) {
    p = data.produits.find(pr => pr.id === parseInt(id)) || {};
  }
  
  const categories = ['Mat√©riel', 'Logiciel', 'IoT', 'Service', 'Formation', 'Support', 'Consommables', 'Connectique'];
  
  return `
    <form onsubmit="saveProduit(event)" data-id="${id || ''}">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">R√©f√©rence <span class="required">*</span></label>
          <input type="text" class="form-control" name="reference" value="${p.reference || p.ref || ''}" required placeholder="Ex: PROD-001">
        </div>
        <div class="form-group">
          <label class="form-label">Type <span class="required">*</span></label>
          <select class="form-control" name="type" required>
            <option value="Produit" ${p.type === 'Produit' ? 'selected' : ''}>Produit</option>
            <option value="Service" ${p.type === 'Service' ? 'selected' : ''}>Service</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">D√©signation <span class="required">*</span></label>
        <input type="text" class="form-control" name="name" value="${p.name || ''}" required>
      </div>
      <div class="form-group">
        <label class="form-label">Mod√®le</label>
        <input type="text" class="form-control" name="model" value="${p.model || ''}" placeholder="Ex: RP324, TempLog Pro...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Cat√©gorie <span class="required">*</span></label>
          <select class="form-control" name="category" required>
            ${categories.map(c => `<option value="${c}" ${p.category === c ? 'selected' : ''}>${c}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Taux TVA</label>
          <select class="form-control" name="tva">
            <option value="20" ${(p.tva || 20) === 20 ? 'selected' : ''}>20%</option>
            <option value="10" ${p.tva === 10 ? 'selected' : ''}>10%</option>
            <option value="5.5" ${p.tva === 5.5 ? 'selected' : ''}>5.5%</option>
            <option value="0" ${p.tva === 0 ? 'selected' : ''}>0%</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Prix HT (‚Ç¨) <span class="required">*</span></label>
        <input type="number" class="form-control" name="price" value="${p.price || ''}" required min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-label">Caract√©ristiques</label>
        <textarea class="form-control" name="characteristics" rows="2" placeholder="Sp√©cifications techniques, dimensions, options...">${p.characteristics || ''}</textarea>
        <small style="color: var(--text-muted); font-size: 11px;">Ces informations appara√Ætront sous la d√©signation dans le bon de commande</small>
      </div>
      <div class="form-group">
        <label class="form-label">Notes internes</label>
        <textarea class="form-control" name="notes" rows="2" placeholder="Notes internes (non visibles sur les documents)">${p.notes || ''}</textarea>
      </div>
      <div class="form-group">
        <label class="form-check">
          <input type="checkbox" name="isActive" ${p.isActive !== false ? 'checked' : ''}>
          <span>Actif</span>
        </label>
      </div>
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">${id ? 'Modifier' : 'Cr√©er'}</button>
      </div>
    </form>
  `;
}

function getMessageForm() {
  const users = (data.users || []).filter(u => u.id !== currentUser.id && u.isActive);
  
  return `
    <form onsubmit="sendDirectMessage(event)">
      <div class="form-group">
        <label class="form-label">Destinataire <span class="required">*</span></label>
        <select class="form-control" name="toId" required>
          <option value="">-- S√©lectionner --</option>
          ${users.map(u => `<option value="${u.id}">${u.firstName} ${u.lastName}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Message <span class="required">*</span></label>
        <textarea class="form-control" name="content" rows="4" required placeholder="Votre message..."></textarea>
      </div>
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Envoyer</button>
      </div>
    </form>
  `;
}

function sendDirectMessage(e) {
  e.preventDefault();
  const form = e.target;
  
  if (!data.messages) data.messages = [];
  data.lastId.message = (data.lastId.message || 0) + 1;
  
  data.messages.push({
    id: data.lastId.message,
    fromId: currentUser.id,
    toId: parseInt(form.toId.value),
    content: form.content.value.trim(),
    read: false,
    date: new Date().toISOString()
  });
  
  saveData();
  closeModal();
  showToast('Envoy√©', 'Message envoy√©', 'success');
}

function getAlerteForm() {
  const users = (data.users || []).filter(u => u.isActive);
  const entreprises = data.entreprises || [];
  const opportunities = data.opportunites || [];
  
  return `
    <form onsubmit="saveAlerte(event)">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type d'alerte <span class="required">*</span></label>
          <select class="form-control" name="type" required>
            <option value="information">‚ÑπÔ∏è Information</option>
            <option value="action_required">‚ö° Action requise</option>
            <option value="urgent">üö® Urgent</option>
            <option value="validation">‚úÖ Validation</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priorit√© <span class="required">*</span></label>
          <select class="form-control" name="priority" required>
            <option value="low">‚ö™ Basse</option>
            <option value="medium" selected>üîµ Moyenne</option>
            <option value="high">üü† Haute</option>
            <option value="critical">üî¥ Critique</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Titre <span class="required">*</span></label>
        <input type="text" class="form-control" name="title" placeholder="Titre de l'alerte..." required>
      </div>
      
      <div class="form-group">
        <label class="form-label">Contenu <span class="required">*</span></label>
        <textarea class="form-control" name="content" rows="4" placeholder="D√©crivez l'alerte en d√©tail..." required></textarea>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Destinataires <span class="required">*</span></label>
          <select class="form-control" name="recipients" multiple size="4" style="min-height: 80px;" required>
            <option value="all">üì¢ Tous les utilisateurs</option>
            <option value="admin">üëë Admin uniquement</option>
            ${users.map(u => '<option value="' + u.id + '">' + u.firstName + ' ' + u.lastName + ' (' + u.role + ')</option>').join('')}
          </select>
          <small style="color: var(--text-muted); font-size: 11px;">Ctrl+clic pour s√©lection multiple</small>
        </div>
        <div class="form-group">
          <label class="form-label">Cat√©gorie</label>
          <select class="form-control" name="category">
            <option value="">-- Aucune --</option>
            <option value="devis">üìã Devis</option>
            <option value="commande">üì¶ Bon de commande</option>
            <option value="paiement">üí≥ Paiement</option>
            <option value="client">üë§ Client</option>
            <option value="incident">üîß Incident</option>
            <option value="autre">üìå Autre</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Lier √† un client</label>
          <select class="form-control" name="contextClientId">
            <option value="">-- Aucun --</option>
            ${entreprises.map(e => '<option value="' + e.id + '">' + e.name + '</option>').join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Lier √† une opportunit√©</label>
          <select class="form-control" name="contextOppId">
            <option value="">-- Aucune --</option>
            ${opportunities.map(o => '<option value="' + o.id + '">' + o.name + '</option>').join('')}
          </select>
        </div>
      </div>
      
      <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-top: 15px;">
        <label class="form-label" style="margin-bottom: 10px;">üì° Canaux de diffusion</label>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" name="channel_crm" checked disabled>
            <span>üíª CRM (obligatoire)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" name="channel_email" checked>
            <span>üìß Email</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" name="channel_teams" checked>
            <span>üí¨ Microsoft Teams</span>
          </label>
        </div>
      </div>
      
      <div class="form-group" style="margin-top: 15px;">
        <label class="form-label">Tags (s√©par√©s par virgules)</label>
        <input type="text" class="form-control" name="tags" placeholder="ex: urgent, finance, suivi">
      </div>
      
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">üì§ Envoyer l'alerte</button>
      </div>
    </form>
  `;
}

function getPackForm() {
  // Get all available products for pack composition
  const allProducts = [
    ...PRODUCT_CATALOGUE,
    ...(data.produits || []).map(p => ({ ref: p.reference, name: p.name, price: p.price, type: p.type }))
  ];
  
  return `
    <form onsubmit="savePack(event)">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">R√©f√©rence <span class="required">*</span></label>
          <input type="text" class="form-control" name="ref" required placeholder="Ex: PACK-CUSTOM-01">
        </div>
        <div class="form-group">
          <label class="form-label">Nom du Pack <span class="required">*</span></label>
          <input type="text" class="form-control" name="name" required placeholder="Ex: Pack Premium">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" name="description" rows="2" placeholder="Description du pack..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Caract√©ristiques</label>
        <textarea class="form-control" name="characteristics" rows="2" placeholder="Sp√©cifications techniques, contenu d√©taill√© du pack..."></textarea>
        <small style="color: var(--text-muted); font-size: 11px;">Appara√Ætra sous la ligne du pack dans le bon de commande</small>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" name="notes" rows="2" placeholder="Informations compl√©mentaires, conditions..."></textarea>
        <small style="color: var(--text-muted); font-size: 11px;">Informations additionnelles affich√©es sur le bon de commande</small>
      </div>
      <div class="form-group">
        <label class="form-label">Composition du Pack</label>
        <div id="packItemsContainer" style="max-height: 200px; overflow-y: auto;">
          <!-- Items will be added here -->
        </div>
        <button type="button" class="btn btn-sm" onclick="addPackItem()" style="margin-top: var(--space-sm);">+ Ajouter un √©l√©ment</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Prix normal (calcul√©)</label>
          <input type="text" class="form-control" id="packRegularPrice" readonly value="0,00 ‚Ç¨">
        </div>
        <div class="form-group">
          <label class="form-label">Prix Pack HT <span class="required">*</span></label>
          <input type="number" class="form-control" name="price" step="0.01" min="0" required placeholder="Prix remis√©">
        </div>
      </div>
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Cr√©er le Pack</button>
      </div>
    </form>
  `;
}

// Initialize pack form with first item
function initPackForm() {
  setTimeout(() => addPackItem(), 100);
}

let packItemCounter = 0;

function addPackItem() {
  const container = document.getElementById('packItemsContainer');
  if (!container) return;
  
  const allProducts = [
    ...PRODUCT_CATALOGUE,
    ...(data.produits || []).map(p => ({ ref: p.reference, name: p.name, price: p.price, type: p.type, category: p.category, model: p.model }))
  ];
  
  // Group products by category
  const categories = [...new Set(allProducts.map(p => p.category))];
  
  const index = packItemCounter++;
  const div = document.createElement('div');
  div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
  div.innerHTML = `
    <select class="form-control" name="packItem_${index}" onchange="calculatePackPrice()" style="flex: 2;">
      <option value="">-- S√©lectionner --</option>
      ${categories.map(cat => `
        <optgroup label="${getCategoryIcon(cat)} ${cat}">
          ${allProducts.filter(p => p.category === cat).map(p => 
            `<option value="${p.ref}" data-price="${p.price}">${p.ref} - ${p.name}${p.model ? ' - ' + p.model : ''} (${formatCurrency(p.price)})</option>`
          ).join('')}
        </optgroup>
      `).join('')}
    </select>
    <input type="number" class="form-control" name="packQty_${index}" value="1" min="1" onchange="calculatePackPrice()" style="width: 70px;">
    <button type="button" class="btn btn-icon sm btn-danger" onclick="this.parentElement.remove(); calculatePackPrice();">‚úï</button>
  `;
  container.appendChild(div);
}

function calculatePackPrice() {
  const container = document.getElementById('packItemsContainer');
  if (!container) return;
  
  let total = 0;
  container.querySelectorAll('select').forEach(select => {
    const price = parseFloat(select.options[select.selectedIndex]?.dataset.price) || 0;
    const qtyInput = select.parentElement.querySelector('input[type="number"]');
    const qty = parseFloat(qtyInput?.value) || 1;
    total += price * qty;
  });
  
  document.getElementById('packRegularPrice').value = formatCurrency(total);
}

function savePack(e) {
  e.preventDefault();
  const form = e.target;
  
  // Collect items
  const items = [];
  const container = document.getElementById('packItemsContainer');
  container.querySelectorAll('select').forEach(select => {
    if (select.value) {
      const qtyInput = select.parentElement.querySelector('input[type="number"]');
      items.push({
        ref: select.value,
        qty: parseInt(qtyInput?.value) || 1
      });
    }
  });
  
  if (items.length === 0) {
    showToast('Erreur', 'Ajoutez au moins un √©l√©ment au pack', 'error');
    return;
  }
  
  // Calculate regular price
  let regularPrice = 0;
  items.forEach(item => {
    const product = PRODUCT_CATALOGUE.find(p => p.ref === item.ref) || 
                    data.produits?.find(p => p.reference === item.ref);
    regularPrice += (product?.price || 0) * item.qty;
  });
  
  const pack = {
    ref: form.ref.value.trim().toUpperCase(),
    name: form.name.value.trim(),
    description: form.description?.value.trim() || '',
    characteristics: form.characteristics?.value.trim() || '',
    notes: form.notes?.value.trim() || '',
    type: 'Pack',
    category: 'Pack',
    items: items,
    price: parseFloat(form.price.value) || 0,
    regularPrice: regularPrice
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    (async () => {
      try {
        showLoadingOverlay('Enregistrement...');
        const packData = {
          reference: pack.ref,
          name: pack.name,
          description: pack.description,
          characteristics: pack.characteristics,
          notes: pack.notes,
          type: 'Pack',
          category: 'Pack',
          items: JSON.stringify(pack.items),
          price: pack.price,
          regularPrice: pack.regularPrice,
          isActive: true
        };
        
        const result = await api.createPack(packData);
        hideLoadingOverlay();
        
        if (result.success) {
          const packsRes = await api.getPacks();
          if (packsRes.success) {
            PACKS_CATALOGUE.length = 0;
            packsRes.data.forEach(p => {
              let items = p.items || [];
              if (typeof items === 'string') {
                try { items = JSON.parse(items); } catch(e) { items = []; }
              }
              PACKS_CATALOGUE.push({
                ref: p.reference,
                name: p.name,
                description: p.description || '',
                items: items,
                price: parseFloat(p.price) || 0,
                regularPrice: parseFloat(p.regularPrice) || 0,
                isActive: p.isActive !== false,
                id: p.id
              });
            });
          }
          closeModal();
          renderProduits();
          packItemCounter = 0;
          showToast('Succ√®s', 'Pack cr√©√© avec succ√®s', 'success');
        } else {
          showToast('Erreur', result.message || 'Erreur', 'error');
        }
      } catch (error) {
        hideLoadingOverlay();
        showToast('Erreur', error.message, 'error');
      }
    })();
  } else {
    // Mode localStorage
    if (currentUser?.role === 'admin') {
      PACKS_CATALOGUE.push(pack);
      localStorage.setItem('crm_packs_catalogue', JSON.stringify(PACKS_CATALOGUE));
    } else {
      if (!data.packs) data.packs = [];
      pack.id = Date.now();
      pack.createdAt = new Date().toISOString();
      data.packs.push(pack);
      saveData();
    }
    
    closeModal();
    renderProduits();
    packItemCounter = 0;
    showToast('Succ√®s', 'Pack cr√©√© avec succ√®s', 'success');
  }
}

// =====================================================
// PRODUIT CATALOGUE FORM
// =====================================================

function getProduitCatalogueForm(catIndex) {
  const p = PRODUCT_CATALOGUE[catIndex] || {};
  const categories = ['Mat√©riel', 'Logiciel', 'IoT', 'Service', 'Formation', 'Support', 'Consommables', 'Connectique'];
  
  return `
    <form onsubmit="saveProduitCatalogue(event)" data-cat-index="${catIndex}">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">R√©f√©rence <span class="required">*</span></label>
          <input type="text" class="form-control" name="reference" value="${p.ref || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Type <span class="required">*</span></label>
          <select class="form-control" name="type" required>
            <option value="Produit" ${p.type === 'Produit' ? 'selected' : ''}>Produit</option>
            <option value="Service" ${p.type === 'Service' ? 'selected' : ''}>Service</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Nom <span class="required">*</span></label>
        <input type="text" class="form-control" name="name" value="${p.name || ''}" required>
      </div>
      <div class="form-group">
        <label class="form-label">Mod√®le / Description courte</label>
        <input type="text" class="form-control" name="model" value="${p.model || ''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Cat√©gorie <span class="required">*</span></label>
          <select class="form-control" name="category" required>
            ${categories.map(c => `<option value="${c}" ${p.category === c ? 'selected' : ''}>${c}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Taux TVA</label>
          <select class="form-control" name="tva">
            <option value="20" ${(p.tva || 20) === 20 ? 'selected' : ''}>20%</option>
            <option value="10" ${p.tva === 10 ? 'selected' : ''}>10%</option>
            <option value="5.5" ${p.tva === 5.5 ? 'selected' : ''}>5.5%</option>
            <option value="0" ${p.tva === 0 ? 'selected' : ''}>0%</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Prix HT (‚Ç¨) <span class="required">*</span></label>
        <input type="number" class="form-control" name="price" value="${p.price || ''}" required min="0" step="0.01">
      </div>
      <div class="form-group">
        <label class="form-check">
          <input type="checkbox" name="isActive" ${p.isActive !== false ? 'checked' : ''}>
          <span>Produit actif</span>
        </label>
      </div>
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
}

async function saveProduitCatalogue(e) {
  e.preventDefault();
  const form = e.target;
  const catIndex = parseInt(form.dataset.catIndex);
  
  const produitData = {
    reference: form.reference.value.trim().toUpperCase(),
    name: form.name.value.trim(),
    model: form.model?.value.trim() || '',
    type: form.type.value,
    category: form.category.value,
    price: parseFloat(form.price.value) || 0,
    tva: parseFloat(form.tva?.value) || 20,
    isActive: form.isActive?.checked !== false
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      const existingId = PRODUCT_CATALOGUE[catIndex]?.id;
      
      let result;
      if (existingId) {
        result = await api.updateProduit(existingId, produitData);
      } else {
        result = await api.createProduit(produitData);
      }
      
      hideLoadingOverlay();
      
      if (result.success) {
        const produitsRes = await api.getProduits();
        if (produitsRes.success) {
          PRODUCT_CATALOGUE.length = 0;
          produitsRes.data.forEach(p => {
            PRODUCT_CATALOGUE.push({
              ref: p.reference,
              name: p.name,
              model: p.model || '',
              type: p.type || 'produit',
              category: p.category || 'Mat√©riel',
              price: parseFloat(p.price) || 0,
              tva: parseFloat(p.tva) || 20,
              isActive: p.isActive !== false,
              id: p.id
            });
          });
        }
        closeModal();
        renderProduits();
        showToast('Succ√®s', 'Produit catalogue modifi√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    PRODUCT_CATALOGUE[catIndex] = {
      ref: produitData.reference,
      ...produitData
    };
    
    localStorage.setItem('crm_product_catalogue', JSON.stringify(PRODUCT_CATALOGUE));
    
    closeModal();
    renderProduits();
    showToast('Succ√®s', 'Produit catalogue modifi√©', 'success');
  }
}

// =====================================================
// PACK EDIT FORM
// =====================================================

function getPackEditForm(id, isCatalogue) {
  let pack;
  if (isCatalogue) {
    pack = PACKS_CATALOGUE[id] || {};
  } else {
    pack = data.packs?.find(p => String(p.id) === String(id)) || {};
  }
  
  return `
    <form onsubmit="savePackEdit(event)" data-id="${id}" data-is-catalogue="${isCatalogue}">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">R√©f√©rence <span class="required">*</span></label>
          <input type="text" class="form-control" name="ref" value="${pack.ref || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Nom du Pack <span class="required">*</span></label>
          <input type="text" class="form-control" name="name" value="${pack.name || ''}" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" name="description" rows="2">${pack.description || ''}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Caract√©ristiques</label>
        <textarea class="form-control" name="characteristics" rows="2" placeholder="Sp√©cifications techniques, contenu d√©taill√©...">${pack.characteristics || ''}</textarea>
        <small style="color: var(--text-muted); font-size: 11px;">Appara√Ætra sous la ligne du pack dans le bon de commande</small>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" name="notes" rows="2" placeholder="Informations compl√©mentaires...">${pack.notes || ''}</textarea>
        <small style="color: var(--text-muted); font-size: 11px;">Informations additionnelles affich√©es sur le bon de commande</small>
      </div>
      <div class="form-group">
        <label class="form-label">Composition du Pack</label>
        <div id="packEditItemsContainer" style="max-height: 200px; overflow-y: auto;">
          <!-- Items will be added here -->
        </div>
        <button type="button" class="btn btn-sm" onclick="addPackEditItem()" style="margin-top: var(--space-sm);">+ Ajouter un √©l√©ment</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Prix normal (calcul√©)</label>
          <input type="text" class="form-control" id="packEditRegularPrice" readonly value="${formatCurrency(pack.regularPrice || 0)}">
        </div>
        <div class="form-group">
          <label class="form-label">Prix Pack HT <span class="required">*</span></label>
          <input type="number" class="form-control" name="price" value="${pack.price || ''}" step="0.01" min="0" required>
        </div>
      </div>
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
}

let packEditItemCounter = 0;

function initPackEditForm(id, isCatalogue) {
  packEditItemCounter = 0;
  let pack;
  if (isCatalogue) {
    pack = PACKS_CATALOGUE[id] || {};
  } else {
    pack = data.packs?.find(p => String(p.id) === String(id)) || {};
  }
  
  // Add existing items
  if (pack.items && pack.items.length > 0) {
    pack.items.forEach(item => {
      addPackEditItem(item.ref, item.qty);
    });
  } else {
    addPackEditItem();
  }
}

function addPackEditItem(selectedRef = '', selectedQty = 1) {
  const container = document.getElementById('packEditItemsContainer');
  if (!container) return;
  
  const allProducts = [
    ...PRODUCT_CATALOGUE,
    ...(data.produits || []).map(p => ({ ref: p.reference, name: p.name, price: p.price, type: p.type, category: p.category, model: p.model }))
  ];
  
  // Group products by category
  const categories = [...new Set(allProducts.map(p => p.category))];
  
  const index = packEditItemCounter++;
  const div = document.createElement('div');
  div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
  div.innerHTML = `
    <select class="form-control" name="packEditItem_${index}" onchange="calculatePackEditPrice()" style="flex: 2;">
      <option value="">-- S√©lectionner --</option>
      ${categories.map(cat => `
        <optgroup label="${getCategoryIcon(cat)} ${cat}">
          ${allProducts.filter(p => p.category === cat).map(p => 
            `<option value="${p.ref}" data-price="${p.price}" ${p.ref === selectedRef ? 'selected' : ''}>${p.ref} - ${p.name}${p.model ? ' - ' + p.model : ''} (${formatCurrency(p.price)})</option>`
          ).join('')}
        </optgroup>
      `).join('')}
    </select>
    <input type="number" class="form-control" name="packEditQty_${index}" value="${selectedQty}" min="1" onchange="calculatePackEditPrice()" style="width: 70px;">
    <button type="button" class="btn btn-icon sm btn-danger" onclick="this.parentElement.remove(); calculatePackEditPrice();">‚úï</button>
  `;
  container.appendChild(div);
  calculatePackEditPrice();
}

function calculatePackEditPrice() {
  const container = document.getElementById('packEditItemsContainer');
  if (!container) return;
  
  let total = 0;
  container.querySelectorAll('select').forEach(select => {
    const price = parseFloat(select.options[select.selectedIndex]?.dataset.price) || 0;
    const qtyInput = select.parentElement.querySelector('input[type="number"]');
    const qty = parseFloat(qtyInput?.value) || 1;
    total += price * qty;
  });
  
  const priceField = document.getElementById('packEditRegularPrice');
  if (priceField) priceField.value = formatCurrency(total);
}

async function savePackEdit(e) {
  e.preventDefault();
  const form = e.target;
  const id = form.dataset.id;
  const isCatalogue = form.dataset.isCatalogue === 'true';
  
  // Collect items
  const items = [];
  const container = document.getElementById('packEditItemsContainer');
  container.querySelectorAll('select').forEach(select => {
    if (select.value) {
      const qtyInput = select.parentElement.querySelector('input[type="number"]');
      items.push({
        ref: select.value,
        qty: parseInt(qtyInput?.value) || 1
      });
    }
  });
  
  if (items.length === 0) {
    showToast('Erreur', 'Ajoutez au moins un √©l√©ment au pack', 'error');
    return;
  }
  
  // Calculate regular price
  let regularPrice = 0;
  items.forEach(item => {
    const product = PRODUCT_CATALOGUE.find(p => p.ref === item.ref) || 
                    data.produits?.find(p => p.reference === item.ref);
    regularPrice += (product?.price || 0) * item.qty;
  });
  
  const packData = {
    reference: form.ref.value.trim().toUpperCase(),
    name: form.name.value.trim(),
    description: form.description?.value.trim() || '',
    characteristics: form.characteristics?.value.trim() || '',
    notes: form.notes?.value.trim() || '',
    type: 'Pack',
    category: 'Pack',
    items: JSON.stringify(items),
    price: parseFloat(form.price.value) || 0,
    regularPrice: regularPrice
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      const realId = isCatalogue ? PACKS_CATALOGUE[parseInt(id)]?.id : id;
      
      let result;
      if (realId) {
        result = await api.updatePack(realId, packData);
      } else {
        result = await api.createPack(packData);
      }
      
      hideLoadingOverlay();
      
      if (result.success) {
        const packsRes = await api.getPacks();
        if (packsRes.success) {
          PACKS_CATALOGUE.length = 0;
          packsRes.data.forEach(p => {
            let pItems = p.items || [];
            if (typeof pItems === 'string') {
              try { pItems = JSON.parse(pItems); } catch(e) { pItems = []; }
            }
            PACKS_CATALOGUE.push({
              ref: p.reference,
              name: p.name,
              description: p.description || '',
              items: pItems,
              price: parseFloat(p.price) || 0,
              regularPrice: parseFloat(p.regularPrice) || 0,
              isActive: p.isActive !== false,
              id: p.id
            });
          });
        }
        closeModal();
        renderProduits();
        packEditItemCounter = 0;
        showToast('Succ√®s', 'Pack modifi√© avec succ√®s', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    const localPackData = {
      ref: packData.reference,
      name: packData.name,
      description: packData.description,
      characteristics: packData.characteristics,
      notes: packData.notes,
      type: 'Pack',
      category: 'Pack',
      items: items,
      price: packData.price,
      regularPrice: packData.regularPrice
    };
    
    if (isCatalogue) {
      const catIndex = parseInt(id);
      PACKS_CATALOGUE[catIndex] = { ...PACKS_CATALOGUE[catIndex], ...localPackData };
      localStorage.setItem('crm_packs_catalogue', JSON.stringify(PACKS_CATALOGUE));
    } else {
      const packIndex = data.packs.findIndex(p => p.id === parseInt(id));
      if (packIndex >= 0) {
        data.packs[packIndex] = { ...data.packs[packIndex], ...localPackData, updatedAt: new Date().toISOString() };
      }
      saveData();
    }
    
    closeModal();
    renderProduits();
    packEditItemCounter = 0;
    showToast('Succ√®s', 'Pack modifi√© avec succ√®s', 'success');
  }
}

function getUtilisateurForm(id) {
  const u = id ? data.users.find(us => us.id === id) : {};
  const accessTypes = u.accessTypes || [1];
  
  return `
    <form onsubmit="saveUtilisateur(event)" data-id="${id || ''}">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Pr√©nom <span class="required">*</span></label>
          <input type="text" class="form-control" name="firstName" value="${u.firstName || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Nom <span class="required">*</span></label>
          <input type="text" class="form-control" name="lastName" value="${u.lastName || ''}" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Nom d'utilisateur <span class="required">*</span></label>
        <input type="text" class="form-control" name="username" value="${u.username || ''}" required ${id ? 'readonly' : ''}>
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe ${id ? '' : '<span class="required">*</span>'}</label>
        <input type="password" class="form-control" name="password" ${id ? '' : 'required'} placeholder="${id ? 'Laisser vide pour ne pas changer' : ''}">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Email <span class="required">*</span></label>
          <input type="email" class="form-control" name="email" value="${u.email || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">T√©l√©phone</label>
          <input type="tel" class="form-control" name="phone" value="${u.phone || ''}">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Niveaux d'acc√®s produits <span class="required">*</span></label>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 8px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md);">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" name="access1" ${accessTypes.includes(1) ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
            <span class="badge badge-success" style="margin-right: 10px;">Niveau 1</span>
            Produits standards (Mat√©riel, Logiciel, IoT, Formation...)
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" name="access2" ${accessTypes.includes(2) ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
            <span class="badge badge-warning" style="margin-right: 10px;">Niveau 2</span>
            N√©gociation, Marketing, Design, Prestations
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" name="access3" ${accessTypes.includes(3) ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
            <span class="badge badge-danger" style="margin-right: 10px;">Niveau 3</span>
            Commissions, Prestations internes
          </label>
        </div>
      </div>
      
      <div class="modal-footer" style="margin: var(--space-lg) calc(var(--space-lg) * -1) calc(var(--space-lg) * -1); padding: var(--space-lg);">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">${id ? 'Modifier' : 'Cr√©er'}</button>
      </div>
    </form>
  `;
}

// =====================================================
// UTILITIES
// =====================================================

function filterByOwner(items, ownerId) {
  if (!ownerId) return items;
  const ownerIdStr = String(ownerId);
  return items.filter(i => String(i.ownerId) === ownerIdStr);
}

function getAccessibleEntreprises() {
  if (currentUser.role === 'admin') {
    return data.entreprises;
  }
  const userId = String(currentUser.id);
  return (data.entreprises || []).filter(e => String(e.ownerId) === userId);
}

function logActivity(type, message) {
  if (!data.activities) data.activities = [];
  data.activities.push({
    type,
    message,
    userId: currentUser?.id,
    date: new Date().toISOString()
  });
  // Keep only last 100
  if (data.activities.length > 100) {
    data.activities = data.activities.slice(-100);
  }
}

function formatCurrency(amount) {
  const num = parseFloat(amount) || 0;
  const currency = data.settings?.currency || 'EUR';
  const symbols = { EUR: '‚Ç¨', USD: '$', GBP: '¬£' };
  return num.toLocaleString('fr-FR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ' + (symbols[currency] || '‚Ç¨');
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
}

function formatDateTime(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
}

function formatTime(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now - date;
  
  if (diff < 60000) return '√Ä l\'instant';
  if (diff < 3600000) return Math.floor(diff / 60000) + ' min';
  if (diff < 86400000) return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
}

function formatDateFile(date) {
  return date.toISOString().split('T')[0].replace(/-/g, '');
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' Ko';
  return (bytes / (1024 * 1024)).toFixed(1) + ' Mo';
}

function getTypeBadge(type) {
  const badges = {
    'Prospect': 'warning',
    'Client': 'success',
    'Partenaire': 'info',
    'Fournisseur': 'default'
  };
  return badges[type] || 'default';
}

function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// =====================================================
// TOAST NOTIFICATIONS
// =====================================================

function showToast(title, message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || '‚Ñπ'}</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
  `;
  
  container.appendChild(toast);
  
  // Auto remove after 4s
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// =====================================================
// EXPORT FUNCTIONS
// =====================================================

function exportEntreprises() {
  const entreprises = getAccessibleEntreprises();
  const headers = ['Nom', 'Type', 'Secteur', 'Contact', 'Email', 'T√©l√©phone', 'Ville'];
  const rows = entreprises.map(e => [e.name, e.type, e.industry, e.contact, e.email, e.phone, e.city]);
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'entreprises.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

function exportContacts() {
  const contacts = filterByOwner(data.contacts, currentUser.role === 'admin' ? null : currentUser.id);
  const headers = ['Pr√©nom', 'Nom', 'Entreprise', 'Fonction', 'Email', 'T√©l√©phone'];
  const rows = contacts.map(c => {
    const e = data.entreprises.find(ent => ent.id === c.entrepriseId);
    return [c.firstName, c.lastName, e?.name || '', c.function, c.email, c.phone];
  });
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'contacts.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

function exportOpportunites() {
  const opps = filterByOwner(data.opportunites, currentUser.role === 'admin' ? null : currentUser.id);
  const headers = ['Nom', 'Entreprise', 'Montant', '√âtape', 'Probabilit√©', 'Date cl√¥ture'];
  const rows = opps.map(o => {
    const e = data.entreprises.find(ent => ent.id === o.entrepriseId);
    const stage = PIPELINE_STAGES.find(s => s.id === o.stage);
    return [o.name, e?.name || '', o.amount, stage?.name || '', o.probability + '%', o.expectedClose];
  });
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  downloadFile(csv, 'opportunites.csv', 'text/csv');
  showToast('Export√©', 'Fichier t√©l√©charg√©', 'success');
}

function exportReport() {
  // Generate a simple report
  const report = {
    date: new Date().toISOString(),
    user: `${currentUser.firstName} ${currentUser.lastName}`,
    stats: {
      entreprises: getAccessibleEntreprises().length,
      contacts: filterByOwner(data.contacts, currentUser.role === 'admin' ? null : currentUser.id).length,
      opportunites: filterByOwner(data.opportunites, currentUser.role === 'admin' ? null : currentUser.id).length,
      orders: (data.orders || []).length
    }
  };
  downloadFile(JSON.stringify(report, null, 2), 'rapport.json', 'application/json');
  showToast('Export√©', 'Rapport t√©l√©charg√©', 'success');
}

// =====================================================
// QUICK ACTIONS
// =====================================================

function openQuickActions() {
  // Simple quick actions modal could be implemented here
  showToast('Actions rapides', 'Fonctionnalit√© √† venir', 'info');
}

// =====================================================
// MODULE ACTIONS - CALENDRIER
// =====================================================

let calendarDate = new Date();
let emailsFilter = 'all';
let rdvFilter = 'all';
let appelsFilter = 'all';
let tachesFilter = 'all';

function renderCalendrier() {
  const year = calendarDate.getFullYear();
  const month = calendarDate.getMonth();
  
  // Update month title
  const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
  document.getElementById('calendarMonthTitle').textContent = `${monthNames[month]} ${year}`;
  
  // Get first day of month and total days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = (firstDay.getDay() + 6) % 7; // Monday = 0
  const totalDays = lastDay.getDate();
  
  // Get previous month days
  const prevLastDay = new Date(year, month, 0).getDate();
  
  const container = document.getElementById('calendarDays');
  container.innerHTML = '';
  
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // Get all events for this month
  const userId = currentUser?.id;
  const myRdv = (data.rdv || []).filter(r => currentUser?.role === 'admin' || String(r.ownerId) === String(userId));
  const myAppels = (data.appels || []).filter(a => currentUser?.role === 'admin' || String(a.ownerId) === String(userId));
  const myTaches = (data.taches || []).filter(t => currentUser?.role === 'admin' || String(t.ownerId) === String(userId));
  const myEmails = (data.emails || []).filter(e => currentUser?.role === 'admin' || e.ownerId === userId);
  
  // Previous month days
  for (let i = startDay - 1; i >= 0; i--) {
    const day = prevLastDay - i;
    const dayEl = createCalendarDay(day, true, year, month - 1);
    container.appendChild(dayEl);
  }
  
  // Current month days
  for (let day = 1; day <= totalDays; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    
    // Find events for this day
    const dayEvents = [];
    
    myRdv.filter(r => r.date === dateStr).forEach(r => {
      const entreprise = data.entreprises.find(e => String(e.id) === String(r.entrepriseId));
      dayEvents.push({ type: 'rdv', icon: 'ü§ù', title: r.objet, meta: entreprise?.name || '', time: r.heure });
    });
    
    myAppels.filter(a => a.date === dateStr).forEach(a => {
      dayEvents.push({ type: 'appel', icon: 'üìû', title: a.objet, meta: a.contact, time: a.heure });
    });
    
    myTaches.filter(t => t.echeance === dateStr && t.statut !== 'terminee').forEach(t => {
      dayEvents.push({ type: 'tache', icon: '‚úÖ', title: t.titre, meta: '', time: '' });
    });
    
    const dayEl = document.createElement('div');
    dayEl.className = `calendar-day${isToday ? ' today' : ''}`;
    dayEl.onclick = () => openDayDetail(dateStr);
    
    dayEl.innerHTML = `
      <div class="calendar-day-number">${day}</div>
      ${dayEvents.slice(0, 3).map(e => `
        <div class="calendar-event ${e.type}" title="${e.title}">
          ${e.time ? e.time + ' ' : ''}${e.title.substring(0, 15)}${e.title.length > 15 ? '...' : ''}
        </div>
      `).join('')}
      ${dayEvents.length > 3 ? `<div style="font-size: 10px; color: var(--text-muted);">+${dayEvents.length - 3} autres</div>` : ''}
    `;
    
    container.appendChild(dayEl);
  }
  
  // Next month days
  const totalCells = startDay + totalDays;
  const remaining = 42 - totalCells;
  for (let day = 1; day <= remaining; day++) {
    const dayEl = createCalendarDay(day, true, year, month + 1);
    container.appendChild(dayEl);
  }
  
  // Render sidebar
  renderTodayActions();
  renderUpcomingEvents();
}

function createCalendarDay(day, otherMonth, year, month) {
  const dayEl = document.createElement('div');
  dayEl.className = `calendar-day${otherMonth ? ' other-month' : ''}`;
  dayEl.innerHTML = `<div class="calendar-day-number">${day}</div>`;
  return dayEl;
}

function previousMonth() {
  calendarDate.setMonth(calendarDate.getMonth() - 1);
  renderCalendrier();
}

function nextMonth() {
  calendarDate.setMonth(calendarDate.getMonth() + 1);
  renderCalendrier();
}

function goToToday() {
  calendarDate = new Date();
  renderCalendrier();
}

function renderTodayActions() {
  const container = document.getElementById('todayActions');
  const todayStr = new Date().toISOString().split('T')[0];
  const userId = currentUser?.id;
  
  const todayRdv = (data.rdv || []).filter(r => r.date === todayStr && (currentUser?.role === 'admin' || r.ownerId === userId));
  const todayAppels = (data.appels || []).filter(a => a.date === todayStr && (currentUser?.role === 'admin' || a.ownerId === userId));
  const todayTaches = (data.taches || []).filter(t => t.echeance === todayStr && t.statut !== 'terminee' && (currentUser?.role === 'admin' || t.ownerId === userId));
  
  const events = [];
  
  todayRdv.forEach(r => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(r.entrepriseId));
    events.push({ type: 'rdv', icon: 'ü§ù', title: r.objet, meta: `${r.heure} - ${entreprise?.name || ''}`, data: r });
  });
  
  todayAppels.forEach(a => {
    events.push({ type: 'appel', icon: 'üìû', title: a.objet, meta: `${a.heure} - ${a.contact}`, data: a });
  });
  
  todayTaches.forEach(t => {
    events.push({ type: 'tache', icon: '‚úÖ', title: t.titre, meta: `Priorit√©: ${t.priorite}`, data: t });
  });
  
  if (events.length === 0) {
    container.innerHTML = '<div class="empty-state-mini"><div class="empty-state-icon">üìÖ</div><p>Aucune action pr√©vue aujourd\'hui</p></div>';
    return;
  }
  
  container.innerHTML = events.map(e => `
    <div class="event-item" onclick="showEventDetail('${e.type}', ${e.data.id})">
      <div class="event-item-icon">${e.icon}</div>
      <div class="event-item-content">
        <div class="event-item-title">${e.title}</div>
        <div class="event-item-meta">${e.meta}</div>
      </div>
    </div>
  `).join('');
}

function renderUpcomingEvents() {
  const container = document.getElementById('upcomingEvents');
  const today = new Date();
  const nextWeek = new Date(today);
  nextWeek.setDate(nextWeek.getDate() + 7);
  const todayStr = today.toISOString().split('T')[0];
  const nextWeekStr = nextWeek.toISOString().split('T')[0];
  const userId = currentUser?.id;
  
  const upcomingRdv = (data.rdv || []).filter(r => r.date > todayStr && r.date <= nextWeekStr && (currentUser?.role === 'admin' || r.ownerId === userId));
  const upcomingAppels = (data.appels || []).filter(a => a.date > todayStr && a.date <= nextWeekStr && (currentUser?.role === 'admin' || a.ownerId === userId));
  
  const events = [];
  
  upcomingRdv.forEach(r => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(r.entrepriseId));
    events.push({ type: 'rdv', icon: 'ü§ù', title: r.objet, meta: `${formatDateFR(r.date)} ${r.heure}`, date: r.date, data: r });
  });
  
  upcomingAppels.forEach(a => {
    events.push({ type: 'appel', icon: 'üìû', title: a.objet, meta: `${formatDateFR(a.date)} ${a.heure}`, date: a.date, data: a });
  });
  
  events.sort((a, b) => a.date.localeCompare(b.date));
  
  if (events.length === 0) {
    container.innerHTML = '<div class="empty-state-mini"><p>Aucun √©v√©nement pr√©vu</p></div>';
    return;
  }
  
  container.innerHTML = events.slice(0, 5).map(e => `
    <div class="event-item" onclick="showEventDetail('${e.type}', ${e.data.id})">
      <div class="event-item-icon">${e.icon}</div>
      <div class="event-item-content">
        <div class="event-item-title">${e.title}</div>
        <div class="event-item-meta">${e.meta}</div>
      </div>
    </div>
  `).join('');
}

function formatDateFR(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
}

function openDayDetail(dateStr) {
  showToast('Date s√©lectionn√©e', formatDateFR(dateStr), 'info');
}

function showEventDetail(type, id) {
  if (type === 'rdv') {
    showPage('rdv');
  } else if (type === 'appel') {
    showPage('appels');
  } else if (type === 'tache') {
    showPage('taches');
  }
}

// =====================================================
// MODULE ACTIONS - EMAILS
// =====================================================

function renderEmails() {
  const userId = currentUser?.id;
  let emails = (data.emails || []).filter(e => currentUser?.role === 'admin' || e.ownerId === userId);
  
  // Apply filter
  if (emailsFilter !== 'all') {
    emails = emails.filter(e => e.statut === emailsFilter);
  }
  
  // Update stats
  const allEmails = (data.emails || []).filter(e => currentUser?.role === 'admin' || e.ownerId === userId);
  document.getElementById('emailsTotal').textContent = allEmails.length;
  document.getElementById('emailsBrouillons').textContent = allEmails.filter(e => e.statut === 'brouillon').length;
  document.getElementById('emailsAEnvoyer').textContent = allEmails.filter(e => e.statut === 'a_envoyer').length;
  document.getElementById('emailsEnvoyes').textContent = allEmails.filter(e => e.statut === 'envoye').length;
  
  const container = document.getElementById('emailsTable');
  
  if (emails.length === 0) {
    container.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üìß</div><h3 class="empty-state-title">Aucun email</h3></div></td></tr>`;
    return;
  }
  
  container.innerHTML = emails.map(e => {
    const entreprise = data.entreprises.find(ent => ent.id === e.entrepriseId);
    const statutBadge = getEmailStatutBadge(e.statut);
    
    return `
      <tr>
        <td>${e.dateEnvoi ? formatDate(e.dateEnvoi) : formatDate(e.createdAt)}</td>
        <td>${e.to}</td>
        <td><strong>${e.subject}</strong></td>
        <td>${entreprise?.name || '-'}</td>
        <td>${statutBadge}</td>
        <td>
          <div class="btn-group">
            <button class="btn btn-sm" onclick="viewEmail('${e.id}')" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-sm" onclick="openModal('email', '${e.id}')" title="Modifier">‚úèÔ∏è</button>
            ${e.statut === 'brouillon' ? `<button class="btn btn-sm btn-primary" onclick="sendEmail('${e.id}')" title="Envoyer">üì§</button>` : ''}
            <button class="btn btn-sm btn-danger" onclick="deleteEmail('${e.id}')" title="Supprimer">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function getEmailStatutBadge(statut) {
  const badges = {
    'brouillon': '<span class="badge badge-secondary">Brouillon</span>',
    'a_envoyer': '<span class="badge badge-warning">√Ä envoyer</span>',
    'envoye': '<span class="badge badge-success">Envoy√©</span>',
    'recu': '<span class="badge badge-info">Re√ßu</span>',
    'traite': '<span class="badge badge-primary">Trait√©</span>'
  };
  return badges[statut] || `<span class="badge">${statut}</span>`;
}

function filterEmails(filter, btn) {
  emailsFilter = filter;
  document.querySelectorAll('#page-emails .tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderEmails();
}

function openNewEmailModal() {
  console.log('üìß openNewEmailModal appel√©e');
  try {
    const entrepriseOptions = (data.entreprises || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
    const contactOptions = (data.contacts || []).map(c => `<option value="${c.id}">${c.firstName} ${c.lastName} - ${c.email}</option>`).join('');
  
  document.getElementById('modalTitle').textContent = '‚úâÔ∏è Nouveau message';
  document.getElementById('modalBody').innerHTML = `
    <form id="emailForm" onsubmit="saveEmail(event)">
      <div class="form-group">
        <label class="form-label">Entreprise</label>
        <select class="form-control" id="emailEntreprise" onchange="updateEmailContacts()">
          <option value="">-- S√©lectionner --</option>
          ${entrepriseOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Contact / Destinataire <span class="required">*</span></label>
        <select class="form-control" id="emailContact" required>
          <option value="">-- S√©lectionner un contact --</option>
          ${contactOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Sujet <span class="required">*</span></label>
        <input type="text" class="form-control" id="emailSubject" required>
      </div>
      <div class="form-group">
        <label class="form-label">Message</label>
        <textarea class="form-control" id="emailBody" rows="6" placeholder="R√©digez votre message..."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Statut</label>
        <select class="form-control" id="emailStatut">
          <option value="brouillon">Brouillon</option>
          <option value="a_envoyer">√Ä envoyer</option>
          <option value="envoye">Marqu√© comme envoy√©</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeMainModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
  openMainModal();
  } catch (error) {
    console.error('‚ùå Erreur openNewEmailModal:', error);
    showToast('Erreur', 'Impossible d\'ouvrir le formulaire: ' + error.message, 'error');
  }
}

function updateEmailContacts() {
  const entrepriseId = parseInt(document.getElementById('emailEntreprise').value);
  const contactSelect = document.getElementById('emailContact');
  
  if (!entrepriseId) {
    contactSelect.innerHTML = '<option value="">-- S√©lectionner un contact --</option>' + 
      (data.contacts || []).map(c => `<option value="${c.id}">${c.firstName} ${c.lastName} - ${c.email}</option>`).join('');
    return;
  }
  
  const filteredContacts = (data.contacts || []).filter(c => c.entrepriseId === entrepriseId);
  contactSelect.innerHTML = '<option value="">-- S√©lectionner un contact --</option>' + 
    filteredContacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName} - ${c.email}</option>`).join('');
}

async function saveEmail(event) {
  event.preventDefault();
  
  const contactId = document.getElementById('emailContact').value;
  const contact = data.contacts.find(c => String(c.id) === String(contactId));
  
  if (!contact) {
    showToast('Erreur', 'Veuillez s√©lectionner un contact', 'error');
    return;
  }
  
  const emailData = {
    type: 'sortant',
    to: contact.email,
    from: currentUser.email,
    subject: document.getElementById('emailSubject').value,
    body: document.getElementById('emailBody').value,
    entrepriseId: contact.entrepriseId,
    contactId: contactId,
    statut: document.getElementById('emailStatut').value,
    dateEnvoi: document.getElementById('emailStatut').value === 'envoye' ? new Date().toISOString() : null
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      const result = await api.createEmail(emailData);
      hideLoadingOverlay();
      
      if (result.success) {
        const emailsRes = await api.getEmails();
        if (emailsRes.success) data.emails = emailsRes.data;
        closeMainModal();
        renderEmails();
        showToast('Succ√®s', 'Email enregistr√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    const email = {
      id: (data.lastId.email || 0) + 1,
      ...emailData,
      ownerId: currentUser.id,
      createdAt: new Date().toISOString()
    };
    
    data.lastId.email = email.id;
    data.emails = data.emails || [];
    data.emails.push(email);
    saveData();
    
    closeMainModal();
    renderEmails();
    showToast('Succ√®s', 'Email enregistr√©', 'success');
  }
}

function viewEmail(id) {
  const email = data.emails.find(e => String(e.id) === String(id));
  if (!email) return;
  
  const contact = data.contacts.find(c => String(c.id) === String(email.contactId));
  const entreprise = data.entreprises.find(e => String(e.id) === String(email.entrepriseId));
  
  document.getElementById('modalTitle').textContent = 'üìß ' + email.subject;
  document.getElementById('modalBody').innerHTML = `
    <div style="margin-bottom: var(--space-md);">
      <strong>De:</strong> ${email.from}<br>
      <strong>√Ä:</strong> ${email.to}<br>
      <strong>Date:</strong> ${email.dateEnvoi ? formatDate(email.dateEnvoi) : 'Non envoy√©'}<br>
      <strong>Entreprise:</strong> ${entreprise?.name || '-'}<br>
      <strong>Contact:</strong> ${contact ? contact.firstName + ' ' + contact.lastName : '-'}<br>
      <strong>Statut:</strong> ${getEmailStatutBadge(email.statut)}
    </div>
    <hr style="border-color: var(--border-default); margin: var(--space-md) 0;">
    <div style="white-space: pre-wrap; background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md);">
      ${email.body || '(Aucun contenu)'}
    </div>
    <div class="modal-actions" style="margin-top: var(--space-lg);">
      <button class="btn" onclick="closeMainModal()">Fermer</button>
    </div>
  `;
  openMainModal();
}

async function sendEmail(id) {
  const email = data.emails.find(e => String(e.id) === String(id));
  if (email) {
    if (USE_GOOGLE_SHEETS_API) {
      try {
        const result = await api.updateEmail(id, { 
          statut: 'envoye', 
          dateEnvoi: new Date().toISOString() 
        });
        if (result.success) {
          email.statut = 'envoye';
          email.dateEnvoi = new Date().toISOString();
          renderEmails();
          showToast('Envoy√©', 'Email marqu√© comme envoy√©', 'success');
        }
      } catch (error) {
        showToast('Erreur', error.message, 'error');
      }
    } else {
      email.statut = 'envoye';
      email.dateEnvoi = new Date().toISOString();
      saveData();
      renderEmails();
      showToast('Envoy√©', 'Email marqu√© comme envoy√©', 'success');
    }
  }
}

async function deleteEmail(id) {
  if (!confirm('Supprimer cet email ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.deleteEmail(id);
      if (result.success) {
        data.emails = data.emails.filter(e => String(e.id) !== String(id));
        renderEmails();
        showToast('Supprim√©', 'Email supprim√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
    }
  } else {
    data.emails = data.emails.filter(e => e.id !== id);
    saveData();
    renderEmails();
    showToast('Supprim√©', 'Email supprim√©', 'success');
  }
}

// =====================================================
// MODULE ACTIONS - RENDEZ-VOUS
// =====================================================

function renderRdv() {
  const userId = currentUser?.id;
  let rdvList = (data.rdv || []).filter(r => currentUser?.role === 'admin' || r.ownerId === userId);
  
  // Apply filter
  if (rdvFilter !== 'all') {
    rdvList = rdvList.filter(r => r.statut === rdvFilter);
  }
  
  // Sort by date
  rdvList.sort((a, b) => {
    const dateA = `${a.date}T${a.heure}`;
    const dateB = `${b.date}T${b.heure}`;
    return dateA.localeCompare(dateB);
  });
  
  // Update stats
  const allRdv = (data.rdv || []).filter(r => currentUser?.role === 'admin' || r.ownerId === userId);
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay() + 1);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  
  document.getElementById('rdvTotal').textContent = allRdv.length;
  document.getElementById('rdvAConfirmer').textContent = allRdv.filter(r => r.statut === 'a_confirmer').length;
  document.getElementById('rdvConfirmes').textContent = allRdv.filter(r => r.statut === 'confirme').length;
  document.getElementById('rdvSemaine').textContent = allRdv.filter(r => {
    const d = new Date(r.date);
    return d >= weekStart && d <= weekEnd;
  }).length;
  
  const container = document.getElementById('rdvTable');
  
  if (rdvList.length === 0) {
    container.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ü§ù</div><h3 class="empty-state-title">Aucun rendez-vous</h3></div></td></tr>`;
    return;
  }
  
  container.innerHTML = rdvList.map(r => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(r.entrepriseId));
    const contact = data.contacts.find(c => String(c.id) === String(r.contactId));
    const statutBadge = getRdvStatutBadge(r.statut);
    
    return `
      <tr>
        <td><strong>${formatDateFR(r.date)}</strong> √† ${r.heure}</td>
        <td>${entreprise?.name || '-'}</td>
        <td>${contact ? contact.firstName + ' ' + contact.lastName : '-'}</td>
        <td>${r.objet}</td>
        <td>${r.lieu || '-'}</td>
        <td>
          <select class="status-select" onchange="changeRdvStatut('${r.id}', this.value)" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);font-size:11px;">
            <option value="a_confirmer" ${r.statut === 'a_confirmer' ? 'selected' : ''}>‚è≥ √Ä confirmer</option>
            <option value="confirme" ${r.statut === 'confirme' ? 'selected' : ''}>‚úÖ Confirm√©</option>
            <option value="effectue" ${r.statut === 'effectue' ? 'selected' : ''}>‚úîÔ∏è Effectu√©</option>
            <option value="annule" ${r.statut === 'annule' ? 'selected' : ''}>‚ùå Annul√©</option>
            <option value="reporte" ${r.statut === 'reporte' ? 'selected' : ''}>üîÑ Report√©</option>
          </select>
        </td>
        <td>
          <div class="btn-group">
            <button class="btn btn-sm" onclick="viewRdv('${r.id}')" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-sm" onclick="openModal('rdv', '${r.id}')" title="Modifier">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteRdv('${r.id}')" title="Supprimer">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function getRdvStatutBadge(statut) {
  const badges = {
    'a_confirmer': '<span class="badge badge-warning">√Ä confirmer</span>',
    'confirme': '<span class="badge badge-success">Confirm√©</span>',
    'effectue': '<span class="badge badge-primary">Effectu√©</span>',
    'annule': '<span class="badge badge-danger">Annul√©</span>'
  };
  return badges[statut] || `<span class="badge">${statut}</span>`;
}

function filterRdv(filter, btn) {
  rdvFilter = filter;
  document.querySelectorAll('#page-rdv .tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderRdv();
}

function openNewRdvModal() {
  const entrepriseOptions = (data.entreprises || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
  const contactOptions = (data.contacts || []).map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
  const opportuniteOptions = (data.opportunites || []).map(o => `<option value="${o.id}">${o.name}</option>`).join('');
  
  document.getElementById('modalTitle').textContent = 'ü§ù Nouveau rendez-vous';
  document.getElementById('modalBody').innerHTML = `
    <form id="rdvForm" onsubmit="saveRdv(event)">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date <span class="required">*</span></label>
          <input type="date" class="form-control" id="rdvDate" required>
        </div>
        <div class="form-group">
          <label class="form-label">Heure <span class="required">*</span></label>
          <input type="time" class="form-control" id="rdvHeure" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Entreprise</label>
        <select class="form-control" id="rdvEntreprise" onchange="updateRdvContacts()">
          <option value="">-- S√©lectionner --</option>
          ${entrepriseOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Contact</label>
        <select class="form-control" id="rdvContact">
          <option value="">-- S√©lectionner --</option>
          ${contactOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Objet <span class="required">*</span></label>
        <input type="text" class="form-control" id="rdvObjet" required placeholder="Ex: Pr√©sentation produit, N√©gociation...">
      </div>
      <div class="form-group">
        <label class="form-label">Lieu</label>
        <input type="text" class="form-control" id="rdvLieu" placeholder="Adresse ou visioconf√©rence">
      </div>
      <div class="form-group">
        <label class="form-label">Opportunit√© li√©e</label>
        <select class="form-control" id="rdvOpportunite">
          <option value="">-- Aucune --</option>
          ${opportuniteOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" id="rdvNotes" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeMainModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
  openMainModal();
}

function updateRdvContacts() {
  const entrepriseId = parseInt(document.getElementById('rdvEntreprise').value);
  const contactSelect = document.getElementById('rdvContact');
  
  if (!entrepriseId) {
    contactSelect.innerHTML = '<option value="">-- S√©lectionner --</option>' + 
      (data.contacts || []).map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
    return;
  }
  
  const filteredContacts = (data.contacts || []).filter(c => c.entrepriseId === entrepriseId);
  contactSelect.innerHTML = '<option value="">-- S√©lectionner --</option>' + 
    filteredContacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
}

async function saveRdv(event) {
  event.preventDefault();
  
  const rdvData = {
    entrepriseId: document.getElementById('rdvEntreprise').value || null,
    contactId: document.getElementById('rdvContact').value || null,
    date: document.getElementById('rdvDate').value,
    heure: document.getElementById('rdvHeure').value,
    objet: document.getElementById('rdvObjet').value,
    lieu: document.getElementById('rdvLieu').value,
    opportuniteId: document.getElementById('rdvOpportunite').value || null,
    notes: document.getElementById('rdvNotes').value,
    statut: 'a_confirmer'
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      const result = await api.createRdv(rdvData);
      hideLoadingOverlay();
      
      if (result.success) {
        const rdvRes = await api.getRdv();
        if (rdvRes.success) data.rdv = rdvRes.data;
        closeMainModal();
        renderRdv();
        renderCalendrier();
        showToast('Succ√®s', 'Rendez-vous cr√©√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    const rdv = {
      id: (data.lastId.rdv || 0) + 1,
      ...rdvData,
      ownerId: currentUser.id,
      createdAt: new Date().toISOString()
    };
    
    data.lastId.rdv = rdv.id;
    data.rdv = data.rdv || [];
    data.rdv.push(rdv);
    saveData();
    
    closeMainModal();
    renderRdv();
    renderCalendrier();
    showToast('Succ√®s', 'Rendez-vous cr√©√©', 'success');
  }
}

async function confirmRdv(id) {
  const rdv = data.rdv.find(r => String(r.id) === String(id));
  if (rdv) {
    if (USE_GOOGLE_SHEETS_API) {
      try {
        const result = await api.updateRdv(id, { statut: 'confirme' });
        if (result.success) {
          rdv.statut = 'confirme';
          renderRdv();
          showToast('Confirm√©', 'Rendez-vous confirm√©', 'success');
        }
      } catch (error) {
        showToast('Erreur', error.message, 'error');
      }
    } else {
      rdv.statut = 'confirme';
      saveData();
      renderRdv();
      showToast('Confirm√©', 'Rendez-vous confirm√©', 'success');
    }
  }
}

async function markRdvDone(id) {
  const rdv = data.rdv.find(r => String(r.id) === String(id));
  if (rdv) {
    if (USE_GOOGLE_SHEETS_API) {
      try {
        const result = await api.updateRdv(id, { statut: 'effectue' });
        if (result.success) {
          rdv.statut = 'effectue';
          renderRdv();
          showToast('Termin√©', 'Rendez-vous marqu√© comme effectu√©', 'success');
        }
      } catch (error) {
        showToast('Erreur', error.message, 'error');
      }
    } else {
      rdv.statut = 'effectue';
      saveData();
      renderRdv();
      showToast('Termin√©', 'Rendez-vous marqu√© comme effectu√©', 'success');
    }
  }
}

function editRdv(id) {
  const rdv = data.rdv.find(r => String(r.id) === String(id));
  if (!rdv) return;
  
  openNewRdvModal();
  
  setTimeout(() => {
    document.getElementById('rdvDate').value = rdv.date;
    document.getElementById('rdvHeure').value = rdv.heure;
    document.getElementById('rdvEntreprise').value = rdv.entrepriseId || '';
    updateRdvContacts();
    setTimeout(() => {
      document.getElementById('rdvContact').value = rdv.contactId || '';
    }, 100);
    document.getElementById('rdvObjet').value = rdv.objet;
    document.getElementById('rdvLieu').value = rdv.lieu || '';
    document.getElementById('rdvOpportunite').value = rdv.opportuniteId || '';
    document.getElementById('rdvNotes').value = rdv.notes || '';
    
    document.getElementById('rdvForm').onsubmit = (e) => {
      e.preventDefault();
      rdv.date = document.getElementById('rdvDate').value;
      rdv.heure = document.getElementById('rdvHeure').value;
      rdv.entrepriseId = parseInt(document.getElementById('rdvEntreprise').value) || null;
      rdv.contactId = parseInt(document.getElementById('rdvContact').value) || null;
      rdv.objet = document.getElementById('rdvObjet').value;
      rdv.lieu = document.getElementById('rdvLieu').value;
      rdv.opportuniteId = parseInt(document.getElementById('rdvOpportunite').value) || null;
      rdv.notes = document.getElementById('rdvNotes').value;
      saveData();
      closeMainModal();
      renderRdv();
      renderCalendrier();
      showToast('Modifi√©', 'Rendez-vous mis √† jour', 'success');
    };
  }, 100);
}

async function deleteRdv(id) {
  if (!confirm('Supprimer ce rendez-vous ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.deleteRdv(id);
      if (result.success) {
        data.rdv = data.rdv.filter(r => String(r.id) !== String(id));
        renderRdv();
        renderCalendrier();
        showToast('Supprim√©', 'Rendez-vous supprim√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
    }
  } else {
    data.rdv = data.rdv.filter(r => r.id !== id);
    saveData();
    renderRdv();
    renderCalendrier();
    showToast('Supprim√©', 'Rendez-vous supprim√©', 'success');
  }
}

// =====================================================
// MODULE ACTIONS - APPELS
// =====================================================

function renderAppels() {
  const userId = currentUser?.id;
  let appelsList = (data.appels || []).filter(a => currentUser?.role === 'admin' || a.ownerId === userId);
  
  // Apply filter
  if (appelsFilter !== 'all') {
    appelsList = appelsList.filter(a => a.statut === appelsFilter);
  }
  
  // Sort by date desc
  appelsList.sort((a, b) => {
    const dateA = `${b.date}T${b.heure}`;
    const dateB = `${a.date}T${a.heure}`;
    return dateA.localeCompare(dateB);
  });
  
  // Update stats
  const allAppels = (data.appels || []).filter(a => currentUser?.role === 'admin' || a.ownerId === userId);
  document.getElementById('appelsTotal').textContent = allAppels.length;
  document.getElementById('appelsPlanifies').textContent = allAppels.filter(a => a.statut === 'planifie').length;
  document.getElementById('appelsEffectues').textContent = allAppels.filter(a => a.statut === 'effectue').length;
  document.getElementById('appelsManques').textContent = allAppels.filter(a => a.statut === 'manque' || a.statut === 'a_rappeler').length;
  
  const container = document.getElementById('appelsTable');
  
  if (appelsList.length === 0) {
    container.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="empty-state-icon">üìû</div><h3 class="empty-state-title">Aucun appel</h3></div></td></tr>`;
    return;
  }
  
  container.innerHTML = appelsList.map(a => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(a.entrepriseId));
    const statutBadge = getAppelStatutBadge(a.statut);
    
    return `
      <tr>
        <td><strong>${formatDateFR(a.date)}</strong> √† ${a.heure}</td>
        <td>${a.contact}</td>
        <td><a href="tel:${a.telephone}">${a.telephone}</a></td>
        <td>${entreprise?.name || '-'}</td>
        <td>${a.objet}</td>
        <td>${a.duree ? a.duree + ' min' : '-'}</td>
        <td>
          <select class="status-select" onchange="changeAppelStatut('${a.id}', this.value)" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-secondary);font-size:11px;">
            <option value="planifie" ${a.statut === 'planifie' ? 'selected' : ''}>üìû Planifi√©</option>
            <option value="effectue" ${a.statut === 'effectue' ? 'selected' : ''}>‚úÖ Effectu√©</option>
            <option value="manque" ${a.statut === 'manque' ? 'selected' : ''}>‚ùå Manqu√©</option>
            <option value="a_rappeler" ${a.statut === 'a_rappeler' ? 'selected' : ''}>üîÑ √Ä rappeler</option>
          </select>
        </td>
        <td>
          <div class="btn-group">
            <button class="btn btn-sm" onclick="viewAppel('${a.id}')" title="Voir">üëÅÔ∏è</button>
            <button class="btn btn-sm" onclick="openModal('appel', '${a.id}')" title="Modifier">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAppel('${a.id}')" title="Supprimer">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function getAppelStatutBadge(statut) {
  const badges = {
    'planifie': '<span class="badge badge-warning">Planifi√©</span>',
    'effectue': '<span class="badge badge-success">Effectu√©</span>',
    'manque': '<span class="badge badge-danger">Manqu√©</span>',
    'a_rappeler': '<span class="badge badge-info">√Ä rappeler</span>'
  };
  return badges[statut] || `<span class="badge">${statut}</span>`;
}

function filterAppels(filter, btn) {
  appelsFilter = filter;
  document.querySelectorAll('#page-appels .tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderAppels();
}

function openNewAppelModal() {
  const entrepriseOptions = (data.entreprises || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
  const contactOptions = (data.contacts || []).map(c => `<option value="${c.id}" data-phone="${c.phone}">${c.firstName} ${c.lastName} - ${c.phone}</option>`).join('');
  
  document.getElementById('modalTitle').textContent = 'üìû Nouvel appel';
  document.getElementById('modalBody').innerHTML = `
    <form id="appelForm" onsubmit="saveAppel(event)">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date <span class="required">*</span></label>
          <input type="date" class="form-control" id="appelDate" value="${new Date().toISOString().split('T')[0]}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Heure <span class="required">*</span></label>
          <input type="time" class="form-control" id="appelHeure" value="${new Date().toTimeString().slice(0,5)}" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Entreprise</label>
        <select class="form-control" id="appelEntreprise" onchange="updateAppelContacts()">
          <option value="">-- S√©lectionner --</option>
          ${entrepriseOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Contact</label>
        <select class="form-control" id="appelContactSelect" onchange="updateAppelPhone()">
          <option value="">-- S√©lectionner --</option>
          ${contactOptions}
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nom du contact <span class="required">*</span></label>
          <input type="text" class="form-control" id="appelContact" required>
        </div>
        <div class="form-group">
          <label class="form-label">T√©l√©phone <span class="required">*</span></label>
          <input type="tel" class="form-control" id="appelTelephone" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Objet de l'appel <span class="required">*</span></label>
        <input type="text" class="form-control" id="appelObjet" required placeholder="Ex: Relance, Prise de RDV...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Dur√©e (minutes)</label>
          <input type="number" class="form-control" id="appelDuree" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Statut</label>
          <select class="form-control" id="appelStatut">
            <option value="planifie">Planifi√©</option>
            <option value="effectue">Effectu√©</option>
            <option value="manque">Manqu√©</option>
            <option value="a_rappeler">√Ä rappeler</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" id="appelNotes" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeMainModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
  openMainModal();
}

function updateAppelContacts() {
  const entrepriseId = parseInt(document.getElementById('appelEntreprise').value);
  const contactSelect = document.getElementById('appelContactSelect');
  
  if (!entrepriseId) {
    contactSelect.innerHTML = '<option value="">-- S√©lectionner --</option>' + 
      (data.contacts || []).map(c => `<option value="${c.id}" data-phone="${c.phone}">${c.firstName} ${c.lastName} - ${c.phone}</option>`).join('');
    return;
  }
  
  const filteredContacts = (data.contacts || []).filter(c => c.entrepriseId === entrepriseId);
  contactSelect.innerHTML = '<option value="">-- S√©lectionner --</option>' + 
    filteredContacts.map(c => `<option value="${c.id}" data-phone="${c.phone}">${c.firstName} ${c.lastName} - ${c.phone}</option>`).join('');
}

function updateAppelPhone() {
  const contactSelect = document.getElementById('appelContactSelect');
  const selectedOption = contactSelect.options[contactSelect.selectedIndex];
  const contactId = parseInt(contactSelect.value);
  
  if (contactId) {
    const contact = data.contacts.find(c => String(c.id) === String(contactId));
    if (contact) {
      document.getElementById('appelContact').value = `${contact.firstName} ${contact.lastName}`;
      document.getElementById('appelTelephone').value = contact.phone || '';
    }
  }
}

async function saveAppel(event) {
  event.preventDefault();
  
  const appelData = {
    entrepriseId: document.getElementById('appelEntreprise').value || null,
    contactId: document.getElementById('appelContactSelect').value || null,
    contact: document.getElementById('appelContact').value,
    telephone: document.getElementById('appelTelephone').value,
    date: document.getElementById('appelDate').value,
    heure: document.getElementById('appelHeure').value,
    objet: document.getElementById('appelObjet').value,
    duree: document.getElementById('appelDuree').value || null,
    notes: document.getElementById('appelNotes').value,
    statut: document.getElementById('appelStatut').value
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      const result = await api.createAppel(appelData);
      hideLoadingOverlay();
      
      if (result.success) {
        const appelsRes = await api.getAppels();
        if (appelsRes.success) data.appels = appelsRes.data;
        closeMainModal();
        renderAppels();
        renderCalendrier();
        showToast('Succ√®s', 'Appel enregistr√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    const appel = {
      id: (data.lastId.appel || 0) + 1,
      ...appelData,
      ownerId: currentUser.id,
      createdAt: new Date().toISOString()
    };
    
    data.lastId.appel = appel.id;
    data.appels = data.appels || [];
    data.appels.push(appel);
    saveData();
    
    closeMainModal();
    renderAppels();
    renderCalendrier();
    showToast('Succ√®s', 'Appel enregistr√©', 'success');
  }
}

async function markAppelDone(id) {
  const appel = data.appels.find(a => String(a.id) === String(id));
  if (appel) {
    if (USE_GOOGLE_SHEETS_API) {
      try {
        const result = await api.updateAppel(id, { statut: 'effectue' });
        if (result.success) {
          appel.statut = 'effectue';
          renderAppels();
          showToast('Effectu√©', 'Appel marqu√© comme effectu√©', 'success');
        }
      } catch (error) {
        showToast('Erreur', error.message, 'error');
      }
    } else {
      appel.statut = 'effectue';
      saveData();
      renderAppels();
      showToast('Effectu√©', 'Appel marqu√© comme effectu√©', 'success');
    }
  }
}

async function markAppelToCallback(id) {
  const appel = data.appels.find(a => String(a.id) === String(id));
  if (appel) {
    if (USE_GOOGLE_SHEETS_API) {
      try {
        const result = await api.updateAppel(id, { statut: 'a_rappeler' });
        if (result.success) {
          appel.statut = 'a_rappeler';
          renderAppels();
          showToast('√Ä rappeler', 'Appel marqu√© √† rappeler', 'info');
        }
      } catch (error) {
        showToast('Erreur', error.message, 'error');
      }
    } else {
      appel.statut = 'a_rappeler';
      saveData();
      renderAppels();
      showToast('√Ä rappeler', 'Appel marqu√© √† rappeler', 'info');
    }
  }
}

function editAppel(id) {
  const appel = data.appels.find(a => String(a.id) === String(id));
  if (!appel) return;
  
  openNewAppelModal();
  
  setTimeout(() => {
    document.getElementById('appelDate').value = appel.date;
    document.getElementById('appelHeure').value = appel.heure;
    document.getElementById('appelEntreprise').value = appel.entrepriseId || '';
    document.getElementById('appelContact').value = appel.contact;
    document.getElementById('appelTelephone').value = appel.telephone;
    document.getElementById('appelObjet').value = appel.objet;
    document.getElementById('appelDuree').value = appel.duree || '';
    document.getElementById('appelStatut').value = appel.statut;
    document.getElementById('appelNotes').value = appel.notes || '';
    
    document.getElementById('appelForm').onsubmit = (e) => {
      e.preventDefault();
      appel.date = document.getElementById('appelDate').value;
      appel.heure = document.getElementById('appelHeure').value;
      appel.entrepriseId = parseInt(document.getElementById('appelEntreprise').value) || null;
      appel.contact = document.getElementById('appelContact').value;
      appel.telephone = document.getElementById('appelTelephone').value;
      appel.objet = document.getElementById('appelObjet').value;
      appel.duree = parseInt(document.getElementById('appelDuree').value) || null;
      appel.statut = document.getElementById('appelStatut').value;
      appel.notes = document.getElementById('appelNotes').value;
      saveData();
      closeMainModal();
      renderAppels();
      renderCalendrier();
      showToast('Modifi√©', 'Appel mis √† jour', 'success');
    };
  }, 100);
}

async function deleteAppel(id) {
  if (!confirm('Supprimer cet appel ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.deleteAppel(id);
      if (result.success) {
        data.appels = data.appels.filter(a => String(a.id) !== String(id));
        renderAppels();
        renderCalendrier();
        showToast('Supprim√©', 'Appel supprim√©', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
    }
  } else {
    data.appels = data.appels.filter(a => a.id !== id);
    saveData();
    renderAppels();
    renderCalendrier();
    showToast('Supprim√©', 'Appel supprim√©', 'success');
  }
}

// =====================================================
// MODULE ACTIONS - TACHES
// =====================================================

function renderTaches() {
  const userId = currentUser?.id;
  let tachesList = (data.taches || []).filter(t => currentUser?.role === 'admin' || t.ownerId === userId);
  
  // Apply filter
  if (tachesFilter === 'urgente') {
    tachesList = tachesList.filter(t => t.priorite === 'urgente' || t.priorite === 'haute');
  } else if (tachesFilter !== 'all') {
    tachesList = tachesList.filter(t => t.statut === tachesFilter);
  }
  
  // Sort: non-termin√©es d'abord, puis par date d'√©ch√©ance
  tachesList.sort((a, b) => {
    if (a.statut === 'terminee' && b.statut !== 'terminee') return 1;
    if (a.statut !== 'terminee' && b.statut === 'terminee') return -1;
    return (a.echeance || '').localeCompare(b.echeance || '');
  });
  
  // Update stats
  const allTaches = (data.taches || []).filter(t => currentUser?.role === 'admin' || t.ownerId === userId);
  document.getElementById('tachesTotal').textContent = allTaches.length;
  document.getElementById('tachesAFaire').textContent = allTaches.filter(t => t.statut === 'a_faire').length;
  document.getElementById('tachesEnCours').textContent = allTaches.filter(t => t.statut === 'en_cours').length;
  document.getElementById('tachesTerminees').textContent = allTaches.filter(t => t.statut === 'terminee').length;
  
  const container = document.getElementById('tachesList');
  
  if (tachesList.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><h3 class="empty-state-title">Aucune t√¢che</h3></div>`;
    return;
  }
  
  const today = new Date().toISOString().split('T')[0];
  
  container.innerHTML = tachesList.map(t => {
    const entreprise = data.entreprises.find(e => String(e.id) === String(t.entrepriseId));
    const isOverdue = t.echeance && t.echeance < today && t.statut !== 'terminee';
    
    return `
      <div class="tache-item priorite-${t.priorite} ${t.statut === 'terminee' ? 'terminee' : ''}">
        <div class="tache-checkbox ${t.statut === 'terminee' ? 'checked' : ''}" onclick="toggleTache(${t.id})">
          ${t.statut === 'terminee' ? '‚úì' : ''}
        </div>
        <div class="tache-content">
          <div class="tache-titre">${t.titre}</div>
          <div class="tache-meta">
            ${entreprise ? `<span>üè¢ ${entreprise.name}</span>` : ''}
            <span class="tache-echeance ${isOverdue ? 'en-retard' : ''}">
              üìÖ ${t.echeance ? formatDateFR(t.echeance) : 'Sans √©ch√©ance'}
              ${isOverdue ? ' ‚ö†Ô∏è En retard' : ''}
            </span>
            <span class="badge badge-${getPrioriteBadgeClass(t.priorite)}">${t.priorite}</span>
            <select class="status-select" onchange="changeTacheStatut('${t.id}', this.value)" style="padding:3px 6px;border-radius:4px;border:1px solid var(--border-color);background:var(--bg-secondary);font-size:11px;margin-left:8px;">
              <option value="a_faire" ${t.statut === 'a_faire' ? 'selected' : ''}>üìã √Ä faire</option>
              <option value="en_cours" ${t.statut === 'en_cours' ? 'selected' : ''}>üîÑ En cours</option>
              <option value="terminee" ${t.statut === 'terminee' ? 'selected' : ''}>‚úÖ Termin√©e</option>
            </select>
          </div>
        </div>
        <div class="tache-actions">
          <button class="btn btn-sm" onclick="viewTache('${t.id}')" title="Voir">üëÅÔ∏è</button>
          <button class="btn btn-sm" onclick="openModal('tache', '${t.id}')" title="Modifier">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="deleteTache('${t.id}')" title="Supprimer">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join('');
}

function getPrioriteBadgeClass(priorite) {
  const classes = {
    'urgente': 'danger',
    'haute': 'warning',
    'normale': 'primary',
    'basse': 'success'
  };
  return classes[priorite] || 'secondary';
}

function filterTaches(filter, btn) {
  tachesFilter = filter;
  document.querySelectorAll('#page-taches .tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderTaches();
}

function openNewTacheModal() {
  const entrepriseOptions = (data.entreprises || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('');
  const opportuniteOptions = (data.opportunites || []).map(o => `<option value="${o.id}">${o.name}</option>`).join('');
  
  document.getElementById('modalTitle').textContent = '‚úÖ Nouvelle t√¢che';
  document.getElementById('modalBody').innerHTML = `
    <form id="tacheForm" onsubmit="saveTache(event)">
      <div class="form-group">
        <label class="form-label">Titre <span class="required">*</span></label>
        <input type="text" class="form-control" id="tacheTitre" required placeholder="Ex: Envoyer devis, Relancer client...">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" id="tacheDescription" rows="3"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">√âch√©ance</label>
          <input type="date" class="form-control" id="tacheEcheance">
        </div>
        <div class="form-group">
          <label class="form-label">Priorit√©</label>
          <select class="form-control" id="tachePriorite">
            <option value="basse">Basse</option>
            <option value="normale" selected>Normale</option>
            <option value="haute">Haute</option>
            <option value="urgente">Urgente</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Entreprise</label>
          <select class="form-control" id="tacheEntreprise">
            <option value="">-- Aucune --</option>
            ${entrepriseOptions}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Opportunit√©</label>
          <select class="form-control" id="tacheOpportunite">
            <option value="">-- Aucune --</option>
            ${opportuniteOptions}
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" onclick="closeMainModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
  openMainModal();
}

async function saveTache(event) {
  event.preventDefault();
  
  const tacheData = {
    titre: document.getElementById('tacheTitre').value,
    description: document.getElementById('tacheDescription').value,
    entrepriseId: document.getElementById('tacheEntreprise').value || null,
    opportuniteId: document.getElementById('tacheOpportunite').value || null,
    echeance: document.getElementById('tacheEcheance').value || null,
    priorite: document.getElementById('tachePriorite').value,
    statut: 'a_faire'
  };
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      showLoadingOverlay('Enregistrement...');
      const result = await api.createTache(tacheData);
      hideLoadingOverlay();
      
      if (result.success) {
        const tachesRes = await api.getTaches();
        if (tachesRes.success) data.taches = tachesRes.data;
        closeMainModal();
        renderTaches();
        renderCalendrier();
        showToast('Succ√®s', 'T√¢che cr√©√©e', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      hideLoadingOverlay();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    const tache = {
      id: (data.lastId.tache || 0) + 1,
      ...tacheData,
      ownerId: currentUser.id,
      createdAt: new Date().toISOString()
    };
    
    data.lastId.tache = tache.id;
    data.taches = data.taches || [];
    data.taches.push(tache);
    saveData();
    
    closeMainModal();
    renderTaches();
    renderCalendrier();
    showToast('Succ√®s', 'T√¢che cr√©√©e', 'success');
  }
}

async function toggleTache(id) {
  const tache = data.taches.find(t => String(t.id) === String(id));
  if (tache) {
    const newStatut = tache.statut === 'terminee' ? 'a_faire' : 'terminee';
    
    if (USE_GOOGLE_SHEETS_API) {
      try {
        const result = await api.updateTache(id, { statut: newStatut });
        if (result.success) {
          tache.statut = newStatut;
          renderTaches();
          showToast(newStatut === 'terminee' ? 'Termin√©e' : 'R√©ouverte', 
                    newStatut === 'terminee' ? 'T√¢che termin√©e !' : 'T√¢che r√©ouverte', 
                    newStatut === 'terminee' ? 'success' : 'info');
        }
      } catch (error) {
        showToast('Erreur', error.message, 'error');
      }
    } else {
      tache.statut = newStatut;
      saveData();
      renderTaches();
      showToast(newStatut === 'terminee' ? 'Termin√©e' : 'R√©ouverte', 
                newStatut === 'terminee' ? 'T√¢che termin√©e !' : 'T√¢che r√©ouverte', 
                newStatut === 'terminee' ? 'success' : 'info');
    }
  }
}

function editTache(id) {
  const tache = data.taches.find(t => String(t.id) === String(id));
  if (!tache) return;
  
  openNewTacheModal();
  
  setTimeout(() => {
    document.getElementById('tacheTitre').value = tache.titre;
    document.getElementById('tacheDescription').value = tache.description || '';
    document.getElementById('tacheEcheance').value = tache.echeance || '';
    document.getElementById('tachePriorite').value = tache.priorite;
    document.getElementById('tacheEntreprise').value = tache.entrepriseId || '';
    document.getElementById('tacheOpportunite').value = tache.opportuniteId || '';
    
    document.getElementById('tacheForm').onsubmit = (e) => {
      e.preventDefault();
      tache.titre = document.getElementById('tacheTitre').value;
      tache.description = document.getElementById('tacheDescription').value;
      tache.echeance = document.getElementById('tacheEcheance').value || null;
      tache.priorite = document.getElementById('tachePriorite').value;
      tache.entrepriseId = parseInt(document.getElementById('tacheEntreprise').value) || null;
      tache.opportuniteId = parseInt(document.getElementById('tacheOpportunite').value) || null;
      saveData();
      closeMainModal();
      renderTaches();
      renderCalendrier();
      showToast('Modifi√©e', 'T√¢che mise √† jour', 'success');
    };
  }, 100);
}

async function deleteTache(id) {
  if (!confirm('Supprimer cette t√¢che ?')) return;
  
  if (USE_GOOGLE_SHEETS_API) {
    try {
      const result = await api.deleteTache(id);
      if (result.success) {
        data.taches = data.taches.filter(t => String(t.id) !== String(id));
        renderTaches();
        renderCalendrier();
        showToast('Supprim√©e', 'T√¢che supprim√©e', 'success');
      } else {
        showToast('Erreur', result.message || 'Erreur', 'error');
      }
    } catch (error) {
      showToast('Erreur', error.message, 'error');
    }
  } else {
    data.taches = data.taches.filter(t => t.id !== id);
    saveData();
    renderTaches();
    renderCalendrier();
    showToast('Supprim√©e', 'T√¢che supprim√©e', 'success');
  }
}

// =====================================================
// INITIALIZATION
// =====================================================

document.addEventListener('DOMContentLoaded', init);


// =====================================================
// PATCH V6 - CORRECTIONS COMPL√àTES DESCLICK CRM
// √Ä ins√©rer avant la fermeture du script
// =====================================================

console.log('üîß Chargement du patch v6...');

// =====================================================
// 1. FIX DRAG & DROP - VERSION ROBUSTE
// =====================================================

// Variable globale pour le drag
window.draggedOppId = null;

// Nouvelle fonction handleDragStart
window.handleDragStart = function(e, oppId) {
  console.log('üéØ Drag Start:', oppId);
  window.draggedOppId = String(oppId);
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', String(oppId));
};

// Nouvelle fonction handleDragEnd
window.handleDragEnd = function(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.pipeline-column').forEach(col => {
    col.classList.remove('drag-over');
  });
};

// Nouvelle fonction handleDragOver
window.handleDragOver = function(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
};

// Nouvelle fonction handleDragLeave
window.handleDragLeave = function(e) {
  e.currentTarget.classList.remove('drag-over');
};

// Nouvelle fonction handleDrop - VERSION ROBUSTE
window.handleDrop = async function(e, stageId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  
  const oppId = window.draggedOppId || e.dataTransfer.getData('text/plain');
  console.log('üì• Drop:', oppId, '‚Üí', stageId);
  
  if (!oppId) {
    console.warn('Pas d\'ID d\'opportunit√©');
    return;
  }
  
  const opp = data.opportunites.find(o => String(o.id) === String(oppId));
  if (!opp) {
    console.warn('Opportunit√© non trouv√©e:', oppId);
    return;
  }
  
  const stage = PIPELINE_STAGES.find(s => s.id === stageId);
  const oldStage = opp.stage;
  
  // Mettre √† jour localement d'abord (optimistic update)
  opp.stage = stageId;
  opp.probability = stage?.probability || opp.probability;
  opp.updatedAt = new Date().toISOString();
  
  // Rafra√Æchir l'affichage imm√©diatement
  if (typeof renderPipeline === 'function') renderPipeline();
  if (typeof renderAdminPipeline === 'function') renderAdminPipeline();
  
  // Sauvegarder via API
  if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
    try {
      const result = await api.updateOpportunite(opp.id, { stage: stageId, probability: opp.probability });
      
      if (result.success) {
        showToast('D√©plac√©', `${opp.name} ‚Üí ${stage?.name}`, 'success');
      } else {
        // Rollback
        opp.stage = oldStage;
        if (typeof renderPipeline === 'function') renderPipeline();
        if (typeof renderAdminPipeline === 'function') renderAdminPipeline();
        showToast('Erreur', result.message || 'Erreur lors du d√©placement', 'error');
      }
    } catch (error) {
      // Rollback
      opp.stage = oldStage;
      if (typeof renderPipeline === 'function') renderPipeline();
      if (typeof renderAdminPipeline === 'function') renderAdminPipeline();
      showToast('Erreur', error.message, 'error');
    }
  } else {
    // Mode local
    if (typeof saveData === 'function') saveData();
    showToast('D√©plac√©', `${opp.name} ‚Üí ${stage?.name}`, 'success');
  }
  
  window.draggedOppId = null;
};

// =====================================================
// 2. BOUTON T√âL√âCHARGER DONN√âES GOOGLE SHEETS
// =====================================================

// =====================================================
// 3. MENUS D√âROULANTS POUR STATUTS DANS LES TABLEAUX
// =====================================================

// Fonction g√©n√©rique pour cr√©er un select de statut
window.createStatusSelect = function(currentValue, options, onChange) {
  const optionsHtml = options.map(opt => 
    `<option value="${opt.value}" ${opt.value === currentValue ? 'selected' : ''}>${opt.label}</option>`
  ).join('');
  
  return `<select class="status-select" onchange="${onChange}" style="
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 12px;
    cursor: pointer;
  ">${optionsHtml}</select>`;
};

// Statuts disponibles
window.STATUS_OPTIONS = {
  entreprise: [
    { value: 'Prospect', label: 'üîµ Prospect' },
    { value: 'Client', label: 'üü¢ Client' },
    { value: 'Partenaire', label: 'üü£ Partenaire' },
    { value: 'Inactif', label: '‚ö´ Inactif' }
  ],
  opportunite: [
    { value: 'prospection', label: 'üîç Prospection' },
    { value: 'qualification', label: 'üìã Qualification' },
    { value: 'proposition', label: 'üìÑ Proposition' },
    { value: 'negociation', label: 'ü§ù N√©gociation' },
    { value: 'cloture', label: '‚úÖ Cl√¥ture' },
    { value: 'gagnee', label: 'üèÜ Gagn√©e' },
    { value: 'perdue', label: '‚ùå Perdue' }
  ],
  rdv: [
    { value: 'a_confirmer', label: '‚è≥ √Ä confirmer' },
    { value: 'confirme', label: '‚úÖ Confirm√©' },
    { value: 'effectue', label: '‚úîÔ∏è Effectu√©' },
    { value: 'annule', label: '‚ùå Annul√©' },
    { value: 'reporte', label: 'üîÑ Report√©' }
  ],
  appel: [
    { value: 'a_faire', label: 'üìû √Ä faire' },
    { value: 'effectue', label: '‚úÖ Effectu√©' },
    { value: 'pas_reponse', label: '‚ùå Pas de r√©ponse' },
    { value: 'rappeler', label: 'üîÑ Rappeler' }
  ],
  tache: [
    { value: 'a_faire', label: 'üìã √Ä faire' },
    { value: 'en_cours', label: 'üîÑ En cours' },
    { value: 'terminee', label: '‚úÖ Termin√©e' },
    { value: 'annulee', label: '‚ùå Annul√©e' }
  ],
  commande: [
    { value: 'brouillon', label: 'üìù Brouillon' },
    { value: 'validee', label: '‚úÖ Valid√©e' },
    { value: 'livree', label: 'üì¶ Livr√©e' },
    { value: 'payee', label: 'üí∞ Pay√©e' },
    { value: 'annulee', label: '‚ùå Annul√©e' }
  ]
};

// Fonctions pour changer les statuts
window.changeEntrepriseType = async function(id, newType) {
  const ent = data.entreprises.find(e => String(e.id) === String(id));
  if (!ent) return;
  
  ent.type = newType;
  
  if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
    try {
      await api.updateEntreprise(id, { type: newType });
      showToast('Mis √† jour', `Type: ${newType}`, 'success');
    } catch (e) {
      showToast('Erreur', e.message, 'error');
    }
  }
  renderEntreprises();
};

window.changeOpportuniteStage = async function(id, newStage) {
  const opp = data.opportunites.find(o => String(o.id) === String(id));
  if (!opp) return;
  
  opp.stage = newStage;
  const stage = PIPELINE_STAGES.find(s => s.id === newStage);
  opp.probability = stage?.probability || opp.probability;
  
  if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
    try {
      await api.updateOpportunite(id, { stage: newStage, probability: opp.probability });
      showToast('Mis √† jour', `√âtape: ${stage?.name || newStage}`, 'success');
    } catch (e) {
      showToast('Erreur', e.message, 'error');
    }
  }
  if (typeof renderOpportunites === 'function') renderOpportunites();
  if (typeof renderPipeline === 'function') renderPipeline();
};

window.changeRdvStatut = async function(id, newStatut) {
  const rdv = data.rdv.find(r => String(r.id) === String(id));
  if (!rdv) return;
  
  rdv.statut = newStatut;
  
  if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
    try {
      await api.updateRdv(id, { statut: newStatut });
      showToast('Mis √† jour', `Statut RDV: ${newStatut}`, 'success');
    } catch (e) {
      showToast('Erreur', e.message, 'error');
    }
  }
  renderRdv();
};

window.changeAppelStatut = async function(id, newStatut) {
  const appel = data.appels.find(a => String(a.id) === String(id));
  if (!appel) return;
  
  appel.statut = newStatut;
  
  if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
    try {
      await api.updateAppel(id, { statut: newStatut });
      showToast('Mis √† jour', `Statut appel: ${newStatut}`, 'success');
    } catch (e) {
      showToast('Erreur', e.message, 'error');
    }
  }
  renderAppels();
};

window.changeTacheStatut = async function(id, newStatut) {
  const tache = data.taches.find(t => String(t.id) === String(id));
  if (!tache) return;
  
  tache.statut = newStatut;
  
  if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
    try {
      await api.updateTache(id, { statut: newStatut });
      showToast('Mis √† jour', `Statut t√¢che: ${newStatut}`, 'success');
    } catch (e) {
      showToast('Erreur', e.message, 'error');
    }
  }
  renderTaches();
};

// =====================================================
// 4. FIX FORMULAIRES - CHARGEMENT DES DONN√âES
// =====================================================

// Fonction pour pr√©-remplir les selects d'entreprises
window.populateEntrepriseSelect = function(selectId, selectedId = null) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  const entreprises = data.entreprises || [];
  select.innerHTML = '<option value="">-- S√©lectionner --</option>' +
    entreprises.map(e => `<option value="${e.id}" ${String(e.id) === String(selectedId) ? 'selected' : ''}>${e.name}</option>`).join('');
};

// Fonction pour pr√©-remplir les selects de contacts
window.populateContactSelect = function(selectId, entrepriseId = null, selectedId = null) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  let contacts = data.contacts || [];
  if (entrepriseId) {
    contacts = contacts.filter(c => String(c.entrepriseId) === String(entrepriseId));
  }
  
  select.innerHTML = '<option value="">-- S√©lectionner --</option>' +
    contacts.map(c => `<option value="${c.id}" ${String(c.id) === String(selectedId) ? 'selected' : ''}>${c.firstName} ${c.lastName}</option>`).join('');
};

// Fonction pour pr√©-remplir les selects de commerciaux
window.populateCommercialSelect = function(selectId, selectedId = null) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  const commerciaux = (data.users || []).filter(u => u.role === 'commercial' || u.role === 'admin');
  select.innerHTML = '<option value="">-- S√©lectionner --</option>' +
    commerciaux.map(u => `<option value="${u.id}" ${String(u.id) === String(selectedId) ? 'selected' : ''}>${u.firstName} ${u.lastName}</option>`).join('');
};

// =====================================================
// 5. AJOUTER LE BOUTON DE T√âL√âCHARGEMENT DANS LE HEADER
// =====================================================

// Cette fonction sera appel√©e apr√®s le chargement
// =====================================================
// 6. INITIALISATION
// =====================================================

// Ajouter les styles pour les selects de statut
const statusStyles = document.createElement('style');
statusStyles.textContent = `
  .status-select {
    transition: all 0.2s;
  }
  .status-select:hover {
    border-color: var(--brand-primary);
  }
  .status-select:focus {
    outline: none;
    border-color: var(--brand-primary);
    box-shadow: 0 0 0 3px rgba(43, 94, 167, 0.2);
  }
  .pipeline-column.drag-over {
    background: rgba(43, 94, 167, 0.1) !important;
    border: 2px dashed var(--brand-primary) !important;
  }
  .pipeline-card.dragging {
    opacity: 0.5;
    transform: rotate(3deg);
  }
  .pipeline-card {
    cursor: grab;
  }
  .pipeline-card:active {
    cursor: grabbing;
  }
`;
document.head.appendChild(statusStyles);

// Ajouter le bouton de t√©l√©chargement apr√®s le chargement


console.log('‚úÖ Patch v6 charg√© avec succ√®s!');
console.log('   - Drag & drop corrig√©');
console.log('   - Boutons t√©l√©chargement ajout√©s');
console.log('   - Selects de statut disponibles');
console.log('   - Fonctions de formulaires am√©lior√©es');




// =====================================================
// FONCTIONS DE FORMULAIRES MANQUANTES
// =====================================================

function getRdvForm(id) {
  const r = id ? (data.rdv || []).find(rdv => String(rdv.id) === String(id)) : {};
  const entreprises = data.entreprises || [];
  const contacts = data.contacts || [];
  
  const entrepriseOptions = entreprises.map(e => 
    `<option value="${e.id}" ${String(e.id) === String(r.entrepriseId) ? 'selected' : ''}>${e.name}</option>`
  ).join('');
  
  const contactOptions = contacts.map(c => 
    `<option value="${c.id}" ${String(c.id) === String(r.contactId) ? 'selected' : ''}>${c.firstName} ${c.lastName}</option>`
  ).join('');
  
  return `
    <form onsubmit="saveRdvFromModal(event)" data-id="${id || ''}">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date <span class="required">*</span></label>
          <input type="date" class="form-control" name="date" value="${r.date || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Heure <span class="required">*</span></label>
          <input type="time" class="form-control" name="heure" value="${r.heure || ''}" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Entreprise</label>
          <select class="form-control" name="entrepriseId" onchange="updateContactsForEntreprise(this.value, 'contactIdRdv')">
            <option value="">-- S√©lectionner --</option>
            ${entrepriseOptions}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Contact</label>
          <select class="form-control" name="contactId" id="contactIdRdv">
            <option value="">-- S√©lectionner --</option>
            ${contactOptions}
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Objet <span class="required">*</span></label>
        <input type="text" class="form-control" name="objet" value="${r.objet || ''}" required>
      </div>
      <div class="form-group">
        <label class="form-label">Lieu</label>
        <input type="text" class="form-control" name="lieu" value="${r.lieu || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Statut</label>
        <select class="form-control" name="statut">
          <option value="a_confirmer" ${r.statut === 'a_confirmer' ? 'selected' : ''}>√Ä confirmer</option>
          <option value="confirme" ${r.statut === 'confirme' ? 'selected' : ''}>Confirm√©</option>
          <option value="effectue" ${r.statut === 'effectue' ? 'selected' : ''}>Effectu√©</option>
          <option value="annule" ${r.statut === 'annule' ? 'selected' : ''}>Annul√©</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" name="notes" rows="3">${r.notes || ''}</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
}

function getAppelForm(id) {
  const a = id ? (data.appels || []).find(appel => String(appel.id) === String(id)) : {};
  const entreprises = data.entreprises || [];
  
  const entrepriseOptions = entreprises.map(e => 
    `<option value="${e.id}" ${String(e.id) === String(a.entrepriseId) ? 'selected' : ''}>${e.name}</option>`
  ).join('');
  
  return `
    <form onsubmit="saveAppelFromModal(event)" data-id="${id || ''}">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date <span class="required">*</span></label>
          <input type="date" class="form-control" name="date" value="${a.date || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Heure <span class="required">*</span></label>
          <input type="time" class="form-control" name="heure" value="${a.heure || ''}" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Contact <span class="required">*</span></label>
          <input type="text" class="form-control" name="contact" value="${a.contact || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">T√©l√©phone <span class="required">*</span></label>
          <input type="tel" class="form-control" name="telephone" value="${a.telephone || ''}" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Entreprise</label>
        <select class="form-control" name="entrepriseId">
          <option value="">-- S√©lectionner --</option>
          ${entrepriseOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Objet <span class="required">*</span></label>
        <input type="text" class="form-control" name="objet" value="${a.objet || ''}" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Dur√©e (min)</label>
          <input type="number" class="form-control" name="duree" value="${a.duree || ''}">
        </div>
        <div class="form-group">
          <label class="form-label">Statut</label>
          <select class="form-control" name="statut">
            <option value="planifie" ${a.statut === 'planifie' ? 'selected' : ''}>Planifi√©</option>
            <option value="effectue" ${a.statut === 'effectue' ? 'selected' : ''}>Effectu√©</option>
            <option value="manque" ${a.statut === 'manque' ? 'selected' : ''}>Manqu√©</option>
            <option value="a_rappeler" ${a.statut === 'a_rappeler' ? 'selected' : ''}>√Ä rappeler</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-control" name="notes" rows="3">${a.notes || ''}</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
}

function getTacheForm(id) {
  const t = id ? (data.taches || []).find(tache => String(tache.id) === String(id)) : {};
  const entreprises = data.entreprises || [];
  
  const entrepriseOptions = entreprises.map(e => 
    `<option value="${e.id}" ${String(e.id) === String(t.entrepriseId) ? 'selected' : ''}>${e.name}</option>`
  ).join('');
  
  return `
    <form onsubmit="saveTacheFromModal(event)" data-id="${id || ''}">
      <div class="form-group">
        <label class="form-label">Titre <span class="required">*</span></label>
        <input type="text" class="form-control" name="titre" value="${t.titre || ''}" required>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="form-control" name="description" rows="3">${t.description || ''}</textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Entreprise</label>
          <select class="form-control" name="entrepriseId">
            <option value="">-- S√©lectionner --</option>
            ${entrepriseOptions}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">√âch√©ance</label>
          <input type="date" class="form-control" name="echeance" value="${t.echeance || ''}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Priorit√©</label>
          <select class="form-control" name="priorite">
            <option value="basse" ${t.priorite === 'basse' ? 'selected' : ''}>Basse</option>
            <option value="normale" ${t.priorite === 'normale' || !t.priorite ? 'selected' : ''}>Normale</option>
            <option value="haute" ${t.priorite === 'haute' ? 'selected' : ''}>Haute</option>
            <option value="urgente" ${t.priorite === 'urgente' ? 'selected' : ''}>Urgente</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Statut</label>
          <select class="form-control" name="statut">
            <option value="a_faire" ${t.statut === 'a_faire' || !t.statut ? 'selected' : ''}>√Ä faire</option>
            <option value="en_cours" ${t.statut === 'en_cours' ? 'selected' : ''}>En cours</option>
            <option value="terminee" ${t.statut === 'terminee' ? 'selected' : ''}>Termin√©e</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  `;
}

function getEmailForm(id) {
  const e = id ? (data.emails || []).find(email => String(email.id) === String(id)) : {};
  const contacts = data.contacts || [];
  
  const contactOptions = contacts.map(c => 
    `<option value="${c.id}" ${String(c.id) === String(e.contactId) ? 'selected' : ''}>${c.firstName} ${c.lastName} (${c.email || 'pas d\'email'})</option>`
  ).join('');
  
  return `
    <form onsubmit="saveEmailFromModal(event)" data-id="${id || ''}">
      <div class="form-group">
        <label class="form-label">Destinataire <span class="required">*</span></label>
        <input type="email" class="form-control" name="to" value="${e.to || ''}" required placeholder="email@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">Contact associ√©</label>
        <select class="form-control" name="contactId" onchange="fillEmailFromContact(this.value)">
          <option value="">-- S√©lectionner --</option>
          ${contactOptions}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Objet <span class="required">*</span></label>
        <input type="text" class="form-control" name="subject" value="${e.subject || ''}" required>
      </div>
      <div class="form-group">
        <label class="form-label">Message <span class="required">*</span></label>
        <textarea class="form-control" name="body" rows="6" required>${e.body || ''}</textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">${id ? 'Enregistrer' : 'Envoyer'}</button>
      </div>
    </form>
  `;
}

// Fonctions de sauvegarde
async function saveRdvFromModal(event) {
  event.preventDefault();
  const form = event.target;
  const id = form.dataset.id;
  
  const rdvData = {
    date: form.date.value,
    heure: form.heure.value,
    entrepriseId: form.entrepriseId?.value || '',
    contactId: form.contactId?.value || '',
    objet: form.objet.value,
    lieu: form.lieu?.value || '',
    statut: form.statut?.value || 'a_confirmer',
    notes: form.notes?.value || ''
  };
  
  try {
    showLoadingOverlay('Enregistrement...');
    let result;
    
    if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
      if (id) {
        result = await api.updateRdv(id, rdvData);
      } else {
        result = await api.createRdv(rdvData);
      }
    } else {
      // Mode local
      if (id) {
        const rdv = data.rdv.find(r => String(r.id) === String(id));
        Object.assign(rdv, rdvData);
      } else {
        data.rdv = data.rdv || [];
        data.rdv.push({ id: Date.now(), ...rdvData, ownerId: currentUser.id });
      }
      result = { success: true };
    }
    
    hideLoadingOverlay();
    
    if (result.success) {
      closeModal();
      if (typeof renderRdv === 'function') renderRdv();
      if (typeof renderCalendrier === 'function') renderCalendrier();
      showToast('Succ√®s', id ? 'RDV modifi√©' : 'RDV cr√©√©', 'success');
    } else {
      showToast('Erreur', result.message || 'Erreur', 'error');
    }
  } catch (e) {
    hideLoadingOverlay();
    showToast('Erreur', e.message, 'error');
  }
}

async function saveAppelFromModal(event) {
  event.preventDefault();
  const form = event.target;
  const id = form.dataset.id;
  
  const appelData = {
    date: form.date.value,
    heure: form.heure.value,
    contact: form.contact.value,
    telephone: form.telephone.value,
    entrepriseId: form.entrepriseId?.value || '',
    objet: form.objet.value,
    duree: form.duree?.value || '',
    statut: form.statut?.value || 'planifie',
    notes: form.notes?.value || ''
  };
  
  try {
    showLoadingOverlay('Enregistrement...');
    let result;
    
    if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
      if (id) {
        result = await api.updateAppel(id, appelData);
      } else {
        result = await api.createAppel(appelData);
      }
    } else {
      if (id) {
        const appel = data.appels.find(a => String(a.id) === String(id));
        Object.assign(appel, appelData);
      } else {
        data.appels = data.appels || [];
        data.appels.push({ id: Date.now(), ...appelData, ownerId: currentUser.id });
      }
      result = { success: true };
    }
    
    hideLoadingOverlay();
    
    if (result.success) {
      closeModal();
      if (typeof renderAppels === 'function') renderAppels();
      showToast('Succ√®s', id ? 'Appel modifi√©' : 'Appel cr√©√©', 'success');
    } else {
      showToast('Erreur', result.message || 'Erreur', 'error');
    }
  } catch (e) {
    hideLoadingOverlay();
    showToast('Erreur', e.message, 'error');
  }
}

async function saveTacheFromModal(event) {
  event.preventDefault();
  const form = event.target;
  const id = form.dataset.id;
  
  const tacheData = {
    titre: form.titre.value,
    description: form.description?.value || '',
    entrepriseId: form.entrepriseId?.value || '',
    echeance: form.echeance?.value || '',
    priorite: form.priorite?.value || 'normale',
    statut: form.statut?.value || 'a_faire'
  };
  
  try {
    showLoadingOverlay('Enregistrement...');
    let result;
    
    if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
      if (id) {
        result = await api.updateTache(id, tacheData);
      } else {
        result = await api.createTache(tacheData);
      }
    } else {
      if (id) {
        const tache = data.taches.find(t => String(t.id) === String(id));
        Object.assign(tache, tacheData);
      } else {
        data.taches = data.taches || [];
        data.taches.push({ id: Date.now(), ...tacheData, ownerId: currentUser.id });
      }
      result = { success: true };
    }
    
    hideLoadingOverlay();
    
    if (result.success) {
      closeModal();
      if (typeof renderTaches === 'function') renderTaches();
      showToast('Succ√®s', id ? 'T√¢che modifi√©e' : 'T√¢che cr√©√©e', 'success');
    } else {
      showToast('Erreur', result.message || 'Erreur', 'error');
    }
  } catch (e) {
    hideLoadingOverlay();
    showToast('Erreur', e.message, 'error');
  }
}

async function saveEmailFromModal(event) {
  event.preventDefault();
  const form = event.target;
  const id = form.dataset.id;
  
  const emailData = {
    to: form.to.value,
    contactId: form.contactId?.value || '',
    subject: form.subject.value,
    body: form.body.value,
    statut: 'brouillon'
  };
  
  try {
    showLoadingOverlay('Enregistrement...');
    let result;
    
    if (typeof USE_GOOGLE_SHEETS_API !== 'undefined' && USE_GOOGLE_SHEETS_API && typeof api !== 'undefined') {
      if (id) {
        result = await api.updateEmail(id, emailData);
      } else {
        // Envoyer directement
        result = await api.request('sendEmail', { data: emailData });
      }
    } else {
      if (id) {
        const email = data.emails.find(e => String(e.id) === String(id));
        Object.assign(email, emailData);
      } else {
        data.emails = data.emails || [];
        data.emails.push({ id: Date.now(), ...emailData, ownerId: currentUser.id, dateEnvoi: new Date().toISOString() });
      }
      result = { success: true };
    }
    
    hideLoadingOverlay();
    
    if (result.success) {
      closeModal();
      if (typeof renderEmails === 'function') renderEmails();
      showToast('Succ√®s', id ? 'Email modifi√©' : 'Email envoy√©', 'success');
    } else {
      showToast('Erreur', result.message || 'Erreur', 'error');
    }
  } catch (e) {
    hideLoadingOverlay();
    showToast('Erreur', e.message, 'error');
  }
}

// Fonction utilitaire pour mettre √† jour les contacts selon l'entreprise
function updateContactsForEntreprise(entrepriseId, selectId) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  let contacts = data.contacts || [];
  if (entrepriseId) {
    contacts = contacts.filter(c => String(c.entrepriseId) === String(entrepriseId));
  }
  
  select.innerHTML = '<option value="">-- S√©lectionner --</option>' +
    contacts.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
}

function fillEmailFromContact(contactId) {
  const contact = (data.contacts || []).find(c => String(c.id) === String(contactId));
  if (contact && contact.email) {
    const toField = document.querySelector('input[name="to"]');
    if (toField) toField.value = contact.email;
  }
}

console.log('‚úÖ Fonctions de formulaires charg√©es');




// =====================================================
// PATCH CHARGEMENT DONN√âES GOOGLE SHEETS
// =====================================================

console.log('üîÑ Initialisation du patch de chargement des donn√©es...');

// Forcer le rechargement des donn√©es depuis Google Sheets
window.forceReloadFromGoogleSheets = async function() {
  console.log('üîÑ Rechargement forc√© depuis Google Sheets...');
  
  if (!currentUser) {
    showToast('Erreur', 'Vous devez √™tre connect√©', 'error');
    return;
  }
  
  try {
    showLoadingOverlay('Chargement depuis Google Sheets...');
    
    // Forcer le mode API
    USE_GOOGLE_SHEETS_API = true;
    
    // Charger toutes les donn√©es
    const results = await Promise.allSettled([
      api.getEntreprises(),
      api.getContacts(),
      api.getOpportunites(),
      api.getProduits(),
      api.getPacks(),
      api.getEmails(),
      api.getRdv(),
      api.getAppels(),
      api.getTaches(),
      currentUser?.role === 'admin' ? api.getUsers() : Promise.resolve({ success: true, data: [] })
    ]);
    
    const [entreprisesRes, contactsRes, opportunitesRes, produitsRes, packsRes, 
           emailsRes, rdvRes, appelsRes, tachesRes, usersRes] = results.map(r => 
      r.status === 'fulfilled' ? r.value : { success: false, data: [] }
    );
    
    // Log des r√©sultats
    console.log('üìä R√©sultats du chargement:');
    console.log('  - Entreprises:', entreprisesRes.success ? entreprisesRes.data?.length || 0 : 'ERREUR');
    console.log('  - Contacts:', contactsRes.success ? contactsRes.data?.length || 0 : 'ERREUR');
    console.log('  - Opportunit√©s:', opportunitesRes.success ? opportunitesRes.data?.length || 0 : 'ERREUR');
    console.log('  - RDV:', rdvRes.success ? rdvRes.data?.length || 0 : 'ERREUR');
    console.log('  - Appels:', appelsRes.success ? appelsRes.data?.length || 0 : 'ERREUR');
    console.log('  - T√¢ches:', tachesRes.success ? tachesRes.data?.length || 0 : 'ERREUR');
    
    // Mettre √† jour les donn√©es
    if (entreprisesRes.success) data.entreprises = entreprisesRes.data || [];
    if (contactsRes.success) data.contacts = contactsRes.data || [];
    if (opportunitesRes.success) data.opportunites = opportunitesRes.data || [];
    if (emailsRes.success) data.emails = emailsRes.data || [];
    if (rdvRes.success) data.rdv = rdvRes.data || [];
    if (appelsRes.success) data.appels = appelsRes.data || [];
    if (tachesRes.success) data.taches = tachesRes.data || [];
    if (usersRes.success && usersRes.data) data.users = usersRes.data;
    
    // S'assurer que les tableaux optionnels existent
    if (!data.activities) data.activities = [];
    if (!data.orders) data.orders = [];
    if (!data.messages) data.messages = [];
    if (!data.alertes) data.alertes = [];
    
    hideLoadingOverlay();
    
    // Rafra√Æchir l'affichage
    if (typeof showPage === 'function') {
      showPage(currentPage || 'dashboard');
    }
    
    const totalItems = (data.entreprises?.length || 0) + (data.contacts?.length || 0) + 
                       (data.opportunites?.length || 0) + (data.rdv?.length || 0);
    
    showToast('Charg√©', `${totalItems} √©l√©ments charg√©s depuis Google Sheets`, 'success');
    
    return true;
  } catch (error) {
    hideLoadingOverlay();
    console.error('‚ùå Erreur chargement:', error);
    showToast('Erreur', 'Erreur de chargement: ' + error.message, 'error');
    return false;
  }
};

// Am√©liorer la fonction de login pour charger les donn√©es apr√®s connexion
const originalDoLogin = window.doLogin;
window.doLogin = async function(event) {
  if (event) event.preventDefault();
  
  const username = document.getElementById('loginUsername')?.value?.trim();
  const password = document.getElementById('loginPassword')?.value;
  
  if (!username || !password) {
    showToast('Erreur', 'Identifiant et mot de passe requis', 'error');
    return;
  }
  
  try {
    showLoadingOverlay('Connexion en cours...');
    
    // Tenter la connexion API
    const result = await api.login(username, password);
    
    console.log('üîê R√©sultat login:', result);
    
    if (result.success && result.data) {
      currentUser = result.data.user || result.data;
      api.token = result.data.token || result.token || '';
      
      localStorage.setItem(API_CONFIG.TOKEN_KEY, api.token);
      localStorage.setItem(API_CONFIG.USER_KEY, JSON.stringify(currentUser));
      
      // Masquer le login
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      
      // Mettre √† jour l'interface
      updateUserInterface();
      
      // IMPORTANT: Charger les donn√©es depuis Google Sheets
      console.log('üì• Chargement des donn√©es apr√®s connexion...');
      await forceReloadFromGoogleSheets();
      
      hideLoadingOverlay();
      showToast('Bienvenue', `Connect√© en tant que ${currentUser.firstName || username}`, 'success');
      
    } else {
      hideLoadingOverlay();
      showToast('Erreur', result.message || 'Identifiants incorrects', 'error');
    }
  } catch (error) {
    hideLoadingOverlay();
    console.error('‚ùå Erreur login:', error);
    showToast('Erreur', 'Erreur de connexion: ' + error.message, 'error');
  }
};

// Ajouter un bouton de synchronisation dans le header
window.addSyncButton = function() {
  const headerRight = document.querySelector('.header-right') || document.querySelector('.header-actions');
  
  if (headerRight && !document.getElementById('syncBtn')) {
    const syncBtn = document.createElement('button');
    syncBtn.id = 'syncBtn';
    syncBtn.className = 'btn btn-icon';
    syncBtn.title = 'Synchroniser avec Google Sheets';
    syncBtn.innerHTML = 'üîÑ';
    syncBtn.onclick = forceReloadFromGoogleSheets;
    syncBtn.style.cssText = 'margin-right: 10px; font-size: 18px;';
    headerRight.insertBefore(syncBtn, headerRight.firstChild);
  }
};

// Modifier la fonction init pour s'assurer que les donn√©es sont charg√©es
const originalInit = window.init;
window.init = async function() {
  console.log('üöÄ Initialisation du CRM...');
  
  // V√©rifier si un token existe
  const savedToken = localStorage.getItem(API_CONFIG.TOKEN_KEY);
  const savedUser = localStorage.getItem(API_CONFIG.USER_KEY);
  
  if (savedToken && savedUser) {
    try {
      currentUser = JSON.parse(savedUser);
      api.token = savedToken;
      
      // V√©rifier que le token est valide
      const meResult = await api.getMe();
      
      if (meResult.success) {
        console.log('‚úÖ Session valide, chargement des donn√©es...');
        
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        
        updateUserInterface();
        
        // Charger les donn√©es depuis Google Sheets
        await forceReloadFromGoogleSheets();
        
        // Ajouter le bouton de synchronisation
        setTimeout(addSyncButton, 500);
        
        return;
      }
    } catch (e) {
      console.warn('Session invalide:', e);
    }
  }
  
  // Afficher le formulaire de connexion
  document.getElementById('loginContainer').style.display = 'flex';
  document.getElementById('appContainer').style.display = 'none';
};

// S'ex√©cuter au chargement
setTimeout(() => {
  addSyncButton();
}, 1000);

console.log('‚úÖ Patch de chargement des donn√©es install√©');
console.log('   - Utilisez üîÑ pour synchroniser manuellement');
console.log('   - Les donn√©es sont charg√©es automatiquement apr√®s connexion');



// =====================================================
// SYNCHRONISATION GOOGLE SHEETS
// =====================================================

async function syncFromGoogleSheets() {
  if (!currentUser) {
    showToast('Erreur', 'Vous devez √™tre connect√©', 'error');
    return;
  }
  
  console.log('üîÑ ========================================');
  console.log('üîÑ SYNCHRONISATION GOOGLE SHEETS - D√âBUT');
  console.log('üîÑ ========================================');
  console.log('üë§ Utilisateur:', currentUser?.username, '- Role:', currentUser?.role);
  console.log('üîó API URL:', API_CONFIG.API_URL);
  console.log('üé´ Token:', api.token ? 'Pr√©sent (' + api.token.substring(0, 20) + '...)' : 'ABSENT!');
  
  showLoadingOverlay('Synchronisation en cours...');
  
  try {
    // Forcer le mode API
    USE_GOOGLE_SHEETS_API = true;
    
    // Utiliser Promise.allSettled pour ne pas bloquer si une requ√™te √©choue
    console.log('üì° Envoi des requ√™tes API...');
    
    const results = await Promise.allSettled([
      api.getEntreprises().then(r => { console.log('‚úÖ Entreprises:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getContacts().then(r => { console.log('‚úÖ Contacts:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getOpportunites().then(r => { console.log('‚úÖ Opportunit√©s:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getProduits().then(r => { console.log('‚úÖ Produits:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getPacks().then(r => { console.log('‚úÖ Packs:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getEmails().then(r => { console.log('‚úÖ Emails:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getRdv().then(r => { console.log('‚úÖ RDV:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getAppels().then(r => { console.log('‚úÖ Appels:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      api.getTaches().then(r => { console.log('‚úÖ T√¢ches:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }),
      currentUser?.role === 'admin' ? api.getUsers().then(r => { console.log('‚úÖ Users:', r.success ? r.data?.length || 0 : 'ERREUR'); return r; }) : Promise.resolve({ success: true, data: [] })
    ]);
    
    console.log('üìä R√©sultats bruts:', results.map(r => r.status));
    
    // Extraire les r√©sultats
    const getValue = (r) => r.status === 'fulfilled' ? r.value : { success: false, data: [] };
    
    const [entreprisesRes, contactsRes, opportunitesRes, produitsRes, packsRes, 
           emailsRes, rdvRes, appelsRes, tachesRes, usersRes] = results.map(getValue);
    
    // Log d√©taill√© des r√©sultats
    console.log('üìã D√©tail des r√©ponses:');
    console.log('  Entreprises:', entreprisesRes);
    console.log('  Opportunit√©s:', opportunitesRes);
    
    // Mettre √† jour les donn√©es
    if (entreprisesRes.success && entreprisesRes.data) {
      data.entreprises = entreprisesRes.data;
      console.log('‚úÖ Entreprises charg√©es:', (data.entreprises || []).length);
    } else {
      console.warn('‚ö†Ô∏è Entreprises: √©chec ou donn√©es vides');
    }
    
    if (contactsRes.success && contactsRes.data) {
      data.contacts = contactsRes.data;
    }
    
    if (opportunitesRes.success && opportunitesRes.data) {
      data.opportunites = opportunitesRes.data;
      console.log('‚úÖ Opportunit√©s charg√©es:', (data.opportunites || []).length);
    } else {
      console.warn('‚ö†Ô∏è Opportunit√©s: √©chec ou donn√©es vides', opportunitesRes);
    }
    
    if (emailsRes.success && emailsRes.data) data.emails = emailsRes.data;
    if (rdvRes.success && rdvRes.data) data.rdv = rdvRes.data;
    if (appelsRes.success && appelsRes.data) data.appels = appelsRes.data;
    if (tachesRes.success && tachesRes.data) data.taches = tachesRes.data;
    if (usersRes.success && usersRes.data) data.users = usersRes.data;
    
    // S'assurer que les tableaux optionnels existent
    if (!data.activities) data.activities = [];
    if (!data.orders) data.orders = [];
    if (!data.messages) data.messages = [];
    if (!data.alertes) data.alertes = [];
    
    hideLoadingOverlay();
    
    // Afficher le r√©sum√©
    const summary = {
      entreprises: data.entreprises?.length || 0,
      contacts: data.contacts?.length || 0,
      opportunites: data.opportunites?.length || 0,
      rdv: data.rdv?.length || 0,
      appels: data.appels?.length || 0,
      taches: data.taches?.length || 0
    };
    
    console.log('üîÑ ========================================');
    console.log('üìä R√âSUM√â FINAL:', summary);
    console.log('üîÑ ========================================');
    
    // Rafra√Æchir la page actuelle
    if (typeof showPage === 'function' && currentPage) {
      console.log('üîÑ Rafra√Æchissement de la page:', currentPage);
      showPage(currentPage);
    }
    
    const total = Object.values(summary).reduce((a, b) => a + b, 0);
    
    if (total > 0) {
      showToast('Synchronis√©', total + ' √©l√©ments charg√©s', 'success');
    } else {
      showToast('Attention', 'Aucune donn√©e charg√©e. V√©rifiez Google Sheets.', 'warning');
    }
    
  } catch (error) {
    hideLoadingOverlay();
    console.error('‚ùå ERREUR SYNC:', error);
    showToast('Erreur', 'Erreur de synchronisation: ' + error.message, 'error');
  }
}




// Fonction pour tester la connexion API
async function testAPIConnectionDetailed() {
  console.log('üß™ ========================================');
  console.log('üß™ TEST DE CONNEXION API');
  console.log('üß™ ========================================');
  
  const url = API_CONFIG.API_URL;
  console.log('üîó URL API:', url);
  
  try {
    // Test 1: Simple ping
    console.log('üì° Test 1: Ping API...');
    const testUrl = url + '?action=getSettings';
    console.log('üåê URL de test:', testUrl);
    
    const response = await fetch(testUrl, {
      method: 'GET',
      redirect: 'follow'
    });
    
    console.log('üì° Status:', response.status, response.statusText);
    
    const text = await response.text();
    console.log('üìÑ R√©ponse brute:', text.substring(0, 500));
    
    try {
      const json = JSON.parse(text);
      console.log('‚úÖ JSON valide:', json);
      
      if (json.success) {
        showToast('Test r√©ussi', 'API accessible', 'success');
      } else {
        showToast('Test √©chou√©', json.message || 'Erreur API', 'error');
      }
    } catch (e) {
      console.error('‚ùå JSON invalide:', e);
      showToast('Erreur', 'R√©ponse API invalide', 'error');
    }
    
  } catch (error) {
    console.error('‚ùå Erreur r√©seau:', error);
    showToast('Erreur', 'Impossible de contacter l\'API: ' + error.message, 'error');
  }
  
  console.log('üß™ ========================================');
}

// Exposer globalement
window.testAPI = testAPIConnectionDetailed;



function toggleSyncMenu() {
  const menu = document.getElementById('syncMenu');
  if (menu) {
    const isVisible = menu.style.display !== 'none';
    menu.style.display = isVisible ? 'none' : 'block';
    
    // Mettre √† jour les infos
    if (!isVisible) {
      document.getElementById('apiModeIndicator').textContent = USE_GOOGLE_SHEETS_API ? 'API Google Sheets' : 'Local (hors-ligne)';
      document.getElementById('syncCountEntr').textContent = data.entreprises?.length || 0;
      document.getElementById('syncCountOpp').textContent = data.opportunites?.length || 0;
    }
  }
}

// Fermer le menu si on clique ailleurs
document.addEventListener('click', function(e) {
  const menu = document.getElementById('syncMenu');
  const btn = document.getElementById('syncBtn');
  if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});


</script>

</body>
</html>
